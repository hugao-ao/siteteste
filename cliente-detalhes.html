<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Detalhes do Cliente</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" /> <!-- Font Awesome -->
  <style>
    /* --- Sidebar Integration Styles --- */
    body {
      display: flex;
      margin: 0;
      min-height: 100vh;
    }
    #main-content-detalhes {
      flex-grow: 1;
      padding: 2rem;
      margin-left: 250px; /* Default margin for expanded sidebar */
      transition: margin-left 0.3s ease;
      background-color: var(--theme-bg-surface);
      color: var(--theme-text-light);
    }
    #main-content-detalhes.sidebar-collapsed {
      margin-left: 60px; /* Margin for collapsed sidebar */
    }
    /* --- End Sidebar Integration Styles --- */

    h1 {
        text-align: center;
        margin-bottom: 2rem;
        color: var(--theme-secondary-lighter); /* Ajustado para tema */
    }

    /* --- Seção de Navegação (Botões) --- */
    #nav-buttons-section {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }
    
    .nav-button {
        background-color: var(--theme-bg-dark);
        color: var(--theme-secondary-lighter);
        border: 1px solid var(--theme-border-color);
        border-radius: 8px;
        padding: 1rem 1.5rem;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 180px;
        text-align: center;
    }
    
    .nav-button:hover {
        background-color: var(--theme-primary);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .nav-button.active {
        background-color: var(--theme-primary);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .nav-button i {
        margin-right: 0.5rem;
    }

    /* --- Seção do Formulário --- */
    #form-section {
        background-color: var(--theme-bg-dark);
        padding: 1.5rem 2rem;
        margin-top: 1rem;
        border-radius: 8px;
        border: 1px solid var(--theme-border-color);
        text-align: left;
        display: none; /* Inicialmente oculto */
    }
    
    #form-section h2 {
        margin-top: 0;
        margin-bottom: 1rem;
        color: var(--theme-secondary);
        border-bottom: 1px solid var(--theme-border-color);
        padding-bottom: 0.5rem;
    }
    
    #form-section p {
        margin-bottom: 1rem;
        line-height: 1.6;
    }
    
    #form-section .form-link-container {
        background-color: var(--theme-bg-surface);
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1rem;
        word-wrap: break-word; /* Quebra links longos */
    }
    
    #form-section .form-link-container a {
        color: var(--theme-secondary-lighter); /* Ajustado para tema */
        text-decoration: none;
        font-weight: bold;
    }
    
    #form-section .form-link-container a:hover {
        text-decoration: underline;
    }
    
    #form-section .form-data-display {
        margin-bottom: 1rem;
    }
    
    #form-section .form-data-display strong {
        color: var(--theme-secondary-lighter);
    }
    
    #form-section .form-data-display ul {
        list-style: none;
        padding-left: 1rem;
        margin-top: 0.5rem;
        border-left: 2px solid var(--theme-border-color);
    }
    
    #form-section .form-data-display li {
        margin-bottom: 0.5rem;
    }
    
    #form-section .delete-form-btn {
        background-color: #c62828; /* Vermelho */
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: background-color 0.3s ease;
        margin-top: 0.5rem; /* Adiciona espaço acima do botão */
    }
    
    #form-section .delete-form-btn:hover {
        background-color: #a12020;
    }
    
    #form-section .generate-link-btn {
        background-color: var(--theme-primary); /* Ajustado para tema */
        color: var(--theme-secondary-lighter);
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: background-color 0.3s ease;
    }
    
    #form-section .generate-link-btn:hover {
        background-color: var(--theme-primary-lighter);
    }
    
    #form-loading-state {
        text-align: center;
        padding: 1rem;
        color: var(--theme-text-muted);
    }

    /* --- Seção de Diagnóstico Financeiro --- */
    #diagnostico-section {
        background-color: var(--theme-bg-dark);
        padding: 1.5rem 2rem;
        margin-top: 1rem;
        border-radius: 8px;
        border: 1px solid var(--theme-border-color);
        text-align: center;
        display: none; /* Inicialmente oculto */
    }
    
    #diagnostico-section h2 {
        margin-top: 0;
        margin-bottom: 1rem;
        color: var(--theme-secondary);
        border-bottom: 1px solid var(--theme-border-color);
        padding-bottom: 0.5rem;
    }
    
    #diagnostico-section p {
        margin-bottom: 1rem;
        line-height: 1.6;
        color: var(--theme-text-muted);
    }

    /* --- Seção de Plano Financeiro --- */
    #plano-section {
        background-color: var(--theme-bg-dark);
        padding: 1.5rem 2rem;
        margin-top: 1rem;
        border-radius: 8px;
        border: 1px solid var(--theme-border-color);
        text-align: center;
        display: none; /* Inicialmente oculto */
    }
    
    #plano-section h2 {
        margin-top: 0;
        margin-bottom: 1rem;
        color: var(--theme-secondary);
        border-bottom: 1px solid var(--theme-border-color);
        padding-bottom: 0.5rem;
    }
    
    #plano-buttons {
        display: flex;
        justify-content: center;
        gap: 1.5rem;
        margin-top: 2rem;
        flex-wrap: wrap;
    }
    
    .plano-button {
        background-color: var(--theme-bg-surface);
        color: var(--theme-secondary-lighter);
        border: 1px solid var(--theme-border-color);
        border-radius: 8px;
        padding: 1.5rem 2rem;
        font-size: 1.1rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 200px;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    
    .plano-button:hover {
        background-color: var(--theme-primary);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .plano-button i {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }
    
    /* Responsividade */
    @media (max-width: 768px) {
        #nav-buttons-section {
            flex-direction: column;
            align-items: center;
        }
        
        .nav-button {
            width: 100%;
            max-width: 300px;
        }
        
        #plano-buttons {
            flex-direction: column;
            align-items: center;
        }
        
        .plano-button {
            width: 100%;
            max-width: 300px;
        }
    }
  </style>
</head>
<body>
  <!-- Sidebar será injetada aqui pelo sidebar.js -->
  <main id="main-content-detalhes">

    <h1>Detalhes do <span id="client-name-display">Cliente</span></h1>
    
    <!-- Seção de navegação com botões (apenas para projeto Planejamento) -->
    <section id="nav-buttons-section" style="display: none;">
      <button id="btn-formulario" class="nav-button active">
        <i class="fas fa-file-alt"></i> Formulário
      </button>
      <button id="btn-diagnostico" class="nav-button">
        <i class="fas fa-chart-line"></i> Diagnóstico Financeiro
      </button>
      <button id="btn-plano" class="nav-button">
        <i class="fas fa-money-bill-wave"></i> Plano Financeiro
      </button>
    </section>

    <!-- Seção para informações do formulário -->
    <section id="form-section">
      <h2>Formulário do Cliente</h2>
      <div id="form-info-content">
        <p id="form-loading-state">Carregando informações do formulário...</p>
        <!-- Conteúdo dinâmico (link, dados preenchidos ou mensagem) será inserido aqui -->
      </div>
    </section>
    
    <!-- Seção para Diagnóstico Financeiro -->
    <section id="diagnostico-section">
      <h2>Diagnóstico Financeiro</h2>
      <p>O diagnóstico financeiro estará disponível em breve.</p>
      <i class="fas fa-chart-line" style="font-size: 4rem; color: var(--theme-text-muted); margin: 2rem 0;"></i>
    </section>
    
    <!-- Seção para Plano Financeiro -->
    <section id="plano-section">
      <h2>Plano Financeiro</h2>
      <div id="plano-buttons">
        <button id="btn-gestao" class="plano-button">
          <i class="fas fa-wallet"></i>
          Gestão Financeira
        </button>
        <button id="btn-implementacoes" class="plano-button">
          <i class="fas fa-tasks"></i>
          Implementações
        </button>
      </div>
    </section>

  </main>

  <script type="module">
    import { injectSidebar } from "./sidebar.js";
    import { supabase } from "./supabase.js"; // Importa supabase

    injectSidebar("main-content-detalhes"); // Passa o ID do container principal

    const clientNameDisplay = document.getElementById("client-name-display");
    const formInfoContentEl = document.getElementById("form-info-content");
    const navButtonsSection = document.getElementById("nav-buttons-section");
    const formSection = document.getElementById("form-section");
    const diagnosticoSection = document.getElementById("diagnostico-section");
    const planoSection = document.getElementById("plano-section");
    
    // Botões de navegação
    const btnFormulario = document.getElementById("btn-formulario");
    const btnDiagnostico = document.getElementById("btn-diagnostico");
    const btnPlano = document.getElementById("btn-plano");
    
    // Botões do plano financeiro
    const btnGestao = document.getElementById("btn-gestao");
    const btnImplementacoes = document.getElementById("btn-implementacoes");
    
    let currentClientId; // Declarada em escopo mais amplo
    let clienteProjeto; // Para armazenar o projeto do cliente

    const sanitizeInput = (str) => {
      if (str === null || str === undefined) return "";
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/\'/g, "&#x27;") 
        .replace(/`/g, "&#x60;");
    };

    const formatCurrencyForDisplay = (value) => {
        if (value === null || value === undefined) return "N/A";
        const number = parseFloat(value);
        if (isNaN(number)) return "Valor inválido";
        return number.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    };

    function displayFormLink(latestForm) {
        console.log("DEBUG: Entering displayFormLink for pending form:", latestForm); 
        const token = latestForm.token_unico;
        const formId = latestForm.id;
        const link = `${window.location.origin}/formulario-cliente.html?token=${token}`;
        console.log("DEBUG: Setting innerHTML for pending form link..."); 
        formInfoContentEl.innerHTML = `
            <p>Este cliente ainda não preencheu o formulário.</p>
            <p>Compartilhe o link abaixo com o cliente:</p>
            <div class="form-link-container">
                <a href="${link}" target="_blank">${link}</a>
            </div>
            <p><small>(Este link é único e só pode ser usado uma vez)</small></p>
            <button class="delete-form-btn" data-form-id="${formId}">Excluir Link e Gerar Novo</button>
        `;
        console.log("DEBUG: innerHTML set. Querying for delete button..."); 
        const deleteBtn = formInfoContentEl.querySelector(".delete-form-btn");
        if (deleteBtn) {
            console.log("DEBUG: Delete button found:", deleteBtn); 
            console.log("DEBUG: Adding event listener to delete button..."); 
            deleteBtn.addEventListener("click", handleDeleteForm);
            console.log("DEBUG: Event listener added."); 
        } else {
            console.log("DEBUG: Delete button not found in DOM after setting innerHTML."); 
        }
    }

    function displayFormData(formData) {
        console.log("DEBUG: Entering displayFormData for completed form:", formData); 
        let dataHtml = "";
        if (formData.dados_formulario && typeof formData.dados_formulario === "object") {
            const data = formData.dados_formulario;

            const nomeCompleto = data.nome_completo ? sanitizeInput(data.nome_completo) : "N/A";
            dataHtml += `<p><strong>Nome Completo:</strong> ${nomeCompleto}</p>`;

            const rendaUnicaText = data.renda_unica === "sim" ? "Sim" : (data.renda_unica === "nao" ? "Não" : "N/A");
            dataHtml += `<p><strong>Única pessoa com renda na casa?</strong> ${rendaUnicaText}</p>`;

            if (data.renda_unica === "nao" && Array.isArray(data.outras_pessoas) && data.outras_pessoas.length > 0) {
                dataHtml += `<p><strong>Outras pessoas com renda na casa:</strong></p><ul>`;
                data.outras_pessoas.forEach((pessoa) => {
                    const nomePessoa = pessoa.nome ? sanitizeInput(pessoa.nome) : "Nome não informado";
                    const autorizacaoText = pessoa.autorizacao === "sim" ? "Sim" : (pessoa.autorizacao === "nao" ? "Não" : "Não informado");
                    dataHtml += `<li>${nomePessoa} (Precisa de autorização: ${autorizacaoText})</li>`;
                });
                dataHtml += `</ul>`;
            } else if (data.renda_unica === "nao") {
                 dataHtml += `<p><strong>Outras pessoas com renda na casa:</strong> Nenhuma pessoa adicionada.</p>`;
            }

            const temDependentesText = data.tem_dependentes === "sim" ? "Sim" : (data.tem_dependentes === "nao" ? "Não" : "N/A");
            dataHtml += `<p style="margin-top: 1rem;"><strong>Tem dependentes?</strong> ${temDependentesText}</p>`;

            if (data.tem_dependentes === "sim" && Array.isArray(data.dependentes) && data.dependentes.length > 0) {
                dataHtml += `<p><strong>Dependentes:</strong></p><ul>`;
                data.dependentes.forEach((dependente) => {
                    const nomeDep = dependente.nome ? sanitizeInput(dependente.nome) : "Nome não informado";
                    const idadeDep = dependente.idade !== undefined && dependente.idade !== null ? sanitizeInput(String(dependente.idade)) : "N/A";
                    const relacaoDep = dependente.relacao ? sanitizeInput(dependente.relacao) : "N/A";
                    dataHtml += `<li>${nomeDep} (Idade: ${idadeDep}, Relação: ${relacaoDep})</li>`;
                });
                dataHtml += `</ul>`;
            } else if (data.tem_dependentes === "sim") {
                dataHtml += `<p><strong>Dependentes:</strong> Nenhum dependente adicionado.</p>`;
            }

            // Exibição de Planos de Saúde
            if (data.planos_saude && Object.keys(data.planos_saude).length > 0) {
                dataHtml += `<p style="margin-top: 1rem;"><strong>Informações sobre Plano de Saúde:</strong></p><ul>`;
                Object.entries(data.planos_saude).forEach(([nome, info]) => {
                    const nomePessoaPlano = sanitizeInput(nome);
                    let statusPlanoText = "N/A";
                    if (info.possui === "sim") statusPlanoText = "Sim";
                    else if (info.possui === "nao") statusPlanoText = "Não";
                    else if (info.possui === "nao_sei") statusPlanoText = "Não sei informar";
                    
                    dataHtml += `<li>${nomePessoaPlano}: ${statusPlanoText}</li>`;
                });
                dataHtml += `</ul>`;
            }

            // Exibição de Seguros de Vida
            if (data.seguros_vida && Object.keys(data.seguros_vida).length > 0) {
                dataHtml += `<p style="margin-top: 1rem;"><strong>Informações sobre Seguro de Vida:</strong></p><ul>`;
                Object.entries(data.seguros_vida).forEach(([nome, info]) => {
                    const nomePessoaSeguro = sanitizeInput(nome);
                    let statusSeguroText = "N/A";
                    if (info.possui === "sim") statusSeguroText = "Sim";
                    else if (info.possui === "nao") statusSeguroText = "Não";
                    else if (info.possui === "nao_sei") statusSeguroText = "Não sei informar";
                    
                    dataHtml += `<li>${nomePessoaSeguro}: ${statusSeguroText}</li>`;
                });
                dataHtml += `</ul>`;
            }

            // Exibição de Patrimônio Físico
            const possuiPatrimonioText = data.tem_patrimonio === "sim" ? "Sim" : (data.tem_patrimonio === "nao" ? "Não" : "N/A");
            dataHtml += `<p style="margin-top: 1rem;"><strong>Possui Patrimônio Físico?</strong> ${possuiPatrimonioText}</p>`;

            if (data.tem_patrimonio === "sim" && Array.isArray(data.patrimonios) && data.patrimonios.length > 0) {
                dataHtml += `<p><strong>Patrimônios Físicos:</strong></p><ul>`;
                data.patrimonios.forEach((patrimonio) => {
                    const descPat = patrimonio.qual ? sanitizeInput(patrimonio.qual) : "Descrição não informada";
                    const valorPat = formatCurrencyForDisplay(patrimonio.valor); 
                    const seguroPatText = patrimonio.seguro === "sim" ? "Sim" : (patrimonio.seguro === "nao" ? "Não" : "N/A");
                    const quitadoPatText = patrimonio.quitado === "sim" ? "Sim" : (patrimonio.quitado === "nao" ? "Não" : "N/A");
                    dataHtml += `<li>${descPat} (Valor: ${valorPat}, Seguro: ${seguroPatText}, Quitado: ${quitadoPatText})</li>`;
                });
                dataHtml += `</ul>`;
            } else if (data.tem_patrimonio === "sim") {
                dataHtml += `<p><strong>Patrimônios Físicos:</strong> Nenhum patrimônio adicionado.</p>`;
            }

            // Exibição do Patrimônio Líquido
            const possuiPatrimonioLiquidoText = data.tem_patrimonio_liquido === "sim" ? "Sim" : (data.tem_patrimonio_liquido === "nao" ? "Não" : "N/A");
            dataHtml += `<p style="margin-top: 1rem;"><strong>Possui Dinheiro Guardado ou Investido?</strong> ${possuiPatrimonioLiquidoText}</p>`;

            if (data.tem_patrimonio_liquido === "sim" && Array.isArray(data.patrimonios_liquidos) && data.patrimonios_liquidos.length > 0) {
                dataHtml += `<p><strong>Dinheiro Guardado ou Investido:</strong></p><ul>`;
                data.patrimonios_liquidos.forEach((patrimonio_liquido) => {
                    const ondePatLiq = patrimonio_liquido.qual ? sanitizeInput(patrimonio_liquido.qual) : "Local não informado";
                    const valorPatLiq = formatCurrencyForDisplay(patrimonio_liquido.valor);
                    dataHtml += `<li>${ondePatLiq} (Valor: ${valorPatLiq})</li>`;
                });
                dataHtml += `</ul>`;
            } else if (data.tem_patrimonio_liquido === "sim") {
                dataHtml += `<p><strong>Dinheiro Guardado ou Investido:</strong> Nenhum item adicionado.</p>`;
            }

            // Exibição de Dívidas
            const possuiDividasText = data.tem_dividas === "sim" ? "Sim" : (data.tem_dividas === "nao" ? "Não" : "N/A");
            dataHtml += `<p style="margin-top: 1rem;"><strong>Possui Dívidas?</strong> ${possuiDividasText}</p>`;

            if (data.tem_dividas === "sim" && Array.isArray(data.dividas) && data.dividas.length > 0) {
                dataHtml += `<p><strong>Dívidas:</strong></p><ul>`;
                data.dividas.forEach((divida) => {
                    const credorDivida = divida.credor ? sanitizeInput(divida.credor) : "Credor não informado";
                    const saldoDivida = formatCurrencyForDisplay(divida.saldo);
                    dataHtml += `<li>A quem deve: ${credorDivida} (Saldo Devedor Atual: ${saldoDivida})</li>`;
                });
                dataHtml += `</ul>`;
            } else if (data.tem_dividas === "sim") {
                dataHtml += `<p><strong>Dívidas:</strong> Nenhuma dívida adicionada.</p>`;
            }
            
            // Exibição de Imposto de Renda com informações adicionais
            if (data.impostos_renda && Object.keys(data.impostos_renda).length > 0) {
                dataHtml += `<p style="margin-top: 1rem;"><strong>Informações sobre Imposto de Renda:</strong></p><ul>`;
                Object.entries(data.impostos_renda).forEach(([nome, info]) => {
                    const nomePessoaIR = sanitizeInput(nome);
                    let statusIRText = "N/A";
                    if (info.declara === "sim") statusIRText = "Sim";
                    else if (info.declara === "nao") statusIRText = "Não";
                    else if (info.declara === "nao_sei") statusIRText = "Não sei informar";
                    
                    // Informações básicas sobre declaração
                    let irInfoText = `${nomePessoaIR}: ${statusIRText}`;
                    
                    // Adicionar informações sobre contador se disponíveis
                    if (info.declara === "sim" && info.contador !== undefined) {
                        const contadorText = info.contador === "sim" ? "Sim" : (info.contador === "nao" ? "Não" : "N/A");
                        irInfoText += ` (Usa contador: ${contadorText})`;
                    }
                    
                    dataHtml += `<li>${irInfoText}</li>`;
                });
                dataHtml += `</ul>`;
            }
        } else {
            dataHtml = "<p>Não foi possível carregar os dados do formulário.</p>";
        }

        // Adicionar botão para excluir formulário e gerar novo
        dataHtml += `
            <button class="delete-form-btn" data-form-id="${formData.id}">Excluir Formulário e Gerar Novo</button>
        `;

        formInfoContentEl.innerHTML = dataHtml;
        
        // Adicionar event listener para o botão de excluir
        const deleteBtn = formInfoContentEl.querySelector(".delete-form-btn");
        if (deleteBtn) {
            deleteBtn.addEventListener("click", handleDeleteForm);
        }
    }

    function displayNoFormMessage() {
        console.log("DEBUG: Entering displayNoFormMessage"); 
        formInfoContentEl.innerHTML = `
            <p>Este cliente ainda não possui um formulário.</p>
            <button class="generate-link-btn" id="generate-form-btn">Gerar Link de Formulário</button>
        `;
        
        const generateBtn = document.getElementById("generate-form-btn");
        if (generateBtn) {
            generateBtn.addEventListener("click", handleGenerateForm);
        }
    }

    async function handleDeleteForm(event) {
        console.log("DEBUG: Entering handleDeleteForm"); 
        const formId = event.currentTarget.dataset.formId;
        if (!formId) {
            console.error("DEBUG: Form ID not found in button dataset"); 
            return;
        }
        
        if (!confirm("Tem certeza que deseja excluir este formulário? Esta ação não pode ser desfeita.")) {
            return;
        }
        
        try {
            const { error } = await supabase
                .from("formularios_clientes")
                .delete()
                .eq("id", formId);
                
            if (error) throw error;
            
            alert("Formulário excluído com sucesso!");
            
            // Gerar novo formulário automaticamente
            await handleGenerateForm();
            
        } catch (error) {
            console.error("DEBUG: Error deleting form:", error); 
            alert("Erro ao excluir formulário: " + error.message);
        }
    }

    async function handleGenerateForm() {
        console.log("DEBUG: Entering handleGenerateForm"); 
        if (!currentClientId) {
            console.error("DEBUG: Client ID not available"); 
            return;
        }
        
        try {
            formInfoContentEl.innerHTML = '<p id="form-loading-state">Gerando novo formulário...</p>';
            
            // Gerar token único
            const token = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
            
            // Inserir novo formulário
            const { data, error } = await supabase
                .from("formularios_clientes")
                .insert([
                    {
                        cliente_id: currentClientId,
                        token_unico: token,
                        status: "preenchido", // Inicialmente como "preenchido" para evitar problemas
                        data_preenchimento: null,
                        dados_formulario: null
                    }
                ])
                .select();
                
            if (error) throw error;
            
            if (data && data.length > 0) {
                displayFormLink(data[0]);
            } else {
                throw new Error("Nenhum dado retornado após inserção");
            }
            
        } catch (error) {
            console.error("DEBUG: Error generating form:", error); 
            formInfoContentEl.innerHTML = `<p style="color: red;">Erro ao gerar formulário: ${error.message}</p>`;
        }
    }

    async function loadClientDetails() {
        console.log("DEBUG: Entering loadClientDetails"); 
        const urlParams = new URLSearchParams(window.location.search);
        const clientId = urlParams.get("id");
        
        if (!clientId) {
            console.error("DEBUG: No client ID in URL"); 
            window.location.href = "clientes-dashboard.html";
            return;
        }
        
        currentClientId = clientId;
        
        try {
            // Carregar informações do cliente
            const { data: clientData, error: clientError } = await supabase
                .from("clientes")
                .select("*")
                .eq("id", clientId)
                .single();
                
            if (clientError) throw clientError;
            
            if (!clientData) {
                throw new Error("Cliente não encontrado");
            }
            
            // Armazenar o projeto do cliente
            clienteProjeto = clientData.projeto;
            
            // Atualizar nome do cliente na página
            clientNameDisplay.textContent = clientData.nome || "Cliente";
            
            // Verificar se o cliente é do projeto Planejamento
            if (clientData.projeto === "Planejamento") {
                // Mostrar os botões de navegação
                navButtonsSection.style.display = "flex";
                
                // Configurar os botões de navegação
                setupNavigationButtons();
                
                // Mostrar a seção de formulário por padrão
                showSection("form");
            } else {
                // Para outros projetos, mostrar apenas a seção de formulário
                formSection.style.display = "block";
            }
            
            // Carregar formulário do cliente
            await loadClientForm(clientId);
            
        } catch (error) {
            console.error("DEBUG: Error loading client details:", error); 
            alert("Erro ao carregar detalhes do cliente: " + error.message);
            window.location.href = "clientes-dashboard.html";
        }
    }

    async function loadClientForm(clientId) {
        console.log(`DEBUG: Entering loadClientForm for client ID: ${clientId}`); 
        try {
            // Buscar o formulário mais recente do cliente
            const { data: forms, error } = await supabase
                .from("formularios_clientes")
                .select("*")
                .eq("cliente_id", clientId)
                .order("created_at", { ascending: false })
                .limit(1);
                
            if (error) throw error;
            
            if (!forms || forms.length === 0) {
                // Cliente não tem formulário
                displayNoFormMessage();
                return;
            }
            
            const latestForm = forms[0];
            
            if (latestForm.status === "preenchido" && latestForm.dados_formulario) {
                // Formulário já preenchido
                displayFormData(latestForm);
            } else {
                // Formulário pendente (link gerado mas não preenchido)
                displayFormLink(latestForm);
            }
            
        } catch (error) {
            console.error("DEBUG: Error loading client form:", error); 
            formInfoContentEl.innerHTML = `<p style="color: red;">Erro ao carregar formulário: ${error.message}</p>`;
        }
    }
    
    // Função para configurar os botões de navegação
    function setupNavigationButtons() {
        // Botão Formulário
        btnFormulario.addEventListener("click", () => {
            showSection("form");
        });
        
        // Botão Diagnóstico Financeiro
        btnDiagnostico.addEventListener("click", () => {
            showSection("diagnostico");
        });
        
        // Botão Plano Financeiro
        btnPlano.addEventListener("click", () => {
            showSection("plano");
        });
        
        // Botões do Plano Financeiro (sem ação por enquanto)
        btnGestao.addEventListener("click", () => {
            alert("Funcionalidade em desenvolvimento");
        });
        
        btnImplementacoes.addEventListener("click", () => {
            alert("Funcionalidade em desenvolvimento");
        });
    }
    
    // Função para mostrar a seção selecionada
    function showSection(section) {
        // Ocultar todas as seções
        formSection.style.display = "none";
        diagnosticoSection.style.display = "none";
        planoSection.style.display = "none";
        
        // Remover classe active de todos os botões
        btnFormulario.classList.remove("active");
        btnDiagnostico.classList.remove("active");
        btnPlano.classList.remove("active");
        
        // Mostrar a seção selecionada e ativar o botão correspondente
        switch (section) {
            case "form":
                formSection.style.display = "block";
                btnFormulario.classList.add("active");
                break;
            case "diagnostico":
                diagnosticoSection.style.display = "block";
                btnDiagnostico.classList.add("active");
                break;
            case "plano":
                planoSection.style.display = "block";
                btnPlano.classList.add("active");
                break;
        }
    }

    // Inicializar a página
    document.addEventListener("DOMContentLoaded", loadClientDetails);
  </script>

</body>
</html>
