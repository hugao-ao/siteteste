<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Detalhes do Cliente</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" /> <!-- Font Awesome -->
  <style>
    /* --- Sidebar Integration Styles --- */
    body {
      display: flex;
      margin: 0;
      min-height: 100vh;
    }
    #main-content-detalhes {
      flex-grow: 1;
      padding: 2rem;
      margin-left: 250px; /* Default margin for expanded sidebar */
      transition: margin-left 0.3s ease;
      background-color: var(--theme-bg-surface);
      color: var(--theme-text-light);
    }
    #main-content-detalhes.sidebar-collapsed {
      margin-left: 60px; /* Margin for collapsed sidebar */
    }
    /* --- End Sidebar Integration Styles --- */

    h1 {
        text-align: center;
        margin-bottom: 2rem;
        color: var(--theme-secondary-lighter); /* Ajustado para tema */
    }

    /* --- Seção de Navegação (Botões) --- */
    #nav-buttons-section {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }
    
    .nav-button {
        background-color: var(--theme-bg-dark);
        color: var(--theme-secondary-lighter);
        border: 1px solid var(--theme-border-color);
        border-radius: 8px;
        padding: 1rem 1.5rem;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 180px;
        text-align: center;
    }
    
    .nav-button:hover {
        background-color: var(--theme-primary);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .nav-button.active {
        background-color: var(--theme-primary);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .nav-button i {
        margin-right: 0.5rem;
    }

    /* --- Seção do Formulário --- */
    #form-section {
        background-color: var(--theme-bg-dark);
        padding: 1.5rem 2rem;
        margin-top: 1rem;
        border-radius: 8px;
        border: 1px solid var(--theme-border-color);
        text-align: left;
        display: none; /* Inicialmente oculto */
    }
    
    #form-section h2 {
        margin-top: 0;
        margin-bottom: 1rem;
        color: var(--theme-secondary);
        border-bottom: 1px solid var(--theme-border-color);
        padding-bottom: 0.5rem;
    }
    
    #form-section p {
        margin-bottom: 1rem;
        line-height: 1.6;
    }
    
    #form-section .form-link-container {
        background-color: var(--theme-bg-surface);
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1rem;
        word-wrap: break-word; /* Quebra links longos */
    }
    
    #form-section .form-link-container a {
        color: var(--theme-secondary-lighter); /* Ajustado para tema */
        text-decoration: none;
        font-weight: bold;
    }
    
    #form-section .form-link-container a:hover {
        text-decoration: underline;
    }
    
    #form-section .form-data-display {
        margin-bottom: 1rem;
    }
    
    #form-section .form-data-display strong {
        color: var(--theme-secondary-lighter);
    }
    
    #form-section .form-data-display ul {
        list-style: none;
        padding-left: 1rem;
        margin-top: 0.5rem;
        border-left: 2px solid var(--theme-border-color);
    }
    
    #form-section .form-data-display li {
        margin-bottom: 0.5rem;
    }
    
    #form-section .delete-form-btn {
        background-color: #c62828; /* Vermelho */
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: background-color 0.3s ease;
        margin-top: 0.5rem; /* Adiciona espaço acima do botão */
    }
    
    #form-section .delete-form-btn:hover {
        background-color: #a12020;
    }
    
    #form-section .generate-link-btn {
        background-color: var(--theme-primary); /* Ajustado para tema */
        color: var(--theme-secondary-lighter);
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: background-color 0.3s ease;
    }
    
    #form-section .generate-link-btn:hover {
        background-color: var(--theme-primary-lighter);
    }
    
    #form-loading-state {
        text-align: center;
        padding: 1rem;
        color: var(--theme-text-muted);
    }

    /* --- Seção de Diagnóstico Financeiro --- */
    #diagnostico-section {
        background-color: var(--theme-bg-dark);
        padding: 1.5rem 2rem;
        margin-top: 1rem;
        border-radius: 8px;
        border: 1px solid var(--theme-border-color);
        text-align: left;
        display: none; /* Inicialmente oculto */
    }
    
    #diagnostico-section h2 {
        margin-top: 0;
        margin-bottom: 1rem;
        color: var(--theme-secondary);
        border-bottom: 1px solid var(--theme-border-color);
        padding-bottom: 0.5rem;
    }
    
    #diagnostico-section p {
        margin-bottom: 1rem;
        line-height: 1.6;
    }

    /* --- Seção de Plano Financeiro --- */
    #plano-section {
        background-color: var(--theme-bg-dark);
        padding: 1.5rem 2rem;
        margin-top: 1rem;
        border-radius: 8px;
        border: 1px solid var(--theme-border-color);
        text-align: center;
        display: none; /* Inicialmente oculto */
    }
    
    #plano-section h2 {
        margin-top: 0;
        margin-bottom: 1rem;
        color: var(--theme-secondary);
        border-bottom: 1px solid var(--theme-border-color);
        padding-bottom: 0.5rem;
    }
    
    #plano-buttons {
        display: flex;
        justify-content: center;
        gap: 1.5rem;
        margin-top: 2rem;
        flex-wrap: wrap;
    }
    
    .plano-button {
        background-color: var(--theme-bg-surface);
        color: var(--theme-secondary-lighter);
        border: 1px solid var(--theme-border-color);
        border-radius: 8px;
        padding: 1.5rem 2rem;
        font-size: 1.1rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 200px;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    
    .plano-button:hover {
        background-color: var(--theme-primary);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .plano-button i {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    /* --- Seção de Dados Cadastrais --- */
    #dados-cadastrais-section {
        background-color: var(--theme-bg-dark);
        padding: 1.5rem 2rem;
        margin-top: 1rem;
        border-radius: 8px;
        border: 1px solid var(--theme-border-color);
        text-align: left;
        display: none; /* Inicialmente oculto */
    }
    
    #dados-cadastrais-section h2 {
        margin-top: 0;
        margin-bottom: 1.5rem;
        color: var(--theme-secondary);
        border-bottom: 1px solid var(--theme-border-color);
        padding-bottom: 0.5rem;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: bold;
        color: var(--theme-secondary-lighter);
    }
    
    .form-group input {
        width: 100%;
        padding: 0.8rem;
        border-radius: 4px;
        border: 1px solid var(--theme-border-color);
        background-color: var(--theme-bg-surface);
        color: var(--theme-text-light);
        font-size: 1rem;
    }
    
    .form-group input:focus {
        outline: none;
        border-color: var(--theme-secondary);
        box-shadow: 0 0 0 2px rgba(var(--theme-secondary-rgb), 0.2);
    }
    
    .required-field::after {
        content: " *";
        color: #e53935;
    }
    
    .form-group .error-message {
        color: #e53935;
        font-size: 0.85rem;
        margin-top: 0.3rem;
        display: none;
    }
    
    .conjuge-section {
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px dashed var(--theme-border-color);
    }
    
    .conjuge-section h3 {
        margin-top: 0;
        margin-bottom: 1.5rem;
        color: var(--theme-secondary-lighter);
    }
    
    .form-actions {
        margin-top: 2rem;
        text-align: right;
    }
    
    .save-btn {
        background-color: var(--theme-primary);
        color: var(--theme-secondary-lighter);
        border: none;
        padding: 0.8rem 1.5rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: bold;
        transition: all 0.3s ease;
    }
    
    .save-btn:hover {
        background-color: var(--theme-primary-lighter);
        transform: translateY(-2px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .save-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    /* Responsividade */
    @media (max-width: 768px) {
        #nav-buttons-section {
            flex-direction: column;
            align-items: center;
        }
        
        .nav-button {
            width: 100%;
            max-width: 300px;
        }
        
        #plano-buttons {
            flex-direction: column;
            align-items: center;
        }
        
        .plano-button {
            width: 100%;
            max-width: 300px;
        }
    }
  </style>
</head>
<body>
  <!-- Sidebar será injetada aqui pelo sidebar.js -->
  <main id="main-content-detalhes">

    <h1>Detalhes do <span id="client-name-display">Cliente</span></h1>
    
    <!-- Seção de navegação com botões (apenas para projeto Planejamento) -->
    <section id="nav-buttons-section" style="display: none;">
      <button id="btn-formulario" class="nav-button active">
        <i class="fas fa-file-alt"></i> Formulário
      </button>
      <button id="btn-diagnostico" class="nav-button">
        <i class="fas fa-chart-line"></i> Diagnóstico Financeiro
      </button>
      <button id="btn-plano" class="nav-button">
        <i class="fas fa-money-bill-wave"></i> Plano Financeiro
      </button>
    </section>

    <!-- Seção para informações do formulário -->
    <section id="form-section">
      <h2>Formulário do Cliente</h2>
      <div id="form-info-content">
        <p id="form-loading-state">Carregando informações do formulário...</p>
        <!-- Conteúdo dinâmico (link, dados preenchidos ou mensagem) será inserido aqui -->
      </div>
    </section>
    
       <!-- Seção para Diagnóstico Financeiro -->
    <section id="diagnostico-section">
      <h2>Diagnóstico Financeiro</h2>
      <div id="diagnostico-info-content">
        <p id="diagnostico-loading-state">Carregando informações do diagnóstico...</p>
      </div>
    </section>
    
    <!-- Seção para Plano Financeiro -->
    <section id="plano-section">
      <h2>Plano Financeiro</h2>
      <div id="plano-buttons">
        <button id="btn-dados-cadastrais" class="plano-button">
          <i class="fas fa-user-edit"></i>
          Dados Cadastrais
        </button>
        <button id="btn-gestao" class="plano-button">
          <i class="fas fa-wallet"></i>
          Gestão Financeira
        </button>
        <button id="btn-implementacoes" class="plano-button">
          <i class="fas fa-tasks"></i>
          Implementações
        </button>
      </div>
    </section>
    
    <!-- Seção para Dados Cadastrais -->
    <section id="dados-cadastrais-section">
      <h2>Dados Cadastrais</h2>
      <form id="dados-cadastrais-form">
        <div class="form-group">
          <label for="nome-completo">Nome Completo</label>
          <input type="text" id="nome-completo" name="nome-completo" placeholder="Digite o nome completo">
        </div>
        
        <div class="form-group">
          <label for="cpf" class="required-field">CPF</label>
          <input type="text" id="cpf" name="cpf" placeholder="000.000.000-00" required maxlength="14">
          <div class="error-message" id="cpf-error">CPF é obrigatório</div>
        </div>
        
        <div class="form-group">
          <label for="email">E-mail</label>
          <input type="email" id="email" name="email" placeholder="exemplo@email.com">
        </div>
        
        <div class="form-group">
          <label for="whatsapp" class="required-field">WhatsApp</label>
          <input type="text" id="whatsapp" name="whatsapp" placeholder="+55DDNNNNNNNNN" required>
          <div class="error-message" id="whatsapp-error">WhatsApp é obrigatório</div>
        </div>
        
        <div class="conjuge-section">
          <h3>Informações do Cônjuge</h3>
          
          <div class="form-group">
            <label for="conjuge-nome">Nome do Cônjuge</label>
            <input type="text" id="conjuge-nome" name="conjuge-nome" placeholder="Digite o nome do cônjuge">
          </div>
          
          <div class="form-group">
            <label for="conjuge-whatsapp" class="required-field">WhatsApp do Cônjuge</label>
            <input type="text" id="conjuge-whatsapp" name="conjuge-whatsapp" placeholder="+55DDNNNNNNNNN">
            <div class="error-message" id="conjuge-whatsapp-error">WhatsApp do cônjuge é obrigatório quando o nome é preenchido</div>
          </div>
        </div>
        
        <div class="form-actions">
          <button type="submit" class="save-btn" id="save-dados-btn">Salvar Dados</button>
        </div>
      </form>
    </section>

  </main>

  <script type="module">
    import { injectSidebar } from "./sidebar.js";
    import { supabase } from "./supabase.js"; // Importa supabase

    injectSidebar("main-content-detalhes"); // Passa o ID do container principal

    const clientNameDisplay = document.getElementById("client-name-display");
    const formInfoContentEl = document.getElementById("form-info-content");
    const navButtonsSection = document.getElementById("nav-buttons-section");
    const formSection = document.getElementById("form-section");
    const diagnosticoSection = document.getElementById("diagnostico-section");
    const planoSection = document.getElementById("plano-section");
    const dadosCadastraisSection = document.getElementById("dados-cadastrais-section");
    
    // Botões de navegação
    const btnFormulario = document.getElementById("btn-formulario");
    const btnDiagnostico = document.getElementById("btn-diagnostico");
    const btnPlano = document.getElementById("btn-plano");
    
    // Botões do plano financeiro
    const btnDadosCadastrais = document.getElementById("btn-dados-cadastrais");
    const btnGestao = document.getElementById("btn-gestao");
    const btnImplementacoes = document.getElementById("btn-implementacoes");
    
    // Formulário de dados cadastrais
    const dadosCadastraisForm = document.getElementById("dados-cadastrais-form");
    const nomeCompletoInput = document.getElementById("nome-completo");
    const cpfInput = document.getElementById("cpf");
    const emailInput = document.getElementById("email");
    const whatsappInput = document.getElementById("whatsapp");
    const conjugeNomeInput = document.getElementById("conjuge-nome");
    const conjugeWhatsappInput = document.getElementById("conjuge-whatsapp");
    
    let currentClientId; // Declarada em escopo global para ser acessível por todas as funções

    // Função para sanitizar entrada do usuário
    function sanitizeInput(input) {
        if (typeof input !== "string") return "";
        return input.replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }

    // Função para obter o ID do cliente da URL
    function getClientIdFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get("id");
    }

    // Função para verificar se é projeto Planejamento
    function isPlanejamentoProject() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get("projeto") === "planejamento";
    }

    // Função para carregar detalhes do cliente
    async function loadClientDetails() {
        console.log("DEBUG: Entering loadClientDetails"); 
        currentClientId = getClientIdFromUrl();
        
        if (!currentClientId) {
            console.log("DEBUG: No client ID found in URL"); 
            clientNameDisplay.textContent = "Cliente não encontrado";
            return;
        }
        
        console.log(`DEBUG: Client ID from URL: ${currentClientId}`); 
        
        try {
            const { data: client, error } = await supabase
                .from("clientes")
                .select("*")
                .eq("id", currentClientId)
                .single();
                
            if (error) throw error;
            
            console.log("DEBUG: Client data loaded:", client); 
            clientNameDisplay.textContent = client.nome || "Cliente";
            
            // Verificar se é projeto Planejamento
            if (isPlanejamentoProject()) {
                console.log("DEBUG: This is a Planejamento project"); 
                navButtonsSection.style.display = "flex";
                showSection("form"); // Mostrar seção de formulário por padrão
                loadClientForm(currentClientId); // Carregar dados do formulário
            } else {
                console.log("DEBUG: This is NOT a Planejamento project"); 
                // Para outros projetos, mostrar seção padrão ou dados cadastrais
                showSection("dados-cadastrais");
                loadClientData(client);
            }
            
        } catch (error) {
            console.error("DEBUG: Error loading client details:", error); 
            clientNameDisplay.textContent = "Erro ao carregar cliente";
        }
    }

    // Função para carregar dados do cliente no formulário de dados cadastrais
    function loadClientData(client) {
        console.log("DEBUG: Loading client data into form:", client); 
        nomeCompletoInput.value = client.nome || "";
        cpfInput.value = client.cpf || "";
        emailInput.value = client.email || "";
        whatsappInput.value = client.whatsapp || "";
        conjugeNomeInput.value = client.conjuge_nome || "";
        conjugeWhatsappInput.value = client.conjuge_whatsapp || "";
    }

    // Função para exibir mensagem quando não há formulário
    function displayNoFormMessage() {
        console.log("DEBUG: Displaying no form message"); 
        formInfoContentEl.innerHTML = `
            <p>Este cliente ainda não possui um formulário.</p>
            <p>Clique no botão abaixo para gerar um link de formulário:</p>
            <button class="generate-link-btn" data-client-id="${currentClientId}">Gerar Link do Formulário</button>
        `;
        
        const generateBtn = formInfoContentEl.querySelector(".generate-link-btn");
        if (generateBtn) {
            generateBtn.addEventListener("click", handleGenerateForm);
        }
    }

    // Função para exibir link do formulário (não preenchido)
    function displayFormLink(latestForm) {
        console.log("DEBUG: Displaying form link for pending form:", latestForm); 
        const token = latestForm.token_unico;
        const formId = latestForm.id;
        const link = `${window.location.origin}/formulario-cliente.html?token=${token}`;
        console.log("DEBUG: Setting innerHTML for pending form link..."); 
        formInfoContentEl.innerHTML = `
            <p>Este cliente ainda não preencheu o formulário.</p>
            <p>Compartilhe o link abaixo com o cliente:</p>
            <div class="form-link-container">
                <a href="${link}" target="_blank">${link}</a>
            </div>
            <p><small>(Este link é único e só pode ser usado uma vez)</small></p>
            <button class="delete-form-btn" id="delete-form-btn-${formId}" data-form-id="${formId}">Excluir Link e Gerar Novo</button>
        `;
        
        // CONDIÇÃO 2: Verificar se existe diagnóstico para desabilitar botão
        setTimeout(async () => {
            try {
                const { data: diagnostico } = await supabase
                    .from('diagnosticos_financeiros')
                    .select('id')
                    .eq('cliente_id', currentClientId)
                    .single();
                
                if (diagnostico) {
                    const btn = document.getElementById(`delete-form-btn-${formId}`);
                    if (btn) {
                        btn.disabled = true;
                        btn.style.opacity = '0.5';
                        btn.style.cursor = 'not-allowed';
                        btn.title = 'Não é possível excluir o formulário pois já existe um diagnóstico financeiro';
                        btn.onclick = function(e) {
                            e.preventDefault();
                            alert('Não é possível excluir o formulário pois já existe um diagnóstico financeiro.\\n\\nExclua o diagnóstico primeiro se necessário.');
                            return false;
                        };
                    }
                }
            } catch (error) {
                console.log('Erro ao verificar diagnóstico:', error);
            }
        }, 100);
        
        console.log("DEBUG: innerHTML set. Querying for delete button..."); 
        const deleteBtn = formInfoContentEl.querySelector(".delete-form-btn");
        if (deleteBtn) {
            console.log("DEBUG: Delete button found:", deleteBtn); 
            console.log("DEBUG: Adding event listener to delete button..."); 
            deleteBtn.addEventListener("click", handleDeleteForm);
            console.log("DEBUG: Event listener added."); 
        } else {
            console.log("DEBUG: Delete button not found in DOM after setting innerHTML."); 
        }
    }

    function displayFormData(formData) {
        console.log("DEBUG: Entering displayFormData for completed form:", formData); 
        let dataHtml = "";
        if (formData.dados_formulario && typeof formData.dados_formulario === "object") {
            const data = formData.dados_formulario;

            const nomeCompleto = data.nome_completo ? sanitizeInput(data.nome_completo) : "N/A";
            dataHtml += `<p><strong style="color: var(--theme-secondary-lighter);">Nome Completo:</strong> ${nomeCompleto}</p>`;

            const rendaUnicaText = data.renda_unica === "sim" ? "Sim" : (data.renda_unica === "nao" ? "Não" : "N/A");
            dataHtml += `<p><strong style="color: var(--theme-secondary-lighter);">Única pessoa com renda na casa?</strong> ${rendaUnicaText}</p>`;

            if (data.renda_unica === "nao" && Array.isArray(data.outras_pessoas) && data.outras_pessoas.length > 0) {
                dataHtml += `<ul>`;
                data.outras_pessoas.forEach((pessoa) => {
                    const nomePessoa = pessoa.nome ? sanitizeInput(pessoa.nome) : "Nome não informado";
                    const autorizacaoText = pessoa.autorizacao === "sim" ? "Sim" : (pessoa.autorizacao === "nao" ? "Não" : "Não informado");
                    dataHtml += `<li>${nomePessoa} (Precisa de autorização: ${autorizacaoText})</li>`;
                });
                dataHtml += `</ul>`;
            } else if (data.renda_unica === "nao") {
                 dataHtml += `<p><strong style="color: var(--theme-secondary-lighter);">Outras pessoas com renda na casa:</strong> Nenhuma pessoa adicionada.</p>`;
            }

            const temDependentesText = data.tem_dependentes === "sim" ? "Sim" : (data.tem_dependentes === "nao" ? "Não" : "N/A");
            dataHtml += `<p style="margin-top: 1rem;"><strong style="color: var(--theme-secondary-lighter);">Tem dependentes?</strong> ${temDependentesText}</p>`;

            if (data.tem_dependentes === "sim" && Array.isArray(data.dependentes) && data.dependentes.length > 0) {
                dataHtml += `<ul>`;
                data.dependentes.forEach((dependente) => {
                    const nomeDep = dependente.nome ? sanitizeInput(dependente.nome) : "Nome não informado";
                    const idadeDep = dependente.idade !== undefined && dependente.idade !== null ? sanitizeInput(String(dependente.idade)) : "N/A";
                    const relacaoDep = dependente.relacao ? sanitizeInput(dependente.relacao) : "N/A";
                    dataHtml += `<li>${nomeDep} (Idade: ${idadeDep}, Relação: ${relacaoDep})</li>`;
                });
                dataHtml += `</ul>`;
            } else if (data.tem_dependentes === "sim") {
                dataHtml += `<p><strong style="color: var(--theme-secondary-lighter);">Dependentes:</strong> Nenhum dependente adicionado.</p>`;
            }

            // Exibição de Planos de Saúde
            if (data.planos_saude && Object.keys(data.planos_saude).length > 0) {
                dataHtml += `<p style="margin-top: 1rem;"><strong style="color: var(--theme-secondary-lighter);">Informações sobre Plano de Saúde:</strong></p><ul>`;
                Object.entries(data.planos_saude).forEach(([nome, info]) => {
                    const nomePessoaPlano = sanitizeInput(nome);
                    let statusPlanoText = "N/A";
                    if (info.possui === "sim") {
                        statusPlanoText = "Possui plano de saúde";
                    } else if (info.possui === "nao") {
                        statusPlanoText = "Não possui plano de saúde";
                    }
                    dataHtml += `<li>${nomePessoaPlano}: ${statusPlanoText}</li>`;
                });
                dataHtml += `</ul>`;
            }

            // Exibição de Seguros de Vida
            if (data.seguros_vida && Object.keys(data.seguros_vida).length > 0) {
                dataHtml += `<p style="margin-top: 1rem;"><strong style="color: var(--theme-secondary-lighter);">Informações sobre Seguro de Vida:</strong></p><ul>`;
                Object.entries(data.seguros_vida).forEach(([nome, info]) => {
                    const nomePessoaSeguro = sanitizeInput(nome);
                    let statusSeguroText = "N/A";
                    if (info.possui === "sim") {
                        statusSeguroText = "Possui seguro de vida";
                    } else if (info.possui === "nao") {
                        statusSeguroText = "Não possui seguro de vida";
                    }
                    dataHtml += `<li>${nomePessoaSeguro}: ${statusSeguroText}</li>`;
                });
                dataHtml += `</ul>`;
            }

            // Exibição de Impostos de Renda
            if (data.impostos_renda && Object.keys(data.impostos_renda).length > 0) {
                dataHtml += `<p style="margin-top: 1rem;"><strong style="color: var(--theme-secondary-lighter);">Informações sobre Imposto de Renda:</strong></p><ul>`;
                Object.entries(data.impostos_renda).forEach(([nome, info]) => {
                    const nomePessoaIR = sanitizeInput(nome);
                    let statusIRText = "N/A";
                    if (info.declara === "sim") {
                        const tipoIR = info.tipo_ir ? sanitizeInput(info.tipo_ir) : "N/A";
                        const resultadoIR = info.resultado_ir ? sanitizeInput(info.resultado_ir) : "N/A";
                        statusIRText = `Declara IR (Tipo: ${tipoIR}, Resultado: ${resultadoIR})`;
                    } else if (info.declara === "nao") {
                        statusIRText = "Não declara IR";
                    }
                    dataHtml += `<li>${nomePessoaIR}: ${statusIRText}</li>`;
                });
                dataHtml += `</ul>`;
            }

            // Exibição de Orçamento de Renda
            if (Array.isArray(data.orcamento_renda) && data.orcamento_renda.length > 0) {
                dataHtml += `<p style="margin-top: 1rem;"><strong style="color: var(--theme-secondary-lighter);">Orçamento de Renda:</strong></p><ul>`;
                data.orcamento_renda.forEach((item) => {
                    const descricao = item.descricao ? sanitizeInput(item.descricao) : "Descrição não informada";
                    const valor = item.valor !== undefined && item.valor !== null ? `R$ ${parseFloat(item.valor).toFixed(2)}` : "Valor não informado";
                    dataHtml += `<li>${descricao}: ${valor}</li>`;
                });
                dataHtml += `</ul>`;
            }

            // Exibição de Despesas Fixas
            if (Array.isArray(data.orcamento_despesas_fixas) && data.orcamento_despesas_fixas.length > 0) {
                dataHtml += `<p style="margin-top: 1rem;"><strong style="color: var(--theme-secondary-lighter);">Despesas Fixas:</strong></p><ul>`;
                data.orcamento_despesas_fixas.forEach((item) => {
                    const descricao = item.descricao ? sanitizeInput(item.descricao) : "Descrição não informada";
                    const valor = item.valor !== undefined && item.valor !== null ? `R$ ${parseFloat(item.valor).toFixed(2)}` : "Valor não informado";
                    dataHtml += `<li>${descricao}: ${valor}</li>`;
                });
                dataHtml += `</ul>`;
            }

            // Exibição de Despesas Variáveis
            if (Array.isArray(data.orcamento_despesas_variaveis) && data.orcamento_despesas_variaveis.length > 0) {
                dataHtml += `<p style="margin-top: 1rem;"><strong style="color: var(--theme-secondary-lighter);">Despesas Variáveis:</strong></p><ul>`;
                data.orcamento_despesas_variaveis.forEach((item) => {
                    const descricao = item.descricao ? sanitizeInput(item.descricao) : "Descrição não informada";
                    const valor = item.valor !== undefined && item.valor !== null ? `R$ ${parseFloat(item.valor).toFixed(2)}` : "Valor não informado";
                    dataHtml += `<li>${descricao}: ${valor}</li>`;
                });
                dataHtml += `</ul>`;
            }

            // Exibição de Patrimônios
            if (Array.isArray(data.patrimonios) && data.patrimonios.length > 0) {
                dataHtml += `<p style="margin-top: 1rem;"><strong style="color: var(--theme-secondary-lighter);">Patrimônios:</strong></p><ul>`;
                data.patrimonios.forEach((item) => {
                    const qual = item.qual ? sanitizeInput(item.qual) : "Não informado";
                    const valor = item.valor !== undefined && item.valor !== null ? `R$ ${parseFloat(item.valor).toFixed(2)}` : "Valor não informado";
                    const seguro = item.seguro ? sanitizeInput(item.seguro) : "N/A";
                    const quitado = item.quitado ? sanitizeInput(item.quitado) : "N/A";
                    dataHtml += `<li>${qual}: ${valor} (Seguro: ${seguro}, Quitado: ${quitado})</li>`;
                });
                dataHtml += `</ul>`;
            }

            // Exibição de Patrimônios Líquidos
            if (Array.isArray(data.patrimonios_liquidos) && data.patrimonios_liquidos.length > 0) {
                dataHtml += `<p style="margin-top: 1rem;"><strong style="color: var(--theme-secondary-lighter);">Patrimônios Líquidos:</strong></p><ul>`;
                data.patrimonios_liquidos.forEach((item) => {
                    const qual = item.qual ? sanitizeInput(item.qual) : "Não informado";
                    const valor = item.valor !== undefined && item.valor !== null ? `R$ ${parseFloat(item.valor).toFixed(2)}` : "Valor não informado";
                    dataHtml += `<li>${qual}: ${valor}</li>`;
                });
                dataHtml += `</ul>`;
            }

            // Exibição de Dívidas
            if (Array.isArray(data.dividas) && data.dividas.length > 0) {
                dataHtml += `<p style="margin-top: 1rem;"><strong style="color: var(--theme-secondary-lighter);">Dívidas:</strong></p><ul>`;
                data.dividas.forEach((item) => {
                    const credor = item.credor ? sanitizeInput(item.credor) : "Não informado";
                    const saldo = item.saldo !== undefined && item.saldo !== null ? `R$ ${parseFloat(item.saldo).toFixed(2)}` : "Saldo não informado";
                    dataHtml += `<li>${credor}: ${saldo}</li>`;
                });
                dataHtml += `</ul>`;
            }

            // Exibição de Objetivos
            if (Array.isArray(data.objetivos) && data.objetivos.length > 0) {
                dataHtml += `<p style="margin-top: 1rem;"><strong style="color: var(--theme-secondary-lighter);">Objetivos:</strong></p><ul>`;
                data.objetivos.forEach((item) => {
                    const descricao = item.descricao ? sanitizeInput(item.descricao) : "Descrição não informada";
                    const valor = item.valor !== undefined && item.valor !== null ? `R$ ${parseFloat(item.valor).toFixed(2)}` : "Valor não informado";
                    const prazo = item.prazo ? sanitizeInput(item.prazo) : "Prazo não informado";
                    dataHtml += `<li>${descricao}: ${valor} (Prazo: ${prazo})</li>`;
                });
                dataHtml += `</ul>`;
            }

            // Exibição de Informações Adicionais
            if (data.info_adicionais && data.info_adicionais.trim()) {
                const infoAdicionais = sanitizeInput(data.info_adicionais);
                dataHtml += `<p style="margin-top: 1rem;"><strong style="color: var(--theme-secondary-lighter);">Informações Adicionais:</strong></p><p>${infoAdicionais}</p>`;
            }

        } else {
            dataHtml = "<p>Dados do formulário não disponíveis ou formato inválido.</p>";
        }

        const createdAt = formData.created_at ? new Date(formData.created_at).toLocaleDateString("pt-BR") : "N/A";
        const updatedAt = formData.updated_at ? new Date(formData.updated_at).toLocaleDateString("pt-BR") : "N/A";

        formInfoContentEl.innerHTML = `
            <div class="form-data-display">
                <strong>Dados do Formulário Preenchido:</strong>
                <p><strong>Data de Criação:</strong> ${createdAt}</p>
                <p><strong>Última Atualização:</strong> ${updatedAt}</p>
                <hr style="margin: 1rem 0; border: 1px solid var(--theme-border-color);">
                ${dataHtml}
            </div>
        `;
    }

    async function loadClientForm(clientId) {
        console.log(`DEBUG: Entering loadClientForm for client ID: ${clientId}`); 
        try {
            // Buscar o formulário mais recente do cliente
            const { data: forms, error } = await supabase
                .from("formularios_clientes")
                .select("*")
                .eq("cliente_id", clientId)
                .order("created_at", { ascending: false })
                .limit(1);
                
            if (error) throw error;
            
            if (!forms || forms.length === 0) {
                // Cliente não tem formulário
                displayNoFormMessage();
                return;
            }
            
            const latestForm = forms[0];
            
            if (latestForm.status === "preenchido" && latestForm.dados_formulario) {
                // Formulário já preenchido
                displayFormData(latestForm);
            } else {
                // Formulário pendente (link gerado mas não preenchido)
                displayFormLink(latestForm);
            }
            
        } catch (error) {
            console.error("DEBUG: Error loading client form:", error); 
            formInfoContentEl.innerHTML = `<p style="color: red;">Erro ao carregar formulário: ${error.message}</p>`;
        }
    }

    // Função para carregar informações do diagnóstico
    async function loadClientDiagnostico(clientId) {
        console.log(`DEBUG: Entering loadClientDiagnostico for client ID: ${clientId}`);
        try {
            // Buscar o diagnóstico do cliente
            const { data: diagnosticos, error } = await supabase
                .from("diagnosticos_financeiros")
                .select("*")
                .eq("cliente_id", clientId)
                .order("created_at", { ascending: false })
                .limit(1);
                
            if (error) throw error;
            
            if (!diagnosticos || diagnosticos.length === 0) {
                // Cliente não tem diagnóstico
                await displayNoDiagnosticoMessage();
                return;
            }
            
            const latestDiagnostico = diagnosticos[0];
            
            // Sempre mostrar o link do diagnóstico (mesmo que em andamento)
            displayDiagnosticoLink(latestDiagnostico);
            
        } catch (error) {
            console.error("DEBUG: Error loading client diagnostico:", error);
            const diagnosticoContent = document.getElementById('diagnostico-info-content');
            diagnosticoContent.innerHTML = `<p style="color: red;">Erro ao carregar diagnóstico: ${error.message}</p>`;
        }
    }

    // Função para exibir mensagem quando não há diagnóstico
    async function displayNoDiagnosticoMessage() {
        const diagnosticoContent = document.getElementById('diagnostico-info-content');
        
        // CONDIÇÃO 1: Verificar se existe formulário preenchido
        const { data: formulario, error: formError } = await supabase
            .from('formularios_clientes')
            .select('status')
            .eq('cliente_id', currentClientId)
            .eq('status', 'preenchido')
            .single();
        
        if (formError || !formulario) {
            diagnosticoContent.innerHTML = `
                <p style="color: #e74c3c;">⚠️ <strong>Diagnóstico não disponível</strong></p>
                <p>O cliente precisa preencher o formulário antes de criar o diagnóstico financeiro.</p>
                <p><em>Vá para a aba "Formulário" e gere o link para o cliente preencher primeiro.</em></p>
            `;
            return;
        }
        
        diagnosticoContent.innerHTML = `
            <p>Este cliente ainda não possui um diagnóstico financeiro.</p>
            <p><strong>O formulário já foi preenchido. Você pode gerar o diagnóstico:</strong></p>
            <button class="generate-link-btn" onclick="gerarLinkDiagnostico()">
                <i class="fas fa-link"></i> Gerar Link do Diagnóstico
            </button>
        `;
    }

    // Função para exibir link do diagnóstico
    function displayDiagnosticoLink(diagnostico) {
        const diagnosticoContent = document.getElementById('diagnostico-info-content');
        const diagnosticoUrl = `${window.location.origin}/diagnostico-financeiro.html?link=${diagnostico.link_unico}`;
        
        diagnosticoContent.innerHTML = `
            <p>Este cliente possui um diagnóstico financeiro.</p>
            <p><strong>Compartilhe o link abaixo com o cliente:</strong></p>
            <div class="form-link-container">
                <a href="${diagnosticoUrl}" target="_blank">${diagnosticoUrl}</a>
            </div>
            <p><em>(Este link é único e pode ser usado várias vezes)</em></p>
            <div class="form-data-display">
                <strong>Informações do Diagnóstico:</strong>
                <ul>
                    <li><strong>Status:</strong> ${diagnostico.status === 'finalizado' ? 'Finalizado' : 'Em Andamento'}</li>
                    <li><strong>Criado em:</strong> ${new Date(diagnostico.created_at).toLocaleDateString('pt-BR')}</li>
                    <li><strong>Última atualização:</strong> ${new Date(diagnostico.updated_at).toLocaleDateString('pt-BR')}</li>
                </ul>
                <button class="delete-form-btn" onclick="excluirDiagnostico('${diagnostico.id}')">
                    <i class="fas fa-trash"></i> Excluir Diagnóstico
                </button>
            </div>
        `;
    }

    // Função para gerar novo link de diagnóstico
    async function gerarLinkDiagnostico() {
        try {
            // CONDIÇÃO 1: Verificar se existe formulário preenchido
            const { data: formulario, error: formError } = await supabase
                .from('formularios_clientes')
                .select('status')
                .eq('cliente_id', currentClientId)
                .eq('status', 'preenchido')
                .single();
            
            if (formError || !formulario) {
                alert('ERRO: Não é possível criar diagnóstico financeiro.\\n\\nO cliente precisa preencher o formulário primeiro.');
                return;
            }
            
            // Buscar dados do cliente
            const { data: cliente, error: clienteError } = await supabase
                .from('clientes')
                .select('nome')
                .eq('id', currentClientId)
                .single();
            
            if (clienteError) throw clienteError;
            
            // Buscar dados do formulário para outras pessoas com renda
            const { data: formularioData, error: formDataError } = await supabase
                .from('formularios_clientes')
                .select('dados_formulario')
                .eq('cliente_id', currentClientId)
                .eq('status', 'preenchido')
                .order('created_at', { ascending: false })
                .limit(1)
                .single();
            
            let outrasPersonasRenda = '';
            if (!formDataError && formularioData?.dados_formulario?.outras_pessoas) {
                const nomes = formularioData.dados_formulario.outras_pessoas.map(p => p.nome);
                outrasPersonasRenda = nomes.join(', ');
            }
            
            // Gerar link único
            const linkUnico = 'diag_' + Math.random().toString(36).substr(2, 16);
            
            // Criar diagnóstico
            const { error: createError } = await supabase
                .from('diagnosticos_financeiros')
                .insert({
                    cliente_id: currentClientId,
                    link_unico: linkUnico,
                    nome_principal: cliente.nome || '',
                    nomes_outras_pessoas_renda: outrasPersonasRenda,
                    created_by_id: sessionStorage.getItem('user_id')
                });
            
            if (createError) throw createError;
            
            // Recarregar informações do diagnóstico
            loadClientDiagnostico(currentClientId);
            
            // CONDIÇÃO 2: Recarregar formulário para desabilitar botão
            loadClientForm(currentClientId);
            
            alert('Link do diagnóstico gerado com sucesso!');
            
        } catch (error) {
            console.error('Erro ao gerar link do diagnóstico:', error);
            alert('Erro ao gerar link do diagnóstico: ' + error.message);
        }
    }

    // Função para excluir diagnóstico
    async function excluirDiagnostico(diagnosticoId) {
        if (!confirm('Tem certeza que deseja excluir este diagnóstico? Esta ação não pode ser desfeita.')) {
            return;
        }
        
        try {
            const { error } = await supabase
                .from('diagnosticos_financeiros')
                .delete()
                .eq('id', diagnosticoId);
            
            if (error) throw error;
            
            // CONDIÇÃO 3: Não gerar link automático - apenas recarregar
            loadClientDiagnostico(currentClientId);
            
            // CONDIÇÃO 2: Recarregar formulário para reabilitar botão
            loadClientForm(currentClientId);
            
            alert('Diagnóstico excluído com sucesso!');
            
        } catch (error) {
            console.error('Erro ao excluir diagnóstico:', error);
            alert('Erro ao excluir diagnóstico: ' + error.message);
        }
    }

    // Tornar as funções globais para serem acessíveis pelo onclick
    window.gerarLinkDiagnostico = gerarLinkDiagnostico;
    window.excluirDiagnostico = excluirDiagnostico;

    // Função para gerar novo formulário
    async function handleGenerateForm(event) {
        console.log("DEBUG: Entering handleGenerateForm"); 
        const clientId = event.target.getAttribute("data-client-id") || currentClientId;
        
        try {
            const tokenUnico = generateUniqueToken();
            console.log(`DEBUG: Generated token: ${tokenUnico}`); 
            
            const { data, error } = await supabase
                .from("formularios_clientes")
                .insert({
                    cliente_id: clientId,
                    token_unico: tokenUnico,
                    status: "pendente"
                })
                .select();
                
            if (error) throw error;
            
            console.log("DEBUG: Form created successfully:", data); 
            
            // Recarregar a seção do formulário
            loadClientForm(clientId);
            
        } catch (error) {
            console.error("DEBUG: Error generating form:", error); 
            alert("Erro ao gerar formulário: " + error.message);
        }
    }

    // Função para excluir formulário
    async function handleDeleteForm(event) {
        console.log("DEBUG: Entering handleDeleteForm"); 
        const formId = event.target.getAttribute("data-form-id");
        
        if (!formId) {
            console.log("DEBUG: No form ID found"); 
            return;
        }
        
        console.log(`DEBUG: Attempting to delete form with ID: ${formId}`); 
        
        if (!confirm("Tem certeza que deseja excluir este formulário? Esta ação não pode ser desfeita.")) {
            console.log("DEBUG: User cancelled deletion"); 
            return;
        }
        
        try {
            const { error } = await supabase
                .from("formularios_clientes")
                .delete()
                .eq("id", formId);
                
            if (error) throw error;
            
            console.log("DEBUG: Form deleted successfully"); 
            
            // Recarregar a seção do formulário
            loadClientForm(currentClientId);
            
        } catch (error) {
            console.error("DEBUG: Error deleting form:", error); 
            alert("Erro ao excluir formulário: " + error.message);
        }
    }

    // Função para gerar token único
    function generateUniqueToken() {
        return Math.random().toString(36).substr(2, 16) + Date.now().toString(36);
    }

    // Função para salvar dados cadastrais
    async function saveDadosCadastrais(event) {
        event.preventDefault();
        
        // Validações
        if (!cpfInput.value.trim()) {
            document.getElementById("cpf-error").style.display = "block";
            return;
        } else {
            document.getElementById("cpf-error").style.display = "none";
        }
        
        if (!whatsappInput.value.trim()) {
            document.getElementById("whatsapp-error").style.display = "block";
            return;
        } else {
            document.getElementById("whatsapp-error").style.display = "none";
        }
        
        // Validação condicional: se nome do cônjuge preenchido, WhatsApp é obrigatório
        if (conjugeNomeInput.value.trim() && !conjugeWhatsappInput.value.trim()) {
            document.getElementById("conjuge-whatsapp-error").style.display = "block";
            return;
        } else {
            document.getElementById("conjuge-whatsapp-error").style.display = "none";
        }
        
        const saveBtn = document.getElementById("save-dados-btn");
        saveBtn.disabled = true;
        saveBtn.textContent = "Salvando...";
        
        try {
            const { data, error } = await supabase
                .from("clientes")
                .update({
                    nome: nomeCompletoInput.value.trim(),
                    cpf: cpfInput.value.trim(),
                    email: emailInput.value.trim(),
                    whatsapp: whatsappInput.value.trim(),
                    conjuge_nome: conjugeNomeInput.value.trim(),
                    conjuge_whatsapp: conjugeWhatsappInput.value.trim()
                })
                .eq("id", currentClientId);
                
            if (error) throw error;
            
            alert("Dados salvos com sucesso!");
            
        } catch (error) {
            console.error("Erro ao salvar dados:", error);
            alert("Erro ao salvar dados: " + error.message);
        } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = "Salvar Dados";
        }
    }

    // Função para formatar CPF
    function formatCPF(cpf) {
        cpf = cpf.replace(/\D/g, "");
        cpf = cpf.replace(/(\d{3})(\d)/, "$1.$2");
        cpf = cpf.replace(/(\d{3})(\d)/, "$1.$2");
        cpf = cpf.replace(/(\d{3})(\d{1,2})$/, "$1-$2");
        return cpf;
    }

    // Função para formatar WhatsApp
    function formatWhatsApp(phone) {
        phone = phone.replace(/\D/g, "");
        if (phone.length <= 11) {
            phone = phone.replace(/(\d{2})(\d)/, "($1) $2");
            phone = phone.replace(/(\d{4,5})(\d{4})$/, "$1-$2");
        } else {
            phone = phone.replace(/(\d{2})(\d{2})(\d)/, "+$1 ($2) $3");
            phone = phone.replace(/(\d{4,5})(\d{4})$/, "$1-$2");
        }
        return phone;
    }

    // Função para configurar event listeners
    function setupEventListeners() {
        // Botão Formulário
        btnFormulario.addEventListener("click", () => {
            showSection("form");
            loadClientForm(currentClientId); // Carregar dados do formulário
        });
        
        // Botão Diagnóstico Financeiro
        btnDiagnostico.addEventListener("click", () => {
            showSection("diagnostico");
            loadClientDiagnostico(currentClientId); // Carregar dados do diagnóstico
        });
        
        // Botão Plano Financeiro
        btnPlano.addEventListener("click", () => {
            showSection("plano");
        });
        
        // Botão Dados Cadastrais
        btnDadosCadastrais.addEventListener("click", () => {
            showSection("dados-cadastrais");
        });
        
        btnGestao.addEventListener("click", () => {
            alert("Funcionalidade em desenvolvimento");
        });
        
        btnImplementacoes.addEventListener("click", () => {
            alert("Funcionalidade em desenvolvimento");
        });
        
        // Formulário de dados cadastrais
        dadosCadastraisForm.addEventListener("submit", saveDadosCadastrais);
        
        // Adicionar formatação automática para CPF
        cpfInput.addEventListener("input", function(e) {
            const cursorPosition = this.selectionStart;
            const originalLength = this.value.length;
            
            this.value = formatCPF(this.value);
            
            // Ajustar posição do cursor após formatação
            const newLength = this.value.length;
            const cursorAdjustment = newLength - originalLength;
            this.setSelectionRange(cursorPosition + cursorAdjustment, cursorPosition + cursorAdjustment);
        });
        
        // Adicionar formatação automática para WhatsApp
        whatsappInput.addEventListener("input", function() {
            this.value = formatWhatsApp(this.value);
        });
        
        // Adicionar formatação automática para WhatsApp do Cônjuge
        conjugeWhatsappInput.addEventListener("input", function() {
            this.value = formatWhatsApp(this.value);
        });
    }
    
    // Função para mostrar a seção selecionada
    function showSection(section) {
        // Ocultar todas as seções
        formSection.style.display = "none";
        diagnosticoSection.style.display = "none";
        planoSection.style.display = "none";
        dadosCadastraisSection.style.display = "none";
        
        // Remover classe active de todos os botões
        btnFormulario.classList.remove("active");
        btnDiagnostico.classList.remove("active");
        btnPlano.classList.remove("active");
        
        // Mostrar a seção selecionada e ativar o botão correspondente
        switch (section) {
            case "form":
                formSection.style.display = "block";
                btnFormulario.classList.add("active");
                break;
            case "diagnostico":
                diagnosticoSection.style.display = "block";
                btnDiagnostico.classList.add("active");
                loadClientDiagnostico(currentClientId); // Carregar dados do diagnóstico
                break;
            case "plano":
                planoSection.style.display = "block";
                btnPlano.classList.add("active");
                break;
            case "dados-cadastrais":
                dadosCadastraisSection.style.display = "block";
                btnPlano.classList.add("active");
                break;
        }
    }

    // Inicializar a página
    document.addEventListener("DOMContentLoaded", () => {
        loadClientDetails();
        setupEventListeners();
    });
  </script>

</body>
</html>

