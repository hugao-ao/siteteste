<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Detalhes do Cliente</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" /> <!-- Font Awesome -->
  <style>
    /* --- Sidebar Integration Styles --- */
    body {
      display: flex;
      margin: 0;
      min-height: 100vh;
    }
    #main-content-detalhes {
      flex-grow: 1;
      padding: 2rem;
      margin-left: 250px; /* Default margin for expanded sidebar */
      transition: margin-left 0.3s ease;
      background-color: var(--theme-bg-surface);
      color: var(--theme-text-light);
    }
    #main-content-detalhes.sidebar-collapsed {
      margin-left: 60px; /* Margin for collapsed sidebar */
    }
    /* --- End Sidebar Integration Styles --- */

    h1 {
        text-align: center;
        margin-bottom: 2rem;
        color: var(--theme-secondary-lighter); /* Ajustado para tema */
    }

    /* --- Seção de Navegação (Botões) --- */
    #nav-buttons-section {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }
    
    .nav-button {
        background-color: var(--theme-bg-dark);
        color: var(--theme-secondary-lighter);
        border: 1px solid var(--theme-border-color);
        border-radius: 8px;
        padding: 1rem 1.5rem;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 180px;
        text-align: center;
    }
    
    .nav-button:hover {
        background-color: var(--theme-primary);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .nav-button.active {
        background-color: var(--theme-primary);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .nav-button i {
        margin-right: 0.5rem;
    }

    /* --- Seção do Formulário --- */
    #form-section {
        background-color: var(--theme-bg-dark);
        padding: 1.5rem 2rem;
        margin-top: 1rem;
        border-radius: 8px;
        border: 1px solid var(--theme-border-color);
        text-align: left;
        display: none; /* Inicialmente oculto */
    }
    
    #form-section h2 {
        margin-top: 0;
        margin-bottom: 1rem;
        color: var(--theme-secondary);
        border-bottom: 1px solid var(--theme-border-color);
        padding-bottom: 0.5rem;
    }
    
    #form-section p {
        margin-bottom: 1rem;
        line-height: 1.6;
    }
    
    #form-section .form-link-container {
        background-color: var(--theme-bg-surface);
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1rem;
        word-wrap: break-word; /* Quebra links longos */
    }
    
    #form-section .form-link-container a {
        color: var(--theme-secondary-lighter); /* Ajustado para tema */
        text-decoration: none;
        font-weight: bold;
    }
    
    #form-section .form-link-container a:hover {
        text-decoration: underline;
    }
    
    /* Estilos ADICIONADOS para exibição dos dados do formulário */
    .form-data-display {
        margin-top: 1.5rem;
        padding-top: 1rem;
        border-top: 1px dashed var(--theme-border-color);
    }
    .form-data-display h3 {
        color: var(--theme-secondary-lighter);
        margin-bottom: 0.8rem;
    }
    .form-data-display ul {
        list-style: none;
        padding-left: 1rem;
        margin-top: 0.5rem;
        border-left: 2px solid var(--theme-border-color);
    }
    .form-data-display li {
        margin-bottom: 0.5rem;
    }
     .form-data-display p.info-paragraph {
        white-space: pre-wrap; /* Preserva quebras de linha */
        background-color: var(--theme-bg-surface);
        padding: 0.8rem;
        border-radius: 4px;
        border: 1px solid var(--theme-border-color);
        margin-top: 0.5rem; /* Espaçamento para parágrafos de info adicional */
    }
    .form-data-display strong {
        color: var(--theme-secondary-lighter);
    }
    /* FIM dos estilos ADICIONADOS */
    
    #form-section .delete-form-btn {
        background-color: #c62828; /* Vermelho */
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: background-color 0.3s ease;
        margin-top: 0.5rem; /* Adiciona espaço acima do botão */
    }
    
    #form-section .delete-form-btn:hover {
        background-color: #a12020;
    }
    
    #form-section .generate-link-btn {
        background-color: var(--theme-primary); /* Ajustado para tema */
        color: var(--theme-secondary-lighter);
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: background-color 0.3s ease;
    }
    
    #form-section .generate-link-btn:hover {
        background-color: var(--theme-primary-lighter);
    }
    
    #form-loading-state {
        text-align: center;
        padding: 1rem;
        color: var(--theme-text-muted);
    }

    /* --- Seção de Diagnóstico Financeiro --- */
    #diagnostico-section {
        background-color: var(--theme-bg-dark);
        padding: 1.5rem 2rem;
        margin-top: 1rem;
        border-radius: 8px;
        border: 1px solid var(--theme-border-color);
        text-align: center;
        display: none; /* Inicialmente oculto */
    }
    
    #diagnostico-section h2 {
        margin-top: 0;
        margin-bottom: 1rem;
        color: var(--theme-secondary);
        border-bottom: 1px solid var(--theme-border-color);
        padding-bottom: 0.5rem;
    }
    
    #diagnostico-section p {
        margin-bottom: 1rem;
        line-height: 1.6;
        color: var(--theme-text-muted);
    }

    /* --- Seção de Plano Financeiro --- */
    #plano-section {
        background-color: var(--theme-bg-dark);
        padding: 1.5rem 2rem;
        margin-top: 1rem;
        border-radius: 8px;
        border: 1px solid var(--theme-border-color);
        text-align: center;
        display: none; /* Inicialmente oculto */
    }
    
    #plano-section h2 {
        margin-top: 0;
        margin-bottom: 1rem;
        color: var(--theme-secondary);
        border-bottom: 1px solid var(--theme-border-color);
        padding-bottom: 0.5rem;
    }
    
    #plano-buttons {
        display: flex;
        justify-content: center;
        gap: 1.5rem;
        margin-top: 2rem;
        flex-wrap: wrap;
    }
    
    .plano-button {
        background-color: var(--theme-bg-surface);
        color: var(--theme-secondary-lighter);
        border: 1px solid var(--theme-border-color);
        border-radius: 8px;
        padding: 1.5rem 2rem;
        font-size: 1.1rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 200px;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    
    .plano-button:hover {
        background-color: var(--theme-primary);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .plano-button i {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    /* --- Seção de Dados Cadastrais --- */
    #dados-cadastrais-section {
        background-color: var(--theme-bg-dark);
        padding: 1.5rem 2rem;
        margin-top: 1rem;
        border-radius: 8px;
        border: 1px solid var(--theme-border-color);
        text-align: left;
        display: none; /* Inicialmente oculto */
    }
    
    #dados-cadastrais-section h2 {
        margin-top: 0;
        margin-bottom: 1.5rem;
        color: var(--theme-secondary);
        border-bottom: 1px solid var(--theme-border-color);
        padding-bottom: 0.5rem;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: bold;
        color: var(--theme-secondary-lighter);
    }
    
    .form-group input {
        width: 100%;
        padding: 0.8rem;
        border-radius: 4px;
        border: 1px solid var(--theme-border-color);
        background-color: var(--theme-bg-surface);
        color: var(--theme-text-light);
        font-size: 1rem;
    }
    
    .form-group input:focus {
        outline: none;
        border-color: var(--theme-secondary);
        box-shadow: 0 0 0 2px rgba(var(--theme-secondary-rgb), 0.2);
    }
    
    .required-field::after {
        content: " *";
        color: #e53935;
    }
    
    .form-group .error-message {
        color: #e53935;
        font-size: 0.85rem;
        margin-top: 0.3rem;
        display: none;
    }
    
    .conjuge-section {
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px dashed var(--theme-border-color);
    }
    
    .conjuge-section h3 {
        margin-top: 0;
        margin-bottom: 1.5rem;
        color: var(--theme-secondary-lighter);
    }
    
    .form-actions {
        margin-top: 2rem;
        text-align: right;
    }
    
    .save-btn {
        background-color: var(--theme-primary);
        color: var(--theme-secondary-lighter);
        border: none;
        padding: 0.8rem 1.5rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: bold;
        transition: all 0.3s ease;
    }
    
    .save-btn:hover {
        background-color: var(--theme-primary-lighter);
        transform: translateY(-2px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .save-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }
    
    /* Responsividade */
    @media (max-width: 768px) {
        #nav-buttons-section {
            flex-direction: column;
            align-items: center;
        }
        
        .nav-button {
            width: 100%;
            max-width: 300px;
        }
        
        #plano-buttons {
            flex-direction: column;
            align-items: center;
        }
        
        .plano-button {
            width: 100%;
            max-width: 300px;
        }
    }
  </style>
</head>
<body>
  <!-- Sidebar será injetada aqui pelo sidebar.js -->
  <main id="main-content-detalhes">

    <h1>Detalhes do <span id="client-name-display">Cliente</span></h1>
    
    <!-- Seção de navegação com botões (apenas para projeto Planejamento) -->
    <section id="nav-buttons-section" style="display: none;">
      <button id="btn-formulario" class="nav-button active">
        <i class="fas fa-file-alt"></i> Formulário
      </button>
      <button id="btn-diagnostico" class="nav-button">
        <i class="fas fa-chart-line"></i> Diagnóstico Financeiro
      </button>
      <button id="btn-plano" class="nav-button">
        <i class="fas fa-money-bill-wave"></i> Plano Financeiro
      </button>
    </section>

    <!-- Seção para informações do formulário -->
    <section id="form-section">
      <h2>Formulário do Cliente</h2>
      <div id="form-info-content">
        <p id="form-loading-state">Carregando informações do formulário...</p>
        <!-- Conteúdo dinâmico (link, status, botões) será inserido aqui pelo JS -->
        <div id="form-actions-container"></div>
        
        <!-- ### INÍCIO DO BLOCO ADICIONADO ### -->
        <!-- Container para exibir os dados do formulário preenchido -->
        <div id="form-data-summary-container" style="display: none;">
            <!-- Orçamento -->
            <div class="form-data-display" id="form-data-orcamento">
                <h3>Orçamento Informado</h3>
                <div id="orcamento-renda-display"></div>
                <div id="orcamento-fixa-display" style="margin-top: 1rem;"></div>
                <div id="orcamento-variavel-display" style="margin-top: 1rem;"></div>
            </div>
            <!-- Informações Adicionais -->
            <div class="form-data-display" id="form-data-adicionais" style="margin-top: 1.5rem;">
                <h3>Informações Adicionais Relevantes</h3>
                <div id="adicionais-display"></div>
            </div>
        </div>
        <!-- ### FIM DO BLOCO ADICIONADO ### -->
      </div>
    </section>
    
    <!-- Seção para Diagnóstico Financeiro -->
    <section id="diagnostico-section">
      <h2>Diagnóstico Financeiro</h2>
      <p>O diagnóstico financeiro estará disponível em breve.</p>
      <i class="fas fa-chart-line" style="font-size: 4rem; color: var(--theme-text-muted); margin: 2rem 0;"></i>
    </section>
    
    <!-- Seção para Plano Financeiro -->
    <section id="plano-section">
      <h2>Plano Financeiro</h2>
      <div id="plano-buttons">
        <button id="btn-dados-cadastrais" class="plano-button">
          <i class="fas fa-user-edit"></i>
          Dados Cadastrais
        </button>
        <button id="btn-gestao" class="plano-button">
          <i class="fas fa-wallet"></i>
          Gestão Financeira
        </button>
        <button id="btn-implementacoes" class="plano-button">
          <i class="fas fa-tasks"></i>
          Implementações
        </button>
      </div>
    </section>
    
    <!-- Seção para Dados Cadastrais -->
    <section id="dados-cadastrais-section">
      <h2>Dados Cadastrais</h2>
      <form id="dados-cadastrais-form">
        <div class="form-group">
          <label for="nome-completo">Nome Completo</label>
          <input type="text" id="nome-completo" name="nome-completo" placeholder="Digite o nome completo">
        </div>
        
        <div class="form-group">
          <label for="cpf" class="required-field">CPF</label>
          <input type="text" id="cpf" name="cpf" placeholder="000.000.000-00" required maxlength="14">
          <div class="error-message" id="cpf-error">CPF é obrigatório</div>
        </div>
        
        <div class="form-group">
          <label for="email">E-mail</label>
          <input type="email" id="email" name="email" placeholder="exemplo@email.com">
        </div>
        
        <div class="form-group">
          <label for="whatsapp" class="required-field">WhatsApp</label>
          <input type="text" id="whatsapp" name="whatsapp" placeholder="+55DDNNNNNNNNN" required>
          <div class="error-message" id="whatsapp-error">WhatsApp é obrigatório</div>
        </div>
        
        <div class="conjuge-section">
          <h3>Informações do Cônjuge</h3>
          
          <div class="form-group">
            <label for="conjuge-nome">Nome do Cônjuge</label>
            <input type="text" id="conjuge-nome" name="conjuge-nome" placeholder="Digite o nome do cônjuge">
          </div>
          
          <div class="form-group">
            <label for="conjuge-whatsapp" class="required-field">WhatsApp do Cônjuge</label>
            <input type="text" id="conjuge-whatsapp" name="conjuge-whatsapp" placeholder="+55DDNNNNNNNNN">
            <div class="error-message" id="conjuge-whatsapp-error">WhatsApp do cônjuge é obrigatório quando o nome é preenchido</div>
          </div>
        </div>
        
        <div class="form-actions">
          <button type="submit" class="save-btn" id="save-dados-btn">Salvar Dados</button>
        </div>
      </form>
    </section>

  </main>

  <script type="module">
    import { injectSidebar } from "./sidebar.js";
    import { supabase } from "./supabase.js"; // Importa supabase

    injectSidebar("main-content-detalhes"); // Passa o ID do container principal

    // --- Elementos DOM --- 
    const clientNameDisplay = document.getElementById("client-name-display");
    const formInfoContentEl = document.getElementById("form-info-content");
    const formLoadingStateEl = document.getElementById("form-loading-state"); // Mantido para estado de carregamento inicial
    const formActionsContainerEl = document.getElementById("form-actions-container"); // Container para status/link/botões
    
    // ### INÍCIO DAS CONSTANTES ADICIONADAS ###
    const formDataSummaryContainerEl = document.getElementById("form-data-summary-container"); // Container GERAL para os dados
    const orcamentoRendaDisplayEl = document.getElementById("orcamento-renda-display");
    const orcamentoFixaDisplayEl = document.getElementById("orcamento-fixa-display");
    const orcamentoVariavelDisplayEl = document.getElementById("orcamento-variavel-display");
    const adicionaisDisplayEl = document.getElementById("adicionais-display");
    // ### FIM DAS CONSTANTES ADICIONADAS ###

    const navButtonsSection = document.getElementById("nav-buttons-section");
    const formSection = document.getElementById("form-section");
    const diagnosticoSection = document.getElementById("diagnostico-section");
    const planoSection = document.getElementById("plano-section");
    const dadosCadastraisSection = document.getElementById("dados-cadastrais-section");
    
    // Botões de navegação
    const btnFormulario = document.getElementById("btn-formulario");
    const btnDiagnostico = document.getElementById("btn-diagnostico");
    const btnPlano = document.getElementById("btn-plano");
    
    // Botões do plano financeiro
    const btnDadosCadastrais = document.getElementById("btn-dados-cadastrais");
    const btnGestao = document.getElementById("btn-gestao");
    const btnImplementacoes = document.getElementById("btn-implementacoes");
    
    // Formulário de dados cadastrais
    const dadosCadastraisForm = document.getElementById("dados-cadastrais-form");
    const nomeCompletoInput = document.getElementById("nome-completo");
    const cpfInput = document.getElementById("cpf");
    const emailInput = document.getElementById("email");
    const whatsappInput = document.getElementById("whatsapp");
    const conjugeNomeInput = document.getElementById("conjuge-nome");
    const conjugeWhatsappInput = document.getElementById("conjuge-whatsapp");
    const saveDadosBtn = document.getElementById("save-dados-btn"); // Adicionado seletor para botão salvar
    
    let currentClientId = null;
    let currentClientData = null;
    let currentClientProjeto = null;
    let currentFormSubmission = null; // Armazena a última submissão do formulário
    let dadosCadastraisId = null; // Para armazenar o ID do registro de dados cadastrais

    // --- Funções Utilitárias (Verificadas/Mantidas) ---
    const sanitizeInput = (str) => {
      if (str === null || str === undefined) return "";
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/\'/g, "&#x27;") 
        .replace(/`/g, "&#x60;");
    };

    // Função de formatação de moeda (Verificada/Mantida)
    const formatCurrency = (value) => {
        if (value === null || value === undefined || value === "") return "Não informado";
        // Tenta converter para número, tratando possíveis formatos de entrada
        const cleanValue = String(value).replace(/R\$\s?/g, ".").replace(/\./g, "").replace(/,/g, ".");
        const number = parseFloat(cleanValue);
        if (isNaN(number)) {
            console.warn("formatCurrency: Valor inválido recebido:", value);
            return "Valor inválido";
        }
        return number.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    };
    
    // Função para formatar CPF (Mantida)
    function formatCPF(cpf) {
        cpf = String(cpf).replace(/\D/g, ");
        cpf = cpf.substring(0, 11);
        if (cpf.length > 9) {
            return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
        } else if (cpf.length > 6) {
            return cpf.replace(/(\d{3})(\d{3})(\d{3})/, "$1.$2.$3");
        } else if (cpf.length > 3) {
            return cpf.replace(/(\d{3})(\d{3})/, "$1.$2");
        } else {
            return cpf;
        }
    }
    
    // Função para formatar WhatsApp (Mantida)
    function formatWhatsApp(whatsapp) {
        let formatted = String(whatsapp).replace(/[^\d+]/g, ");
        if (!formatted.startsWith("+")) {
            formatted = "+" + formatted;
        }
        return formatted;
    }
    
    // Função para gerar UUID v4 válido (Mantida)
    function generateUUID() {
        return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0,
                v = c == "x" ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    // --- Funções Principais --- 

    // Função para carregar dados do cliente e formulário (Mantida)
    async function loadClientDetails() {
      const urlParams = new URLSearchParams(window.location.search);
      currentClientId = urlParams.get("id");

      if (!currentClientId) {
        alert("ID do cliente não fornecido.");
        window.location.href = "clientes-dashboard.html"; 
        return;
      }

      try {
        const { data: clientData, error: clientError } = await supabase
          .from("clientes")
          .select("*, dados_cadastrais(*)") 
          .eq("id", currentClientId)
          .single();

        if (clientError) throw clientError;
        if (!clientData) throw new Error("Cliente não encontrado.");
        
        currentClientData = clientData;
        currentClientProjeto = clientData.projeto;
        dadosCadastraisId = clientData.dados_cadastrais && clientData.dados_cadastrais.length > 0 ? clientData.dados_cadastrais[0].id : null;
        
        if (clientNameDisplay) {
            clientNameDisplay.textContent = sanitizeInput(clientData.nome || "Cliente");
        }
        document.title = `Detalhes - ${sanitizeInput(clientData.nome || "Cliente")}`;

        if (currentClientProjeto === "Planejamento") {
          if (navButtonsSection) navButtonsSection.style.display = "flex";
          showSection("form"); 
          await loadFormInfo(); 
        } else {
          if (navButtonsSection) navButtonsSection.style.display = "none";
          showSection("dados-cadastrais"); 
        }

        populateDadosCadastraisForm(clientData.dados_cadastrais ? clientData.dados_cadastrais[0] : null, clientData);

      } catch (error) {
        console.error("Erro ao carregar detalhes do cliente:", error);
        alert(`Erro ao carregar dados: ${error.message}`);
        if (clientNameDisplay) clientNameDisplay.textContent = "Erro";
      }
    }

    // Função para carregar informações do formulário (MODIFICADA PARA EXIBIR RESUMO)
    async function loadFormInfo() {
      if (!currentClientId) return;
      if (formLoadingStateEl) formLoadingStateEl.style.display = "block";
      if (formActionsContainerEl) formActionsContainerEl.innerHTML = ""; // Limpa ações anteriores
      
      // ### INÍCIO DA MODIFICAÇÃO: Limpar e esconder displays de resumo ###
      if (formDataSummaryContainerEl) formDataSummaryContainerEl.style.display = "none"; 
      if (orcamentoRendaDisplayEl) orcamentoRendaDisplayEl.innerHTML = "";
      if (orcamentoFixaDisplayEl) orcamentoFixaDisplayEl.innerHTML = "";
      if (orcamentoVariavelDisplayEl) orcamentoVariavelDisplayEl.innerHTML = "";
      if (adicionaisDisplayEl) adicionaisDisplayEl.innerHTML = "";
      // ### FIM DA MODIFICAÇÃO ###

      try {
        const { data: formSubmissions, error: formError } = await supabase
          .from("formularios_clientes")
          .select("id, token_unico, status, data_preenchimento, dados_formulario") // Inclui dados_formulario
          .eq("cliente_id", currentClientId)
          .order("created_at", { ascending: false })
          .limit(1);

        if (formError) throw formError;

        currentFormSubmission = formSubmissions && formSubmissions.length > 0 ? formSubmissions[0] : null;

        if (currentFormSubmission) {
          const { id: formId, token_unico, status, data_preenchimento, dados_formulario } = currentFormSubmission;
          
          if (status === "pendente") {
              // Mostra link para preencher
              const link = `${window.location.origin}/formulario-cliente.html?token=${token_unico}`;
              if (formActionsContainerEl) {
                  formActionsContainerEl.innerHTML = `
                      <p>Este cliente ainda não preencheu o formulário.</p>
                      <p>Compartilhe o link abaixo com o cliente:</p>
                      <div class="form-link-container">
                          <a href="${link}" target="_blank">${link}</a>
                      </div>
                      <p><small>(Este link é único e só pode ser usado uma vez)</small></p>
                      <button class="delete-form-btn" data-form-id="${formId}">Excluir Link e Gerar Novo</button>
                  `;
              }
          } else if (status === "preenchido") {
              // Mostra status e botão de excluir
              const formattedDate = data_preenchimento ? new Date(data_preenchimento).toLocaleString("pt-BR") : "N/A";
              if (formActionsContainerEl) {
                  formActionsContainerEl.innerHTML = `
                      <p><strong>Status do Último Formulário:</strong> ${sanitizeInput(status)} (Preenchido em: ${formattedDate})</p>
                      <button class="delete-form-btn" data-form-id="${formId}">Excluir este Formulário</button>
                  `;
              }

              // ### INÍCIO DA MODIFICAÇÃO: Exibir dados do formulário (Orçamento e Adicionais) ###
              if (dados_formulario) {
                  try {
                      const formData = typeof dados_formulario === "string" ? JSON.parse(dados_formulario) : dados_formulario;
                      
                      // --- Exibir Orçamento ---
                      let orcamentoRendaHtml = "<h4>Rendas:</h4>";
                      if (formData.orcamentoRenda && Array.isArray(formData.orcamentoRenda) && formData.orcamentoRenda.length > 0) {
                          orcamentoRendaHtml += "<ul>";
                          formData.orcamentoRenda.forEach(item => {
                              orcamentoRendaHtml += `<li>${sanitizeInput(item.descricao || "Descrição não informada")}: ${formatCurrency(item.valor)}</li>`;
                          });
                          orcamentoRendaHtml += "</ul>";
                      } else {
                          orcamentoRendaHtml += "<p>Nenhuma renda informada.</p>";
                      }
                      if (orcamentoRendaDisplayEl) orcamentoRendaDisplayEl.innerHTML = orcamentoRendaHtml;

                      let orcamentoFixaHtml = "<h4>Despesas Fixas:</h4>";
                      if (formData.orcamentoDespesasFixas && Array.isArray(formData.orcamentoDespesasFixas) && formData.orcamentoDespesasFixas.length > 0) {
                          orcamentoFixaHtml += "<ul>";
                          formData.orcamentoDespesasFixas.forEach(item => {
                              orcamentoFixaHtml += `<li>${sanitizeInput(item.descricao || "Descrição não informada")}: ${formatCurrency(item.valor)}</li>`;
                          });
                          orcamentoFixaHtml += "</ul>";
                      } else {
                           orcamentoFixaHtml += "<p>Nenhuma despesa fixa informada.</p>";
                      }
                      if (orcamentoFixaDisplayEl) orcamentoFixaDisplayEl.innerHTML = orcamentoFixaHtml;

                      let orcamentoVariavelHtml = "<h4>Despesas Variáveis (Média):</h4>";
                      if (formData.orcamentoDespesasVariaveis && Array.isArray(formData.orcamentoDespesasVariaveis) && formData.orcamentoDespesasVariaveis.length > 0) {
                          orcamentoVariavelHtml += "<ul>";
                          formData.orcamentoDespesasVariaveis.forEach(item => {
                              orcamentoVariavelHtml += `<li>${sanitizeInput(item.descricao || "Descrição não informada")}: ${formatCurrency(item.valor)}</li>`;
                          });
                          orcamentoVariavelHtml += "</ul>";
                      } else {
                          orcamentoVariavelHtml += "<p>Nenhuma despesa variável informada.</p>";
                      }
                      if (orcamentoVariavelDisplayEl) orcamentoVariavelDisplayEl.innerHTML = orcamentoVariavelHtml;

                      // --- Exibir Informações Adicionais ---
                      if (formData.informacoesAdicionais && String(formData.informacoesAdicionais).trim() !== "") {
                          if (adicionaisDisplayEl) adicionaisDisplayEl.innerHTML = `<p class="info-paragraph">${sanitizeInput(formData.informacoesAdicionais)}</p>`;
                      } else {
                          if (adicionaisDisplayEl) adicionaisDisplayEl.innerHTML = "<p>Nenhuma informação adicional fornecida.</p>";
                      }
                      
                      // Mostrar o container geral dos dados do formulário APENAS se houver dados
                      if (formDataSummaryContainerEl) formDataSummaryContainerEl.style.display = "block";

                  } catch (parseError) {
                      console.error("Erro ao processar dados_formulario JSON:", parseError);
                       if (formDataSummaryContainerEl) formDataSummaryContainerEl.style.display = "none"; // Esconde se deu erro
                       if (formActionsContainerEl) formActionsContainerEl.innerHTML += `<p style="color: red;">Erro ao carregar detalhes do formulário.</p>`;
                  }
              } else {
                 // Se dados_formulario for null ou vazio, esconde o container
                 if (formDataSummaryContainerEl) formDataSummaryContainerEl.style.display = "none"; 
              }
              // ### FIM DA MODIFICAÇÃO ###
          } else {
              // Outros status (se houver)
              if (formActionsContainerEl) {
                  formActionsContainerEl.innerHTML = `<p>Status do formulário: ${sanitizeInput(status)}</p>`;
              }
          }
          
          // Adiciona listener ao botão de excluir DEPOIS de inseri-lo no DOM
          const deleteBtn = formActionsContainerEl.querySelector(".delete-form-btn");
          if (deleteBtn) {
              deleteBtn.addEventListener("click", handleDeleteForm);
          }

        } else {
          // Nenhum formulário encontrado, oferecer gerar link
          if (formActionsContainerEl) {
              formActionsContainerEl.innerHTML = `
                <p>Nenhum formulário encontrado para este cliente.</p>
                <button class="generate-link-btn">Gerar Link do Formulário</button>
              `;
              const generateBtn = formActionsContainerEl.querySelector(".generate-link-btn");
              if (generateBtn) {
                  generateBtn.addEventListener("click", handleGenerateFormLink);
              }
          }
           if (formDataSummaryContainerEl) formDataSummaryContainerEl.style.display = "none"; // Esconde container de dados
        }

      } catch (error) {
        console.error("Erro ao carregar informações do formulário:", error);
        if (formActionsContainerEl) formActionsContainerEl.innerHTML = `<p style="color: red;">Erro ao carregar status do formulário: ${error.message}</p>`;
        if (formDataSummaryContainerEl) formDataSummaryContainerEl.style.display = "none"; // Esconde container de dados
      } finally {
         if (formLoadingStateEl) formLoadingStateEl.style.display = "none";
      }
    }

    // Handler para o botão Gerar Link (Mantido)
    async function handleGenerateFormLink() {
        if (!currentClientId) return;
        const button = formActionsContainerEl.querySelector(".generate-link-btn");
        if (button) button.disabled = true;
        if (button) button.textContent = "Gerando...";

        try {
            const uniqueToken = generateUUID();
            const { data, error } = await supabase
                .from("formularios_clientes")
                .insert({
                    cliente_id: currentClientId,
                    token_unico: uniqueToken,
                    status: "pendente"
                })
                .select("id")
                .single();

            if (error) throw error;
            
            // Recarrega as informações para mostrar o link gerado
            await loadFormInfo(); 

        } catch (error) {
            console.error("Erro ao gerar link do formulário:", error);
            alert(`Erro ao gerar link: ${error.message}`);
            // Restaura o botão em caso de erro
            if (formActionsContainerEl) {
                 formActionsContainerEl.innerHTML = `
                    <p>Erro ao gerar link.</p>
                    <button class="generate-link-btn">Gerar Link do Formulário</button>
                 `;
                 const generateBtn = formActionsContainerEl.querySelector(".generate-link-btn");
                 if (generateBtn) {
                     generateBtn.addEventListener("click", handleGenerateFormLink);
                 }
            }
        }
    }

    // Handler para o botão Excluir (Mantido)
    async function handleDeleteForm(event) {
        const formId = event.target.dataset.formId;
        if (!formId) return;

        const confirmed = confirm("Tem certeza que deseja excluir este formulário/link? Esta ação não pode ser desfeita.");
        if (!confirmed) return;

        try {
            const { error } = await supabase
                .from("formularios_clientes")
                .delete()
                .eq("id", formId);

            if (error) throw error;

            alert("Formulário/Link excluído com sucesso!");
            await loadFormInfo(); // Recarrega a seção

        } catch (error) {
            console.error("Erro ao excluir formulário:", error);
            alert(`Erro ao excluir: ${error.message}`);
        }
    }

    // Função para preencher o formulário de dados cadastrais (Mantida)
    function populateDadosCadastraisForm(dadosCadastrais, clientData) {
        if (dadosCadastraisForm) {
            if (dadosCadastrais) {
                if (nomeCompletoInput) nomeCompletoInput.value = dadosCadastrais.nome_completo || "";
                if (cpfInput) cpfInput.value = dadosCadastrais.cpf ? formatCPF(dadosCadastrais.cpf) : "";
                if (emailInput) emailInput.value = dadosCadastrais.email || "";
                if (whatsappInput) whatsappInput.value = dadosCadastrais.whatsapp ? formatWhatsApp(dadosCadastrais.whatsapp) : "";
                if (dadosCadastrais.conjuge) {
                    if (conjugeNomeInput) conjugeNomeInput.value = dadosCadastrais.conjuge.nome || "";
                    if (conjugeWhatsappInput) conjugeWhatsappInput.value = dadosCadastrais.conjuge.whatsapp ? formatWhatsApp(dadosCadastrais.conjuge.whatsapp) : "";
                } else {
                    if (conjugeNomeInput) conjugeNomeInput.value = "";
                    if (conjugeWhatsappInput) conjugeWhatsappInput.value = "";
                }
            } else {
                 if (nomeCompletoInput && clientData) nomeCompletoInput.value = clientData.nome || "";
                 if (whatsappInput && clientData) whatsappInput.value = clientData.whatsapp ? formatWhatsApp(clientData.whatsapp) : "";
                 if (cpfInput) cpfInput.value = "";
                 if (emailInput) emailInput.value = "";
                 if (conjugeNomeInput) conjugeNomeInput.value = "";
                 if (conjugeWhatsappInput) conjugeWhatsappInput.value = "";
            }
        }
    }

    // Função para salvar dados cadastrais (Mantida)
    async function saveDadosCadastrais(event) {
        event.preventDefault();
        if (!currentClientId || !currentClientData) return;
        if (saveDadosBtn) saveDadosBtn.disabled = true;
        if (saveDadosBtn) saveDadosBtn.textContent = "Salvando...";

        const cpf = cpfInput?.value.replace(/\D/g, ""); // Salva só números
        const whatsapp = whatsappInput?.value.replace(/[^\d+]/g, ""); // Salva só números e +
        const conjugeNome = conjugeNomeInput?.value.trim();
        const conjugeWhatsapp = conjugeWhatsappInput?.value.replace(/[^\d+]/g, ""); // Salva só números e +

        let isValid = true;
        document.querySelectorAll(".error-message").forEach(el => el.style.display = "none");

        if (!cpf || cpf.length !== 11) { // Validação simples de CPF
            document.getElementById("cpf-error").textContent = "CPF inválido";
            document.getElementById("cpf-error").style.display = "block";
            isValid = false;
        } else {
             document.getElementById("cpf-error").textContent = "CPF é obrigatório"; // Reset message
        }
        if (!whatsapp || whatsapp.length < 10) { // Validação simples de WhatsApp
             document.getElementById("whatsapp-error").textContent = "WhatsApp inválido";
            document.getElementById("whatsapp-error").style.display = "block";
            isValid = false;
        } else {
             document.getElementById("whatsapp-error").textContent = "WhatsApp é obrigatório"; // Reset message
        }
        if (conjugeNome && (!conjugeWhatsapp || conjugeWhatsapp.length < 10)) {
            document.getElementById("conjuge-whatsapp-error").textContent = "WhatsApp do cônjuge inválido";
            document.getElementById("conjuge-whatsapp-error").style.display = "block";
            isValid = false;
        } else {
             document.getElementById("conjuge-whatsapp-error").textContent = "WhatsApp do cônjuge é obrigatório quando o nome é preenchido"; // Reset message
        }

        if (!isValid) {
            if (saveDadosBtn) saveDadosBtn.disabled = false;
            if (saveDadosBtn) saveDadosBtn.textContent = "Salvar Dados";
            alert("Por favor, corrija os erros no formulário.");
            return;
        }

        const dadosToSave = {
            cliente_id: currentClientId,
            nome_completo: nomeCompletoInput?.value.trim(),
            cpf: cpf,
            email: emailInput?.value.trim(),
            whatsapp: whatsapp,
            conjuge: conjugeNome ? { nome: conjugeNome, whatsapp: conjugeWhatsapp } : null
        };

        try {
            let error;
            if (dadosCadastraisId) {
                ({ error } = await supabase
                    .from("dados_cadastrais")
                    .update(dadosToSave)
                    .eq("id", dadosCadastraisId));
            } else {
                ({ error } = await supabase
                    .from("dados_cadastrais")
                    .insert(dadosToSave));
            }

            if (error) throw error;

            const { error: clientUpdateError } = await supabase
                .from("clientes")
                .update({ nome: dadosToSave.nome_completo, whatsapp: dadosToSave.whatsapp })
                .eq("id", currentClientId);
            
            if (clientUpdateError) {
                console.warn("Erro ao atualizar nome/whatsapp na tabela clientes:", clientUpdateError.message);
            }

            alert("Dados cadastrais salvos com sucesso!");
            await loadClientDetails(); 

        } catch (error) {
            console.error("Erro ao salvar dados cadastrais:", error);
            alert(`Erro ao salvar: ${error.message}`);
        } finally {
            if (saveDadosBtn) saveDadosBtn.disabled = false;
            if (saveDadosBtn) saveDadosBtn.textContent = "Salvar Dados";
        }
    }

    // Função para mostrar a seção correta (Mantida)
    function showSection(sectionName) {
      if (formSection) formSection.style.display = "none";
      if (diagnosticoSection) diagnosticoSection.style.display = "none";
      if (planoSection) planoSection.style.display = "none";
      if (dadosCadastraisSection) dadosCadastraisSection.style.display = "none";
      
      document.querySelectorAll(".nav-button").forEach(btn => btn.classList.remove("active"));

      switch (sectionName) {
        case "form":
          if (formSection) formSection.style.display = "block";
          if (btnFormulario) btnFormulario.classList.add("active");
          break;
        case "diagnostico":
          if (diagnosticoSection) diagnosticoSection.style.display = "block";
          if (btnDiagnostico) btnDiagnostico.classList.add("active");
          break;
        case "plano":
          if (planoSection) planoSection.style.display = "block";
          if (btnPlano) btnPlano.classList.add("active");
          break;
        case "dados-cadastrais": 
          if (dadosCadastraisSection) dadosCadastraisSection.style.display = "block";
          if (btnPlano) btnPlano.classList.add("active"); 
          break;
      }
    }

    // --- Event Listeners --- 

    // Listeners para botões de navegação (Mantidos)
    if (btnFormulario) btnFormulario.addEventListener("click", () => showSection("form"));
    if (btnDiagnostico) btnDiagnostico.addEventListener("click", () => showSection("diagnostico"));
    if (btnPlano) btnPlano.addEventListener("click", () => showSection("plano"));

    // Listeners para botões do plano financeiro (Mantidos)
    if (btnDadosCadastrais) btnDadosCadastrais.addEventListener("click", () => showSection("dados-cadastrais"));
    if (btnGestao) btnGestao.addEventListener("click", () => alert("Seção Gestão Financeira em desenvolvimento."));
    if (btnImplementacoes) btnImplementacoes.addEventListener("click", () => alert("Seção Implementações em desenvolvimento."));

    // Listener para o formulário de dados cadastrais (Mantido)
    if (dadosCadastraisForm) {
        // Adiciona listeners para formatação enquanto digita
        if (cpfInput) cpfInput.addEventListener("input", (e) => { e.target.value = formatCPF(e.target.value); });
        if (whatsappInput) whatsappInput.addEventListener("input", (e) => { e.target.value = formatWhatsApp(e.target.value); });
        if (conjugeWhatsappInput) conjugeWhatsappInput.addEventListener("input", (e) => { e.target.value = formatWhatsApp(e.target.value); });
        
        dadosCadastraisForm.addEventListener("submit", saveDadosCadastrais);
    }

    // --- Inicialização --- 
    document.addEventListener("DOMContentLoaded", loadClientDetails);

  </script>
</body>
</html>

