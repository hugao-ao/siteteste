<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Detalhes do Cliente</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" /> <!-- Font Awesome -->
  <style>
    /* --- Sidebar Integration Styles --- */
    body {
      display: flex;
      margin: 0;
      min-height: 100vh;
    }
    #main-content-detalhes {
      flex-grow: 1;
      padding: 2rem;
      margin-left: 250px; /* Default margin for expanded sidebar */
      transition: margin-left 0.3s ease;
      background-color: var(--bg-surface);
      color: var(--text-light);
      /* text-align: center; /* REMOVIDO - Deixar alinhamento padrão */
    }
    #main-content-detalhes.sidebar-collapsed {
      margin-left: 60px; /* Margin for collapsed sidebar */
    }
    /* --- End Sidebar Integration Styles --- */

    h1 {
        text-align: center;
        margin-bottom: 2rem;
        color: var(--gold-lighter);
    }

    /* --- Seção do Formulário --- */
    #form-section {
        background-color: var(--bg-dark);
        padding: 1.5rem 2rem;
        margin-top: 2rem;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        text-align: left;
    }
    #form-section h2 {
        margin-top: 0;
        margin-bottom: 1rem;
        color: var(--gold);
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 0.5rem;
    }
    #form-section p {
        margin-bottom: 1rem;
        line-height: 1.6;
    }
    #form-section .form-link-container {
        background-color: var(--bg-surface);
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1rem;
        word-wrap: break-word; /* Quebra links longos */
    }
    #form-section .form-link-container a {
        color: var(--emerald-glow);
        text-decoration: none;
        font-weight: bold;
    }
    #form-section .form-link-container a:hover {
        text-decoration: underline;
    }
    #form-section .form-data-display {
        margin-bottom: 1rem;
    }
    #form-section .form-data-display strong {
        color: var(--gold-lighter);
    }
    #form-section .delete-form-btn {
        background-color: #c62828; /* Vermelho */
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: background-color 0.3s ease;
        margin-top: 0.5rem; /* Adiciona espaço acima do botão */
    }
    #form-section .delete-form-btn:hover {
        background-color: #a12020;
    }
    #form-section .generate-link-btn {
        background-color: var(--emerald-dark);
        color: var(--gold-lighter);
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: background-color 0.3s ease;
    }
    #form-section .generate-link-btn:hover {
        background-color: var(--emerald-glow);
    }
    #form-loading-state {
        text-align: center;
        padding: 1rem;
        color: var(--text-muted);
    }

  </style>
</head>
<body>
  <!-- Sidebar será injetada aqui pelo sidebar.js -->
  <main id="main-content-detalhes">

    <h1>Detalhes do <span id="client-name-display">Cliente</span></h1>

    <!-- Seção para informações do formulário -->
    <section id="form-section">
      <h2>Formulário do Cliente (Planejamento)</h2>
      <div id="form-info-content">
        <p id="form-loading-state">Carregando informações do formulário...</p>
        <!-- Conteúdo dinâmico (link, dados preenchidos ou mensagem) será inserido aqui -->
      </div>
    </section>

    <!-- Outros detalhes do cliente podem ir aqui no futuro -->

  </main>

  <script type="module">
    import { injectSidebar } from './sidebar.js';
    import { supabase } from './supabase.js'; // Importa supabase

    injectSidebar("main-content-detalhes"); // Passa o ID do container principal

    const clientNameDisplay = document.getElementById("client-name-display");
    const formInfoContentEl = document.getElementById("form-info-content");
    const formLoadingStateEl = document.getElementById("form-loading-state");

    // Recupera ID e nome do cliente do sessionStorage
    const clientId = sessionStorage.getItem("viewing_client_id");
    const clientName = sessionStorage.getItem("viewing_client_name");

    // Função para gerar UUID (necessária se não usar extensão pgcrypto no Supabase)
    // function generateUUID() { 
    //     return crypto.randomUUID();
    // }

    // Função para sanitizar input (copiada de outros scripts)
    const sanitizeInput = (str) => {
      if (str === null || str === undefined) return "";
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/\'/g, "&#x27;") // Corrigido para \'
        .replace(/`/g, "&#x60;");
    };

    // Função para exibir o link do formulário PENDENTE
    function displayFormLink(latestForm) {
        console.log("DEBUG: Entering displayFormLink for pending form:", latestForm); // DEBUG LOG
        const token = latestForm.token_unico;
        const formId = latestForm.id;
        const link = `${window.location.origin}/formulario-cliente.html?token=${token}`;
        console.log("DEBUG: Setting innerHTML for pending form link..."); // DEBUG LOG
        formInfoContentEl.innerHTML = `
            <p>Este cliente ainda não preencheu o formulário.</p>
            <p>Compartilhe o link abaixo com o cliente:</p>
            <div class="form-link-container">
                <a href="${link}" target="_blank">${link}</a>
            </div>
            <p><small>(Este link é único e só pode ser usado uma vez)</small></p>
            <button class="delete-form-btn" data-form-id="${formId}">Excluir Link e Gerar Novo</button>
        `;
        console.log("DEBUG: innerHTML set. Querying for delete button..."); // DEBUG LOG
        // Adiciona listener para o botão de exclusão
        const deleteBtn = formInfoContentEl.querySelector('.delete-form-btn');
        if (deleteBtn) {
            console.log("DEBUG: Delete button found:", deleteBtn); // DEBUG LOG
            console.log("DEBUG: Adding event listener to delete button..."); // DEBUG LOG
            deleteBtn.addEventListener('click', handleDeleteForm);
            console.log("DEBUG: Event listener added."); // DEBUG LOG
        } else {
            console.log("DEBUG: Delete button not found in DOM after setting innerHTML."); // DEBUG LOG
        }
    }

    // Função para exibir os dados PREENCHIDOS (MODIFICADA PARA USAR JSONB)
    function displayFormData(formData) {
        console.log("DEBUG: Entering displayFormData for completed form:", formData); // DEBUG LOG
        let dataHtml = '';
        // Verifica se dados_formulario existe e é um objeto
        if (formData.dados_formulario && typeof formData.dados_formulario === 'object') {
            const data = formData.dados_formulario;
            // Acessa os campos dentro do JSON
            const nome = data.nome ? sanitizeInput(data.nome) : 'N/A';
            const cidade = data.cidade_natal ? sanitizeInput(data.cidade_natal) : 'N/A';
            
            dataHtml = `
                <p><strong>Nome Completo:</strong> ${nome}</p>
                <p><strong>Cidade Natal:</strong> ${cidade}</p>
                <!-- Adicione outros campos do JSON aqui conforme necessário -->
            `;
        } else {
            dataHtml = '<p>Não foi possível carregar os dados do formulário.</p>';
            console.log("DEBUG: dados_formulario is null or not an object:", formData.dados_formulario); // DEBUG LOG
        }

        formInfoContentEl.innerHTML = `
            <p>Formulário preenchido em: ${new Date(formData.data_preenchimento).toLocaleString("pt-BR")}</p>
            <div class="form-data-display">
                ${dataHtml}
            </div>
            <button class="delete-form-btn" data-form-id="${formData.id}">Excluir Dados e Gerar Novo Link</button>
        `;
        // Adiciona listener para o botão de exclusão
        const deleteBtn = formInfoContentEl.querySelector('.delete-form-btn');
        if (deleteBtn) {
            console.log("DEBUG: Delete button found (completed form):", deleteBtn); // DEBUG LOG
            deleteBtn.addEventListener('click', handleDeleteForm);
            console.log("DEBUG: Event listener added (completed form)."); // DEBUG LOG
        } else {
             console.log("DEBUG: Delete button not found (completed form)."); // DEBUG LOG
        }
    }

    // Função para exibir mensagem de formulário não aplicável
    function displayFormNotApplicable() {
        console.log("DEBUG: Entering displayFormNotApplicable"); // DEBUG LOG
        formInfoContentEl.innerHTML = `<p>O formulário é aplicável apenas para clientes do projeto "Planejamento".</p>`;
    }

    // Função para exibir botão de gerar link (quando não há formulário)
    function displayGenerateLinkForm() {
        console.log("DEBUG: Entering displayGenerateLinkForm"); // DEBUG LOG
         formInfoContentEl.innerHTML = `
            <p>Nenhum formulário encontrado para este cliente.</p>
            <button class="generate-link-btn">Gerar Link do Formulário</button>
        `;
        // Adiciona listener para o botão de gerar link
        const generateBtn = formInfoContentEl.querySelector('.generate-link-btn');
        if (generateBtn) {
            console.log("DEBUG: Generate button found:", generateBtn); // DEBUG LOG
            generateBtn.addEventListener('click', handleGenerateLink);
            console.log("DEBUG: Event listener added (generate button)."); // DEBUG LOG
        } else {
            console.log("DEBUG: Generate button not found."); // DEBUG LOG
        }
    }

    // Função principal para carregar e gerenciar o formulário
    async function loadAndManageForm() {
        console.log("DEBUG: Entering loadAndManageForm. Client ID:", clientId, "Client Name:", clientName); // DEBUG LOG
        if (!clientId) {
            console.log("DEBUG: Client ID not found in sessionStorage."); // DEBUG LOG
            clientNameDisplay.textContent = "Cliente Inválido";
            formInfoContentEl.innerHTML = `<p style="color:red;">ID do cliente não encontrado.</p>`;
            return;
        }

        if (clientName) {
            clientNameDisplay.textContent = clientName;
            document.title = `Detalhes - ${clientName}`; // Atualiza título da aba
        } else {
            clientNameDisplay.textContent = "Cliente";
        }

        try {
            console.log("DEBUG: Resetting form info content."); // DEBUG LOG
            formInfoContentEl.innerHTML = `<p id="form-loading-state">Carregando informações do formulário...</p>`; // Reset state
            // 1. Busca dados do cliente (incluindo projeto)
            console.log("DEBUG: Fetching client data for ID:", clientId); // DEBUG LOG
            const { data: clientData, error: clientError } = await supabase
                .from('clientes')
                .select('projeto')
                .eq('id', clientId)
                .single();

            if (clientError || !clientData) {
                console.error("DEBUG: Error fetching client data or client not found:", clientError); // DEBUG LOG
                throw clientError || new Error("Cliente não encontrado.");
            }
            console.log("DEBUG: Client data fetched:", clientData); // DEBUG LOG

            // 2. Verifica se o projeto é Planejamento
            if (clientData.projeto !== 'Planejamento') {
                console.log("DEBUG: Client project is not Planejamento. Displaying not applicable message."); // DEBUG LOG
                displayFormNotApplicable();
                return;
            }
            console.log("DEBUG: Client project is Planejamento. Proceeding..."); // DEBUG LOG

            // 3. Busca o formulário MAIS RECENTE para este cliente
            console.log("DEBUG: Fetching latest form for client ID:", clientId); // DEBUG LOG
            const { data: latestForm, error: formError } = await supabase
                .from('formularios_clientes')
                .select('*') // Seleciona todas as colunas necessárias (id, token_unico, status, data_preenchimento, dados_formulario)
                .eq('cliente_id', clientId)
                .order('created_at', { ascending: false })
                .limit(1)
                .maybeSingle(); // Retorna null se não encontrar, em vez de erro

            if (formError) {
                console.error("DEBUG: Error fetching form data:", formError); // DEBUG LOG
                throw formError;
            }
            console.log("DEBUG: Latest form data fetched:", latestForm); // DEBUG LOG

            // 4. Decide o que exibir com base no formulário encontrado
            if (!latestForm) {
                // Nenhum formulário existe, mostra botão para gerar
                console.log("DEBUG: No form found. Displaying generate link button."); // DEBUG LOG
                displayGenerateLinkForm();
            } else if (latestForm.status === 'pendente') {
                // Formulário pendente existe, mostra o link E o botão de excluir
                console.log("DEBUG: Pending form found. Displaying form link and delete button."); // DEBUG LOG
                displayFormLink(latestForm);
            } else if (latestForm.status === 'preenchido') {
                // Formulário preenchido existe, mostra os dados e botão de excluir
                console.log("DEBUG: Completed form found. Displaying form data and delete button."); // DEBUG LOG
                displayFormData(latestForm);
            } else {
                 console.log("DEBUG: Form found with unknown status:", latestForm.status); // DEBUG LOG
                 formInfoContentEl.innerHTML = `<p style="color:orange;">Status desconhecido do formulário: ${latestForm.status}</p>`;
            }

        } catch (error) {
            console.error("Erro ao carregar informações do formulário:", error);
            formInfoContentEl.innerHTML = `<p style="color:red;">Erro ao carregar: ${error.message}</p>`;
        }
    }

    // Handler para gerar novo link
    async function handleGenerateLink() {
        console.log("DEBUG: Entering handleGenerateLink"); // DEBUG LOG
        formInfoContentEl.innerHTML = `<p>Gerando novo link...</p>`;
        try {
            const newToken = crypto.randomUUID(); // Gera token único
            console.log("DEBUG: Generated new token:", newToken); // DEBUG LOG
            const { data, error } = await supabase
                .from('formularios_clientes')
                .insert({
                    cliente_id: clientId,
                    token_unico: newToken,
                    status: 'pendente'
                    // dados_formulario será null por padrão
                })
                .select()
                .single();

            if (error) {
                 console.error("DEBUG: Error inserting new form link:", error); // DEBUG LOG
                 throw error;
            }
            console.log("DEBUG: New form link inserted:", data); // DEBUG LOG

            displayFormLink(data); // Exibe o novo link e o botão de excluir

        } catch (error) {
            console.error("Erro ao gerar link:", error);
            formInfoContentEl.innerHTML = `<p style="color:red;">Erro ao gerar link: ${error.message}</p>`;
            // Adiciona botão para tentar novamente
            formInfoContentEl.innerHTML += `<br><button class="generate-link-btn">Tentar Gerar Novamente</button>`;
            const generateBtn = formInfoContentEl.querySelector('.generate-link-btn');
            if (generateBtn) {
                generateBtn.addEventListener('click', handleGenerateLink);
            }
        }
    }

    // Handler para excluir dados/link do formulário
    async function handleDeleteForm(event) {
        const formId = event.target.dataset.formId;
        console.log("DEBUG: Entering handleDeleteForm for form ID:", formId); // DEBUG LOG
        if (!formId) {
            console.error("DEBUG: Form ID not found on button dataset."); // DEBUG LOG
            alert("Erro: ID do formulário não encontrado.");
            return;
        }

        const confirmation = confirm("Tem certeza que deseja excluir este formulário/link? Esta ação gerará um novo link para o cliente.");
        if (!confirmation) {
            console.log("DEBUG: Deletion cancelled by user."); // DEBUG LOG
            return;
        }

        formInfoContentEl.innerHTML = `<p>Excluindo formulário e gerando novo link...</p>`;

        try {
            // 1. Exclui o formulário antigo (ou apenas o link, se pendente)
            console.log("DEBUG: Deleting form with ID:", formId); // DEBUG LOG
            const { error: deleteError } = await supabase
                .from('formularios_clientes')
                .delete()
                .eq('id', formId);

            if (deleteError) {
                console.error("DEBUG: Error deleting form:", deleteError); // DEBUG LOG
                throw deleteError;
            }
            console.log("DEBUG: Form deleted successfully."); // DEBUG LOG

            // 2. Gera um novo link (chama a função handleGenerateLink)
            console.log("DEBUG: Calling handleGenerateLink to create a new form link."); // DEBUG LOG
            await handleGenerateLink(); // Reutiliza a função de gerar link

        } catch (error) {
            console.error("Erro ao excluir e gerar novo link:", error);
            formInfoContentEl.innerHTML = `<p style="color:red;">Erro ao processar a exclusão: ${error.message}</p>`;
            // Adiciona botão para tentar recarregar
            formInfoContentEl.innerHTML += `<br><button onclick="loadAndManageForm()">Recarregar</button>`;
        }
    }

    // --- Inicialização ---
    // Carrega o formulário quando o DOM estiver pronto
    document.addEventListener('DOMContentLoaded', loadAndManageForm);

  </script>
</body>
</html>

