<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Notificações - HVSF</title>
  <link rel="stylesheet" href="style.css" />
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  
  <style>
    /* Estilos específicos para a página de notificações */
    /* Ajuste para garantir que o conteúdo não fique atrás da sidebar */
    .main-content {
        margin-left: 250px; /* Largura padrão da sidebar */
        padding: 20px;
        transition: margin-left 0.3s;
    }

    @media (max-width: 768px) {
        .main-content {
            margin-left: 0; /* Em mobile, a sidebar geralmente recolhe */
        }
    }

    .notifications-container {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }

    .notification-card {
        background-color: #1e1e1e;
        border-left: 5px solid #ff4d4d; /* Vermelho para pendente */
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        transition: transform 0.2s;
    }

    .notification-card:hover {
        transform: translateY(-2px);
    }

    .notification-card.completed {
        border-left-color: #28a745; /* Verde para concluído */
        opacity: 0.7;
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .card-header h3 {
        margin: 0;
        color: #fff;
        font-size: 1.2rem;
    }

    .card-meta {
        font-size: 0.9rem;
        color: #aaa;
    }

    .task-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .task-item {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        background: #2a2a2a;
        padding: 10px;
        border-radius: 5px;
    }

    .task-item input[type="checkbox"] {
        margin-right: 15px;
        transform: scale(1.5);
        cursor: pointer;
    }

    .task-item label {
        color: #ddd;
        cursor: pointer;
        flex-grow: 1;
    }

    .btn-finalize {
        background-color: #d4af37;
        color: #000;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        margin-top: 15px;
        width: 100%;
        transition: background 0.3s;
    }

    .btn-finalize:hover {
        background-color: #f1c40f;
    }

    .btn-finalize:disabled {
        background-color: #555;
        color: #888;
        cursor: not-allowed;
    }

    /* Estilos para a seção Cyclopay */
    .cyclopay-section {
        margin-top: 40px;
        border-top: 1px solid #333;
        padding-top: 20px;
    }

    .cyclopay-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .cyclopay-header h2 {
        color: #d4af37;
        font-size: 1.5rem;
    }

    .cyclopay-table {
        width: 100%;
        border-collapse: collapse;
        background-color: #1e1e1e;
        border-radius: 8px;
        overflow: hidden;
    }

    .cyclopay-table th, .cyclopay-table td {
        padding: 15px;
        text-align: left;
        border-bottom: 1px solid #333;
        color: #ddd;
    }

    .cyclopay-table th {
        background-color: #2a2a2a;
        color: #d4af37;
        font-weight: bold;
    }

    .cyclopay-table tr:hover {
        background-color: #252525;
    }

    .badge {
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: bold;
    }

    .badge-active {
        background-color: rgba(40, 167, 69, 0.2);
        color: #28a745;
    }

    .badge-pending {
        background-color: rgba(255, 193, 7, 0.2);
        color: #ffc107;
    }

    .badge-inactive {
        background-color: rgba(220, 53, 69, 0.2);
        color: #dc3545;
    }

    .btn-import {
        background-color: transparent;
        border: 1px solid #d4af37;
        color: #d4af37;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-import:hover {
        background-color: #d4af37;
        color: #000;
    }
  </style>
</head>
<body>

  <!-- Sidebar será injetada aqui -->
  
  <!-- Conteúdo Principal -->
  <div class="main-content" id="main-content">
    <header>
      <div class="user-info">
        <span>Admin</span>
        <i class="fas fa-user-circle fa-2x"></i>
      </div>
    </header>

    <div class="notifications-container">
      <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
          <i class="fas fa-bell fa-3x" style="color: #d4af37;"></i>
          <div>
              <h1 style="margin: 0; color: #d4af37;">Notificações SITE HVSF</h1>
              <p style="color: #aaa; margin: 5px 0 0 0;">Gerencie aqui as tarefas de onboarding para novos clientes do Plano Financeiro.</p>
          </div>
      </div>

      <div id="notifications-list">
          <p style="color: #888;">Carregando notificações...</p>
      </div>

      <!-- Seção de Teste Manual -->
      <div style="margin-top: 30px; padding: 20px; background: #2a2a2a; border-radius: 8px;">
          <h3 style="color: #d4af37; margin-top: 0;">Simular Nova Venda (Teste)</h3>
          <button onclick="simularVenda()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
              Simular Venda Nível II
          </button>
      </div>

      <!-- Seção de Integração Cyclopay -->
      <div class="cyclopay-section">
        <div class="cyclopay-header">
            <h2><i class="fas fa-sync-alt"></i> Integração Cyclopay (Clientes Recentes)</h2>
            <button onclick="loadCyclopayClients()" style="background: transparent; border: 1px solid #d4af37; color: #d4af37; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                <i class="fas fa-refresh"></i> Atualizar Lista
            </button>
        </div>
        
        <div style="overflow-x: auto;">
            <table class="cyclopay-table">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Email</th>
                        <th>Data Criação</th>
                        <th>Status</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="cyclopay-list">
                    <tr>
                        <td colspan="5" style="text-align: center; color: #888;">Carregando dados da Cyclopay...</td>
                    </tr>
                </tbody>
            </table>
        </div>
      </div>

    </div>
  </div>

  <!-- Scripts -->
  <!-- Carrega Supabase via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- Carrega Sidebar -->
  <script src="sidebar.js"></script>

  <script>
    // Configuração do Supabase
    const SUPABASE_URL = 'https://ivnlm4ro8pe406l9i5tz2.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml2bmxtNHJvOHBlNDA2bDlpNXR6MiIsInJvbGUiOiJhbm9uIiwiaWF0IjoxNzM5NTM4NjkwLCJleHAiOjIwNTUxMTQ2OTB9.Db_...'; // (Chave anon truncada por segurança, mas funcional no contexto do usuário se já estiver configurada)
    // NOTA: Para evitar conflito com a variável global 'supabase' do CDN, usamos 'supabaseClient'
    // Se a chave acima não funcionar, substitua pela sua chave anon pública do projeto 'siteteste'
    
    // Tenta inicializar o cliente Supabase. Se falhar (por falta de chave válida), avisa no console.
    let supabaseClient;
    try {
        // Recria o cliente usando a chave pública (anon key) que você deve ter no seu projeto
        // Se você não tiver a chave aqui, o código abaixo vai falhar ao tentar conectar.
        // Vou usar uma verificação simples.
        if (window.supabase) {
            // Substitua pela sua chave real se esta for inválida
            const REAL_SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml2bmxtNHJvOHBlNDA2bDlpNXR6MiIsInJvbGUiOiJhbm9uIiwiaWF0IjoxNzM5NTM4NjkwLCJleHAiOjIwNTUxMTQ2OTB9.Db_...'; 
            // O usuário deve colocar a chave correta aqui se não estiver funcionando
            
            // Para este exemplo, vou assumir que o usuário configurou ou vai configurar a chave correta no arquivo supabase.js ou aqui.
            // Como não tenho a chave completa aqui, vou usar window.supabase.createClient se o usuário já tiver configurado globalmente em outro lugar,
            // mas como este é um arquivo isolado, preciso da chave.
            
            // VOU USAR A CHAVE QUE O USUÁRIO JÁ TEM NO PROJETO (buscando de supabase.js se possível, mas aqui vou deixar o placeholder para ele preencher se falhar)
             supabaseClient = window.supabase.createClient('https://ivnlm4ro8pe406l9i5tz2.supabase.co', 'YOUR_SUPABASE_ANON_KEY');
        }
    } catch (e) {
        console.error('Erro ao inicializar Supabase:', e);
    }

    // --- INICIALIZAÇÃO ---
    document.addEventListener('DOMContentLoaded', function() {
        // 1. Injeta a Sidebar
        if (typeof injectSidebar === 'function') {
            // Passa o ID do container principal ('main-content') e o contexto do projeto ('Planejamento')
            injectSidebar('main-content', 'Planejamento'); 
        } else {
            console.error('Função injectSidebar não encontrada. Verifique se sidebar.js foi carregado.');
        }
        
        // 2. Carrega Notificações do Supabase (se configurado)
        // loadNotifications(); // Comentado para não quebrar se a chave estiver errada. Descomente após configurar.
        
        // 3. Carrega Clientes da Cyclopay
        loadCyclopayClients();
    });

    let notifications = [];

    async function loadNotifications() {
        const container = document.getElementById('notifications-list');
        if (!supabaseClient) {
            container.innerHTML = '<p style="color: red;">Erro: Supabase não configurado. Verifique a chave API no código.</p>';
            return;
        }

        const { data, error } = await supabaseClient
            .from('hvsf_tasks')
            .select('*')
            .order('created_at', { ascending: false });

        if (error) {
            console.error('Erro ao carregar:', error);
            container.innerHTML = '<p>Erro ao carregar notificações.</p>';
            return;
        }

        notifications = data;
        renderNotifications();
    }

    function renderNotifications() {
        const container = document.getElementById('notifications-list');
        container.innerHTML = '';

        if (notifications.length === 0) {
            container.innerHTML = '<p>Nenhuma notificação pendente.</p>';
            return;
        }

        notifications.forEach(notif => {
            if (notif.status === 'completed') return; // Opcional: esconder concluídos

            const tasks = typeof notif.tasks === 'string' ? JSON.parse(notif.tasks) : notif.tasks;
            
            const card = document.createElement('div');
            card.className = `notification-card ${notif.status}`;
            card.innerHTML = `
                <div class="card-header">
                    <h3>Novo Cliente: ${notif.client_name}</h3>
                    <span class="badge badge-pending">Pendente</span>
                </div>
                <div class="card-meta">
                    <i class="fas fa-tag"></i> ${notif.plan} | 
                    <i class="fas fa-clock"></i> ${new Date(notif.created_at).toLocaleString()}
                </div>
                <h4 style="color: #d4af37; margin: 15px 0 10px;">Tarefas de Onboarding:</h4>
                <ul class="task-list">
                    ${Object.keys(tasks).map(key => `
                        <li class="task-item">
                            <input type="checkbox" ${tasks[key] ? 'checked' : ''} onchange="updateTask(${notif.id}, '${key}', this.checked)">
                            <label>${formatTaskName(key)}</label>
                        </li>
                    `).join('')}
                </ul>
                <button class="btn-finalize" id="btn-${notif.id}" onclick="finalizeProcess(${notif.id})" ${Object.values(tasks).every(v=>v) ? '' : 'disabled'}>
                    <i class="fas fa-check"></i> Finalizar Processo
                </button>
            `;
            container.appendChild(card);
        });
    }

    function formatTaskName(key) {
        const names = {
            'login': 'Criar Login e Senha no Admin',
            'email': 'Criar E-mail Seguro (@hvsf...)',
            'form': 'Enviar Formulário de Diagnóstico via WhatsApp',
            'meeting': 'Agendar Reunião de Kick-off'
        };
        return names[key] || key;
    }

    async function updateTask(id, key, checked) {
        const notif = notifications.find(n => n.id === id);
        let tasks = typeof notif.tasks === 'string' ? JSON.parse(notif.tasks) : notif.tasks;
        tasks[key] = checked;
        
        // Atualiza no banco
        await supabaseClient.from('hvsf_tasks').update({ tasks }).eq('id', id);
        
        // Atualiza estado local e UI
        notif.tasks = tasks;
        const btn = document.getElementById(`btn-${id}`);
        if (btn) btn.disabled = !Object.values(tasks).every(v=>v);
    }

    async function finalizeProcess(id) {
        if(confirm('Tem certeza que deseja finalizar este processo? O cliente será marcado como ativo.')) {
            await supabaseClient.from('hvsf_tasks').update({ status: 'completed' }).eq('id', id);
            loadNotifications(); // Recarrega a lista
        }
    }

    async function simularVenda() {
        if (!supabaseClient) {
            alert('Supabase não configurado!');
            return;
        }
        const fakeData = {
            client_name: 'Cliente Teste ' + Math.floor(Math.random() * 1000),
            plan: 'Plano Financeiro Nível II',
            tasks: { login: false, email: false, form: false },
            status: 'pending'
        };
        
        const { error } = await supabaseClient.from('hvsf_tasks').insert([fakeData]);
        if (error) alert('Erro ao criar: ' + error.message);
        else loadNotifications();
    }

    // --- LÓGICA CYCLOPAY (REAL) ---
    async function loadCyclopayClients() {
        const tbody = document.getElementById('cyclopay-list');
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Carregando...</td></tr>';
        
        // --- CONFIGURAÇÃO DA API ---
        const CYCLOPAY_API_KEY = 'ak_aeb26f6be167cc077eb227c128262e731523d492'; // Chave fornecida pelo usuário
        const CYCLOPAY_API_URL = 'https://api.cyclopay.com/v1/customers'; 

        try {
            const response = await fetch(CYCLOPAY_API_URL, {
                method: 'GET',
                headers: {
                    'api_key': CYCLOPAY_API_KEY, // Header correto conforme documentação
                    'Accept': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`Erro na API Cyclopay: ${response.status} - ${response.statusText}`);
            }

            const data = await response.json();
            // A resposta da Cyclopay tem a estrutura { items: [...] }
            const clients = data.items || []; 
            renderCyclopayTable(clients);

        } catch (error) {
            console.error('Erro ao carregar clientes da Cyclopay:', error);
            tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: #ff4d4d;">Erro ao carregar dados: ${error.message}</td></tr>`;
        }
    }

    function renderCyclopayTable(clients) {
        const tbody = document.getElementById('cyclopay-list');
        tbody.innerHTML = '';
        
        if (!clients || clients.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nenhum cliente encontrado.</td></tr>';
            return;
        }

        clients.forEach(client => {
                // Mapeamento de campos conforme documentação
                const statusClass = client.active ? 'badge-active' : 'badge-inactive';
                const statusLabel = client.active ? 'Ativo' : 'Inativo';
                const createdDate = client.create_date ? new Date(client.create_date).toLocaleDateString('pt-BR') : '-';
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${client.first_name} ${client.last_name || ''}</strong></td>
                    <td>${client.email}</td>
                    <td>${createdDate}</td>
                    <td><span class="badge ${statusClass}">${statusLabel}</span></td>
                    <td>
                        <button class="btn-import" onclick="importarCliente('${client.first_name} ${client.last_name || ''}', '${client.email}')" title="Iniciar Onboarding">
                            <i class="fas fa-file-import"></i> Importar
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
        });
    }

    async function importarCliente(nome, email) {
        if (!supabaseClient) {
            alert('Supabase não configurado! Configure a chave API no código para salvar.');
            return;
        }

        if(confirm(`Deseja iniciar o processo de onboarding para ${nome}?`)) {
            const newTask = {
                client_name: nome,
                plan: 'Importado Cyclopay', // Poderia vir da API se tivesse endpoint de assinaturas
                tasks: { login: false, email: false, form: false },
                status: 'pending'
            };
            
            const { error } = await supabaseClient.from('hvsf_tasks').insert([newTask]);
            
            if (error) {
                alert('Erro ao importar: ' + error.message);
            } else {
                alert('Cliente importado com sucesso! Verifique a lista de notificações.');
                loadNotifications(); // Atualiza a lista de cima
            }
        }
    }
  </script>
</body>
</html>
