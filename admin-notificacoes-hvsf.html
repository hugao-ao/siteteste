<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Notificações SITE HVSF</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    body {
      display: flex;
      margin: 0;
      min-height: 100vh;
      background-color: var(--theme-bg-dark, #1a1a1a);
      color: var(--theme-text-light, #e0e0e0);
    }

    #main-content {
      flex-grow: 1;
      padding: 2rem;
      margin-left: 250px;
      transition: margin-left 0.3s ease;
      background-color: var(--theme-bg-surface, #2d2d2d);
      color: var(--theme-text-light, #e0e0e0);
    }

    #main-content.sidebar-collapsed {
      margin-left: 60px;
    }

    @media (max-width: 768px) {
        #main-content {
            margin-left: 60px !important;
            padding: 1rem;
        }
    }

    /* Estilos específicos para esta página */
    .notification-card {
      background-color: var(--theme-bg-dark, #1a1a1a);
      border: 1px solid var(--theme-border-color, #444);
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border-left: 5px solid #ff4444; /* Vermelho para pendente */
      position: relative;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .notification-card.completed {
      border-left-color: #00C851; /* Verde para concluído */
      opacity: 0.7;
    }

    .notification-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1rem;
    }

    .notification-title {
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--theme-text-light, #fff);
    }

    .notification-meta {
      font-size: 0.9rem;
      color: var(--theme-text-muted, #aaa);
      margin-top: 0.2rem;
    }

    .task-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .task-item {
      margin-bottom: 0.8rem;
      display: flex;
      align-items: center;
      gap: 0.8rem;
      padding: 0.5rem;
      background-color: rgba(255,255,255,0.05);
      border-radius: 4px;
    }

    .task-item:hover {
      background-color: rgba(255,255,255,0.1);
    }

    .task-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: #00C851;
    }

    .task-item label {
      cursor: pointer;
      flex-grow: 1;
    }

    .btn-finalize {
      background-color: #00C851;
      color: white;
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 1rem;
      font-weight: bold;
      transition: background-color 0.2s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-finalize:hover {
      background-color: #007E33;
    }

    .btn-finalize:disabled {
      background-color: #555;
      cursor: not-allowed;
      opacity: 0.7;
    }

    .status-badge {
      font-size: 1.5rem;
    }

    /* Estilos para a lista de clientes Cyclopay */
    .cyclopay-section {
      margin-top: 3rem;
      border-top: 1px solid var(--theme-border-color, #444);
      padding-top: 2rem;
    }

    .cyclopay-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .cyclopay-table {
      width: 100%;
      border-collapse: collapse;
      background-color: var(--theme-bg-dark, #1a1a1a);
      border-radius: 8px;
      overflow: hidden;
    }

    .cyclopay-table th, .cyclopay-table td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid var(--theme-border-color, #444);
    }

    .cyclopay-table th {
      background-color: #2c3e50;
      color: white;
      font-weight: 600;
    }

    .cyclopay-table tr:hover {
      background-color: rgba(255,255,255,0.05);
    }

    .badge-status {
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: bold;
    }
    .badge-active { background-color: #00C851; color: white; }
    .badge-pending { background-color: #ffbb33; color: black; }
    .badge-inactive { background-color: #ff4444; color: white; }

    .btn-import {
      background-color: #33b5e5;
      color: white;
      border: none;
      padding: 0.4rem 0.8rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .btn-import:hover { background-color: #0099cc; }

  </style>
  
  <!-- Supabase JS via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <!-- Sidebar será injetada dinamicamente por sidebar.js -->
  
  <main id="main-content">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
      <div>
        <h1><i class="fas fa-bell" style="color: #ffbb33;"></i> Notificações SITE HVSF</h1>
        <p style="color: #aaa; margin-top: 0.5rem;">Gerencie aqui as tarefas de onboarding para novos clientes do Plano Financeiro.</p>
      </div>
      <button onclick="simularVenda()" style="padding: 10px 20px; background: #33b5e5; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
        <i class="fas fa-plus"></i> Simular Nova Venda (Teste)
      </button>
    </div>
    
    <!-- Seção de Notificações -->
    <div id="notifications-container">
      <p>Carregando notificações...</p>
    </div>

    <!-- Seção de Clientes Cyclopay -->
    <div class="cyclopay-section">
      <div class="cyclopay-header">
        <h2><i class="fas fa-users" style="color: #33b5e5;"></i> Clientes Recentes (Integração Cyclopay)</h2>
        <button onclick="refreshCyclopay()" style="background: none; border: 1px solid #aaa; color: #aaa; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
          <i class="fas fa-sync-alt"></i> Atualizar
        </button>
      </div>
      
      <div style="overflow-x: auto;">
        <table class="cyclopay-table">
          <thead>
            <tr>
              <th>Cliente</th>
              <th>Email</th>
              <th>Plano</th>
              <th>Status Pagamento</th>
              <th>Data Venda</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="cyclopay-list">
            <!-- Dados simulados da Cyclopay serão inseridos aqui -->
            <tr><td colspan="6" style="text-align: center;">Carregando dados da Cyclopay...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Carrega sidebar.js como script normal -->
  <script src="sidebar.js"></script>
  
  <script>
    // --- CONFIGURAÇÃO SUPABASE ---
    // Usamos 'supabaseClient' para evitar conflito com a variável global 'supabase' do CDN
    const SUPABASE_URL = 'https://vbikskbfkhundhropykf.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZiaWtza2Jma2h1bmRocm9weWtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU1MTk5NjEsImV4cCI6MjA2MTA5NTk2MX0.-n-Tj_5JnF1NL2ZImWlMeTcobWDl_VD6Vqp0lxRQFFU';
    
    // Verifica se window.supabase existe antes de criar o cliente
    let supabaseClient;
    if (window.supabase && window.supabase.createClient) {
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    } else {
        console.error('Biblioteca Supabase não carregada corretamente via CDN.');
        document.getElementById('notifications-container').innerHTML = '<p style="color: red;">Erro crítico: Biblioteca Supabase não carregada.</p>';
    }
    
    // --- INICIALIZAÇÃO ---
    document.addEventListener('DOMContentLoaded', function() {
        // 1. Injeta a Sidebar
        if (typeof injectSidebar === 'function') {
            injectSidebar('Planejamento'); // Define contexto como 'Planejamento' para destacar no menu
        } else {
            console.error('Função injectSidebar não encontrada. Verifique se sidebar.js foi carregado.');
        }
        
        // 2. Carrega Notificações do Supabase
        if (supabaseClient) {
            loadNotifications();
        }

        // 3. Carrega Clientes Cyclopay (Simulado)
        loadCyclopayClients();
    });

    // --- LÓGICA DE NOTIFICAÇÕES ---
    let notifications = [];

    async function loadNotifications() {
        const container = document.getElementById('notifications-container');
        
        try {
            const { data, error } = await supabaseClient
                .from('hvsf_tasks')
                .select('*')
                .eq('status', 'pending')
                .order('created_at', { ascending: false });

            if (error) throw error;

            notifications = data || [];
            renderNotifications();
        } catch (err) {
            console.error('Erro ao carregar notificações:', err);
            container.innerHTML = '<p style="color: #ff4444;">Erro ao conectar com o banco de dados. Verifique o console.</p>';
        }
    }

    function renderNotifications() {
        const container = document.getElementById('notifications-container');
        container.innerHTML = '';

        if (notifications.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 2rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
                    <i class="fas fa-check-circle" style="font-size: 3rem; color: #00C851; margin-bottom: 1rem;"></i>
                    <h3>Tudo em dia!</h3>
                    <p>Não há tarefas de onboarding pendentes no momento.</p>
                </div>
            `;
            updateBadge(0);
            return;
        }

        notifications.forEach(notif => {
            const card = document.createElement('div');
            card.className = 'notification-card';
            
            // Garante que tasks seja um objeto
            let tasks = notif.tasks;
            if (typeof tasks === 'string') {
                try { tasks = JSON.parse(tasks); } catch(e) { tasks = {}; }
            }

            // Verifica se todas as tarefas estão completas
            const allDone = isAllChecked(tasks);

            card.innerHTML = `
                <div class="notification-header">
                    <div>
                        <div class="notification-title">Novo Cliente: ${notif.client_name}</div>
                        <div class="notification-meta">
                            <i class="fas fa-tag"></i> ${notif.plan} &nbsp;|&nbsp; 
                            <i class="far fa-clock"></i> ${new Date(notif.created_at).toLocaleString('pt-BR')}
                        </div>
                    </div>
                    <div class="status-badge">
                        <i class="fas fa-exclamation-circle" style="color: #ff4444;" title="Pendente"></i>
                    </div>
                </div>
                
                <div style="margin-bottom: 1rem; font-size: 0.9rem; color: #ccc;">
                    <strong>Tarefas de Onboarding:</strong>
                </div>

                <ul class="task-list">
                    <li class="task-item">
                        <input type="checkbox" id="task-login-${notif.id}" ${tasks.login ? 'checked' : ''} onchange="updateTask(${notif.id}, 'login', this.checked)">
                        <label for="task-login-${notif.id}">Criar Login e Senha no Admin</label>
                    </li>
                    <li class="task-item">
                        <input type="checkbox" id="task-email-${notif.id}" ${tasks.email ? 'checked' : ''} onchange="updateTask(${notif.id}, 'email', this.checked)">
                        <label for="task-email-${notif.id}">Criar E-mail Seguro (@hvsf...)</label>
                    </li>
                    <li class="task-item">
                        <input type="checkbox" id="task-form-${notif.id}" ${tasks.form ? 'checked' : ''} onchange="updateTask(${notif.id}, 'form', this.checked)">
                        <label for="task-form-${notif.id}">Enviar Formulário de Diagnóstico via WhatsApp</label>
                    </li>
                    ${notif.plan === 'Nível IV' ? `
                    <li class="task-item" style="border-left: 3px solid #ffbb33;">
                        <input type="checkbox" id="task-meeting-${notif.id}" ${tasks.meeting ? 'checked' : ''} onchange="updateTask(${notif.id}, 'meeting', this.checked)">
                        <label for="task-meeting-${notif.id}">Agendar Reunião de Boas-vindas (Prioridade)</label>
                    </li>
                    ` : ''}
                </ul>

                <button class="btn-finalize" id="btn-finalize-${notif.id}" onclick="finalizeProcess(${notif.id})" ${allDone ? '' : 'disabled'}>
                    <i class="fas fa-check"></i> Finalizar Processo
                </button>
            `;
            container.appendChild(card);
        });
        
        updateBadge(notifications.length);
    }

    async function updateTask(id, taskKey, checked) {
        const notif = notifications.find(n => n.id === id);
        if (notif) {
            // Atualiza estado local
            if (typeof notif.tasks === 'string') {
                 try { notif.tasks = JSON.parse(notif.tasks); } catch(e) { notif.tasks = {}; }
            }
            notif.tasks[taskKey] = checked;
            
            // Atualiza UI do botão imediatamente
            const btn = document.getElementById(`btn-finalize-${id}`);
            if (btn) {
                btn.disabled = !isAllChecked(notif.tasks);
            }

            // Atualiza Supabase
            try {
                const { error } = await supabaseClient
                    .from('hvsf_tasks')
                    .update({ tasks: notif.tasks })
                    .eq('id', id);
                
                if (error) throw error;
            } catch (err) {
                console.error('Erro ao atualizar tarefa:', err);
                alert('Erro ao salvar alteração. Verifique sua conexão.');
            }
        }
    }

    function isAllChecked(tasks) {
        // Verifica se todos os valores no objeto tasks são true
        return Object.values(tasks).every(v => v === true);
    }

    async function finalizeProcess(id) {
        if (confirm('Tem certeza que deseja finalizar este processo? A notificação será arquivada.')) {
            try {
                const { error } = await supabaseClient
                    .from('hvsf_tasks')
                    .update({ status: 'completed' })
                    .eq('id', id);

                if (error) throw error;

                // Recarrega lista
                loadNotifications();
            } catch (err) {
                console.error('Erro ao finalizar processo:', err);
                alert('Erro ao finalizar. Tente novamente.');
            }
        }
    }
    
    function updateBadge(count) {
        // Tenta atualizar o badge na sidebar se ele existir
        const badge = document.getElementById('badge-notificacoes-hvsf');
        if (badge) {
            badge.textContent = count;
            badge.style.display = count > 0 ? 'inline-block' : 'none';
        }
    }

    async function simularVenda() {
        if (!supabaseClient) return;

        const nomes = ['Carlos Souza', 'Ana Pereira', 'Roberto Lima', 'Fernanda Costa', 'Juliana Martins'];
        const planos = ['Nível I', 'Nível II', 'Nível III', 'Nível IV'];
        const nome = nomes[Math.floor(Math.random() * nomes.length)];
        const plano = planos[Math.floor(Math.random() * planos.length)];
        
        const initialTasks = {
            login: false,
            email: false,
            form: false
        };
        if (plano === 'Nível IV') {
            initialTasks.meeting = false;
        }

        try {
            const { error } = await supabaseClient
                .from('hvsf_tasks')
                .insert([{
                    client_name: nome,
                    plan: plano,
                    tasks: initialTasks,
                    status: 'pending'
                }]);

            if (error) throw error;

            alert(`Nova venda simulada para ${nome} (${plano})!`);
            loadNotifications();
        } catch (err) {
            console.error('Erro ao simular venda:', err);
            alert('Erro ao criar simulação.');
        }
    }

    // --- LÓGICA CYCLOPAY (MOCK) ---
    function loadCyclopayClients() {
        const tbody = document.getElementById('cyclopay-list');
        
        // Simulação de dados vindos de uma API
        // Em produção, você faria: fetch('https://api.cyclopay.com/v1/clients', { headers: { 'Authorization': 'Bearer SEU_TOKEN' } })
        const mockClients = [
            { name: 'Empresa ABC Ltda', email: 'contato@abc.com.br', plan: 'Plano Empresarial', status: 'active', date: '2024-02-10' },
            { name: 'João da Silva', email: 'joao.silva@email.com', plan: 'Plano Básico', status: 'active', date: '2024-02-12' },
            { name: 'Maria Oliveira', email: 'maria.oli@email.com', plan: 'Plano Premium', status: 'pending', date: '2024-02-14' },
            { name: 'Tech Solutions', email: 'financeiro@techsol.com', plan: 'Plano Empresarial', status: 'inactive', date: '2023-11-05' },
            { name: 'Consultoria XYZ', email: 'xyz@consultoria.com', plan: 'Plano Premium', status: 'active', date: '2024-01-20' }
        ];

        setTimeout(() => { // Simula delay de rede
            tbody.innerHTML = '';
            mockClients.forEach(client => {
                const statusClass = client.status === 'active' ? 'badge-active' : (client.status === 'pending' ? 'badge-pending' : 'badge-inactive');
                const statusLabel = client.status === 'active' ? 'Ativo' : (client.status === 'pending' ? 'Pendente' : 'Inativo');
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${client.name}</td>
                    <td>${client.email}</td>
                    <td>${client.plan}</td>
                    <td><span class="badge-status ${statusClass}">${statusLabel}</span></td>
                    <td>${new Date(client.date).toLocaleDateString('pt-BR')}</td>
                    <td>
                        <button class="btn-import" onclick="importClient('${client.name}', '${client.plan}')">
                            <i class="fas fa-file-import"></i> Importar
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }, 800);
    }

    function refreshCyclopay() {
        document.getElementById('cyclopay-list').innerHTML = '<tr><td colspan="6" style="text-align: center;">Atualizando dados...</td></tr>';
        loadCyclopayClients();
    }

    // Função para importar cliente da Cyclopay para o sistema de notificações
    window.importClient = async function(name, plan) {
        if(confirm(`Deseja importar ${name} para o sistema de onboarding?`)) {
            if (!supabaseClient) return;

            const initialTasks = { login: false, email: false, form: false };
            
            try {
                const { error } = await supabaseClient
                    .from('hvsf_tasks')
                    .insert([{
                        client_name: name,
                        plan: plan,
                        tasks: initialTasks,
                        status: 'pending'
                    }]);

                if (error) throw error;

                alert('Cliente importado com sucesso! Verifique a lista de notificações.');
                loadNotifications();
                window.scrollTo(0, 0); // Rola para o topo para ver a notificação
            } catch (err) {
                console.error('Erro ao importar:', err);
                alert('Erro ao importar cliente.');
            }
        }
    };
  </script>
</body>
</html>
