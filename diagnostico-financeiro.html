<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Diagnóstico Financeiro</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    /* Paleta de cores verde esmeralda escuro + dourado */
    :root {
      --primary-color: #1a4d3a; /* Verde esmeralda escuro */
      --secondary-color: #d4af37; /* Dourado */
      --accent-color: #ffd700; /* Dourado claro */
      --success-color: #2e8b57; /* Verde mar */
      --warning-color: #daa520; /* Dourado escuro */
      --dark-bg: #0f2e1f; /* Verde muito escuro */
      --surface-bg: #1a4d3a; /* Verde esmeralda escuro */
      --white: #ffffff;
      --text-light: #f0f8f0; /* Texto claro esverdeado */
      --text-gold: #d4af37; /* Texto dourado */
      --border-color: #2e8b57; /* Borda verde mar */
      --shadow-color: rgba(0, 0, 0, 0.3);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--dark-bg) 0%, var(--primary-color) 100%);
      color: var(--text-light);
      line-height: 1.6;
      min-height: 100vh;
    }

    .container {
      width: 100%;
      margin: 0;
      padding: 2rem;
      box-sizing: border-box;
    }

    .header {
      text-align: center;
      margin-bottom: 1.5rem;
      background: var(--surface-bg);
      padding: 1.5rem;
      border-radius: 15px;
      box-shadow: 0 10px 30px var(--shadow-color);
      border: 2px solid var(--border-color);
      width: 100%;
      box-sizing: border-box;
    }

    .header h1 {
      color: var(--accent-color);
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
      font-weight: 700;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .header .subtitle {
      color: var(--text-light);
      font-size: 1.1rem;
      margin-bottom: 1rem;
    }

    .canva-container {
      margin: 1.5rem 0;
      background: var(--surface-bg);
      padding: 1rem;
      border-radius: 15px;
      box-shadow: 0 10px 30px var(--shadow-color);
      border: 2px solid var(--border-color);
      width: 100%;
      box-sizing: border-box;
    }

    .canva-embed {
      position: relative;
      width: 100%;
      height: 0;
      padding-top: 56.2500%;
      padding-bottom: 0;
      box-shadow: 0 2px 8px 0 rgba(63,69,81,0.16);
      margin-top: 1.6em;
      margin-bottom: 0.9em;
      overflow: hidden;
      border-radius: 8px;
      will-change: transform;
    }

    .canva-embed iframe {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      border: none;
      padding: 0;
      margin: 0;
    }

    .canva-link {
      display: inline-block;
      color: var(--secondary-color);
      text-decoration: none;
      font-weight: 600;
      margin-top: 1rem;
      transition: color 0.3s ease;
    }

    .canva-link:hover {
      color: var(--accent-color);
      text-shadow: 0 0 8px var(--accent-color);
    }

    .form-container {
      background: var(--surface-bg);
      padding: 1.5rem;
      border-radius: 15px;
      box-shadow: 0 10px 30px var(--shadow-color);
      margin-top: 1.5rem;
      border: 2px solid var(--border-color);
      width: 100%;
      box-sizing: border-box;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
      width: 100%;
    }

    .form-grid-3 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
      width: 100%;
    }

    .form-group {
      margin-bottom: 0;
    }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.3rem;
      color: var(--text-gold);
      font-weight: 600;
      font-size: 0.9rem;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 0.7rem;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      background: var(--dark-bg);
      color: var(--text-light);
      font-size: 0.9rem;
      transition: all 0.3s ease;
      box-sizing: border-box;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--secondary-color);
      box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2);
      transform: translateY(-2px);
    }

    .form-group select {
      cursor: pointer;
    }

    .form-group select option {
      background: var(--dark-bg);
      color: var(--text-light);
    }

    .loading {
      text-align: center;
      padding: 3rem;
      color: var(--text-gold);
    }

    .loading i {
      font-size: 2rem;
      margin-bottom: 1rem;
      color: var(--secondary-color);
    }

    .error-message {
      background: rgba(220, 53, 69, 0.2);
      border: 1px solid #dc3545;
      color: #ff6b6b;
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .success-message {
      background: rgba(46, 139, 87, 0.2);
      border: 1px solid var(--success-color);
      color: #90ee90;
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .status-badge {
      display: inline-block;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
      margin-left: 1rem;
    }

    .status-em-andamento {
      background: rgba(212, 175, 55, 0.2);
      color: var(--accent-color);
      border: 1px solid var(--secondary-color);
    }

    .status-finalizado {
      background: rgba(46, 139, 87, 0.2);
      color: #90ee90;
      border: 1px solid var(--success-color);
    }

    .save-btn {
      background: linear-gradient(135deg, var(--secondary-color), var(--warning-color));
      color: var(--dark-bg);
      border: none;
      padding: 1.2rem 3rem;
      border-radius: 10px;
      font-size: 1.2rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
      box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
    }

    .save-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(212, 175, 55, 0.4);
      background: linear-gradient(135deg, var(--accent-color), var(--secondary-color));
    }

    .save-btn:disabled {
      background: var(--border-color);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
      color: var(--text-light);
    }

    .save-btn-container {
      text-align: center;
      margin-top: 2rem;
      margin-bottom: 1.5rem;
      padding: 1.5rem;
      width: 100%;
      box-sizing: border-box;
    }

    .add-btn {
      background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
      color: var(--dark-bg);
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
    }

    .add-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
    }

    .pessoa-card {
      background: var(--dark-bg);
      border: 2px solid var(--border-color);
      border-radius: 10px;
      padding: 1.2rem;
      margin-bottom: 1rem;
      position: relative;
    }

    .pessoa-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border-color);
    }

    .pessoa-title {
      color: var(--accent-color);
      font-size: 1.1rem;
      font-weight: 600;
      margin: 0;
    }

    .pessoa-actions {
      display: flex;
      gap: 0.5rem;
    }

    .edit-btn, .delete-btn {
      background: none;
      border: none;
      color: var(--text-light);
      cursor: pointer;
      padding: 0.3rem;
      border-radius: 4px;
      transition: all 0.3s ease;
      font-size: 0.9rem;
    }

    .edit-btn:hover {
      background: var(--primary-color);
      color: var(--dark-bg);
    }

    .delete-btn:hover {
      background: #dc3545;
      color: white;
    }

    .dependente-card {
      background: var(--dark-bg);
      border: 2px solid var(--border-color);
      border-radius: 10px;
      padding: 1.2rem;
      margin-bottom: 1rem;
      position: relative;
    }

    .dependente-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border-color);
    }

    .dependente-title {
      color: var(--accent-color);
      font-size: 1.1rem;
      font-weight: 600;
      margin: 0;
    }

    .dependente-actions {
      display: flex;
      gap: 0.5rem;
    }

    .idade-display {
      background: var(--primary-color);
      color: var(--dark-bg);
      padding: 0.3rem 0.8rem;
      border-radius: 15px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-left: 0.5rem;
      display: inline-block;
    }

    @media (max-width: 1200px) {
      .container {
        padding: 1.5rem;
      }
      
      .header, .canva-container, .form-container {
        padding: 1.2rem;
      }
      
      .form-grid {
        gap: 0.8rem;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      }

      .form-grid-3 {
        gap: 0.8rem;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }

      .header h1 {
        font-size: 2rem;
      }

      .header, .canva-container, .form-container {
        padding: 1rem;
      }

      .form-grid, .form-grid-3 {
        grid-template-columns: 1fr;
        gap: 0.8rem;
      }

      .form-group.full-width {
        grid-column: 1;
      }
      
      .save-btn-container {
        padding: 1.2rem 1rem;
        margin-top: 1.5rem;
        margin-bottom: 1rem;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 0.5rem;
      }
      
      .header, .canva-container, .form-container {
        padding: 0.8rem;
        margin: 1rem 0;
      }
      
      .save-btn {
        padding: 0.8rem 1.5rem;
        font-size: 0.9rem;
      }
      
      .save-btn-container {
        padding: 1rem;
        margin-top: 1rem;
        margin-bottom: 0.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="loading" class="loading">
      <i class="fas fa-spinner fa-spin"></i>
      <p>Carregando diagnóstico...</p>
    </div>

    <div id="error-container"></div>
    <div id="success-container"></div>

    <div id="main-content" style="display: none;">
      <!-- Header com título dinâmico -->
      <div class="header">
        <h1 id="diagnostico-title">Diagnóstico Financeiro</h1>
        <p class="subtitle">Análise completa da situação financeira</p>
        <span id="status-badge" class="status-badge"></span>
      </div>

      <!-- Apresentação do Canva -->
      <div class="canva-container">
        <div class="canva-embed">
          <iframe loading="lazy" 
            src="https://www.canva.com/design/DAGcaLXui_M/wzHI8hgio6j0mK_uNlcz8Q/view?embed" 
            allowfullscreen="allowfullscreen" 
            allow="fullscreen">
          </iframe>
          </div>
      </div>

      <!-- Formulário do diagnóstico -->
      <div class="form-container">
        <form id="diagnostico-form">
          <div class="form-grid-3">
            <div class="form-group">
              <label for="nome_diagnostico">
                <i class="fas fa-user"></i> Nome Completo *
              </label>
              <input type="text" 
                     id="nome_diagnostico" 
                     name="nome_diagnostico" 
                     placeholder="Digite o nome completo"
                     required>
            </div>

            <div class="form-group">
              <label for="cpf">
                <i class="fas fa-id-card"></i> CPF *
              </label>
              <input type="text" 
                     id="cpf" 
                     name="cpf" 
                     placeholder="000.000.000-00"
                     maxlength="14"
                     required>
            </div>

            <div class="form-group">
              <label for="data_nascimento">
                <i class="fas fa-calendar"></i> Data de Nascimento *
              </label>
              <input type="date" 
                     id="data_nascimento" 
                     name="data_nascimento" 
                     required>
            </div>

            <div class="form-group">
              <label for="profissao">
                <i class="fas fa-briefcase"></i> Profissão *
              </label>
              <input type="text" 
                     id="profissao" 
                     name="profissao" 
                     placeholder="Digite sua profissão"
                     required>
            </div>

            <div class="form-group">
              <label for="telefone">
                <i class="fas fa-phone"></i> Telefone de Contato
              </label>
              <input type="tel" 
                     id="telefone" 
                     name="telefone" 
                     placeholder="(00) 00000-0000">
            </div>

            <div class="form-group">
              <label for="email">
                <i class="fas fa-envelope"></i> E-mail
              </label>
              <input type="email" 
                     id="email" 
                     name="email" 
                     placeholder="seu@email.com">
            </div>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label for="estado_civil">
                <i class="fas fa-heart"></i> Estado Civil *
              </label>
              <select id="estado_civil" 
                      name="estado_civil" 
                      required>
                <option value="">Selecione o estado civil</option>
                <option value="Solteiro(a)">Solteiro(a)</option>
                <option value="Casado(a)">Casado(a)</option>
                <option value="União Estável">União Estável</option>
                <option value="Divorciado(a)">Divorciado(a)</option>
                <option value="Viúvo(a)">Viúvo(a)</option>
              </select>
            </div>

            <!-- Regime de Bens (aparece quando casado/união estável) -->
            <div class="form-group" id="regime-bens-group" style="display: none;">
              <label for="regime_bens">
                <i class="fas fa-balance-scale"></i> Regime de Bens
              </label>
              <select id="regime_bens" name="regime_bens">
                <option value="">Selecione o regime de bens</option>
                <option value="Comunhão Parcial de Bens">Comunhão Parcial de Bens</option>
                <option value="Comunhão Universal de Bens">Comunhão Universal de Bens</option>
                <option value="Separação Total de Bens">Separação Total de Bens</option>
                <option value="Participação Final nos Aquestos">Participação Final nos Aquestos</option>
              </select>
            </div>
          </div>

          <!-- Dados do Cônjuge (aparece quando casado/união estável) -->
          <div id="conjuge-section" style="display: none;">
            <h3 style="color: var(--accent-color); margin: 1.5rem 0 0.8rem 0; text-align: center;">
              <i class="fas fa-users"></i> Dados do Cônjuge
            </h3>
            
            <div class="form-grid-3">
              <div class="form-group">
                <label for="conjuge_nome">
                  <i class="fas fa-user"></i> Nome Completo do Cônjuge *
                </label>
                <input type="text" 
                       id="conjuge_nome" 
                       name="conjuge_nome" 
                       placeholder="Digite o nome completo do cônjuge">
              </div>

              <div class="form-group">
                <label for="conjuge_cpf">
                  <i class="fas fa-id-card"></i> CPF do Cônjuge
                </label>
                <input type="text" 
                       id="conjuge_cpf" 
                       name="conjuge_cpf" 
                       placeholder="000.000.000-00"
                       maxlength="14">
              </div>

              <div class="form-group">
                <label for="conjuge_data_nascimento">
                  <i class="fas fa-calendar"></i> Data de Nascimento do Cônjuge
                </label>
                <input type="date" 
                       id="conjuge_data_nascimento" 
                       name="conjuge_data_nascimento">
              </div>

              <div class="form-group">
                <label for="conjuge_profissao">
                  <i class="fas fa-briefcase"></i> Profissão do Cônjuge
                </label>
                <input type="text" 
                       id="conjuge_profissao" 
                       name="conjuge_profissao" 
                       placeholder="Digite a profissão do cônjuge">
              </div>

              <div class="form-group">
                <label for="conjuge_telefone">
                  <i class="fas fa-phone"></i> Telefone do Cônjuge
                </label>
                <input type="tel" 
                       id="conjuge_telefone" 
                       name="conjuge_telefone" 
                       placeholder="(00) 00000-0000">
              </div>

              <div class="form-group">
                <label for="conjuge_email">
                  <i class="fas fa-envelope"></i> E-mail do Cônjuge
                </label>
                <input type="email" 
                       id="conjuge_email" 
                       name="conjuge_email" 
                       placeholder="email@conjuge.com">
              </div>
            </div>
          </div>

          <!-- Sistema de Múltiplas Pessoas com Renda -->
          <div class="form-container" style="margin-top: 1.5rem;">
            <h3 style="color: var(--accent-color); margin: 0 0 1rem 0; text-align: center;">
              <i class="fas fa-users"></i> Outras Pessoas com Renda no Planejamento
            </h3>
            
            <div id="pessoas-renda-container">
              <!-- Pessoas adicionais serão inseridas aqui dinamicamente -->
            </div>
            
            <div style="text-align: center; margin-top: 1rem;">
              <button type="button" id="add-pessoa-btn" class="add-btn">
                <i class="fas fa-plus"></i> Adicionar Pessoa com Renda
              </button>
            </div>
          </div>

          <!-- Sistema de Dependentes -->
          <div class="form-container" style="margin-top: 1.5rem;">
            <h3 style="color: var(--accent-color); margin: 0 0 1rem 0; text-align: center;">
              <i class="fas fa-baby"></i> Dependentes
            </h3>
            
            <div id="dependentes-container">
              <!-- Dependentes serão inseridos aqui dinamicamente -->
            </div>
            
            <div style="text-align: center; margin-top: 1rem;">
              <button type="button" id="add-dependente-btn" class="add-btn">
                <i class="fas fa-plus"></i> Adicionar Dependente
              </button>
            </div>
          </div>
        </form>
      </div>

      <!-- Botão de salvar no final da página -->
      <div class="save-btn-container">
        <button type="submit" class="save-btn" id="save-btn" form="diagnostico-form">
          <i class="fas fa-save"></i>
          Salvar Diagnóstico
        </button>
      </div>
    </div>
  </div>

  <script type="module">
    import { supabase } from './supabase.js';
    
    // Elementos DOM
    const loadingEl = document.getElementById('loading');
    const errorContainer = document.getElementById('error-container');
    const successContainer = document.getElementById('success-container');
    const mainContent = document.getElementById('main-content');
    const diagnosticoTitle = document.getElementById('diagnostico-title');
    const statusBadge = document.getElementById('status-badge');
    const diagnosticoForm = document.getElementById('diagnostico-form');
    const nomeInput = document.getElementById('nome_diagnostico');
    const cpfInput = document.getElementById('cpf');
    const dataNascimentoInput = document.getElementById('data_nascimento');
    const profissaoInput = document.getElementById('profissao');
    const estadoCivilInput = document.getElementById('estado_civil');
    const regimeBensInput = document.getElementById('regime_bens');
    const telefoneInput = document.getElementById('telefone');
    const emailInput = document.getElementById('email');
    const saveBtn = document.getElementById('save-btn');
    
    // Elementos do cônjuge
    const regimeBensGroup = document.getElementById('regime-bens-group');
    const conjugeSection = document.getElementById('conjuge-section');
    const conjugeNomeInput = document.getElementById('conjuge_nome');
    const conjugeCpfInput = document.getElementById('conjuge_cpf');
    const conjugeDataNascimentoInput = document.getElementById('conjuge_data_nascimento');
    const conjugeProfissaoInput = document.getElementById('conjuge_profissao');
    const conjugeTelefoneInput = document.getElementById('conjuge_telefone');
    const conjugeEmailInput = document.getElementById('conjuge_email');
    
    // Elementos do sistema de múltiplas pessoas
    const pessoasRendaContainer = document.getElementById('pessoas-renda-container');
    const addPessoaBtn = document.getElementById('add-pessoa-btn');
    
    // Elementos do sistema de dependentes
    const dependentesContainer = document.getElementById('dependentes-container');
    const addDependenteBtn = document.getElementById('add-dependente-btn');
    
    // Variáveis globais
    let diagnosticoData = null;
    let clienteData = null;
    let pessoasRenda = [];
    let dependentes = [];
    let pessoaCounter = 0;
    let dependenteCounter = 0;
    
    // Funções utilitárias
    function showError(message) {
      errorContainer.innerHTML = `<div class="error-message"><i class="fas fa-exclamation-triangle"></i> ${message}</div>`;
      successContainer.innerHTML = '';
    }
    
    function showSuccess(message) {
      successContainer.innerHTML = `<div class="success-message"><i class="fas fa-check-circle"></i> ${message}</div>`;
      errorContainer.innerHTML = '';
    }
    
    function clearMessages() {
      errorContainer.innerHTML = '';
      successContainer.innerHTML = '';
    }

    // Funções utilitárias
    function formatarCPF(cpf) {
      cpf = cpf.replace(/\D/g, '');
      cpf = cpf.replace(/(\d{3})(\d)/, '$1.$2');
      cpf = cpf.replace(/(\d{3})(\d)/, '$1.$2');
      cpf = cpf.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
      return cpf;
    }

    function formatarTelefone(telefone) {
      telefone = telefone.replace(/\D/g, '');
      if (telefone.length <= 10) {
        telefone = telefone.replace(/(\d{2})(\d)/, '($1) $2');
        telefone = telefone.replace(/(\d{4})(\d)/, '$1-$2');
      } else {
        telefone = telefone.replace(/(\d{2})(\d)/, '($1) $2');
        telefone = telefone.replace(/(\d{5})(\d)/, '$1-$2');
      }
      return telefone;
    }

    function validarCPF(cpf) {
      cpf = cpf.replace(/\D/g, '');
      if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false;
      
      let soma = 0;
      for (let i = 0; i < 9; i++) {
        soma += parseInt(cpf.charAt(i)) * (10 - i);
      }
      let resto = 11 - (soma % 11);
      if (resto === 10 || resto === 11) resto = 0;
      if (resto !== parseInt(cpf.charAt(9))) return false;
      
      soma = 0;
      for (let i = 0; i < 10; i++) {
        soma += parseInt(cpf.charAt(i)) * (11 - i);
      }
      resto = 11 - (soma % 11);
      if (resto === 10 || resto === 11) resto = 0;
      return resto === parseInt(cpf.charAt(10));
    }

    function validarEmail(email) {
      const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return regex.test(email);
    }

    // Função para mostrar/ocultar campos do cônjuge
    function toggleConjugeFields() {
      const estadoCivil = estadoCivilInput.value;
      const showConjuge = estadoCivil === 'Casado(a)' || estadoCivil === 'União Estável';
      
      if (showConjuge) {
        regimeBensGroup.style.display = 'block';
        conjugeSection.style.display = 'block';
        conjugeNomeInput.required = true;
      } else {
        regimeBensGroup.style.display = 'none';
        conjugeSection.style.display = 'none';
        conjugeNomeInput.required = false;
        
        // Limpar campos do cônjuge quando ocultar
        regimeBensInput.value = '';
        conjugeNomeInput.value = '';
        conjugeCpfInput.value = '';
        conjugeDataNascimentoInput.value = '';
        conjugeProfissaoInput.value = '';
        conjugeTelefoneInput.value = '';
        conjugeEmailInput.value = '';
      }
    }

    // Funções para gerenciar múltiplas pessoas com renda
    function createPessoaCard(pessoa, index) {
      const pessoaId = `pessoa_${index}`;
      
      return `
        <div class="pessoa-card" data-index="${index}">
          <div class="pessoa-header">
            <h4 class="pessoa-title">
              <i class="fas fa-user"></i> ${pessoa.nome || `Pessoa ${index + 1}`}
            </h4>
            <div class="pessoa-actions">
              <button type="button" class="edit-btn" onclick="editPessoa(${index})">
                <i class="fas fa-edit"></i>
              </button>
              <button type="button" class="delete-btn" onclick="deletePessoa(${index})">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
          
          <div class="form-grid-3">
            <div class="form-group">
              <label for="${pessoaId}_nome">
                <i class="fas fa-user"></i> Nome Completo *
              </label>
              <input type="text" 
                     id="${pessoaId}_nome" 
                     name="${pessoaId}_nome" 
                     value="${pessoa.nome || ''}"
                     placeholder="Digite o nome completo"
                     required>
            </div>

            <div class="form-group">
              <label for="${pessoaId}_cpf">
                <i class="fas fa-id-card"></i> CPF
              </label>
              <input type="text" 
                     id="${pessoaId}_cpf" 
                     name="${pessoaId}_cpf" 
                     value="${pessoa.cpf || ''}"
                     placeholder="000.000.000-00"
                     maxlength="14">
            </div>

            <div class="form-group">
              <label for="${pessoaId}_data_nascimento">
                <i class="fas fa-calendar"></i> Data de Nascimento
              </label>
              <input type="date" 
                     id="${pessoaId}_data_nascimento" 
                     name="${pessoaId}_data_nascimento" 
                     value="${pessoa.data_nascimento || ''}">
            </div>

            <div class="form-group">
              <label for="${pessoaId}_profissao">
                <i class="fas fa-briefcase"></i> Profissão
              </label>
              <input type="text" 
                     id="${pessoaId}_profissao" 
                     name="${pessoaId}_profissao" 
                     value="${pessoa.profissao || ''}"
                     placeholder="Digite a profissão">
            </div>

            <div class="form-group">
              <label for="${pessoaId}_telefone">
                <i class="fas fa-phone"></i> Telefone
              </label>
              <input type="tel" 
                     id="${pessoaId}_telefone" 
                     name="${pessoaId}_telefone" 
                     value="${pessoa.telefone || ''}"
                     placeholder="(00) 00000-0000">
            </div>

            <div class="form-group">
              <label for="${pessoaId}_email">
                <i class="fas fa-envelope"></i> E-mail
              </label>
              <input type="email" 
                     id="${pessoaId}_email" 
                     name="${pessoaId}_email" 
                     value="${pessoa.email || ''}"
                     placeholder="email@exemplo.com">
            </div>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label for="${pessoaId}_estado_civil">
                <i class="fas fa-heart"></i> Estado Civil
              </label>
              <select id="${pessoaId}_estado_civil" 
                      name="${pessoaId}_estado_civil"
                      onchange="toggleConjugePessoa(${index})">
                <option value="">Selecione o estado civil</option>
                <option value="Solteiro(a)" ${pessoa.estado_civil === 'Solteiro(a)' ? 'selected' : ''}>Solteiro(a)</option>
                <option value="Casado(a)" ${pessoa.estado_civil === 'Casado(a)' ? 'selected' : ''}>Casado(a)</option>
                <option value="União Estável" ${pessoa.estado_civil === 'União Estável' ? 'selected' : ''}>União Estável</option>
                <option value="Divorciado(a)" ${pessoa.estado_civil === 'Divorciado(a)' ? 'selected' : ''}>Divorciado(a)</option>
                <option value="Viúvo(a)" ${pessoa.estado_civil === 'Viúvo(a)' ? 'selected' : ''}>Viúvo(a)</option>
              </select>
            </div>

            <div class="form-group" id="${pessoaId}_regime_bens_group" style="display: ${pessoa.estado_civil === 'Casado(a)' || pessoa.estado_civil === 'União Estável' ? 'block' : 'none'};">
              <label for="${pessoaId}_regime_bens">
                <i class="fas fa-balance-scale"></i> Regime de Bens
              </label>
              <select id="${pessoaId}_regime_bens" name="${pessoaId}_regime_bens">
                <option value="">Selecione o regime de bens</option>
                <option value="Comunhão Parcial de Bens" ${pessoa.regime_bens === 'Comunhão Parcial de Bens' ? 'selected' : ''}>Comunhão Parcial de Bens</option>
                <option value="Comunhão Universal de Bens" ${pessoa.regime_bens === 'Comunhão Universal de Bens' ? 'selected' : ''}>Comunhão Universal de Bens</option>
                <option value="Separação Total de Bens" ${pessoa.regime_bens === 'Separação Total de Bens' ? 'selected' : ''}>Separação Total de Bens</option>
                <option value="Participação Final nos Aquestos" ${pessoa.regime_bens === 'Participação Final nos Aquestos' ? 'selected' : ''}>Participação Final nos Aquestos</option>
              </select>
            </div>
          </div>

          <!-- Dados do Cônjuge da Pessoa -->
          <div id="${pessoaId}_conjuge_section" style="display: ${pessoa.estado_civil === 'Casado(a)' || pessoa.estado_civil === 'União Estável' ? 'block' : 'none'};">
            <h4 style="color: var(--accent-color); margin: 1rem 0 0.5rem 0; font-size: 1rem;">
              <i class="fas fa-users"></i> Dados do Cônjuge
            </h4>
            
            <div class="form-grid-3">
              <div class="form-group">
                <label for="${pessoaId}_conjuge_nome">
                  <i class="fas fa-user"></i> Nome do Cônjuge
                </label>
                <input type="text" 
                       id="${pessoaId}_conjuge_nome" 
                       name="${pessoaId}_conjuge_nome" 
                       value="${pessoa.conjuge_nome || ''}"
                       placeholder="Nome do cônjuge">
              </div>

              <div class="form-group">
                <label for="${pessoaId}_conjuge_cpf">
                  <i class="fas fa-id-card"></i> CPF do Cônjuge
                </label>
                <input type="text" 
                       id="${pessoaId}_conjuge_cpf" 
                       name="${pessoaId}_conjuge_cpf" 
                       value="${pessoa.conjuge_cpf || ''}"
                       placeholder="000.000.000-00"
                       maxlength="14">
              </div>

              <div class="form-group">
                <label for="${pessoaId}_conjuge_data_nascimento">
                  <i class="fas fa-calendar"></i> Data Nasc. Cônjuge
                </label>
                <input type="date" 
                       id="${pessoaId}_conjuge_data_nascimento" 
                       name="${pessoaId}_conjuge_data_nascimento" 
                       value="${pessoa.conjuge_data_nascimento || ''}">
              </div>

              <div class="form-group">
                <label for="${pessoaId}_conjuge_profissao">
                  <i class="fas fa-briefcase"></i> Profissão do Cônjuge
                </label>
                <input type="text" 
                       id="${pessoaId}_conjuge_profissao" 
                       name="${pessoaId}_conjuge_profissao" 
                       value="${pessoa.conjuge_profissao || ''}"
                       placeholder="Profissão do cônjuge">
              </div>

              <div class="form-group">
                <label for="${pessoaId}_conjuge_telefone">
                  <i class="fas fa-phone"></i> Telefone do Cônjuge
                </label>
                <input type="tel" 
                       id="${pessoaId}_conjuge_telefone" 
                       name="${pessoaId}_conjuge_telefone" 
                       value="${pessoa.conjuge_telefone || ''}"
                       placeholder="(00) 00000-0000">
              </div>

              <div class="form-group">
                <label for="${pessoaId}_conjuge_email">
                  <i class="fas fa-envelope"></i> E-mail do Cônjuge
                </label>
                <input type="email" 
                       id="${pessoaId}_conjuge_email" 
                       name="${pessoaId}_conjuge_email" 
                       value="${pessoa.conjuge_email || ''}"
                       placeholder="email@conjuge.com">
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function addPessoa() {
      const novaPessoa = {
        nome: '',
        cpf: '',
        data_nascimento: '',
        profissao: '',
        telefone: '',
        email: '',
        estado_civil: '',
        regime_bens: '',
        conjuge_nome: '',
        conjuge_cpf: '',
        conjuge_data_nascimento: '',
        conjuge_profissao: '',
        conjuge_telefone: '',
        conjuge_email: ''
      };
      
      pessoasRenda.push(novaPessoa);
      renderPessoas();
    }

    function deletePessoa(index) {
      if (confirm('Tem certeza que deseja excluir esta pessoa?')) {
        pessoasRenda.splice(index, 1);
        renderPessoas();
      }
    }

    function editPessoa(index) {
      // Função para editar pessoa (pode ser expandida futuramente)
      const pessoaCard = document.querySelector(`[data-index="${index}"]`);
      pessoaCard.scrollIntoView({ behavior: 'smooth' });
    }

    function toggleConjugePessoa(index) {
      const pessoaId = `pessoa_${index}`;
      const estadoCivilSelect = document.getElementById(`${pessoaId}_estado_civil`);
      const regimeBensGroup = document.getElementById(`${pessoaId}_regime_bens_group`);
      const conjugeSection = document.getElementById(`${pessoaId}_conjuge_section`);
      
      const estadoCivil = estadoCivilSelect.value;
      const showConjuge = estadoCivil === 'Casado(a)' || estadoCivil === 'União Estável';
      
      if (showConjuge) {
        regimeBensGroup.style.display = 'block';
        conjugeSection.style.display = 'block';
      } else {
        regimeBensGroup.style.display = 'none';
        conjugeSection.style.display = 'none';
        
        // Limpar campos do cônjuge
        document.getElementById(`${pessoaId}_regime_bens`).value = '';
        document.getElementById(`${pessoaId}_conjuge_nome`).value = '';
        document.getElementById(`${pessoaId}_conjuge_cpf`).value = '';
        document.getElementById(`${pessoaId}_conjuge_data_nascimento`).value = '';
        document.getElementById(`${pessoaId}_conjuge_profissao`).value = '';
        document.getElementById(`${pessoaId}_conjuge_telefone`).value = '';
        document.getElementById(`${pessoaId}_conjuge_email`).value = '';
      }
      
      // Atualizar dados da pessoa
      pessoasRenda[index].estado_civil = estadoCivil;
    }

    function renderPessoas() {
      pessoasRendaContainer.innerHTML = '';
      
      pessoasRenda.forEach((pessoa, index) => {
        const pessoaHTML = createPessoaCard(pessoa, index);
        pessoasRendaContainer.insertAdjacentHTML('beforeend', pessoaHTML);
        
        // Adicionar formatação automática para CPF e telefone
        const cpfInput = document.getElementById(`pessoa_${index}_cpf`);
        const telefoneInput = document.getElementById(`pessoa_${index}_telefone`);
        const conjugeCpfInput = document.getElementById(`pessoa_${index}_conjuge_cpf`);
        const conjugeTelefoneInput = document.getElementById(`pessoa_${index}_conjuge_telefone`);
        
        if (cpfInput) {
          cpfInput.addEventListener('input', function(e) {
            e.target.value = formatarCPF(e.target.value);
          });
        }
        
        if (telefoneInput) {
          telefoneInput.addEventListener('input', function(e) {
            e.target.value = formatarTelefone(e.target.value);
          });
        }
        
        if (conjugeCpfInput) {
          conjugeCpfInput.addEventListener('input', function(e) {
            e.target.value = formatarCPF(e.target.value);
          });
        }
        
        if (conjugeTelefoneInput) {
          conjugeTelefoneInput.addEventListener('input', function(e) {
            e.target.value = formatarTelefone(e.target.value);
          });
        }
      });
    }

    // Tornar funções globais para uso nos event handlers inline
    window.editPessoa = editPessoa;
    window.deletePessoa = deletePessoa;
    window.toggleConjugePessoa = toggleConjugePessoa;

    // Funções para gerenciar dependentes
    function calcularIdade(dataNascimento) {
      if (!dataNascimento) return '';
      
      const hoje = new Date();
      const nascimento = new Date(dataNascimento);
      let idade = hoje.getFullYear() - nascimento.getFullYear();
      const mesAtual = hoje.getMonth();
      const mesNascimento = nascimento.getMonth();
      
      if (mesAtual < mesNascimento || (mesAtual === mesNascimento && hoje.getDate() < nascimento.getDate())) {
        idade--;
      }
      
      if (idade < 0) return '';
      
      if (idade === 0) {
        const meses = mesAtual - mesNascimento + (hoje.getDate() >= nascimento.getDate() ? 0 : -1);
        if (meses <= 0) {
          const dias = Math.floor((hoje - nascimento) / (1000 * 60 * 60 * 24));
          return dias === 1 ? '1 dia' : `${dias} dias`;
        }
        return meses === 1 ? '1 mês' : `${meses} meses`;
      }
      
      return idade === 1 ? '1 ano' : `${idade} anos`;
    }

    function createDependenteCard(dependente, index) {
      const dependenteId = `dependente_${index}`;
      const idade = calcularIdade(dependente.data_nascimento);
      
      return `
        <div class="dependente-card" data-index="${index}">
          <div class="dependente-header">
            <h4 class="dependente-title">
              <i class="fas fa-baby"></i> ${dependente.nome || `Dependente ${index + 1}`}
              ${idade ? `<span class="idade-display">${idade}</span>` : ''}
            </h4>
            <div class="dependente-actions">
              <button type="button" class="edit-btn" onclick="editDependente(${index})">
                <i class="fas fa-edit"></i>
              </button>
              <button type="button" class="delete-btn" onclick="deleteDependente(${index})">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
          
          <div class="form-grid-3">
            <div class="form-group">
              <label for="${dependenteId}_nome">
                <i class="fas fa-user"></i> Nome Completo *
              </label>
              <input type="text" 
                     id="${dependenteId}_nome" 
                     name="${dependenteId}_nome" 
                     value="${dependente.nome || ''}"
                     placeholder="Digite o nome completo"
                     oninput="updateDependenteNome(${index})"
                     required>
            </div>

            <div class="form-group">
              <label for="${dependenteId}_data_nascimento">
                <i class="fas fa-calendar"></i> Data de Nascimento *
              </label>
              <input type="date" 
                     id="${dependenteId}_data_nascimento" 
                     name="${dependenteId}_data_nascimento" 
                     value="${dependente.data_nascimento || ''}"
                     onchange="updateDependenteIdade(${index})"
                     required>
            </div>

            <div class="form-group">
              <label for="${dependenteId}_parentesco">
                <i class="fas fa-heart"></i> Grau de Parentesco
              </label>
              <input type="text" 
                     id="${dependenteId}_parentesco" 
                     name="${dependenteId}_parentesco" 
                     value="${dependente.parentesco || ''}"
                     placeholder="Ex: filho(a), enteado(a), pet, etc.">
            </div>
          </div>
        </div>
      `;
    }

    function addDependente() {
      const novoDependente = {
        nome: '',
        data_nascimento: '',
        parentesco: ''
      };
      
      dependentes.push(novoDependente);
      renderDependentes();
    }

    function deleteDependente(index) {
      if (confirm('Tem certeza que deseja excluir este dependente?')) {
        dependentes.splice(index, 1);
        renderDependentes();
      }
    }

    function editDependente(index) {
      // Função para editar dependente (pode ser expandida futuramente)
      const dependenteCard = document.querySelector(`[data-index="${index}"]`);
      dependenteCard.scrollIntoView({ behavior: 'smooth' });
    }

    function updateDependenteNome(index) {
      const dependenteId = `dependente_${index}`;
      const nomeInput = document.getElementById(`${dependenteId}_nome`);
      
      if (nomeInput && dependentes[index]) {
        dependentes[index].nome = nomeInput.value;
        
        // Atualizar apenas o título do card, sem recriar tudo
        const dependenteCard = document.querySelector(`[data-index="${index}"]`);
        if (dependenteCard) {
          const titleElement = dependenteCard.querySelector('.dependente-title');
          if (titleElement) {
            const dataInput = document.getElementById(`${dependenteId}_data_nascimento`);
            const idade = calcularIdade(dataInput ? dataInput.value : dependentes[index].data_nascimento);
            const nomeDisplay = dependentes[index].nome || `Dependente ${index + 1}`;
            
            titleElement.innerHTML = `
              <i class="fas fa-baby"></i> ${nomeDisplay}
              ${idade ? `<span class="idade-display">${idade}</span>` : ''}
            `;
          }
        }
      }
    }

    function updateDependenteIdade(index) {
      const dependenteId = `dependente_${index}`;
      const dataInput = document.getElementById(`${dependenteId}_data_nascimento`);
      
      if (dataInput && dependentes[index]) {
        dependentes[index].data_nascimento = dataInput.value;
        
        // Atualizar apenas o título do card, sem recriar tudo
        const dependenteCard = document.querySelector(`[data-index="${index}"]`);
        if (dependenteCard) {
          const titleElement = dependenteCard.querySelector('.dependente-title');
          if (titleElement) {
            const idade = calcularIdade(dataInput.value);
            const nomeDisplay = dependentes[index].nome || `Dependente ${index + 1}`;
            
            titleElement.innerHTML = `
              <i class="fas fa-baby"></i> ${nomeDisplay}
              ${idade ? `<span class="idade-display">${idade}</span>` : ''}
            `;
          }
        }
      }
    }

    function renderDependentes() {
      dependentesContainer.innerHTML = '';
      
      dependentes.forEach((dependente, index) => {
        const dependenteHTML = createDependenteCard(dependente, index);
        dependentesContainer.insertAdjacentHTML('beforeend', dependenteHTML);
        
        // Adicionar event listeners para atualizar dados sem recriar cards
        const dependenteId = `dependente_${index}`;
        
        // Event listener para campo de parentesco
        const parentescoInput = document.getElementById(`${dependenteId}_parentesco`);
        if (parentescoInput) {
          parentescoInput.addEventListener('input', function() {
            if (dependentes[index]) {
              dependentes[index].parentesco = this.value;
            }
          });
        }
      });
    }

    // Tornar funções de dependentes globais
    window.editDependente = editDependente;
    window.deleteDependente = deleteDependente;
    window.updateDependenteNome = updateDependenteNome;
    window.updateDependenteIdade = updateDependenteIdade;
    
    function formatName(name) {
      if (!name) return '';
      return name.split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
        .join(' ');
    }
    
    function getFirstAndLastName(fullName) {
      if (!fullName) return '';
      const names = fullName.trim().split(' ');
      if (names.length === 1) return formatName(names[0]);
      return formatName(names[0] + ' ' + names[names.length - 1]);
    }
    
    function buildDiagnosticoTitle(cliente) {
      let title = 'Diagnóstico Financeiro ';
      
      // Nome principal
      if (cliente.nome) {
        title += getFirstAndLastName(cliente.nome);
      }
      
      // Outras pessoas com renda
      if (cliente.outras_pessoas_renda && cliente.outras_pessoas_renda.trim()) {
        const outrasRenda = cliente.outras_pessoas_renda.split(',')
          .map(nome => getFirstAndLastName(nome.trim()))
          .filter(nome => nome)
          .join(' + ');
        
        if (outrasRenda) {
          title += ' + ' + outrasRenda;
        }
      }
      
      return title;
    }
    
    function updateStatusBadge(status) {
      statusBadge.className = 'status-badge';
      if (status === 'finalizado') {
        statusBadge.classList.add('status-finalizado');
        statusBadge.textContent = 'Finalizado';
      } else {
        statusBadge.classList.add('status-em-andamento');
        statusBadge.textContent = 'Em Andamento';
      }
    }
    
    // Função para obter link único da URL
    function getLinkUnico() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('link');
    }
    
    // Função para carregar dados do diagnóstico
    async function loadDiagnostico() {
      try {
        const linkUnico = getLinkUnico();
        
        if (!linkUnico) {
          throw new Error('Link de diagnóstico não encontrado na URL');
        }
        
      // Buscar diagnóstico pelo link único
        const { data: diagnostico, error: diagError } = await supabase
          .from('diagnosticos_financeiros')
          .select(`
            *,
            clientes (
              id,
              nome
            )
          `)
          .eq('link_unico', linkUnico)
          .single();

        
        if (diagError) throw diagError;
        
        if (!diagnostico) {
          throw new Error('Diagnóstico não encontrado');
        }
        
        diagnosticoData = diagnostico;
        clienteData = diagnostico.clientes;
        
        // Atualizar título
        const title = buildDiagnosticoTitle(clienteData);
        diagnosticoTitle.textContent = title;
        
        // Atualizar status
        updateStatusBadge(diagnostico.status);
        
        // Pré-preencher campos (do formulário ou do diagnóstico)
        nomeInput.value = diagnostico.nome_diagnostico || clienteData.nome || '';
        cpfInput.value = diagnostico.cpf || '';
        dataNascimentoInput.value = diagnostico.data_nascimento || '';
        profissaoInput.value = diagnostico.profissao || '';
        estadoCivilInput.value = diagnostico.estado_civil || '';
        regimeBensInput.value = diagnostico.regime_bens || '';
        telefoneInput.value = diagnostico.telefone || '';
        emailInput.value = diagnostico.email || '';
        
        // Campos do cônjuge
        conjugeNomeInput.value = diagnostico.conjuge_nome || '';
        conjugeCpfInput.value = diagnostico.conjuge_cpf || '';
        conjugeDataNascimentoInput.value = diagnostico.conjuge_data_nascimento || '';
        conjugeProfissaoInput.value = diagnostico.conjuge_profissao || '';
        conjugeTelefoneInput.value = diagnostico.conjuge_telefone || '';
        conjugeEmailInput.value = diagnostico.conjuge_email || '';
        
        // Carregar pessoas com renda se existirem
        if (diagnostico.pessoas_renda) {
          try {
            pessoasRenda = JSON.parse(diagnostico.pessoas_renda);
            renderPessoas();
          } catch (e) {
            console.log('Erro ao carregar pessoas com renda:', e);
            pessoasRenda = [];
          }
        }
        
        // Carregar dependentes se existirem
        if (diagnostico.dependentes) {
          try {
            dependentes = JSON.parse(diagnostico.dependentes);
            renderDependentes();
          } catch (e) {
            console.log('Erro ao carregar dependentes:', e);
            dependentes = [];
          }
        }
        
        // Mostrar campos do cônjuge se necessário
        toggleConjugeFields();
        
        return diagnostico;
        
      } catch (error) {
        console.error('Erro ao carregar diagnóstico:', error);
        throw error;
      }
    }
    
    // Função para salvar diagnóstico
    async function saveDiagnostico(event) {
      event.preventDefault();
      
      // Validações
      clearMessages();
      
      // Validar CPF
      if (!validarCPF(cpfInput.value)) {
        showError('CPF inválido. Por favor, digite um CPF válido.');
        cpfInput.focus();
        return;
      }
      
      // Validar data de nascimento (não pode ser futura)
      const dataNasc = new Date(dataNascimentoInput.value);
      const hoje = new Date();
      if (dataNasc >= hoje) {
        showError('Data de nascimento não pode ser futura.');
        dataNascimentoInput.focus();
        return;
      }
      
      // Validar idade mínima (18 anos)
      const idade = hoje.getFullYear() - dataNasc.getFullYear();
      if (idade < 18) {
        showError('É necessário ter pelo menos 18 anos.');
        dataNascimentoInput.focus();
        return;
      }
      
      // Validar e-mail se preenchido
      if (emailInput.value && !validarEmail(emailInput.value)) {
        showError('E-mail inválido. Por favor, digite um e-mail válido.');
        emailInput.focus();
        return;
      }
      
      // Validar CPF do cônjuge se preenchido
      if (conjugeCpfInput.value && !validarCPF(conjugeCpfInput.value)) {
        showError('CPF do cônjuge inválido. Por favor, digite um CPF válido.');
        conjugeCpfInput.focus();
        return;
      }
      
      // Validar e-mail do cônjuge se preenchido
      if (conjugeEmailInput.value && !validarEmail(conjugeEmailInput.value)) {
        showError('E-mail do cônjuge inválido. Por favor, digite um e-mail válido.');
        conjugeEmailInput.focus();
        return;
      }
      
      // Validar nome do cônjuge se campos do cônjuge estão visíveis
      const estadoCivil = estadoCivilInput.value;
      const showConjuge = estadoCivil === 'Casado(a)' || estadoCivil === 'União Estável';
      if (showConjuge && !conjugeNomeInput.value.trim()) {
        showError('Nome do cônjuge é obrigatório para pessoas casadas ou em união estável.');
        conjugeNomeInput.focus();
        return;
      }
      
      // Coletar dados das pessoas com renda
      const pessoasRendaData = [];
      pessoasRenda.forEach((pessoa, index) => {
        const pessoaId = `pessoa_${index}`;
        const pessoaData = {
          nome: document.getElementById(`${pessoaId}_nome`)?.value.trim() || '',
          cpf: document.getElementById(`${pessoaId}_cpf`)?.value.replace(/\D/g, '') || '',
          data_nascimento: document.getElementById(`${pessoaId}_data_nascimento`)?.value || '',
          profissao: document.getElementById(`${pessoaId}_profissao`)?.value.trim() || '',
          telefone: document.getElementById(`${pessoaId}_telefone`)?.value.replace(/\D/g, '') || '',
          email: document.getElementById(`${pessoaId}_email`)?.value.trim() || '',
          estado_civil: document.getElementById(`${pessoaId}_estado_civil`)?.value || '',
          regime_bens: document.getElementById(`${pessoaId}_regime_bens`)?.value || '',
          conjuge_nome: document.getElementById(`${pessoaId}_conjuge_nome`)?.value.trim() || '',
          conjuge_cpf: document.getElementById(`${pessoaId}_conjuge_cpf`)?.value.replace(/\D/g, '') || '',
          conjuge_data_nascimento: document.getElementById(`${pessoaId}_conjuge_data_nascimento`)?.value || '',
          conjuge_profissao: document.getElementById(`${pessoaId}_conjuge_profissao`)?.value.trim() || '',
          conjuge_telefone: document.getElementById(`${pessoaId}_conjuge_telefone`)?.value.replace(/\D/g, '') || '',
          conjuge_email: document.getElementById(`${pessoaId}_conjuge_email`)?.value.trim() || ''
        };
        
        // Validar nome obrigatório para pessoas com renda
        if (!pessoaData.nome) {
          showError(`Nome é obrigatório para a Pessoa ${index + 1}.`);
          document.getElementById(`${pessoaId}_nome`)?.focus();
          return;
        }
        
        pessoasRendaData.push(pessoaData);
      });
      
      // Coletar dados dos dependentes
      const dependentesData = [];
      dependentes.forEach((dependente, index) => {
        const dependenteId = `dependente_${index}`;
        const dependenteData = {
          nome: document.getElementById(`${dependenteId}_nome`)?.value.trim() || '',
          data_nascimento: document.getElementById(`${dependenteId}_data_nascimento`)?.value || '',
          parentesco: document.getElementById(`${dependenteId}_parentesco`)?.value.trim() || ''
        };
        
        // Validar campos obrigatórios para dependentes
        if (!dependenteData.nome) {
          showError(`Nome é obrigatório para o Dependente ${index + 1}.`);
          document.getElementById(`${dependenteId}_nome`)?.focus();
          return;
        }
        
        if (!dependenteData.data_nascimento) {
          showError(`Data de nascimento é obrigatória para o Dependente ${index + 1}.`);
          document.getElementById(`${dependenteId}_data_nascimento`)?.focus();
          return;
        }
        
        dependentesData.push(dependenteData);
      });
      
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
      
      try {
        const dataToSave = {
          nome_diagnostico: nomeInput.value.trim(),
          cpf: cpfInput.value.replace(/\D/g, ''), // Salvar só números
          data_nascimento: dataNascimentoInput.value,
          profissao: profissaoInput.value.trim(),
          estado_civil: estadoCivilInput.value,
          regime_bens: regimeBensInput.value,
          telefone: telefoneInput.value.replace(/\D/g, ''), // Salvar só números
          email: emailInput.value.trim(),
          conjuge_nome: conjugeNomeInput.value.trim(),
          conjuge_cpf: conjugeCpfInput.value.replace(/\D/g, ''), // Salvar só números
          conjuge_data_nascimento: conjugeDataNascimentoInput.value || null,
          conjuge_profissao: conjugeProfissaoInput.value.trim(),
          conjuge_telefone: conjugeTelefoneInput.value.replace(/\D/g, ''), // Salvar só números
          conjuge_email: conjugeEmailInput.value.trim(),
          pessoas_renda: JSON.stringify(pessoasRendaData), // Salvar como JSON
          dependentes: JSON.stringify(dependentesData) // Salvar como JSON
        };
        
        const { data, error } = await supabase
          .from('diagnosticos_financeiros')
          .update(dataToSave)
          .eq('id', diagnosticoData.id)
          .select();
        
        if (error) throw error;
        
        showSuccess('Diagnóstico salvo com sucesso!');
        
        // Atualizar dados locais
        diagnosticoData = { ...diagnosticoData, ...dataToSave };
        
      } catch (error) {
        console.error('Erro ao salvar diagnóstico:', error);
        showError('Erro ao salvar diagnóstico: ' + error.message);
      } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-save"></i> Salvar Diagnóstico';
      }
    }
    
    // Inicialização
    document.addEventListener("DOMContentLoaded", async () => {
      try {
        await loadDiagnostico();
        
        // Mostrar conteúdo principal e esconder loading
        loadingEl.style.display = 'none';
        mainContent.style.display = 'block';
        
        // Adicionar listener para o formulário
        diagnosticoForm.addEventListener('submit', saveDiagnostico);
        
        // Adicionar formatação automática do CPF
        cpfInput.addEventListener('input', function(e) {
          e.target.value = formatarCPF(e.target.value);
        });
        
        // Adicionar formatação automática do CPF do cônjuge
        conjugeCpfInput.addEventListener('input', function(e) {
          e.target.value = formatarCPF(e.target.value);
        });
        
        // Adicionar formatação automática do telefone do cônjuge
        conjugeTelefoneInput.addEventListener('input', function(e) {
          e.target.value = formatarTelefone(e.target.value);
        });
        
        // Adicionar listener para mudança de estado civil
        estadoCivilInput.addEventListener('change', toggleConjugeFields);
        
        // Adicionar listener para botão de adicionar pessoa
        addPessoaBtn.addEventListener('click', addPessoa);
        
        // Adicionar listener para botão de adicionar dependente
        addDependenteBtn.addEventListener('click', addDependente);
        
      } catch (error) {
        loadingEl.style.display = 'none';
        showError('Erro ao carregar diagnóstico: ' + error.message);
      }
    });
  </script>
</body>
</html>

