<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Fluxo de Caixa HVC - Administrador</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Tema espec√≠fico HVC - Paleta original */
        body {
            display: flex;
            margin: 0;
            min-height: 100vh;
            background: linear-gradient(135deg, #000080, #800080);
            color: #e0e0e0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        #main-content-fluxo-caixa-hvc-admin {
            flex-grow: 1;
            padding: 1rem;
            transition: margin-left 0.3s ease;
            background: linear-gradient(135deg, #000080, #800080);
            color: #e0e0e0;
            overflow-y: auto;
        }

        #main-content-fluxo-caixa-hvc-admin.sidebar-collapsed {
            margin-left: 60px;
        }

        .hvc-container {
            background: rgba(25, 25, 112, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 8px 32px rgba(0, 0, 128, 0.3);
            backdrop-filter: blur(10px);
        }

        .hvc-title {
            color: #ffffff;
            font-size: 1.8rem;
            margin-bottom: 1rem;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        /* Header com bot√£o OpenFinance */
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .openfinance-btn {
            background: rgba(255, 255, 255, 0.2);
            color: #ffffff;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 0.7rem 1.2rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .openfinance-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(255, 255, 255, 0.2);
        }

        /* Layout REDIMENSION√ÅVEL em duas colunas */
        .content-layout {
            display: flex;
            gap: 1rem;
            height: calc(100vh - 200px);
            position: relative;
        }

        /* Calend√°rio REDIMENSION√ÅVEL */
        .calendar-container {
            background: rgba(25, 25, 112, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 8px 32px rgba(0, 0, 128, 0.3);
            backdrop-filter: blur(10px);
            /* REDIMENSION√ÅVEL */
            resize: horizontal;
            overflow: auto;
            min-width: 300px;
            max-width: 70%;
            width: 50%;
        }

        /* Lista REDIMENSION√ÅVEL */
        .list-container {
            background: rgba(25, 25, 112, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 8px 32px rgba(0, 0, 128, 0.3);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            /* REDIMENSION√ÅVEL */
            resize: horizontal;
            overflow: auto;
            min-width: 300px;
            flex: 1;
        }

        /* DIVISOR REDIMENSION√ÅVEL */
        .resize-handle {
            width: 10px;
            background: rgba(255, 255, 255, 0.1);
            cursor: col-resize;
            border-radius: 5px;
            transition: background 0.3s;
            position: relative;
        }

        .resize-handle:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .resize-handle::before {
            content: '‚ãÆ‚ãÆ';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: rgba(255, 255, 255, 0.5);
            font-size: 1.2rem;
            line-height: 0.5;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0.5rem;
        }

        .calendar-nav {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #ffffff;
            padding: 0.5rem;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .calendar-nav:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .calendar-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #ffffff;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        .calendar-day-header {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.5rem;
            text-align: center;
            font-weight: bold;
            font-size: 0.8rem;
            color: #ffffff;
        }

        .calendar-day {
            background: rgba(255, 255, 255, 0.05);
            padding: 0.3rem;
            min-height: 60px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .calendar-day:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-1px);
        }

        .calendar-day.other-month {
            opacity: 0.3;
        }

        .calendar-day.today {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid #ffffff;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }

        .calendar-day.has-events {
            background: rgba(255, 255, 255, 0.1);
        }

        .calendar-day-number {
            font-size: 0.8rem;
            margin-bottom: 0.2rem;
            color: #ffffff;
        }

        .calendar-event {
            background: rgba(255, 255, 255, 0.8);
            color: #000080;
            font-size: 0.6rem;
            padding: 1px 3px;
            border-radius: 3px;
            margin-bottom: 1px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-weight: bold;
            position: relative;
        }

        .calendar-event.pagamento {
            background: rgba(255, 255, 255, 0.9);
            color: #800080;
        }

        .calendar-event.compromisso {
            background: rgba(255, 255, 255, 0.7);
            color: #000080;
        }

        /* INDICADOR DE RECORR√äNCIA */
        .calendar-event.recorrente::after {
            content: 'üîÑ';
            position: absolute;
            right: 2px;
            top: 0;
            font-size: 0.5rem;
        }

        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .list-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #ffffff;
        }

        .add-btn {
            background: rgba(255, 255, 255, 0.2);
            color: #ffffff;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: bold;
        }

        .add-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .filters {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .filter-input, .filter-select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ffffff;
            padding: 0.3rem;
            border-radius: 5px;
            font-size: 0.8rem;
        }

        .filter-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .filter-select option {
            background: #000080;
            color: #ffffff;
        }

        .items-list {
            flex-grow: 1;
            overflow-y: auto;
            max-height: 400px;
        }

        .item-card {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 0.8rem;
            margin-bottom: 0.5rem;
            transition: all 0.3s;
            position: relative;
        }

        .item-card:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(255, 255, 255, 0.1);
        }

        /* INDICADOR DE RECORR√äNCIA NO CARD */
        .item-card.recorrente::before {
            content: 'üîÑ';
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            font-size: 1rem;
            opacity: 0.7;
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .item-title {
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 0.2rem;
        }

        .item-type {
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            text-transform: uppercase;
            font-weight: bold;
        }

        .item-type.compromisso {
            background: rgba(255, 255, 255, 0.8);
            color: #000080;
        }

        .item-type.pagamento {
            background: rgba(255, 255, 255, 0.9);
            color: #800080;
        }

        .item-details {
            font-size: 0.8rem;
            color: #ffffff;
            margin-bottom: 0.5rem;
            opacity: 0.9;
        }

        .item-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .status-select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ffffff;
            padding: 0.2rem;
            border-radius: 3px;
            font-size: 0.7rem;
        }

        .status-select option {
            background: #000080;
            color: #ffffff;
        }

        .item-actions {
            display: flex;
            gap: 0.5rem;
        }

        .action-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ffffff;
            padding: 0.3rem 0.6rem;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.7rem;
            transition: all 0.3s;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .last-update {
            font-size: 0.6rem;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 0.3rem;
        }

        /* INFORMA√á√ïES DE RECORR√äNCIA */
        .recurrence-info {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.8);
            background: rgba(255, 255, 255, 0.1);
            padding: 0.3rem;
            border-radius: 3px;
            margin-top: 0.3rem;
        }

        /* Modal - CORRIGIDO PARA SER REDIMENSION√ÅVEL */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
        }

        .modal-content {
            background: linear-gradient(135deg, #000080, #800080);
            margin: 2% auto;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 700px;
            min-width: 400px;
            max-height: 90vh;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 128, 0.3);
            backdrop-filter: blur(10px);
            /* PERMITIR REDIMENSIONAMENTO */
            resize: both;
            overflow: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .modal-title {
            color: #ffffff;
            font-size: 1.3rem;
        }

        .close {
            color: #ffffff;
            font-size: 1.5rem;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .close:hover {
            opacity: 0.7;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            color: #ffffff;
            margin-bottom: 0.3rem;
            font-size: 0.9rem;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ffffff;
            padding: 0.5rem;
            border-radius: 5px;
            font-size: 0.9rem;
            box-sizing: border-box;
        }

        .form-input::placeholder, .form-textarea::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .form-select option {
            background: #000080;
            color: #ffffff;
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* CAMPO VALOR COM FORMATA√á√ÉO DE MOEDA */
        .currency-input {
            position: relative;
        }

        .currency-input::before {
            content: 'R$';
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.8);
            font-weight: bold;
            z-index: 1;
        }

        .currency-input input {
            padding-left: 35px;
            text-align: right;
        }

        /* CAMPOS DE RECORR√äNCIA */
        .recurrence-group {
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            background: rgba(255, 255, 255, 0.05);
        }

        .recurrence-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .recurrence-checkbox {
            width: auto;
            margin-right: 0.5rem;
        }

        .recurrence-fields {
            display: none;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 0.5rem;
            align-items: end;
        }

        .recurrence-fields.active {
            display: grid;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            font-weight: bold;
        }

        .btn-primary {
            background: rgba(255, 255, 255, 0.2);
            color: #ffffff;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-primary:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        /* Loading e Error */
        .loading {
            text-align: center;
            padding: 2rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .error {
            text-align: center;
            padding: 2rem;
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.3);
            border-radius: 8px;
            margin: 1rem 0;
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .content-layout {
                flex-direction: column;
                height: auto;
            }
            
            .calendar-container, .list-container {
                resize: none;
                width: 100%;
                max-width: 100%;
            }
            
            .resize-handle {
                display: none;
            }
            
            .calendar-day {
                min-height: 40px;
                font-size: 0.7rem;
            }
            
            .filters {
                flex-direction: column;
            }

            .admin-header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }

            .modal-content {
                width: 95%;
                margin: 5% auto;
                min-width: 300px;
            }

            .recurrence-fields {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar ser√° injetada aqui pelo sidebar.js -->
    <main id="main-content-fluxo-caixa-hvc-admin">
        <div class="hvc-container">
            <div class="admin-header">
                <h1 class="hvc-title">
                    <i class="fas fa-chart-line"></i> Fluxo de Caixa - Administrador
                </h1>
                <button class="openfinance-btn" id="openFinanceBtn">
                    <i class="fas fa-university"></i>
                    OpenFinance
                </button>
            </div>
        </div>

        <div class="content-layout">
            <!-- Calend√°rio √† esquerda - REDIMENSION√ÅVEL -->
            <div class="calendar-container" id="calendarContainer">
                <div class="calendar-header">
                    <button class="calendar-nav" id="prevMonth">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div class="calendar-title" id="calendarTitle">
                        Agosto 2025
                    </div>
                    <button class="calendar-nav" id="nextMonth">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div class="calendar-grid" id="calendarGrid">
                    <!-- Cabe√ßalhos dos dias da semana - COME√áAR NA SEGUNDA -->
                    <div class="calendar-day-header">Seg</div>
                    <div class="calendar-day-header">Ter</div>
                    <div class="calendar-day-header">Qua</div>
                    <div class="calendar-day-header">Qui</div>
                    <div class="calendar-day-header">Sex</div>
                    <div class="calendar-day-header">S√°b</div>
                    <div class="calendar-day-header">Dom</div>
                    <!-- Dias ser√£o gerados dinamicamente -->
                </div>
            </div>

            <!-- Divisor redimension√°vel -->
            <div class="resize-handle" id="resizeHandle"></div>

            <!-- Lista de compromissos e pagamentos √† direita - REDIMENSION√ÅVEL -->
            <div class="list-container" id="listContainer">
                <div class="list-header">
                    <div class="list-title">Compromissos e Pagamentos</div>
                    <button class="add-btn" id="addItemBtn">
                        <i class="fas fa-plus"></i> Adicionar
                    </button>
                </div>

                <div class="filters">
                    <input type="text" class="filter-input" id="searchFilter" placeholder="Buscar...">
                    <select class="filter-select" id="typeFilter">
                        <option value="">Todos os tipos</option>
                        <option value="compromisso">Compromissos</option>
                        <option value="pagamento">Pagamentos</option>
                    </select>
                    <select class="filter-select" id="statusFilter">
                        <option value="">Todos os status</option>
                        <option value="pendente">Pendente</option>
                        <option value="confirmado">Confirmado</option>
                        <option value="pago">Pago</option>
                        <option value="cancelado">Cancelado</option>
                        <option value="vencido">Vencido</option>
                    </select>
                    <input type="date" class="filter-input" id="dateFilter">
                </div>

                <div class="items-list" id="itemsList">
                    <div class="loading">Carregando itens...</div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal para adicionar/editar item -->
    <div id="itemModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Adicionar Item</h2>
                <span class="close" id="closeModal">&times;</span>
            </div>
            <form id="itemForm">
                <div class="form-group">
                    <label class="form-label" for="itemTitulo">T√≠tulo *</label>
                    <input type="text" class="form-input" id="itemTitulo" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="itemTipo">Tipo *</label>
                    <select class="form-select" id="itemTipo" required>
                        <option value="">Selecione...</option>
                        <option value="compromisso">Compromisso</option>
                        <option value="pagamento">Pagamento</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="itemCategoria">Categoria</label>
                    <input type="text" class="form-input" id="itemCategoria" placeholder="Ex: Reuni√£o, Fornecedor, Sal√°rio...">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="itemData">Data *</label>
                    <input type="date" class="form-input" id="itemData" required>
                </div>
                
                <!-- CAMPO HORA S√ì PARA COMPROMISSOS -->
                <div class="form-group" id="horaGroup" style="display: none;">
                    <label class="form-label" for="itemHora">Hora</label>
                    <input type="time" class="form-input" id="itemHora">
                </div>
                
                <!-- CAMPO VALOR S√ì PARA PAGAMENTOS -->
                <div class="form-group" id="valorGroup" style="display: none;">
                    <label class="form-label" for="itemValor">Valor (R$)</label>
                    <div class="currency-input">
                        <input type="text" class="form-input" id="itemValor" placeholder="0,00">
                    </div>
                </div>

                <!-- CAMPOS DE RECORR√äNCIA -->
                <div class="recurrence-group">
                    <div class="recurrence-header">
                        <input type="checkbox" class="recurrence-checkbox" id="recorrenciaAtiva">
                        <label class="form-label" for="recorrenciaAtiva">
                            <i class="fas fa-redo"></i> Repetir este item
                        </label>
                    </div>
                    
                    <div class="recurrence-fields" id="recurrenceFields">
                        <div class="form-group">
                            <label class="form-label" for="recorrenciaNumero">A cada</label>
                            <input type="number" class="form-input" id="recorrenciaNumero" min="1" max="365" value="1">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="recorrenciaUnidade">Per√≠odo</label>
                            <select class="form-select" id="recorrenciaUnidade">
                                <option value="dias">Dias</option>
                                <option value="dias_uteis">Dias √∫teis</option>
                                <option value="semanas">Semanas</option>
                                <option value="quinzenas">Quinzenas</option>
                                <option value="meses">Meses</option>
                                <option value="anos">Anos</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="recorrenciaFim">At√© (opcional)</label>
                            <input type="date" class="form-input" id="recorrenciaFim">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="itemStatus">Status</label>
                    <select class="form-select" id="itemStatus">
                        <option value="pendente">Pendente</option>
                        <option value="confirmado">Confirmado</option>
                        <option value="pago">Pago</option>
                        <option value="cancelado">Cancelado</option>
                        <option value="vencido">Vencido</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="itemPrioridade">Prioridade</label>
                    <select class="form-select" id="itemPrioridade">
                        <option value="baixa">Baixa</option>
                        <option value="media">M√©dia</option>
                        <option value="alta">Alta</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="itemDescricao">Descri√ß√£o</label>
                    <textarea class="form-textarea" id="itemDescricao" placeholder="Detalhes adicionais..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="itemObservacoes">Observa√ß√µes</label>
                    <textarea class="form-textarea" id="itemObservacoes" placeholder="Observa√ß√µes internas..."></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelBtn">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="saveBtn">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module" src="supabase.js"></script>
    <script type="module" src="fluxo-caixa-hvc.js"></script>
    <script type="module">
        import { injectSidebar } from './sidebar.js';
        injectSidebar("main-content-fluxo-caixa-hvc-admin");
    </script>
    
    <script type="module">
        // Importar cliente Supabase - INTEGRA√á√ÉO REAL
        import { supabase } from './supabase.js';
        
        // Vari√°veis globais
        let currentDate = new Date();
        let currentUser = sessionStorage.getItem('usuario') || 'admin';
        let editingItemId = null;
        let agendaItems = [];

        // Inicializar quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            setupCurrencyMask();
            setupRecurrenceToggle();
            setupResizeHandles(); // CONFIGURAR REDIMENSIONAMENTO
            loadAgendaItems();
            renderCalendar();
        });

        // CONFIGURAR REDIMENSIONAMENTO DOS QUADROS
        function setupResizeHandles() {
            const resizeHandle = document.getElementById('resizeHandle');
            const calendarContainer = document.getElementById('calendarContainer');
            const listContainer = document.getElementById('listContainer');
            const contentLayout = document.querySelector('.content-layout');
            
            let isResizing = false;
            
            resizeHandle.addEventListener('mousedown', function(e) {
                isResizing = true;
                document.addEventListener('mousemove', handleResize);
                document.addEventListener('mouseup', stopResize);
                e.preventDefault();
            });
            
            function handleResize(e) {
                if (!isResizing) return;
                
                const containerRect = contentLayout.getBoundingClientRect();
                const mouseX = e.clientX - containerRect.left;
                const containerWidth = containerRect.width;
                
                // Calcular porcentagens
                const calendarPercent = (mouseX / containerWidth) * 100;
                const listPercent = 100 - calendarPercent;
                
                // Limites m√≠nimos e m√°ximos
                if (calendarPercent >= 20 && calendarPercent <= 80) {
                    calendarContainer.style.width = calendarPercent + '%';
                    listContainer.style.width = listPercent + '%';
                }
            }
            
            function stopResize() {
                isResizing = false;
                document.removeEventListener('mousemove', handleResize);
                document.removeEventListener('mouseup', stopResize);
            }
        }

        // CONFIGURAR TOGGLE DE RECORR√äNCIA
        function setupRecurrenceToggle() {
            const checkbox = document.getElementById('recorrenciaAtiva');
            const fields = document.getElementById('recurrenceFields');
            
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    fields.classList.add('active');
                } else {
                    fields.classList.remove('active');
                }
            });
        }

        // CONFIGURAR M√ÅSCARA DE MOEDA BRASILEIRA
        function setupCurrencyMask() {
            const valorInput = document.getElementById('itemValor');
            
            valorInput.addEventListener('input', function(e) {
                let value = e.target.value;
                value = value.replace(/\D/g, '');
                value = (parseInt(value) / 100).toFixed(2);
                value = value.replace('.', ',');
                value = value.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
                e.target.value = value;
            });

            valorInput.addEventListener('focus', function(e) {
                if (e.target.value === '' || e.target.value === '0,00') {
                    e.target.value = '';
                }
            });

            valorInput.addEventListener('blur', function(e) {
                if (e.target.value === '') {
                    e.target.value = '0,00';
                }
            });
        }

        // CONVERTER VALOR FORMATADO PARA N√öMERO
        function parseFormattedCurrency(formattedValue) {
            if (!formattedValue || formattedValue === '0,00') return null;
            const numericValue = formattedValue.replace(/\./g, '').replace(',', '.');
            return parseFloat(numericValue);
        }

        // FORMATAR N√öMERO PARA MOEDA BRASILEIRA
        function formatCurrency(value) {
            if (!value) return '0,00';
            return new Intl.NumberFormat('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        // GERAR PR√ìXIMO HOR√ÅRIO PARA PAGAMENTO - CORRIGIDA
        async function generateNextPaymentTime(dataEvento) {
            try {
                // Buscar pagamentos existentes na mesma data
                const { data: existingPayments, error } = await supabase
                    .from('agenda_hvc')
                    .select('hora_evento')
                    .eq('data_evento', dataEvento)
                    .eq('tipo', 'pagamento')
                    .not('hora_evento', 'is', null);
                
                if (error) {
                    console.error('Erro ao buscar pagamentos existentes:', error);
                    return '09:00'; // Fallback
                }
                
                const count = existingPayments ? existingPayments.length : 0;
                const baseHour = 9; // Come√ßar √†s 9:00
                const minutes = count % 60;
                const hours = baseHour + Math.floor(count / 60);
                
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                
            } catch (error) {
                console.error('Erro ao gerar hor√°rio:', error);
                return '09:00'; // Fallback
            }
        }

        // CALCULAR PR√ìXIMA DATA DE RECORR√äNCIA - CORRIGIDO
        function calculateNextRecurrenceDate(baseDate, numero, unidade) {
            const date = new Date(baseDate + 'T00:00:00'); // CORRIGIR TIMEZONE
            
            switch (unidade) {
                case 'dias':
                    date.setDate(date.getDate() + numero);
                    break;
                case 'dias_uteis':
                    let addedDays = 0;
                    while (addedDays < numero) {
                        date.setDate(date.getDate() + 1);
                        // Se n√£o for s√°bado (6) nem domingo (0)
                        if (date.getDay() !== 0 && date.getDay() !== 6) {
                            addedDays++;
                        }
                    }
                    break;
                case 'semanas':
                    date.setDate(date.getDate() + (numero * 7));
                    break;
                case 'quinzenas':
                    date.setDate(date.getDate() + (numero * 15));
                    break;
                case 'meses':
                    date.setMonth(date.getMonth() + numero);
                    break;
                case 'anos':
                    date.setFullYear(date.getFullYear() + numero);
                    break;
            }
            
            return date;
        }

        // GERAR EVENTOS RECORRENTES - CORRIGIDO
        async function generateRecurrentEvents(baseItem) {
            if (!baseItem.recorrencia_ativa) return [];
            
            console.log('Gerando eventos recorrentes para:', baseItem);
            
            const events = [];
            const startDate = baseItem.data_evento; // String no formato YYYY-MM-DD
            const endDate = baseItem.recorrencia_fim;
            const maxEvents = 50; // Reduzir limite para debug
            
            let currentDate = calculateNextRecurrenceDate(
                startDate, 
                baseItem.recorrencia_numero, 
                baseItem.recorrencia_unidade
            );
            
            let eventCount = 0;
            
            console.log('Data inicial:', startDate);
            console.log('Primeira recorr√™ncia calculada:', currentDate.toISOString().split('T')[0]);
            
            while (eventCount < maxEvents) {
                const currentDateStr = currentDate.toISOString().split('T')[0];
                
                // Se h√° data fim e j√° passou, parar
                if (endDate && currentDateStr > endDate) {
                    console.log('Data fim atingida:', endDate);
                    break;
                }
                
                // Se a data √© muito no futuro (1 ano), parar
                const oneYearFromNow = new Date();
                oneYearFromNow.setFullYear(oneYearFromNow.getFullYear() + 1);
                if (currentDate > oneYearFromNow) {
                    console.log('Limite de 1 ano atingido');
                    break;
                }
                
                // Gerar hor√°rio para pagamentos recorrentes
                let horaEvento = baseItem.hora_evento;
                if (baseItem.tipo === 'pagamento' && !horaEvento) {
                    horaEvento = await generateNextPaymentTime(currentDateStr);
                }
                
                const newEvent = {
                    titulo: baseItem.titulo,
                    tipo: baseItem.tipo,
                    categoria: baseItem.categoria,
                    data_evento: currentDateStr,
                    hora_evento: horaEvento,
                    valor: baseItem.valor,
                    status: baseItem.status,
                    prioridade: baseItem.prioridade,
                    descricao: baseItem.descricao,
                    observacoes: baseItem.observacoes,
                    evento_pai_id: baseItem.id,
                    eh_recorrente: true,
                    recorrencia_ativa: false, // Eventos filhos n√£o geram mais recorr√™ncias
                    recorrencia_numero: null,
                    recorrencia_unidade: null,
                    recorrencia_fim: null,
                    criado_por: baseItem.criado_por,
                    criado_em: new Date().toISOString(),
                    atualizado_por: baseItem.atualizado_por,
                    atualizado_em: new Date().toISOString()
                };
                
                events.push(newEvent);
                console.log(`Evento ${eventCount + 1} gerado:`, currentDateStr);
                
                // Calcular pr√≥xima data
                currentDate = calculateNextRecurrenceDate(
                    currentDateStr, 
                    baseItem.recorrencia_numero, 
                    baseItem.recorrencia_unidade
                );
                
                eventCount++;
            }
            
            console.log(`Total de eventos gerados: ${events.length}`);
            return events;
        }

        // Configurar event listeners
        function setupEventListeners() {
            // Navega√ß√£o do calend√°rio
            document.getElementById('prevMonth').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar();
            });

            document.getElementById('nextMonth').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar();
            });

            // Modal
            document.getElementById('addItemBtn').addEventListener('click', openAddModal);
            document.getElementById('closeModal').addEventListener('click', closeModal);
            document.getElementById('cancelBtn').addEventListener('click', closeModal);
            document.getElementById('itemForm').addEventListener('submit', saveItem);

            // Filtros
            document.getElementById('searchFilter').addEventListener('input', filterItems);
            document.getElementById('typeFilter').addEventListener('change', filterItems);
            document.getElementById('statusFilter').addEventListener('change', filterItems);
            document.getElementById('dateFilter').addEventListener('change', filterItems);

            // OpenFinance
            document.getElementById('openFinanceBtn').addEventListener('click', function() {
                alert('Funcionalidade OpenFinance ser√° implementada em breve!\n\nEsta funcionalidade permitir√°:\n- Conectar contas banc√°rias\n- Importar transa√ß√µes automaticamente\n- Classificar entradas e sa√≠das\n- Reconciliar com a agenda');
            });

            // TIPO DE ITEM - MOSTRAR/OCULTAR CAMPOS CORRETOS
            document.getElementById('itemTipo').addEventListener('change', function() {
                const horaGroup = document.getElementById('horaGroup');
                const valorGroup = document.getElementById('valorGroup');
                
                if (this.value === 'compromisso') {
                    horaGroup.style.display = 'block';
                    valorGroup.style.display = 'none';
                    document.getElementById('itemHora').required = false;
                    document.getElementById('itemValor').required = false;
                } else if (this.value === 'pagamento') {
                    horaGroup.style.display = 'none';
                    valorGroup.style.display = 'block';
                    document.getElementById('itemHora').required = false;
                    document.getElementById('itemValor').required = true;
                } else {
                    horaGroup.style.display = 'none';
                    valorGroup.style.display = 'none';
                    document.getElementById('itemHora').required = false;
                    document.getElementById('itemValor').required = false;
                }
            });

            // Fechar modal clicando fora
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('itemModal');
                if (event.target === modal) {
                    closeModal();
                }
            });
        }

        // Renderizar calend√°rio - semana come√ßa na segunda
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            const monthNames = [
                'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
            ];
            document.getElementById('calendarTitle').textContent = `${monthNames[month]} ${year}`;

            const grid = document.getElementById('calendarGrid');
            const headers = grid.querySelectorAll('.calendar-day-header');
            grid.innerHTML = '';
            headers.forEach(header => grid.appendChild(header));

            const firstDay = new Date(year, month, 1);
            const startDate = new Date(firstDay);
            
            let dayOfWeek = firstDay.getDay();
            dayOfWeek = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            startDate.setDate(startDate.getDate() - dayOfWeek);

            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dayElement = createDayElement(date, month);
                grid.appendChild(dayElement);
            }
        }

        // Criar elemento do dia
        function createDayElement(date, currentMonth) {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'calendar-day';
            
            if (date.getMonth() !== currentMonth) {
                dayDiv.classList.add('other-month');
            }
            
            const today = new Date();
            if (date.toDateString() === today.toDateString()) {
                dayDiv.classList.add('today');
            }
            
            const dayNumber = document.createElement('div');
            dayNumber.className = 'calendar-day-number';
            dayNumber.textContent = date.getDate();
            dayDiv.appendChild(dayNumber);
            
            const dayEvents = getEventsForDate(date);
            if (dayEvents.length > 0) {
                dayDiv.classList.add('has-events');
                dayEvents.slice(0, 3).forEach(event => {
                    const eventDiv = document.createElement('div');
                    eventDiv.className = `calendar-event ${event.tipo}`;
                    
                    // ADICIONAR CLASSE RECORRENTE
                    if (event.eh_recorrente || event.recorrencia_ativa) {
                        eventDiv.classList.add('recorrente');
                    }
                    
                    eventDiv.textContent = event.titulo;
                    eventDiv.title = `${event.titulo} - ${event.hora_evento || 'Sem hor√°rio'}${event.eh_recorrente ? ' (Recorrente)' : ''}`;
                    dayDiv.appendChild(eventDiv);
                });
                
                if (dayEvents.length > 3) {
                    const moreDiv = document.createElement('div');
                    moreDiv.className = 'calendar-event';
                    moreDiv.textContent = `+${dayEvents.length - 3} mais`;
                    dayDiv.appendChild(moreDiv);
                }
            }
            
            dayDiv.addEventListener('click', () => {
                const dateStr = date.toISOString().split('T')[0];
                document.getElementById('dateFilter').value = dateStr;
                filterItems();
            });
            
            return dayDiv;
        }

        // Obter eventos para uma data espec√≠fica
        function getEventsForDate(date) {
            const dateStr = date.toISOString().split('T')[0];
            return agendaItems.filter(item => item.data_evento === dateStr);
        }

        // CARREGAR ITENS DO SUPABASE - INTEGRA√á√ÉO REAL
        async function loadAgendaItems() {
            try {
                console.log('Carregando itens do Supabase...');
                
                const { data, error } = await supabase
                    .from('agenda_hvc')
                    .select('*')
                    .order('data_evento', { ascending: true });

                if (error) {
                    console.error('Erro ao carregar itens:', error);
                    showError('Erro ao carregar itens da agenda: ' + error.message);
                    return;
                }

                console.log('Itens carregados:', data);
                agendaItems = data || [];
                
                renderItemsList();
                renderCalendar();
            } catch (error) {
                console.error('Erro ao carregar itens:', error);
                showError('Erro ao conectar com o banco de dados');
            }
        }

        // Mostrar erro
        function showError(message) {
            const container = document.getElementById('itemsList');
            container.innerHTML = `<div class="error">${message}</div>`;
        }

        // Renderizar lista de itens
        function renderItemsList() {
            const container = document.getElementById('itemsList');
            container.innerHTML = '';
            
            if (agendaItems.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.6);">Nenhum item encontrado</div>';
                return;
            }
            
            agendaItems.forEach(item => {
                const itemDiv = createItemElement(item);
                container.appendChild(itemDiv);
            });
        }

        // Criar elemento do item
        function createItemElement(item) {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'item-card';
            
            // ADICIONAR CLASSE RECORRENTE
            if (item.eh_recorrente || item.recorrencia_ativa) {
                itemDiv.classList.add('recorrente');
            }
            
            const formatDate = (dateStr) => {
                const date = new Date(dateStr + 'T00:00:00');
                return date.toLocaleDateString('pt-BR');
            };
            
            const formatCurrencyDisplay = (value) => {
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(value);
            };

            // FORMATAR INFORMA√á√ïES DE RECORR√äNCIA
            const getRecurrenceInfo = (item) => {
                if (!item.recorrencia_ativa && !item.eh_recorrente) return '';
                
                if (item.eh_recorrente) {
                    return '<div class="recurrence-info"><i class="fas fa-redo"></i> Evento recorrente</div>';
                }
                
                if (item.recorrencia_ativa) {
                    const unidadeTexto = {
                        'dias': 'dias',
                        'dias_uteis': 'dias √∫teis',
                        'semanas': 'semanas',
                        'quinzenas': 'quinzenas',
                        'meses': 'meses',
                        'anos': 'anos'
                    };
                    
                    const texto = `Repete a cada ${item.recorrencia_numero} ${unidadeTexto[item.recorrencia_unidade] || item.recorrencia_unidade}`;
                    const fimTexto = item.recorrencia_fim ? ` at√© ${formatDate(item.recorrencia_fim)}` : '';
                    
                    return `<div class="recurrence-info"><i class="fas fa-redo"></i> ${texto}${fimTexto}</div>`;
                }
                
                return '';
            };
            
            itemDiv.innerHTML = `
                <div class="item-header">
                    <div>
                        <div class="item-title">${item.titulo}</div>
                        <div class="item-type ${item.tipo}">${item.tipo}</div>
                    </div>
                    <div class="item-actions">
                        <button class="action-btn edit" onclick="editItem(${item.id})">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button class="action-btn delete" onclick="deleteItem(${item.id})">
                            <i class="fas fa-trash"></i> Excluir
                        </button>
                    </div>
                </div>
                <div class="item-details">
                    <div><strong>Data:</strong> ${formatDate(item.data_evento)} ${item.hora_evento ? '√†s ' + item.hora_evento : ''}</div>
                    ${item.categoria ? `<div><strong>Categoria:</strong> ${item.categoria}</div>` : ''}
                    ${item.valor ? `<div><strong>Valor:</strong> ${formatCurrencyDisplay(item.valor)}</div>` : ''}
                    ${item.descricao ? `<div><strong>Descri√ß√£o:</strong> ${item.descricao}</div>` : ''}
                </div>
                <div class="item-status">
                    <label>Status:</label>
                    <select class="status-select" onchange="updateStatus(${item.id}, this.value)">
                        <option value="pendente" ${item.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                        <option value="confirmado" ${item.status === 'confirmado' ? 'selected' : ''}>Confirmado</option>
                        <option value="pago" ${item.status === 'pago' ? 'selected' : ''}>Pago</option>
                        <option value="cancelado" ${item.status === 'cancelado' ? 'selected' : ''}>Cancelado</option>
                        <option value="vencido" ${item.status === 'vencido' ? 'selected' : ''}>Vencido</option>
                    </select>
                </div>
                ${getRecurrenceInfo(item)}
                ${item.atualizado_por ? `
                    <div class="last-update">
                        √öltima atualiza√ß√£o: ${new Date(item.atualizado_em).toLocaleString('pt-BR')} por ${item.atualizado_por}
                    </div>
                ` : ''}
            `;
            
            return itemDiv;
        }

        // Filtrar itens
        function filterItems() {
            const search = document.getElementById('searchFilter').value.toLowerCase();
            const type = document.getElementById('typeFilter').value;
            const status = document.getElementById('statusFilter').value;
            const date = document.getElementById('dateFilter').value;
            
            const filtered = agendaItems.filter(item => {
                const matchSearch = !search || 
                    item.titulo.toLowerCase().includes(search) ||
                    (item.descricao && item.descricao.toLowerCase().includes(search)) ||
                    (item.categoria && item.categoria.toLowerCase().includes(search));
                
                const matchType = !type || item.tipo === type;
                const matchStatus = !status || item.status === status;
                const matchDate = !date || item.data_evento === date;
                
                return matchSearch && matchType && matchStatus && matchDate;
            });
            
            const originalItems = agendaItems;
            agendaItems = filtered;
            renderItemsList();
            agendaItems = originalItems;
        }

        // Abrir modal para adicionar
        function openAddModal() {
            editingItemId = null;
            document.getElementById('modalTitle').textContent = 'Adicionar Item';
            document.getElementById('itemForm').reset();
            document.getElementById('horaGroup').style.display = 'none';
            document.getElementById('valorGroup').style.display = 'none';
            document.getElementById('itemValor').value = '0,00';
            document.getElementById('recurrenceFields').classList.remove('active');
            document.getElementById('itemModal').style.display = 'block';
        }

        // Editar item
        window.editItem = function(id) {
            const item = agendaItems.find(i => i.id === id);
            if (!item) return;
            
            editingItemId = id;
            document.getElementById('modalTitle').textContent = 'Editar Item';
            
            document.getElementById('itemTitulo').value = item.titulo;
            document.getElementById('itemTipo').value = item.tipo;
            document.getElementById('itemCategoria').value = item.categoria || '';
            document.getElementById('itemData').value = item.data_evento;
            document.getElementById('itemHora').value = item.hora_evento || '';
            document.getElementById('itemValor').value = item.valor ? formatCurrency(item.valor) : '0,00';
            document.getElementById('itemStatus').value = item.status;
            document.getElementById('itemPrioridade').value = item.prioridade;
            document.getElementById('itemDescricao').value = item.descricao || '';
            document.getElementById('itemObservacoes').value = item.observacoes || '';
            
            // CAMPOS DE RECORR√äNCIA
            document.getElementById('recorrenciaAtiva').checked = item.recorrencia_ativa || false;
            document.getElementById('recorrenciaNumero').value = item.recorrencia_numero || 1;
            document.getElementById('recorrenciaUnidade').value = item.recorrencia_unidade || 'dias';
            document.getElementById('recorrenciaFim').value = item.recorrencia_fim || '';
            
            if (item.recorrencia_ativa) {
                document.getElementById('recurrenceFields').classList.add('active');
            }
            
            // Mostrar campos corretos baseado no tipo
            const horaGroup = document.getElementById('horaGroup');
            const valorGroup = document.getElementById('valorGroup');
            
            if (item.tipo === 'compromisso') {
                horaGroup.style.display = 'block';
                valorGroup.style.display = 'none';
            } else if (item.tipo === 'pagamento') {
                horaGroup.style.display = 'none';
                valorGroup.style.display = 'block';
            }
            
            document.getElementById('itemModal').style.display = 'block';
        }


                // CALCULAR TODAS AS DATAS DA RECORR√äNCIA
        function calculateRecurrenceDates(startDate, interval, unit, endDate) {
            const dates = [];
            const start = new Date(startDate + 'T00:00:00');
            
            // Se n√£o h√° data fim, usar √∫ltimo dia do ano atual
            let end;
            if (endDate) {
                end = new Date(endDate + 'T23:59:59');
            } else {
                end = new Date(start.getFullYear(), 11, 31); // 31 de dezembro do ano atual
            }
            
            console.log('üìä Calculando recorr√™ncia:', {
                inicio: start.toISOString().split('T')[0],
                fim: end.toISOString().split('T')[0],
                intervalo: interval,
                unidade: unit
            });
            
            let currentDate = new Date(start);
            let iterations = 0;
            const maxIterations = 1000; // Limite de seguran√ßa
            
            while (currentDate <= end && iterations < maxIterations) {
                // Calcular pr√≥xima data baseada na unidade
                switch (unit) {
                    case 'dias':
                        currentDate.setDate(currentDate.getDate() + interval);
                        break;
                    case 'dias √∫teis':
                        let daysAdded = 0;
                        while (daysAdded < interval) {
                            currentDate.setDate(currentDate.getDate() + 1);
                            // Segunda = 1, Ter√ßa = 2, ..., Sexta = 5
                            if (currentDate.getDay() >= 1 && currentDate.getDay() <= 5) {
                                daysAdded++;
                            }
                        }
                        break;
                    case 'semanas':
                        currentDate.setDate(currentDate.getDate() + (interval * 7));
                        break;
                    case 'quinzenas':
                        currentDate.setDate(currentDate.getDate() + (interval * 14));
                        break;
                    case 'meses':
                        currentDate.setMonth(currentDate.getMonth() + interval);
                        break;
                    case 'anos':
                        currentDate.setFullYear(currentDate.getFullYear() + interval);
                        break;
                }
                
                // Se ainda est√° dentro do per√≠odo, adicionar √† lista
                if (currentDate <= end) {
                    dates.push(currentDate.toISOString().split('T')[0]);
                }
                
                iterations++;
            }
            
            console.log(`üìÖ Datas calculadas: ${dates.join(', ')}`);
            return dates;
        }


        // SALVAR ITEM NO SUPABASE - COM RECORR√äNCIA CORRIGIDA
        async function saveItem(event) {
            event.preventDefault();
            
            const tipo = document.getElementById('itemTipo').value;
            const dataEvento = document.getElementById('itemData').value;
            
            let horaEvento = null;
            
            if (tipo === 'compromisso') {
                const horaValue = document.getElementById('itemHora').value;
                horaEvento = horaValue && horaValue.trim() !== '' ? horaValue : null;
            } else if (tipo === 'pagamento') {
                horaEvento = await generateNextPaymentTime(dataEvento);
            }
            
            const formData = {
                titulo: document.getElementById('itemTitulo').value,
                tipo: tipo,
                categoria: document.getElementById('itemCategoria').value,
                data_evento: dataEvento,
                hora_evento: horaEvento,
                valor: tipo === 'pagamento' ? parseFormattedCurrency(document.getElementById('itemValor').value) : null,
                status: document.getElementById('itemStatus').value,
                prioridade: document.getElementById('itemPrioridade').value,
                descricao: document.getElementById('itemDescricao').value,
                observacoes: document.getElementById('itemObservacoes').value,
                // CAMPOS DE RECORR√äNCIA
                recorrencia_ativa: document.getElementById('recorrenciaAtiva').checked,
                recorrencia_numero: document.getElementById('recorrenciaAtiva').checked ? parseInt(document.getElementById('recorrenciaNumero').value) : null,
                recorrencia_unidade: document.getElementById('recorrenciaAtiva').checked ? document.getElementById('recorrenciaUnidade').value : null,
                recorrencia_fim: document.getElementById('recorrenciaAtiva').checked && document.getElementById('recorrenciaFim').value ? document.getElementById('recorrenciaFim').value : null,
                atualizado_por: currentUser,
                atualizado_em: new Date().toISOString()
            };
            
            try {
                let result;
                
                if (editingItemId) {
                    console.log('Atualizando item:', editingItemId, formData);
                    result = await supabase
                        .from('agenda_hvc')
                        .update(formData)
                        .eq('id', editingItemId)
                        .select();
                } else {
                    console.log('Adicionando novo item:', formData);
                    formData.criado_por = currentUser;
                    formData.criado_em = new Date().toISOString();
                    
                    result = await supabase
                        .from('agenda_hvc')
                        .insert([formData])
                        .select();
                }
                
                if (result.error) {
                    console.error('Erro ao salvar item:', result.error);
                    alert('Erro ao salvar item: ' + result.error.message);
                    return;
                }
                
                console.log('Item salvo com sucesso');
                
                            // GERAR EVENTOS RECORRENTES SE NECESS√ÅRIO
                            if (!editingItemId && formData.recorrencia_ativa) {
                                const savedItem = result.data[0];
                                console.log('üîÑ Item com recorr√™ncia salvo:', savedItem);
                                
                                // CALCULAR TODAS AS DATAS DA RECORR√äNCIA
                                const recurrenceDates = calculateRecurrenceDates(
                                    savedItem.data_evento,
                                    savedItem.recorrencia_numero,
                                    savedItem.recorrencia_unidade,
                                    savedItem.recorrencia_fim
                                );
                                
                                console.log(`üìÖ Datas calculadas: ${recurrenceDates.length} eventos`);
                                
                                if (recurrenceDates.length > 0) {
                                    // CRIAR EVENTOS PARA CADA DATA
                                    const recurrentEvents = [];
                                    
                                    for (let i = 0; i < recurrenceDates.length; i++) {
                                        const eventDate = recurrenceDates[i];
                                        
                                        // Gerar hor√°rio para pagamentos (sequencial)
                                        let eventTime = savedItem.hora_evento;
                                        if (savedItem.tipo === 'pagamento') {
                                            const baseHour = 9;
                                            const minutes = i % 60;
                                            const hours = baseHour + Math.floor(i / 60);
                                            eventTime = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                                        }
                                        
                                        // Criar evento hom√¥nimo
                                        const recurrentEvent = {
                                            titulo: savedItem.titulo,
                                            tipo: savedItem.tipo,
                                            categoria: savedItem.categoria,
                                            data_evento: eventDate,
                                            hora_evento: eventTime,
                                            valor: savedItem.valor,
                                            status: savedItem.status,
                                            prioridade: savedItem.prioridade,
                                            descricao: savedItem.descricao,
                                            observacoes: savedItem.observacoes,
                                            recorrencia_ativa: false, // Eventos gerados n√£o s√£o recorrentes
                                            recorrencia_numero: null,
                                            recorrencia_unidade: null,
                                            recorrencia_fim: null,
                                            evento_pai_id: savedItem.id,
                                            criado_por: savedItem.criado_por,
                                            criado_em: new Date().toISOString(),
                                            atualizado_por: savedItem.atualizado_por,
                                            atualizado_em: new Date().toISOString()
                                        };
                                        
                                        recurrentEvents.push(recurrentEvent);
                                    }
                                    
                                    console.log(`üíæ Inserindo ${recurrentEvents.length} eventos recorrentes...`);
                                    
                                    // INSERIR TODOS OS EVENTOS DE UMA VEZ
                                    const { data: insertedEvents, error: recurrenceError } = await supabase
                                        .from('agenda_hvc')
                                        .insert(recurrentEvents)
                                        .select();
                                    
                                    if (recurrenceError) {
                                        console.error('‚ùå Erro ao inserir eventos recorrentes:', recurrenceError);
                                        alert('Item salvo, mas houve erro ao gerar recorr√™ncias: ' + recurrenceError.message);
                                    } else {
                                        console.log(`‚úÖ ${insertedEvents.length} eventos recorrentes inseridos com sucesso`);
                                    }
                                }
                            }
                
                closeModal();
                await loadAgendaItems();
                
            } catch (error) {
                console.error('Erro ao salvar item:', error);
                alert('Erro ao salvar item: ' + error.message);
            }
        }

        // ATUALIZAR STATUS NO SUPABASE - INTEGRA√á√ÉO REAL
        window.updateStatus = async function(id, newStatus) {
            try {
                console.log('Atualizando status:', id, newStatus);
                
                const { error } = await supabase
                    .from('agenda_hvc')
                    .update({
                        status: newStatus,
                        atualizado_por: currentUser,
                        atualizado_em: new Date().toISOString()
                    })
                    .eq('id', id);
                
                if (error) {
                    console.error('Erro ao atualizar status:', error);
                    alert('Erro ao atualizar status: ' + error.message);
                    return;
                }
                
                console.log('Status atualizado com sucesso');
                await loadAgendaItems();
                
            } catch (error) {
                console.error('Erro ao atualizar status:', error);
                alert('Erro ao atualizar status: ' + error.message);
            }
        }

        // EXCLUIR ITEM DO SUPABASE - COM OP√á√ÉO DE EXCLUIR RECORR√äNCIAS
        window.deleteItem = async function(id) {
            const item = agendaItems.find(i => i.id === id);
            if (!item) return;
            
            let confirmMessage = 'Tem certeza que deseja excluir este item?';
            
            // Se √© um item com recorr√™ncia ativa, perguntar sobre eventos futuros
            if (item.recorrencia_ativa) {
                confirmMessage += '\n\nEste item tem recorr√™ncia ativa. Deseja tamb√©m excluir todos os eventos futuros gerados por esta recorr√™ncia?';
                
                if (confirm(confirmMessage)) {
                    try {
                        // Excluir eventos filhos primeiro
                        const { error: childrenError } = await supabase
                            .from('agenda_hvc')
                            .delete()
                            .eq('evento_pai_id', id);
                        
                        if (childrenError) {
                            console.error('Erro ao excluir eventos recorrentes:', childrenError);
                        }
                        
                        // Depois excluir o item principal
                        const { error } = await supabase
                            .from('agenda_hvc')
                            .delete()
                            .eq('id', id);
                        
                        if (error) {
                            console.error('Erro ao excluir item:', error);
                            alert('Erro ao excluir item: ' + error.message);
                            return;
                        }
                        
                        console.log('Item e recorr√™ncias exclu√≠dos com sucesso');
                        await loadAgendaItems();
                        
                    } catch (error) {
                        console.error('Erro ao excluir item:', error);
                        alert('Erro ao excluir item: ' + error.message);
                    }
                }
            } else {
                // Item normal, excluir apenas ele
                if (confirm(confirmMessage)) {
                    try {
                        const { error } = await supabase
                            .from('agenda_hvc')
                            .delete()
                            .eq('id', id);
                        
                        if (error) {
                            console.error('Erro ao excluir item:', error);
                            alert('Erro ao excluir item: ' + error.message);
                            return;
                        }
                        
                        console.log('Item exclu√≠do com sucesso');
                        await loadAgendaItems();
                        
                    } catch (error) {
                        console.error('Erro ao excluir item:', error);
                        alert('Erro ao excluir item: ' + error.message);
                    }
                }
            }
        }

        // Fechar modal
        function closeModal() {
            document.getElementById('itemModal').style.display = 'none';
            editingItemId = null;
        }
    </script>
</body>
</html>

