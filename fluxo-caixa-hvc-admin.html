<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Fluxo de Caixa HVC - Administrador</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Tema específico HVC - Paleta original */
        body {
            display: flex;
            margin: 0;
            min-height: 100vh;
            background: linear-gradient(135deg, #000080, #800080);
            color: #e0e0e0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        #main-content-fluxo-caixa-hvc-admin {
            flex-grow: 1;
            padding: 1rem;
            transition: margin-left 0.3s ease;
            background: linear-gradient(135deg, #000080, #800080);
            color: #e0e0e0;
            overflow-y: auto;
        }

        #main-content-fluxo-caixa-hvc-admin.sidebar-collapsed {
            margin-left: 60px;
        }

        .hvc-container {
            background: rgba(25, 25, 112, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 8px 32px rgba(0, 0, 128, 0.3);
            backdrop-filter: blur(10px);
        }

        .hvc-title {
            color: #ffffff;
            font-size: 1.8rem;
            margin-bottom: 1rem;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        /* Header com botão OpenFinance */
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .openfinance-btn {
            background: rgba(255, 255, 255, 0.2);
            color: #ffffff;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 0.7rem 1.2rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .openfinance-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(255, 255, 255, 0.2);
        }

        /* Layout em duas colunas - ESTÉTICA ORIGINAL */
        .content-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            height: calc(100vh - 200px);
        }

        /* Calendário - ESTÉTICA ORIGINAL */
        .calendar-container {
            background: rgba(25, 25, 112, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 8px 32px rgba(0, 0, 128, 0.3);
            backdrop-filter: blur(10px);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0.5rem;
        }

        .calendar-nav {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #ffffff;
            padding: 0.5rem;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .calendar-nav:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .calendar-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #ffffff;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        .calendar-day-header {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.5rem;
            text-align: center;
            font-weight: bold;
            font-size: 0.8rem;
            color: #ffffff;
        }

        .calendar-day {
            background: rgba(255, 255, 255, 0.05);
            padding: 0.3rem;
            min-height: 60px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .calendar-day:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-1px);
        }

        .calendar-day.other-month {
            opacity: 0.3;
        }

        .calendar-day.today {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid #ffffff;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }

        .calendar-day.has-events {
            background: rgba(255, 255, 255, 0.1);
        }

        .calendar-day-number {
            font-size: 0.8rem;
            margin-bottom: 0.2rem;
            color: #ffffff;
        }

        .calendar-event {
            background: rgba(255, 255, 255, 0.8);
            color: #000080;
            font-size: 0.6rem;
            padding: 1px 3px;
            border-radius: 3px;
            margin-bottom: 1px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-weight: bold;
        }

        .calendar-event.pagamento {
            background: rgba(255, 255, 255, 0.9);
            color: #800080;
        }

        .calendar-event.compromisso {
            background: rgba(255, 255, 255, 0.7);
            color: #000080;
        }

        /* Lista de itens - ESTÉTICA ORIGINAL */
        .list-container {
            background: rgba(25, 25, 112, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 8px 32px rgba(0, 0, 128, 0.3);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
        }

        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .list-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #ffffff;
        }

        .add-btn {
            background: rgba(255, 255, 255, 0.2);
            color: #ffffff;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: bold;
        }

        .add-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .filters {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .filter-input, .filter-select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ffffff;
            padding: 0.3rem;
            border-radius: 5px;
            font-size: 0.8rem;
        }

        .filter-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .filter-select option {
            background: #000080;
            color: #ffffff;
        }

        .items-list {
            flex-grow: 1;
            overflow-y: auto;
            max-height: 400px;
        }

        .item-card {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 0.8rem;
            margin-bottom: 0.5rem;
            transition: all 0.3s;
        }

        .item-card:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(255, 255, 255, 0.1);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .item-title {
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 0.2rem;
        }

        .item-type {
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            text-transform: uppercase;
            font-weight: bold;
        }

        .item-type.compromisso {
            background: rgba(255, 255, 255, 0.8);
            color: #000080;
        }

        .item-type.pagamento {
            background: rgba(255, 255, 255, 0.9);
            color: #800080;
        }

        .item-details {
            font-size: 0.8rem;
            color: #ffffff;
            margin-bottom: 0.5rem;
            opacity: 0.9;
        }

        .item-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .status-select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ffffff;
            padding: 0.2rem;
            border-radius: 3px;
            font-size: 0.7rem;
        }

        .status-select option {
            background: #000080;
            color: #ffffff;
        }

        .item-actions {
            display: flex;
            gap: 0.5rem;
        }

        .action-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ffffff;
            padding: 0.3rem 0.6rem;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.7rem;
            transition: all 0.3s;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .last-update {
            font-size: 0.6rem;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 0.3rem;
        }

        /* Modal - CORRIGIDO PARA SER REDIMENSIONÁVEL */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
        }

        .modal-content {
            background: linear-gradient(135deg, #000080, #800080);
            margin: 2% auto;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            min-width: 400px;
            max-height: 90vh;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 128, 0.3);
            backdrop-filter: blur(10px);
            /* PERMITIR REDIMENSIONAMENTO */
            resize: both;
            overflow: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .modal-title {
            color: #ffffff;
            font-size: 1.3rem;
        }

        .close {
            color: #ffffff;
            font-size: 1.5rem;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .close:hover {
            opacity: 0.7;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            color: #ffffff;
            margin-bottom: 0.3rem;
            font-size: 0.9rem;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ffffff;
            padding: 0.5rem;
            border-radius: 5px;
            font-size: 0.9rem;
            box-sizing: border-box;
        }

        .form-input::placeholder, .form-textarea::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .form-select option {
            background: #000080;
            color: #ffffff;
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* CAMPO VALOR COM FORMATAÇÃO DE MOEDA */
        .currency-input {
            position: relative;
        }

        .currency-input::before {
            content: 'R$';
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.8);
            font-weight: bold;
            z-index: 1;
        }

        .currency-input input {
            padding-left: 35px;
            text-align: right;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            font-weight: bold;
        }

        .btn-primary {
            background: rgba(255, 255, 255, 0.2);
            color: #ffffff;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-primary:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        /* Loading e Error */
        .loading {
            text-align: center;
            padding: 2rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .error {
            text-align: center;
            padding: 2rem;
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.3);
            border-radius: 8px;
            margin: 1rem 0;
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .content-layout {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .calendar-day {
                min-height: 40px;
                font-size: 0.7rem;
            }
            
            .filters {
                flex-direction: column;
            }

            .admin-header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }

            .modal-content {
                width: 95%;
                margin: 5% auto;
                min-width: 300px;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar será injetada aqui pelo sidebar.js -->
    <main id="main-content-fluxo-caixa-hvc-admin">
        <div class="hvc-container">
            <div class="admin-header">
                <h1 class="hvc-title">
                    <i class="fas fa-chart-line"></i> Fluxo de Caixa - Administrador
                </h1>
                <button class="openfinance-btn" id="openFinanceBtn">
                    <i class="fas fa-university"></i>
                    OpenFinance
                </button>
            </div>
        </div>

        <div class="content-layout">
            <!-- Calendário à esquerda -->
            <div class="calendar-container">
                <div class="calendar-header">
                    <button class="calendar-nav" id="prevMonth">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div class="calendar-title" id="calendarTitle">
                        Agosto 2025
                    </div>
                    <button class="calendar-nav" id="nextMonth">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div class="calendar-grid" id="calendarGrid">
                    <!-- Cabeçalhos dos dias da semana - COMEÇAR NA SEGUNDA -->
                    <div class="calendar-day-header">Seg</div>
                    <div class="calendar-day-header">Ter</div>
                    <div class="calendar-day-header">Qua</div>
                    <div class="calendar-day-header">Qui</div>
                    <div class="calendar-day-header">Sex</div>
                    <div class="calendar-day-header">Sáb</div>
                    <div class="calendar-day-header">Dom</div>
                    <!-- Dias serão gerados dinamicamente -->
                </div>
            </div>

            <!-- Lista de compromissos e pagamentos à direita -->
            <div class="list-container">
                <div class="list-header">
                    <div class="list-title">Compromissos e Pagamentos</div>
                    <button class="add-btn" id="addItemBtn">
                        <i class="fas fa-plus"></i> Adicionar
                    </button>
                </div>

                <div class="filters">
                    <input type="text" class="filter-input" id="searchFilter" placeholder="Buscar...">
                    <select class="filter-select" id="typeFilter">
                        <option value="">Todos os tipos</option>
                        <option value="compromisso">Compromissos</option>
                        <option value="pagamento">Pagamentos</option>
                    </select>
                    <select class="filter-select" id="statusFilter">
                        <option value="">Todos os status</option>
                        <option value="pendente">Pendente</option>
                        <option value="confirmado">Confirmado</option>
                        <option value="pago">Pago</option>
                        <option value="cancelado">Cancelado</option>
                        <option value="vencido">Vencido</option>
                    </select>
                    <input type="date" class="filter-input" id="dateFilter">
                </div>

                <div class="items-list" id="itemsList">
                    <div class="loading">Carregando itens...</div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal para adicionar/editar item -->
    <div id="itemModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Adicionar Item</h2>
                <span class="close" id="closeModal">&times;</span>
            </div>
            <form id="itemForm">
                <div class="form-group">
                    <label class="form-label" for="itemTitulo">Título *</label>
                    <input type="text" class="form-input" id="itemTitulo" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="itemTipo">Tipo *</label>
                    <select class="form-select" id="itemTipo" required>
                        <option value="">Selecione...</option>
                        <option value="compromisso">Compromisso</option>
                        <option value="pagamento">Pagamento</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="itemCategoria">Categoria</label>
                    <input type="text" class="form-input" id="itemCategoria" placeholder="Ex: Reunião, Fornecedor, Salário...">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="itemData">Data *</label>
                    <input type="date" class="form-input" id="itemData" required>
                </div>
                
                <!-- CAMPO HORA SÓ PARA COMPROMISSOS -->
                <div class="form-group" id="horaGroup" style="display: none;">
                    <label class="form-label" for="itemHora">Hora</label>
                    <input type="time" class="form-input" id="itemHora">
                </div>
                
                <!-- CAMPO VALOR SÓ PARA PAGAMENTOS -->
                <div class="form-group" id="valorGroup" style="display: none;">
                    <label class="form-label" for="itemValor">Valor (R$)</label>
                    <div class="currency-input">
                        <input type="text" class="form-input" id="itemValor" placeholder="0,00">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="itemStatus">Status</label>
                    <select class="form-select" id="itemStatus">
                        <option value="pendente">Pendente</option>
                        <option value="confirmado">Confirmado</option>
                        <option value="pago">Pago</option>
                        <option value="cancelado">Cancelado</option>
                        <option value="vencido">Vencido</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="itemPrioridade">Prioridade</label>
                    <select class="form-select" id="itemPrioridade">
                        <option value="baixa">Baixa</option>
                        <option value="media">Média</option>
                        <option value="alta">Alta</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="itemDescricao">Descrição</label>
                    <textarea class="form-textarea" id="itemDescricao" placeholder="Detalhes adicionais..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="itemObservacoes">Observações</label>
                    <textarea class="form-textarea" id="itemObservacoes" placeholder="Observações internas..."></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelBtn">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="saveBtn">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module" src="supabase.js"></script>
    <script type="module" src="fluxo-caixa-hvc.js"></script>
    <script type="module">
        import { injectSidebar } from './sidebar.js';
        injectSidebar("main-content-fluxo-caixa-hvc-admin");
    </script>
    
    <script type="module">
        // Importar cliente Supabase - INTEGRAÇÃO REAL
        import { supabase } from './supabase.js';
        
        // Variáveis globais
        let currentDate = new Date();
        let currentUser = sessionStorage.getItem('usuario') || 'admin';
        let editingItemId = null;
        let agendaItems = [];

        // Inicializar quando a página carregar
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            setupCurrencyMask(); // CONFIGURAR MÁSCARA DE MOEDA
            loadAgendaItems(); // CARREGAMENTO REAL DO SUPABASE
            renderCalendar();
        });

        // CONFIGURAR MÁSCARA DE MOEDA BRASILEIRA
        function setupCurrencyMask() {
            const valorInput = document.getElementById('itemValor');
            
            valorInput.addEventListener('input', function(e) {
                let value = e.target.value;
                
                // Remove tudo que não é dígito
                value = value.replace(/\D/g, '');
                
                // Converte para centavos
                value = (parseInt(value) / 100).toFixed(2);
                
                // Formata como moeda brasileira
                value = value.replace('.', ',');
                value = value.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
                
                e.target.value = value;
            });

            valorInput.addEventListener('focus', function(e) {
                if (e.target.value === '' || e.target.value === '0,00') {
                    e.target.value = '';
                }
            });

            valorInput.addEventListener('blur', function(e) {
                if (e.target.value === '') {
                    e.target.value = '0,00';
                }
            });
        }

        // CONVERTER VALOR FORMATADO PARA NÚMERO
        function parseFormattedCurrency(formattedValue) {
            if (!formattedValue || formattedValue === '0,00') return null;
            
            // Remove pontos e substitui vírgula por ponto
            const numericValue = formattedValue
                .replace(/\./g, '')
                .replace(',', '.');
            
            return parseFloat(numericValue);
        }

        // FORMATAR NÚMERO PARA MOEDA BRASILEIRA
        function formatCurrency(value) {
            if (!value) return '0,00';
            
            return new Intl.NumberFormat('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        // GERAR HORÁRIO AUTOMÁTICO PARA PAGAMENTOS
        async function generateNextPaymentTime(date) {
            try {
                // Buscar pagamentos existentes na mesma data
                const { data, error } = await supabase
                    .from('agenda_hvc')
                    .select('hora_evento')
                    .eq('data_evento', date)
                    .eq('tipo', 'pagamento')
                    .not('hora_evento', 'is', null)
                    .order('hora_evento', { ascending: false })
                    .limit(1);

                if (error) {
                    console.error('Erro ao buscar horários:', error);
                    return '09:00'; // Horário padrão
                }

                if (!data || data.length === 0) {
                    return '09:00'; // Primeiro pagamento do dia
                }

                // Pegar o último horário e adicionar 1 minuto
                const lastTime = data[0].hora_evento;
                const [hours, minutes] = lastTime.split(':').map(Number);
                
                let newMinutes = minutes + 1;
                let newHours = hours;
                
                if (newMinutes >= 60) {
                    newMinutes = 0;
                    newHours += 1;
                }
                
                // Formatar com zero à esquerda
                const formattedTime = `${String(newHours).padStart(2, '0')}:${String(newMinutes).padStart(2, '0')}`;
                
                return formattedTime;
            } catch (error) {
                console.error('Erro ao gerar horário:', error);
                return '09:00'; // Horário padrão em caso de erro
            }
        }

        // Configurar event listeners
        function setupEventListeners() {
            // Navegação do calendário
            document.getElementById('prevMonth').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar();
            });

            document.getElementById('nextMonth').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar();
            });

            // Modal
            document.getElementById('addItemBtn').addEventListener('click', openAddModal);
            document.getElementById('closeModal').addEventListener('click', closeModal);
            document.getElementById('cancelBtn').addEventListener('click', closeModal);
            document.getElementById('itemForm').addEventListener('submit', saveItem);

            // Filtros
            document.getElementById('searchFilter').addEventListener('input', filterItems);
            document.getElementById('typeFilter').addEventListener('change', filterItems);
            document.getElementById('statusFilter').addEventListener('change', filterItems);
            document.getElementById('dateFilter').addEventListener('change', filterItems);

            // OpenFinance
            document.getElementById('openFinanceBtn').addEventListener('click', function() {
                alert('Funcionalidade OpenFinance será implementada em breve!\n\nEsta funcionalidade permitirá:\n- Conectar contas bancárias\n- Importar transações automaticamente\n- Classificar entradas e saídas\n- Reconciliar com a agenda');
            });

            // TIPO DE ITEM - MOSTRAR/OCULTAR CAMPOS CORRETOS
            document.getElementById('itemTipo').addEventListener('change', function() {
                const horaGroup = document.getElementById('horaGroup');
                const valorGroup = document.getElementById('valorGroup');
                
                if (this.value === 'compromisso') {
                    // COMPROMISSO: mostrar hora, ocultar valor
                    horaGroup.style.display = 'block';
                    valorGroup.style.display = 'none';
                    document.getElementById('itemHora').required = false;
                    document.getElementById('itemValor').required = false;
                } else if (this.value === 'pagamento') {
                    // PAGAMENTO: ocultar hora, mostrar valor
                    horaGroup.style.display = 'none';
                    valorGroup.style.display = 'block';
                    document.getElementById('itemHora').required = false;
                    document.getElementById('itemValor').required = true;
                } else {
                    // NENHUM SELECIONADO: ocultar ambos
                    horaGroup.style.display = 'none';
                    valorGroup.style.display = 'none';
                    document.getElementById('itemHora').required = false;
                    document.getElementById('itemValor').required = false;
                }
            });

            // Fechar modal clicando fora
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('itemModal');
                if (event.target === modal) {
                    closeModal();
                }
            });
        }

        // Renderizar calendário - semana começa na segunda
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // Atualizar título
            const monthNames = [
                'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
            ];
            document.getElementById('calendarTitle').textContent = `${monthNames[month]} ${year}`;

            // Limpar grid (manter cabeçalhos)
            const grid = document.getElementById('calendarGrid');
            const headers = grid.querySelectorAll('.calendar-day-header');
            grid.innerHTML = '';
            headers.forEach(header => grid.appendChild(header));

            // Primeiro dia do mês
            const firstDay = new Date(year, month, 1);
            const startDate = new Date(firstDay);
            
            // Ajustar para começar na segunda-feira
            let dayOfWeek = firstDay.getDay();
            dayOfWeek = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            startDate.setDate(startDate.getDate() - dayOfWeek);

            // Gerar 42 dias (6 semanas)
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dayElement = createDayElement(date, month);
                grid.appendChild(dayElement);
            }
        }

        // Criar elemento do dia
        function createDayElement(date, currentMonth) {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'calendar-day';
            
            if (date.getMonth() !== currentMonth) {
                dayDiv.classList.add('other-month');
            }
            
            const today = new Date();
            if (date.toDateString() === today.toDateString()) {
                dayDiv.classList.add('today');
            }
            
            const dayNumber = document.createElement('div');
            dayNumber.className = 'calendar-day-number';
            dayNumber.textContent = date.getDate();
            dayDiv.appendChild(dayNumber);
            
            const dayEvents = getEventsForDate(date);
            if (dayEvents.length > 0) {
                dayDiv.classList.add('has-events');
                dayEvents.slice(0, 3).forEach(event => {
                    const eventDiv = document.createElement('div');
                    eventDiv.className = `calendar-event ${event.tipo}`;
                    eventDiv.textContent = event.titulo;
                    eventDiv.title = `${event.titulo} - ${event.hora_evento || 'Sem horário'}`;
                    dayDiv.appendChild(eventDiv);
                });
                
                if (dayEvents.length > 3) {
                    const moreDiv = document.createElement('div');
                    moreDiv.className = 'calendar-event';
                    moreDiv.textContent = `+${dayEvents.length - 3} mais`;
                    dayDiv.appendChild(moreDiv);
                }
            }
            
            dayDiv.addEventListener('click', () => {
                const dateStr = date.toISOString().split('T')[0];
                document.getElementById('dateFilter').value = dateStr;
                filterItems();
            });
            
            return dayDiv;
        }

        // Obter eventos para uma data específica
        function getEventsForDate(date) {
            const dateStr = date.toISOString().split('T')[0];
            return agendaItems.filter(item => item.data_evento === dateStr);
        }

        // CARREGAR ITENS DO SUPABASE - INTEGRAÇÃO REAL
        async function loadAgendaItems() {
            try {
                console.log('Carregando itens do Supabase...');
                
                const { data, error } = await supabase
                    .from('agenda_hvc')
                    .select('*')
                    .order('data_evento', { ascending: true });

                if (error) {
                    console.error('Erro ao carregar itens:', error);
                    showError('Erro ao carregar itens da agenda: ' + error.message);
                    return;
                }

                console.log('Itens carregados:', data);
                agendaItems = data || [];
                
                renderItemsList();
                renderCalendar();
            } catch (error) {
                console.error('Erro ao carregar itens:', error);
                showError('Erro ao conectar com o banco de dados');
            }
        }

        // Mostrar erro
        function showError(message) {
            const container = document.getElementById('itemsList');
            container.innerHTML = `<div class="error">${message}</div>`;
        }

        // Renderizar lista de itens
        function renderItemsList() {
            const container = document.getElementById('itemsList');
            container.innerHTML = '';
            
            if (agendaItems.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.6);">Nenhum item encontrado</div>';
                return;
            }
            
            agendaItems.forEach(item => {
                const itemDiv = createItemElement(item);
                container.appendChild(itemDiv);
            });
        }

        // Criar elemento do item
        function createItemElement(item) {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'item-card';
            
            const formatDate = (dateStr) => {
                const date = new Date(dateStr + 'T00:00:00');
                return date.toLocaleDateString('pt-BR');
            };
            
            const formatCurrencyDisplay = (value) => {
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(value);
            };
            
            itemDiv.innerHTML = `
                <div class="item-header">
                    <div>
                        <div class="item-title">${item.titulo}</div>
                        <div class="item-type ${item.tipo}">${item.tipo}</div>
                    </div>
                    <div class="item-actions">
                        <button class="action-btn edit" onclick="editItem(${item.id})">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button class="action-btn delete" onclick="deleteItem(${item.id})">
                            <i class="fas fa-trash"></i> Excluir
                        </button>
                    </div>
                </div>
                <div class="item-details">
                    <div><strong>Data:</strong> ${formatDate(item.data_evento)} ${item.hora_evento ? 'às ' + item.hora_evento : ''}</div>
                    ${item.categoria ? `<div><strong>Categoria:</strong> ${item.categoria}</div>` : ''}
                    ${item.valor ? `<div><strong>Valor:</strong> ${formatCurrencyDisplay(item.valor)}</div>` : ''}
                    ${item.descricao ? `<div><strong>Descrição:</strong> ${item.descricao}</div>` : ''}
                </div>
                <div class="item-status">
                    <label>Status:</label>
                    <select class="status-select" onchange="updateStatus(${item.id}, this.value)">
                        <option value="pendente" ${item.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                        <option value="confirmado" ${item.status === 'confirmado' ? 'selected' : ''}>Confirmado</option>
                        <option value="pago" ${item.status === 'pago' ? 'selected' : ''}>Pago</option>
                        <option value="cancelado" ${item.status === 'cancelado' ? 'selected' : ''}>Cancelado</option>
                        <option value="vencido" ${item.status === 'vencido' ? 'selected' : ''}>Vencido</option>
                    </select>
                </div>
                ${item.atualizado_por ? `
                    <div class="last-update">
                        Última atualização: ${new Date(item.atualizado_em).toLocaleString('pt-BR')} por ${item.atualizado_por}
                    </div>
                ` : ''}
            `;
            
            return itemDiv;
        }

        // Filtrar itens
        function filterItems() {
            const search = document.getElementById('searchFilter').value.toLowerCase();
            const type = document.getElementById('typeFilter').value;
            const status = document.getElementById('statusFilter').value;
            const date = document.getElementById('dateFilter').value;
            
            const filtered = agendaItems.filter(item => {
                const matchSearch = !search || 
                    item.titulo.toLowerCase().includes(search) ||
                    (item.descricao && item.descricao.toLowerCase().includes(search)) ||
                    (item.categoria && item.categoria.toLowerCase().includes(search));
                
                const matchType = !type || item.tipo === type;
                const matchStatus = !status || item.status === status;
                const matchDate = !date || item.data_evento === date;
                
                return matchSearch && matchType && matchStatus && matchDate;
            });
            
            const originalItems = agendaItems;
            agendaItems = filtered;
            renderItemsList();
            agendaItems = originalItems;
        }

        // Abrir modal para adicionar
        function openAddModal() {
            editingItemId = null;
            document.getElementById('modalTitle').textContent = 'Adicionar Item';
            document.getElementById('itemForm').reset();
            document.getElementById('horaGroup').style.display = 'none';
            document.getElementById('valorGroup').style.display = 'none';
            document.getElementById('itemValor').value = '0,00';
            document.getElementById('itemModal').style.display = 'block';
        }

        // Editar item
        window.editItem = function(id) {
            const item = agendaItems.find(i => i.id === id);
            if (!item) return;
            
            editingItemId = id;
            document.getElementById('modalTitle').textContent = 'Editar Item';
            
            document.getElementById('itemTitulo').value = item.titulo;
            document.getElementById('itemTipo').value = item.tipo;
            document.getElementById('itemCategoria').value = item.categoria || '';
            document.getElementById('itemData').value = item.data_evento;
            document.getElementById('itemHora').value = item.hora_evento || '';
            document.getElementById('itemValor').value = item.valor ? formatCurrency(item.valor) : '0,00';
            document.getElementById('itemStatus').value = item.status;
            document.getElementById('itemPrioridade').value = item.prioridade;
            document.getElementById('itemDescricao').value = item.descricao || '';
            document.getElementById('itemObservacoes').value = item.observacoes || '';
            
            // Mostrar campos corretos baseado no tipo
            const horaGroup = document.getElementById('horaGroup');
            const valorGroup = document.getElementById('valorGroup');
            
            if (item.tipo === 'compromisso') {
                horaGroup.style.display = 'block';
                valorGroup.style.display = 'none';
            } else if (item.tipo === 'pagamento') {
                horaGroup.style.display = 'none';
                valorGroup.style.display = 'block';
            }
            
            document.getElementById('itemModal').style.display = 'block';
        }

        // SALVAR ITEM NO SUPABASE - INTEGRAÇÃO REAL COM CORREÇÕES
        async function saveItem(event) {
            event.preventDefault();
            
            const tipo = document.getElementById('itemTipo').value;
            const dataEvento = document.getElementById('itemData').value;
            
            let horaEvento = null;
            
            if (tipo === 'compromisso') {
                // COMPROMISSO: usar hora do campo (pode ser vazia)
                const horaValue = document.getElementById('itemHora').value;
                horaEvento = horaValue && horaValue.trim() !== '' ? horaValue : null;
            } else if (tipo === 'pagamento') {
                // PAGAMENTO: gerar horário automático
                horaEvento = await generateNextPaymentTime(dataEvento);
            }
            
            const formData = {
                titulo: document.getElementById('itemTitulo').value,
                tipo: tipo,
                categoria: document.getElementById('itemCategoria').value,
                data_evento: dataEvento,
                hora_evento: horaEvento,
                valor: tipo === 'pagamento' ? parseFormattedCurrency(document.getElementById('itemValor').value) : null,
                status: document.getElementById('itemStatus').value,
                prioridade: document.getElementById('itemPrioridade').value,
                descricao: document.getElementById('itemDescricao').value,
                observacoes: document.getElementById('itemObservacoes').value,
                atualizado_por: currentUser,
                atualizado_em: new Date().toISOString()
            };
            
            try {
                let result;
                
                if (editingItemId) {
                    console.log('Atualizando item:', editingItemId, formData);
                    result = await supabase
                        .from('agenda_hvc')
                        .update(formData)
                        .eq('id', editingItemId);
                } else {
                    console.log('Adicionando novo item:', formData);
                    formData.criado_por = currentUser;
                    formData.criado_em = new Date().toISOString();
                    
                    result = await supabase
                        .from('agenda_hvc')
                        .insert([formData]);
                }
                
                if (result.error) {
                    console.error('Erro ao salvar item:', result.error);
                    alert('Erro ao salvar item: ' + result.error.message);
                    return;
                }
                
                console.log('Item salvo com sucesso');
                closeModal();
                await loadAgendaItems(); // Recarregar do Supabase
                
            } catch (error) {
                console.error('Erro ao salvar item:', error);
                alert('Erro ao salvar item: ' + error.message);
            }
        }

        // ATUALIZAR STATUS NO SUPABASE - INTEGRAÇÃO REAL
        window.updateStatus = async function(id, newStatus) {
            try {
                console.log('Atualizando status:', id, newStatus);
                
                const { error } = await supabase
                    .from('agenda_hvc')
                    .update({
                        status: newStatus,
                        atualizado_por: currentUser,
                        atualizado_em: new Date().toISOString()
                    })
                    .eq('id', id);
                
                if (error) {
                    console.error('Erro ao atualizar status:', error);
                    alert('Erro ao atualizar status: ' + error.message);
                    return;
                }
                
                console.log('Status atualizado com sucesso');
                await loadAgendaItems(); // Recarregar do Supabase
                
            } catch (error) {
                console.error('Erro ao atualizar status:', error);
                alert('Erro ao atualizar status: ' + error.message);
            }
        }

        // EXCLUIR ITEM DO SUPABASE - INTEGRAÇÃO REAL
        window.deleteItem = async function(id) {
            if (!confirm('Tem certeza que deseja excluir este item?')) {
                return;
            }
            
            try {
                console.log('Excluindo item:', id);
                
                const { error } = await supabase
                    .from('agenda_hvc')
                    .delete()
                    .eq('id', id);
                
                if (error) {
                    console.error('Erro ao excluir item:', error);
                    alert('Erro ao excluir item: ' + error.message);
                    return;
                }
                
                console.log('Item excluído com sucesso');
                await loadAgendaItems(); // Recarregar do Supabase
                
            } catch (error) {
                console.error('Erro ao excluir item:', error);
                alert('Erro ao excluir item: ' + error.message);
            }
        }

        // Fechar modal
        function closeModal() {
            document.getElementById('itemModal').style.display = 'none';
            editingItemId = null;
        }
    </script>
</body>
</html>

