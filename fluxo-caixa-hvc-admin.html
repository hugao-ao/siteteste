<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fluxo de Caixa HVC - Agenda e Pagamentos</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <style>
        /* Tema específico HVC - Elegante e sofisticado */
        body {
            display: flex;
            margin: 0;
            min-height: 100vh;
            background: linear-gradient(135deg, #000080, #800080);
            color: #e0e0e0;
        }

        /* Layout responsivo para sidebar */
        #main-content-fluxo-caixa-hvc {
            flex-grow: 1;
            padding: 2rem;
            transition: margin-left 0.3s ease;
            background: linear-gradient(135deg, #000080, #800080);
            margin-left: 250px;
            width: calc(100vw - 250px);
            box-sizing: border-box;
        }

        #main-content-fluxo-caixa-hvc.sidebar-collapsed {
            margin-left: 60px;
            width: calc(100vw - 60px);
        }

        @media (max-width: 768px) {
            #main-content-fluxo-caixa-hvc {
                margin-left: 0;
                width: 100vw;
            }
            
            #main-content-fluxo-caixa-hvc.sidebar-collapsed {
                margin-left: 0;
                width: 100vw;
            }
        }

        .hvc-container {
            background: rgba(25, 25, 112, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 128, 0.3);
            backdrop-filter: blur(10px);
            max-width: 100%;
            box-sizing: border-box;
        }

        .hvc-title {
            color: #ffffff;
            font-size: 2rem;
            margin-bottom: 1.5rem;
            text-align: center;
            word-wrap: break-word;
        }

        /* Seção de Resumo Mensal */
        .monthly-summary {
            background: rgba(255, 193, 7, 0.2);
            border: 2px solid #ffc107;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            text-align: center;
        }

        .monthly-summary h3 {
            color: #ffc107;
            font-size: 1.5rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .monthly-total {
            color: #ffffff;
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .monthly-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .stat-value {
            color: #ffc107;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .stat-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            margin-top: 5px;
        }

        /* ✅ NOVO: Estatísticas por Status com Montantes */
        .status-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .status-stat-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            border: 2px solid transparent;
        }

        .status-stat-item.pg {
            border-color: #34a853;
            background: rgba(52, 168, 83, 0.2);
        }

        .status-stat-item.pendente {
            border-color: #ea4335;
            background: rgba(234, 67, 53, 0.2);
        }

        .status-stat-item.recalculado {
            border-color: #4285f4;
            background: rgba(66, 133, 244, 0.2);
        }

        .status-stat-value {
            color: #ffffff;
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .status-stat-amount {
            color: #ffc107;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .status-stat-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.8rem;
            margin-top: 5px;
        }

        /* Lista de Pagamentos */
        .payments-list-section {
            background: rgba(25, 25, 112, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            max-width: 100%;
            box-sizing: border-box;
        }

        .payments-list-section h3 {
            color: #ffffff;
            font-size: 1.5rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* ✅ NOVO: Filtros de Pagamentos */
        .payments-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .filter-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 8px 12px;
            color: #ffffff;
            font-size: 0.9rem;
        }

        .filter-input:focus {
            outline: none;
            border-color: #4285f4;
            background: rgba(255, 255, 255, 0.15);
        }

        .filter-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .filter-select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 8px 12px;
            color: #ffffff;
            font-size: 0.9rem;
        }

        .filter-select option {
            background: #1a1a2e;
            color: #ffffff;
        }

        .clear-filters-btn {
            background: rgba(234, 67, 53, 0.3);
            border: 1px solid #ea4335;
            border-radius: 6px;
            padding: 8px 16px;
            color: #ea4335;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            align-self: flex-end;
        }

        .clear-filters-btn:hover {
            background: rgba(234, 67, 53, 0.5);
            color: #ffffff;
        }

        .payments-list {
            max-height: 500px;
            overflow-y: auto;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
        }

        .payments-list::-webkit-scrollbar {
            width: 8px;
        }

        .payments-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .payments-list::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }

        .payment-item {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .payment-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
        }

        .payment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .payment-name {
            color: #ffffff;
            font-weight: bold;
            font-size: 1.1rem;
            flex: 1;
            min-width: 200px;
        }

        .payment-value {
            color: #ffc107;
            font-weight: bold;
            font-size: 1.2rem;
            background: rgba(255, 193, 7, 0.2);
            padding: 5px 10px;
            border-radius: 5px;
        }

        .payment-details {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .payment-date {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .payment-status {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .payment-status.pg {
            background: rgba(52, 168, 83, 0.3);
            color: #34a853;
        }

        .payment-status.pendente {
            background: rgba(234, 67, 53, 0.3);
            color: #ea4335;
        }

        .payment-status.recalculado {
            background: rgba(66, 133, 244, 0.3);
            color: #4285f4;
        }

        .payment-type {
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(66, 133, 244, 0.3);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .payment-type.pagamento {
            background: rgba(234, 67, 53, 0.3);
        }

        .payment-type.hvc {
            background: rgba(156, 39, 176, 0.3);
        }

        .no-payments {
            text-align: center;
            padding: 40px;
            color: rgba(255, 255, 255, 0.6);
        }

        .no-payments i {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
        }

        /* Google Calendar Section */
        .google-section {
            background: rgba(25, 25, 112, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            max-width: 100%;
            box-sizing: border-box;
        }

        .google-section h2 {
            color: #ffffff;
            font-size: 1.8rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            font-size: 16px;
            font-weight: 500;
            flex-wrap: wrap;
        }

        .status-disconnected {
            background: rgba(234, 67, 53, 0.2);
            border: 1px solid rgba(234, 67, 53, 0.4);
            color: #ea4335;
        }

        .status-connected {
            background: rgba(52, 168, 83, 0.2);
            border: 1px solid rgba(52, 168, 83, 0.4);
            color: #34a853;
        }

        .google-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: flex-start;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4285f4, #34a853);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ea4335, #d33b2c);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(234, 67, 53, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* =================================================================
         * ✅ NOVO: ESTILOS PARA MÚLTIPLAS CONTAS GOOGLE
         * ================================================================= */
        
        .multi-account-section {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
        }

        .accounts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .accounts-title {
            color: #ffffff;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .add-account-btn {
            background: rgba(52, 168, 83, 0.3);
            border: 1px solid #34a853;
            color: #34a853;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .add-account-btn:hover {
            background: rgba(52, 168, 83, 0.5);
            color: #ffffff;
            transform: translateY(-1px);
        }

        .accounts-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .account-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .account-item:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .account-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .account-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .account-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .account-details {
            display: flex;
            flex-direction: column;
        }

        .account-email {
            color: #ffffff;
            font-weight: 500;
            font-size: 14px;
        }

        .account-status {
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-connected {
            background: #34a853;
        }

        .status-disconnected {
            background: #ea4335;
        }

        .status-loading {
            background: #fbbc04;
            animation: pulse 1.5s infinite;
        }

        .account-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .account-btn {
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .btn-disconnect {
            background: rgba(234, 67, 53, 0.2);
            border-color: #ea4335;
            color: #ea4335;
        }

        .btn-disconnect:hover {
            background: rgba(234, 67, 53, 0.4);
            color: #ffffff;
        }

        .btn-reconnect {
            background: rgba(66, 133, 244, 0.2);
            border-color: #4285f4;
            color: #4285f4;
        }

        .btn-reconnect:hover {
            background: rgba(66, 133, 244, 0.4);
            color: #ffffff;
        }

        .btn-settings {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 0.8);
        }

        .btn-settings:hover {
            background: rgba(255, 255, 255, 0.2);
            color: #ffffff;
        }

        .calendars-list {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .calendars-header {
            color: rgba(255, 255, 255, 0.8);
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .calendar-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .calendar-item:last-child {
            border-bottom: none;
        }

        .calendar-info {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .calendar-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .calendar-name {
            color: rgba(255, 255, 255, 0.9);
            font-size: 13px;
            flex: 1;
        }

        .calendar-toggle {
            width: 40px;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .calendar-toggle::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background: #ffffff;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .calendar-toggle.active {
            background: #34a853;
        }

        .calendar-toggle.active::before {
            transform: translateX(20px);
        }

        .account-summary {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sync-status {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .sync-info {
            display: flex;
            align-items: center;
            gap: 4px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
        }

        .no-accounts {
            text-align: center;
            padding: 40px 20px;
            color: rgba(255, 255, 255, 0.6);
        }

        .no-accounts-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .no-accounts-text {
            font-size: 16px;
            margin-bottom: 20px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Filter Section */
        .filter-section {
            background: rgba(25, 25, 112, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            max-width: 100%;
            box-sizing: border-box;
        }

        .filter-section h3 {
            color: #ffffff;
            font-size: 1.3rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-label {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            font-weight: 500;
        }

        .filter-input, .filter-select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 12px 16px;
            color: #ffffff;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .filter-input:focus, .filter-select:focus {
            outline: none;
            border-color: #4285f4;
            background: rgba(255, 255, 255, 0.15);
        }

        .filter-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .filter-select option {
            background: #1a1a2e;
            color: #ffffff;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-filter {
            background: rgba(66, 133, 244, 0.3);
            border: 1px solid #4285f4;
            color: #4285f4;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-filter:hover {
            background: rgba(66, 133, 244, 0.5);
            color: #ffffff;
        }

        .btn-clear {
            background: rgba(234, 67, 53, 0.3);
            border: 1px solid #ea4335;
            color: #ea4335;
        }

        .btn-clear:hover {
            background: rgba(234, 67, 53, 0.5);
            color: #ffffff;
        }

        /* Calendar Section */
        .calendar-section {
            background: rgba(25, 25, 112, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            max-width: 100%;
            box-sizing: border-box;
        }

        .calendar-section h3 {
            color: #ffffff;
            font-size: 1.5rem;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ffffff;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .current-month {
            color: #ffffff;
            font-size: 1.3rem;
            font-weight: 600;
            min-width: 200px;
            text-align: center;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            min-width: 100%;
            box-sizing: border-box;
        }

        .calendar-day-header {
            background: rgba(66, 133, 244, 0.3);
            color: #ffffff;
            padding: 15px 5px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
        }

        .calendar-day {
            background: rgba(255, 255, 255, 0.05);
            min-height: 120px;
            padding: 8px;
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
            box-sizing: border-box;
        }

        .calendar-day:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .calendar-day.other-month {
            background: rgba(255, 255, 255, 0.02);
            color: rgba(255, 255, 255, 0.3);
        }

        .calendar-day.today {
            background: rgba(66, 133, 244, 0.2);
            border-color: #4285f4;
        }

        .day-number {
            color: #ffffff;
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .day-total {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255, 193, 7, 0.8);
            color: #000;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }

        .day-events {
            display: flex;
            flex-direction: column;
            gap: 2px;
            max-height: 80px;
            overflow: hidden;
        }

        .event-item {
            background: rgba(234, 67, 53, 0.8);
            color: #ffffff;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            word-wrap: break-word;
            line-height: 1.2;
        }

        .event-item:hover {
            transform: scale(1.05);
            z-index: 10;
        }

        .event-item.pagamento {
            background: rgba(234, 67, 53, 0.8);
        }

        .event-item.hvc {
            background: rgba(156, 39, 176, 0.8);
        }

        .event-item.pg {
            background: rgba(52, 168, 83, 0.8);
        }

        .event-item.all-pg {
            background: rgba(52, 168, 83, 0.8);
        }

        .event-item.has-pending {
            background: rgba(234, 67, 53, 0.8);
        }

        .event-item.future-pending {
            background: rgba(66, 133, 244, 0.8);
        }

        .more-events {
            color: rgba(255, 255, 255, 0.7);
            font-size: 10px;
            text-align: center;
            margin-top: 2px;
        }

        /* Event Modal */
        .event-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .event-modal-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            margin: 5% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header {
            background: rgba(66, 133, 244, 0.2);
            padding: 20px 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            color: #ffffff;
            margin: 0;
            font-size: 1.3rem;
            flex: 1;
            word-wrap: break-word;
        }

        .close {
            color: rgba(255, 255, 255, 0.7);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 15px;
        }

        .close:hover {
            color: #ffffff;
            transform: scale(1.1);
        }

        .modal-body {
            padding: 30px;
            max-height: 60vh;
            overflow-y: auto;
            color: #ffffff;
            line-height: 1.6;
        }

        .modal-body::-webkit-scrollbar {
            width: 8px;
        }

        .modal-body::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .modal-body::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }

        .modal-body p {
            margin-bottom: 15px;
        }

        .modal-body strong {
            color: #4285f4;
        }

        .event-total-section {
            background: rgba(255, 193, 7, 0.2);
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .event-total-title {
            color: #ffc107;
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .event-total-value {
            color: #ffffff;
            font-size: 2rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .event-values-list {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .event-values-list h4 {
            color: #4285f4;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .value-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            flex-wrap: wrap;
            gap: 10px;
        }

        .value-item:last-child {
            border-bottom: none;
        }

        .value-item-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .value-item-status.pg {
            background: rgba(52, 168, 83, 0.3);
            color: #34a853;
        }

        .value-item-status.pendente {
            background: rgba(234, 67, 53, 0.3);
            color: #ea4335;
        }

        .value-item-status.recalculado {
            background: rgba(66, 133, 244, 0.3);
            color: #4285f4;
        }

        .attachment-link {
            color: #4285f4;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-right: 15px;
            margin-bottom: 5px;
            padding: 5px 10px;
            background: rgba(66, 133, 244, 0.1);
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .attachment-link:hover {
            background: rgba(66, 133, 244, 0.2);
            transform: translateY(-1px);
        }

        /* Message System */
        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: #ffffff;
            font-weight: 500;
            z-index: 10000;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease;
        }

        .message.success {
            background: linear-gradient(135deg, #34a853, #2d8f47);
            border: 1px solid #34a853;
        }

        .message.error {
            background: linear-gradient(135deg, #ea4335, #d33b2c);
            border: 1px solid #ea4335;
        }

        .message.warning {
            background: linear-gradient(135deg, #fbbc04, #f9ab00);
            border: 1px solid #fbbc04;
            color: #000000;
        }

        .message.info {
            background: linear-gradient(135deg, #4285f4, #3367d6);
            border: 1px solid #4285f4;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .calendar-grid {
                font-size: 12px;
            }
            
            .calendar-day {
                min-height: 100px;
                padding: 6px;
            }
            
            .event-item {
                font-size: 10px;
                padding: 1px 4px;
            }
        }

        @media (max-width: 768px) {
            .hvc-container {
                padding: 1rem;
            }
            
            .calendar-header {
                flex-direction: column;
                gap: 10px;
            }
            
            .calendar-nav {
                order: 2;
            }
            
            .current-month {
                order: 1;
                font-size: 1.1rem;
            }
            
            .calendar-day {
                min-height: 80px;
                padding: 4px;
            }
            
            .day-number {
                font-size: 14px;
            }
            
            .event-item {
                font-size: 9px;
                padding: 1px 3px;
            }
            
            .day-total {
                font-size: 8px;
                padding: 1px 3px;
            }
            
            .filter-controls {
                grid-template-columns: 1fr;
            }
            
            .google-controls {
                flex-direction: column;
            }
            
            .btn {
                justify-content: center;
            }
            
            .monthly-stats {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            }
            
            .status-stats {
                grid-template-columns: 1fr;
            }
            
            .payments-filters {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .calendar-day-header {
                padding: 10px 2px;
                font-size: 12px;
            }
            
            .calendar-day {
                min-height: 60px;
                padding: 2px;
            }
            
            .day-number {
                font-size: 12px;
            }
            
            .event-item {
                font-size: 8px;
                padding: 1px 2px;
            }
            
            .event-modal-content {
                width: 95%;
                margin: 2% auto;
            }
            
            .modal-header {
                padding: 15px 20px;
            }
            
            .modal-body {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div id="main-content-fluxo-caixa-hvc">
        <div class="hvc-container">
            <h1 class="hvc-title">📅 Fluxo de Caixa HVC - Agenda e Pagamentos</h1>
            
            <!-- Google Calendar Connection Section -->
            <div class="google-section">
                <h2><i class="fab fa-google"></i> Conexão Google Calendar</h2>
                
                <div id="connectionStatus" class="status-indicator status-disconnected">
                    <i class="fas fa-times-circle"></i>
                    <span>Desconectado do Google Calendar</span>
                </div>
                
                <div class="google-controls">
                    <button id="authorizeButton" onclick="handleAuthClick()" class="btn btn-primary">
                        <i class="fab fa-google"></i>
                        Conectar ao Google Calendar
                    </button>
                    <button id="signoutButton" onclick="handleSignoutClick()" class="btn btn-danger" style="display: none;">
                        <i class="fas fa-sign-out-alt"></i>
                        Desconectar
                    </button>
                    <button id="syncButton" onclick="loadFilteredEvents()" class="btn btn-secondary" style="display: none;">
                        <i class="fas fa-sync-alt"></i>
                        Sincronizar
                    </button>
                </div>
            </div> <!-- Fim da seção Google Calendar -->

            <!-- ✅ NOVO: SEÇÃO DE MÚLTIPLAS CONTAS -->
            <div class="multi-account-section" id="multiAccountSection" style="display: none;">
                <div class="accounts-header">
                    <div class="accounts-title">
                        <i class="fas fa-users"></i>
                        Contas Conectadas
                    </div>
                    <button onclick="addNewAccount()" class="add-account-btn">
                        <i class="fas fa-plus"></i>
                        Adicionar Conta
                    </button>
                </div>
                
                <div id="accountsList" class="accounts-list">
                    <!-- Contas serão inseridas aqui dinamicamente -->
                </div>
                
                <div id="noAccountsMessage" class="no-accounts">
                    <div class="no-accounts-icon">
                        <i class="fas fa-user-plus"></i>
                    </div>
                    <div class="no-accounts-text">
                        Nenhuma conta adicional conectada
                    </div>
                    <button onclick="addNewAccount()" class="add-account-btn">
                        <i class="fas fa-plus"></i>
                        Conectar Primeira Conta Adicional
                    </button>
                </div>
            </div>

            <!-- Filter Section -->
            <div id="filterSection" class="filter-section" style="display: none;">
                <h3><i class="fas fa-filter"></i> Filtros de Eventos</h3>
                <div class="filter-controls">
                    <div class="filter-group">
                        <label class="filter-label">Palavras-chave</label>
                        <input type="text" id="keywordFilter" class="filter-input" placeholder="Ex: PAGAMENTO, HVC, PG">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Tipo de Evento</label>
                        <select id="typeFilter" class="filter-select">
                            <option value="">Todos os tipos</option>
                            <option value="PAGAMENTO">PAGAMENTO</option>
                            <option value="HVC">HVC</option>
                            <option value="PG">PG</option>
                        </select>
                    </div>
                    <div class="filter-buttons">
                        <button onclick="applyFilters()" class="btn-filter">
                            <i class="fas fa-search"></i>
                            Aplicar Filtros
                        </button>
                        <button onclick="clearFilters()" class="btn-filter btn-clear">
                            <i class="fas fa-times"></i>
                            Limpar
                        </button>
                    </div>
                </div>
                <div id="filterResults" style="margin-top: 15px; color: rgba(255, 255, 255, 0.8); font-size: 14px;">
                    <!-- Resultados dos filtros aparecerão aqui -->
                </div>
            </div>

            <!-- Calendar Section -->
            <div id="calendarSection" class="calendar-section" style="display: none;">
                <h3><i class="fas fa-calendar-alt"></i> Calendário</h3>
                
                <div class="calendar-header">
                    <div class="current-month" id="currentMonth">Agosto 2025</div>
                    <div class="calendar-nav">
                        <button class="nav-btn" onclick="previousMonth()">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button class="nav-btn" onclick="nextMonth()">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                
                <div class="calendar-grid" id="calendarGrid">
                    <!-- Calendar will be generated here -->
                </div>
            </div>

            <!-- ✅ NOVO: Resumo do Mês -->
            <div id="monthlySummarySection" class="monthly-summary" style="display: none;">
                <h3><i class="fas fa-chart-line"></i> Resumo do Mês</h3>
                <div id="monthlyTotal" class="monthly-total">R$ 0,00</div>
                
                <div class="monthly-stats">
                    <div class="stat-item">
                        <div id="totalEvents" class="stat-value">0</div>
                        <div class="stat-label">Eventos</div>
                    </div>
                    <div class="stat-item">
                        <div id="totalPayments" class="stat-value">0</div>
                        <div class="stat-label">Pagamentos</div>
                    </div>
                    <div class="stat-item">
                        <div id="avgPayment" class="stat-value">R$ 0,00</div>
                        <div class="stat-label">Valor Médio</div>
                    </div>
                </div>

                <!-- ✅ NOVO: Estatísticas por Status com Montantes -->
                <div class="status-stats">
                    <div class="status-stat-item pg">
                        <div id="totalPG" class="status-stat-value">0</div>
                        <div id="amountPG" class="status-stat-amount">R$ 0,00</div>
                        <div class="status-stat-label">PG</div>
                    </div>
                    <div class="status-stat-item pendente">
                        <div id="totalPendente" class="status-stat-value">0</div>
                        <div id="amountPendente" class="status-stat-amount">R$ 0,00</div>
                        <div class="status-stat-label">Pendente</div>
                    </div>
                    <div class="status-stat-item recalculado">
                        <div id="totalRecalculado" class="status-stat-value">0</div>
                        <div id="amountRecalculado" class="status-stat-amount">R$ 0,00</div>
                        <div class="status-stat-label">Recalculado</div>
                    </div>
                </div>
            </div>

            <!-- ✅ NOVO: Lista de Pagamentos com Filtros -->
            <div id="paymentsListSection" class="payments-list-section" style="display: none;">
                <h3><i class="fas fa-list-alt"></i> Lista de Pagamentos do Mês</h3>
                
                <!-- ✅ NOVO: Filtros -->
                <div class="payments-filters">
                    <div class="filter-group">
                        <label class="filter-label">Nome do Pagamento</label>
                        <input type="text" id="nameFilter" class="filter-input" placeholder="Buscar por nome...">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Data</label>
                        <input type="date" id="dateFilter" class="filter-input">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Status</label>
                        <select id="statusFilter" class="filter-select">
                            <option value="">Todos os status</option>
                            <option value="PG">PG</option>
                            <option value="PENDENTE">Pendente</option>
                            <option value="RECALCULADO">Recalculado</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <button id="clearFilters" class="clear-filters-btn">
                            <i class="fas fa-times"></i> Limpar Filtros
                        </button>
                    </div>
                </div>
                
                <div id="paymentsList" class="payments-list">
                    <!-- Pagamentos serão listados aqui -->
                </div>
            </div>
        </div>

        <!-- Event Details Modal -->
        <div id="eventModal" class="event-modal">
            <div class="event-modal-content">
                <div class="modal-header">
                    <h2 id="eventModalTitle">Detalhes do Evento</h2>
                    <span class="close" onclick="closeEventModal()">&times;</span>
                </div>
                <div class="modal-body" id="eventModalBody">
                    <!-- Event details will be populated here -->
                </div>
            </div>
        </div>

        <script>
            // =================================================================
            // GLOBAL VARIABLES
            // =================================================================
            let gapiInited = false;
            let gisInited = false;
            let tokenClient;
            let isGoogleConnected = false;
            let currentDate = new Date();
            let filteredEvents = [];
            let allEvents = new Map();
            let currentFilters = {
                keywords: '',
                type: ''
            };

            // ✅ NOVO: Variáveis para filtros de pagamentos
            let allPaymentsList = [];
            let filteredPaymentsList = [];

            // ✅ NOVO: Variáveis para edição de descrição
            let isEditingDescription = false;
            let currentEditingEventId = null;
            let originalDescription = '';

            // =================================================================
            // ✅ NOVO: VARIÁVEIS PARA MÚLTIPLAS CONTAS GOOGLE
            // =================================================================
            let connectedAccounts = new Map();
            let accountCalendars = new Map();
            let activeCalendars = new Set();
            let currentAuthInstance = null;
            let isLoadingAccounts = false;

            const ACCOUNT_COLORS = [
                '#4285f4', '#34a853', '#ea4335', '#fbbc04', '#9c27b0',
                '#ff9800', '#795548', '#607d8b', '#e91e63', '#009688'
            ];

            // =================================================================
            // GOOGLE API INITIALIZATION
            // =================================================================
            async function gapiLoaded() {
                await gapi.load('client', initializeGapi);
            }

            async function initializeGapi() {
                try {
                    await gapi.client.init({
                        apiKey: 'AIzaSyBhJJOOqNGqNGqNGqNGqNGqNGqNGqNGqNG',
                        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest'],
                    });
                    gapiInited = true;
                    console.log('✅ GAPI inicializado com sucesso');
                    maybeEnableButtons();
                } catch (error) {
                    console.error('❌ Erro ao inicializar GAPI:', error);
                    showMessage('Erro ao carregar APIs do Google', 'error');
                }
            }

            async function gisLoaded() {
                try {
                    tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: '123456789-abcdefghijklmnopqrstuvwxyz.apps.googleusercontent.com',
                        scope: 'https://www.googleapis.com/auth/calendar.events',
                        callback: handleTokenResponse,
                    });
                    gisInited = true;
                    console.log('✅ GIS inicializado com sucesso');
                    maybeEnableButtons();
                } catch (error) {
                    console.error('❌ Erro ao inicializar GIS:', error);
                    showMessage('Erro ao carregar sistema de autenticação', 'error');
                }
            }

            function maybeEnableButtons() {
                if (gapiInited && gisInited) {
                    console.log('✅ Todas as APIs carregadas');
                    
                    // Verificar se há token salvo
                    const savedToken = localStorage.getItem('google_calendar_token');
                    if (savedToken) {
                        try {
                            const tokenData = JSON.parse(savedToken);
                            if (tokenData.access_token && tokenData.expires_at > Date.now()) {
                                console.log('✅ Token válido encontrado, restaurando sessão...');
                                gapi.client.setToken(tokenData);
                                isGoogleConnected = true;
                                updateConnectionStatus(true);
                                loadFilteredEvents();
                            } else {
                                console.log('⚠️ Token expirado, removendo...');
                                localStorage.removeItem('google_calendar_token');
                            }
                        } catch (error) {
                            console.error('❌ Erro ao restaurar token:', error);
                            localStorage.removeItem('google_calendar_token');
                        }
                    }
                }
            }

            function initializeGoogleAPI() {
                console.log('🔄 Inicializando APIs do Google...');
                // As funções gapiLoaded e gisLoaded serão chamadas automaticamente
            }

            // =================================================================
            // ✅ SISTEMA DE EXTRAÇÃO COM STATUS MELHORADO
            // =================================================================
            function extractPaymentInfo(text) {
                if (!text) return [];
                
                // Regex para detectar padrões como "Nome do pagamento - R$ 1.234,56 (STATUS)"
                const paymentRegex = /([^-\n\r]+?)\s*-\s*R\$\s*([\d.]+,\d{2})\s*(\([^)]*\))?/gi;
                const matches = [];
                let match;
                
                while ((match = paymentRegex.exec(text)) !== null) {
                    const paymentName = match[1].trim();
                    const valueStr = match[2];
                    const statusText = match[3] ? match[3].replace(/[()]/g, '').trim() : '';
                    const numericValue = parseFloat(valueStr.replace(/\./g, '').replace(',', '.'));
                    
                    // Determinar status baseado no texto entre parênteses
                    let status = 'PENDENTE'; // Status padrão
                    
                    if (statusText) {
                        const statusLower = statusText.toLowerCase();
                        if (statusLower.includes('pg')) {
                            status = 'PG';
                        } else if (statusLower.includes('recalculado')) {
                            status = 'RECALCULADO';
                        }
                    }
                    
                    matches.push({
                        name: paymentName,
                        original: `${paymentName} - R$ ${valueStr}${match[3] ? ' ' + match[3] : ''}`,
                        value: numericValue,
                        formattedValue: `R$ ${valueStr}`,
                        status: status,
                        statusText: statusText
                    });
                }
                
                // Fallback: se não encontrar o padrão com "-", usar o método antigo
                if (matches.length === 0) {
                    const moneyRegex = /R\$\s*([\d.]+,\d{2})/gi;
                    const moneyMatches = text.match(moneyRegex) || [];
                    
                    moneyMatches.forEach(match => {
                        const valueStr = match.replace(/R\$\s*/, '');
                        const numericValue = parseFloat(valueStr.replace(/\./g, '').replace(',', '.'));
                        
                        matches.push({
                            name: 'Pagamento',
                            original: match,
                            value: numericValue,
                            formattedValue: match,
                            status: 'PENDENTE',
                            statusText: ''
                        });
                    });
                }
                
                return matches;
            }

            function calculateEventTotal(event) {
                const description = event.description || '';
                const summary = event.summary || '';
                const fullText = `${summary} ${description}`;
                
                const payments = extractPaymentInfo(fullText);
                
                // Só contar PG e PENDENTE para o total
                const countablePayments = payments.filter(p => p.status === 'PG' || p.status === 'PENDENTE');
                const total = countablePayments.reduce((sum, item) => sum + item.value, 0);
                
                return {
                    total: total,
                    payments: payments,
                    countablePayments: countablePayments,
                    count: payments.length,
                    countableCount: countablePayments.length
                };
            }

            function formatCurrency(value) {
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(value);
            }

            function calculateDayTotal(date) {
                const eventsForDay = getEventsForDay(date);
                let dayTotal = 0;
                
                eventsForDay.forEach(event => {
                    const eventCalc = calculateEventTotal(event);
                    dayTotal += eventCalc.total; // Já considera apenas PG e PENDENTE
                });
                
                return dayTotal;
            }

            function getEventType(event) {
                const text = `${event.summary || ''} ${event.description || ''}`.toLowerCase();
                
                if (text.includes('pagamento')) return 'PAGAMENTO';
                if (text.includes('hvc')) return 'HVC';
                if (text.includes('pg')) return 'PG';
                
                return 'OUTROS';
            }

            // ✅ NOVA LÓGICA DE CORES BASEADA EM STATUS E DATA
            function getEventColor(event) {
                const eventCalc = calculateEventTotal(event);
                const eventDate = parseEventDate(event);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                eventDate.setHours(0, 0, 0, 0);
                
                // Se todos os pagamentos são PG ou RECALCULADO, cor verde
                const allPaidOrRecalculated = eventCalc.payments.length > 0 && 
                    eventCalc.payments.every(p => p.status === 'PG' || p.status === 'RECALCULADO');
                
                if (allPaidOrRecalculated) {
                    return 'all-pg'; // Verde
                }
                
                // Se há pagamentos pendentes
                const hasPending = eventCalc.payments.some(p => p.status === 'PENDENTE');
                
                if (hasPending) {
                    if (eventDate < today) {
                        return 'has-pending'; // Vermelho (data passada)
                    } else {
                        return 'future-pending'; // Azul (data futura)
                    }
                }
                
                // Fallback para lógica antiga baseada no tipo
                const eventType = getEventType(event);
                return eventType.toLowerCase();
            }

            // =================================================================
            // ✅ NOVO: CÁLCULO DE TOTAIS MENSAIS COM STATUS
            // =================================================================
            function calculateMonthlyTotals() {
                const currentMonth = currentDate.getMonth();
                const currentYear = currentDate.getFullYear();
                
                let monthlyTotal = 0;
                let totalEvents = 0;
                let totalPayments = 0;
                let totalPG = 0;
                let totalPendente = 0;
                let totalRecalculado = 0;
                let amountPG = 0;
                let amountPendente = 0;
                let amountRecalculado = 0;
                let paymentsList = [];
                
                filteredEvents.forEach(event => {
                    const eventDate = parseEventDate(event);
                    
                    if (eventDate.getMonth() === currentMonth && eventDate.getFullYear() === currentYear) {
                        totalEvents++;
                        const eventCalc = calculateEventTotal(event);
                        
                        if (eventCalc.count > 0) {
                            monthlyTotal += eventCalc.total; // Já considera apenas PG e PENDENTE
                            totalPayments += eventCalc.count;
                            
                            // ✅ NOVO: Contar por status e calcular montantes
                            eventCalc.payments.forEach(payment => {
                                if (payment.status === 'PG') {
                                    totalPG++;
                                    amountPG += payment.value;
                                } else if (payment.status === 'PENDENTE') {
                                    totalPendente++;
                                    amountPendente += payment.value;
                                } else if (payment.status === 'RECALCULADO') {
                                    totalRecalculado++;
                                    amountRecalculado += payment.value;
                                }
                                
                                // ✅ NOVO: Adicionar à lista de pagamentos
                                paymentsList.push({
                                    name: payment.name,
                                    value: payment.value,
                                    formattedValue: payment.formattedValue,
                                    status: payment.status,
                                    eventDate: eventDate,
                                    eventTitle: event.summary || 'Sem título',
                                    eventType: getEventType(event),
                                    eventId: event.id
                                });
                            });
                        }
                    }
                });
                
                // ✅ NOVO: Ordenar pagamentos por data (mais recente primeiro)
                paymentsList.sort((a, b) => b.eventDate - a.eventDate);
                
                return {
                    total: monthlyTotal,
                    events: totalEvents,
                    payments: totalPayments,
                    totalPG: totalPG,
                    totalPendente: totalPendente,
                    totalRecalculado: totalRecalculado,
                    amountPG: amountPG,
                    amountPendente: amountPendente,
                    amountRecalculado: amountRecalculado,
                    paymentsList: paymentsList
                };
            }

            function updateMonthlySummary() {
                const monthlyData = calculateMonthlyTotals();
                
                // Atualizar total mensal
                const monthlyTotalElement = document.getElementById('monthlyTotal');
                if (monthlyTotalElement) {
                    monthlyTotalElement.textContent = formatCurrency(monthlyData.total);
                }
                
                // Atualizar estatísticas gerais
                const totalEventsElement = document.getElementById('totalEvents');
                const totalPaymentsElement = document.getElementById('totalPayments');
                const avgPaymentElement = document.getElementById('avgPayment');
                
                if (totalEventsElement) {
                    totalEventsElement.textContent = monthlyData.events;
                }
                
                if (totalPaymentsElement) {
                    totalPaymentsElement.textContent = monthlyData.payments;
                }
                
                    if (avgPaymentElement) {
                        // ✅ NOVO: Calcular valor médio por dia do mês
                        const currentMonth = currentDate.getMonth();
                        const currentYear = currentDate.getFullYear();
                        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
                        const avgValue = monthlyData.total > 0 ? monthlyData.total / daysInMonth : 0;
                        avgPaymentElement.textContent = formatCurrency(avgValue);
                    }

                
                // ✅ NOVO: Atualizar estatísticas por status com montantes
                const totalPGElement = document.getElementById('totalPG');
                const totalPendenteElement = document.getElementById('totalPendente');
                const totalRecalculadoElement = document.getElementById('totalRecalculado');
                const amountPGElement = document.getElementById('amountPG');
                const amountPendenteElement = document.getElementById('amountPendente');
                const amountRecalculadoElement = document.getElementById('amountRecalculado');
                
                if (totalPGElement) {
                    totalPGElement.textContent = monthlyData.totalPG;
                }
                
                if (totalPendenteElement) {
                    totalPendenteElement.textContent = monthlyData.totalPendente;
                }
                
                if (totalRecalculadoElement) {
                    totalRecalculadoElement.textContent = monthlyData.totalRecalculado;
                }
                
                if (amountPGElement) {
                    amountPGElement.textContent = formatCurrency(monthlyData.amountPG);
                }
                
                if (amountPendenteElement) {
                    amountPendenteElement.textContent = formatCurrency(monthlyData.amountPendente);
                }
                
                if (amountRecalculadoElement) {
                    amountRecalculadoElement.textContent = formatCurrency(monthlyData.amountRecalculado);
                }
                
                // ✅ NOVO: Atualizar lista de pagamentos com filtros
                allPaymentsList = monthlyData.paymentsList;
                filteredPaymentsList = [...allPaymentsList];
                updatePaymentsList();
            }

            // =================================================================
            // ✅ NOVO: SISTEMA DE FILTROS DE PAGAMENTOS
            // =================================================================
            function initializePaymentFilters() {
                const nameFilter = document.getElementById('nameFilter');
                const dateFilter = document.getElementById('dateFilter');
                const statusFilter = document.getElementById('statusFilter');
                const clearFiltersBtn = document.getElementById('clearFilters');
                
                if (nameFilter) {
                    nameFilter.addEventListener('input', filterPayments);
                }
                
                if (dateFilter) {
                    dateFilter.addEventListener('change', filterPayments);
                }
                
                if (statusFilter) {
                    statusFilter.addEventListener('change', filterPayments);
                }
                
                if (clearFiltersBtn) {
                    clearFiltersBtn.addEventListener('click', clearPaymentFilters);
                }
            }

            function filterPayments() {
                const nameFilter = document.getElementById('nameFilter')?.value.toLowerCase() || '';
                const dateFilter = document.getElementById('dateFilter')?.value || '';
                const statusFilter = document.getElementById('statusFilter')?.value || '';
                
                filteredPaymentsList = allPaymentsList.filter(payment => {
                    // Filtro por nome
                    const nameMatch = !nameFilter || 
                        payment.name.toLowerCase().includes(nameFilter) ||
                        payment.eventTitle.toLowerCase().includes(nameFilter);
                    
                    // Filtro por data
                    const dateMatch = !dateFilter || 
                        payment.eventDate.toISOString().split('T')[0] === dateFilter;
                    
                    // Filtro por status
                    const statusMatch = !statusFilter || payment.status === statusFilter;
                    
                    return nameMatch && dateMatch && statusMatch;
                });
                
                updatePaymentsList();
            }

            function clearPaymentFilters() {
                document.getElementById('nameFilter').value = '';
                document.getElementById('dateFilter').value = '';
                document.getElementById('statusFilter').value = '';
                
                filteredPaymentsList = [...allPaymentsList];
                updatePaymentsList();
            }

            function updatePaymentsList() {
                const paymentsList = document.getElementById('paymentsList');
                if (!paymentsList) return;
                
                if (filteredPaymentsList.length === 0) {
                    paymentsList.innerHTML = `
                        <div class="no-payments">
                            <i class="fas fa-receipt"></i>
                            <div>Nenhum pagamento encontrado</div>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                filteredPaymentsList.forEach(payment => {
                    html += `
                        <div class="payment-item" onclick="showEventDetails({id: '${payment.eventId}'})">
                            <div class="payment-header">
                                <div class="payment-name">${payment.name}</div>
                                <div class="payment-value">${payment.formattedValue}</div>
                            </div>
                            <div class="payment-details">
                                <div class="payment-date">
                                    <i class="fas fa-calendar"></i>
                                    ${payment.eventDate.toLocaleDateString('pt-BR')}
                                </div>
                                <div class="payment-status ${payment.status.toLowerCase()}">
                                    <i class="fas fa-tag"></i>
                                    ${payment.status}
                                </div>
                                <div class="payment-type ${payment.eventType.toLowerCase()}">
                                    <i class="fas fa-file-alt"></i>
                                    ${payment.eventType}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                paymentsList.innerHTML = html;
            }

            // =================================================================
            // MESSAGE SYSTEM
            // =================================================================
            function showMessage(text, type = 'info') {
                // Remove mensagens existentes
                const existingMessages = document.querySelectorAll('.message');
                existingMessages.forEach(msg => msg.remove());
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;
                messageDiv.innerHTML = `
                    <i class="fas ${getMessageIcon(type)}"></i>
                    <span>${text}</span>
                `;
                
                document.body.appendChild(messageDiv);
                
                // Auto-remove após 5 segundos
                setTimeout(() => {
                    messageDiv.remove();
                }, 5000);
            }

            function getMessageIcon(type) {
                switch (type) {
                    case 'success': return 'fa-check-circle';
                    case 'error': return 'fa-exclamation-triangle';
                    case 'warning': return 'fa-exclamation-circle';
                    default: return 'fa-info-circle';
                }
            }

            // =================================================================
            // GOOGLE AUTHENTICATION
            // =================================================================
            function handleAuthClick() {
                if (!gapiInited || !gisInited) {
                    showMessage('APIs do Google ainda não foram carregadas. Aguarde...', 'error');
                    return;
                }

                try {
                    tokenClient.requestAccessToken({ prompt: 'consent' });
                } catch (error) {
                    console.error('❌ Erro na autenticação:', error);
                    showMessage('Erro ao tentar conectar com o Google Calendar', 'error');
                }
            }

            async function handleTokenResponse(resp) {
                if (resp.error) {
                    console.error('❌ Erro de autenticação:', resp.error);
                    showMessage(`Erro de autenticação: ${resp.error}`, 'error');
                    updateConnectionStatus(false);
                    return;
                }

                try {
                    gapi.client.setToken(resp);
                    isGoogleConnected = true;
                    
                    // Salvar estado de conexão
                    saveConnectionState();
                    
                    console.log('✅ Conectado com o Google Calendar!');
                    updateConnectionStatus(true);
                    showMessage('Conectado com sucesso ao Google Calendar!', 'success');
                    
                    // Carregar eventos filtrados
                    await loadFilteredEvents();
                } catch (error) {
                    console.error('❌ Erro ao processar token:', error);
                    showMessage('Erro ao processar autenticação', 'error');
                    updateConnectionStatus(false);
                }
            }

            function handleSignoutClick() {
                try {
                    const token = gapi.client.getToken();
                    if (token !== null) {
                        google.accounts.oauth2.revoke(token.access_token);
                        gapi.client.setToken('');
                        isGoogleConnected = false;
                        
                        // Limpar estado de conexão
                        clearConnectionState();
                        
                        console.log('✅ Desconectado do Google Calendar');
                        updateConnectionStatus(false);
                        document.getElementById('calendarSection').style.display = 'none';
                        document.getElementById('filterSection').style.display = 'none';
                        document.getElementById('monthlySummarySection').style.display = 'none';
                        document.getElementById('paymentsListSection').style.display = 'none';
                        document.getElementById('multiAccountSection').style.display = 'none';
                        showMessage('Desconectado do Google Calendar', 'success');
                    }
                } catch (error) {
                    console.error('❌ Erro ao desconectar:', error);
                    showMessage('Erro ao desconectar', 'error');
                }
            }

            // =================================================================
            // CONNECTION STATUS
            // =================================================================
            function updateConnectionStatus(connected) {
                const connectionStatus = document.getElementById('connectionStatus');
                const authorizeButton = document.getElementById('authorizeButton');
                const signoutButton = document.getElementById('signoutButton');
                const syncButton = document.getElementById('syncButton');
                const calendarSection = document.getElementById('calendarSection');
                const filterSection = document.getElementById('filterSection');
                const monthlySummarySection = document.getElementById('monthlySummarySection');
                const paymentsListSection = document.getElementById('paymentsListSection');
                
                if (connected) {
                    connectionStatus.className = 'status-indicator status-connected';
                    connectionStatus.innerHTML = '<i class="fas fa-check-circle"></i><span>Conectado ao Google Calendar</span>';
                    
                    authorizeButton.style.display = 'none';
                    signoutButton.style.display = 'inline-flex';
                    syncButton.style.display = 'inline-flex';
                    
                    calendarSection.style.display = 'block';
                    filterSection.style.display = 'block';
                    monthlySummarySection.style.display = 'block';
                    paymentsListSection.style.display = 'block';
                    document.getElementById('multiAccountSection').style.display = 'block';
                } else {
                    connectionStatus.className = 'status-indicator status-disconnected';
                    connectionStatus.innerHTML = '<i class="fas fa-times-circle"></i><span>Desconectado do Google Calendar</span>';
                    
                    authorizeButton.style.display = 'inline-flex';
                    signoutButton.style.display = 'none';
                    syncButton.style.display = 'none';
                    
                    calendarSection.style.display = 'none';
                    filterSection.style.display = 'none';
                    monthlySummarySection.style.display = 'none';
                    paymentsListSection.style.display = 'none';
                    document.getElementById('multiAccountSection').style.display = 'none';
                }
                
                isGoogleConnected = connected;
            }

            function saveConnectionState() {
                try {
                    const token = gapi.client.getToken();
                    if (token) {
                        const tokenData = {
                            access_token: token.access_token,
                            expires_at: Date.now() + (3600 * 1000) // 1 hora
                        };
                        localStorage.setItem('google_calendar_token', JSON.stringify(tokenData));
                        console.log('✅ Estado de conexão salvo');
                    }
                } catch (error) {
                    console.error('❌ Erro ao salvar estado de conexão:', error);
                }
            }

            function clearConnectionState() {
                try {
                    localStorage.removeItem('google_calendar_token');
                    console.log('✅ Estado de conexão limpo');
                } catch (error) {
                    console.error('❌ Erro ao limpar estado de conexão:', error);
                }
            }

            // =================================================================
            // CALENDAR EVENTS
            // =================================================================
            async function loadFilteredEvents() {
                if (!isGoogleConnected) {
                    console.log('⚠️ Não conectado ao Google Calendar');
                    return;
                }

                try {
                    console.log('🔄 Carregando eventos filtrados...');
                    
                    const response = await gapi.client.calendar.events.list({
                        calendarId: 'primary',
                        timeMin: new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).toISOString(),
                        timeMax: new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0, 23, 59, 59).toISOString(),
                        singleEvents: true,
                        orderBy: 'startTime',
                        maxResults: 2500
                    });

                    const events = response.result.items || [];
                    console.log(`📅 ${events.length} eventos carregados`);

                    // Aplicar filtros
                    filteredEvents = events.filter(event => {
                        const text = `${event.summary || ''} ${event.description || ''}`.toLowerCase();
                        
                        // Filtro por palavras-chave
                        if (currentFilters.keywords) {
                            const keywords = currentFilters.keywords.toLowerCase().split(',').map(k => k.trim());
                            const hasKeyword = keywords.some(keyword => text.includes(keyword));
                            if (!hasKeyword) return false;
                        }
                        
                        // Filtro por tipo
                        if (currentFilters.type) {
                            const eventType = getEventType(event);
                            if (eventType !== currentFilters.type) return false;
                        }
                        
                        return true;
                    });

                    console.log(`🔍 ${filteredEvents.length} eventos após filtros`);
                    
                    // Atualizar interface
                    renderCalendar();
                    updateMonthlySummary();
                    updateFilterResults();
                    
                } catch (error) {
                    console.error('❌ Erro ao carregar eventos:', error);
                    showMessage('Erro ao carregar eventos do Google Calendar', 'error');
                }
            }

            function parseEventDate(event) {
                if (event.start.date) {
                    return new Date(event.start.date + 'T00:00:00');
                } else if (event.start.dateTime) {
                    return new Date(event.start.dateTime);
                }
                return new Date();
            }

            function getCalendarDateString(date) {
                return date.toISOString().split('T')[0];
            }

            function getEventsForDay(date) {
                const targetDateString = getCalendarDateString(date);
                
                return filteredEvents.filter(event => {
                    const eventDate = parseEventDate(event);
                    const eventDateString = getCalendarDateString(eventDate);
                    
                    return eventDateString === targetDateString;
                });
            }

            async function showEventDetails(event) {
                const modal = document.getElementById('eventModal');
                const title = document.getElementById('eventModalTitle');
                const body = document.getElementById('eventModalBody');
                
                if (!modal || !title || !body) return;
                
                title.textContent = event.summary || 'Sem título';
                
                const eventDate = parseEventDate(event);
                const start = eventDate;
                const end = event.end.dateTime ? new Date(event.end.dateTime) : eventDate;
                
                // Calcular valores do evento
                const eventCalc = calculateEventTotal(event);
                
                let detailsHTML = `
                    <p><strong><i class="fas fa-calendar"></i> Data:</strong> ${start.toLocaleDateString('pt-BR')}</p>
                    <p><strong><i class="fas fa-clock"></i> Horário:</strong> ${event.start.dateTime ? 
                        `${start.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })} - ${end.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}` : 
                        'Dia inteiro'}</p>
                                    <div id="descriptionSection">
                                        <p><strong><i class="fas fa-info-circle"></i> Descrição:</strong></p>
                                        ${event.description ? `
                                            <div id="descriptionDisplay" class="description-display">${event.description}</div>
                                        ` : `
                                            <div id="descriptionDisplay" class="description-display description-empty">Nenhuma descrição</div>
                                        `}
                                        <button onclick="startEditingDescription('${event.id}')" class="btn-edit">
                                            <i class="fas fa-edit"></i> ${event.description ? 'Editar Descrição' : 'Adicionar Descrição'}
                                        </button>
                                    </div>

                    ${event.location ? `<p><strong><i class="fas fa-map-marker-alt"></i> Local:</strong> ${event.location}</p>` : ''}
                    <p><strong><i class="fas fa-tag"></i> Tipo:</strong> ${getEventType(event).toUpperCase()}</p>
                `;
                
                // Seção de valores encontrados
                if (eventCalc.count > 0) {
                    detailsHTML += `
                        <div class="event-total-section">
                            <div class="event-total-title">
                                <i class="fas fa-calculator"></i> TOTAL CONTABILIZADO (PG + PENDENTE)
                            </div>
                            <div class="event-total-value">
                                ${formatCurrency(eventCalc.total)}
                            </div>
                        </div>
                    `;
                    
                    if (eventCalc.payments.length > 0) {
                        detailsHTML += `
                            <div class="event-values-list">
                                <h4><i class="fas fa-list"></i> Pagamentos Encontrados (${eventCalc.count}):</h4>
                        `;
                        eventCalc.payments.forEach((payment, index) => {
                            detailsHTML += `
                                <div class="value-item">
                                    <div>
                                        <strong>${payment.name}</strong> - ${payment.formattedValue}
                                    </div>
                                    <div class="value-item-status ${payment.status.toLowerCase()}">
                                        ${payment.status}
                                    </div>
                                </div>
                            `;
                        });
                        detailsHTML += '</div>';
                    }
                }
                
                // Buscar anexos do evento
                try {
                    if (event.attachments && event.attachments.length > 0) {
                        detailsHTML += '<p><strong><i class="fas fa-paperclip"></i> Anexos:</strong></p><div style="margin-left: 20px;">';
                        event.attachments.forEach(attachment => {
                            detailsHTML += `
                                <a href="${attachment.fileUrl}" target="_blank" class="attachment-link">
                                    <i class="fas fa-file"></i> ${attachment.title || 'Anexo'}
                                </a>
                            `;
                        });
                        detailsHTML += '</div>';
                    } else {
                        // Tentar buscar anexos via API se não estiverem no evento
                        try {
                            const fullEvent = await gapi.client.calendar.events.get({
                                calendarId: 'primary',
                                eventId: event.id
                            });
                            
                            if (fullEvent.result.attachments && fullEvent.result.attachments.length > 0) {
                                detailsHTML += '<p><strong><i class="fas fa-paperclip"></i> Anexos:</strong></p><div style="margin-left: 20px;">';
                                fullEvent.result.attachments.forEach(attachment => {
                                    detailsHTML += `
                                        <a href="${attachment.fileUrl}" target="_blank" class="attachment-link">
                                            <i class="fas fa-file"></i> ${attachment.title || 'Anexo'}
                                        </a>
                                    `;
                                });
                                detailsHTML += '</div>';
                            }
                        } catch (attachmentError) {
                            console.log('ℹ️ Nenhum anexo encontrado ou erro ao buscar anexos');
                        }
                    }
                } catch (error) {
                    console.log('ℹ️ Erro ao processar anexos:', error);
                }
                
                body.innerHTML = detailsHTML;
                modal.style.display = 'block';
            }

            function closeEventModal() {
                const modal = document.getElementById('eventModal');
                if (modal) {
                    modal.style.display = 'none';
                }
                
                // Cancelar edição se estiver ativa
                if (isEditingDescription) {
                    cancelEditingDescription();
                }
            }

            // Fechar modal ao clicar fora dele
            window.onclick = function(event) {
                const modal = document.getElementById('eventModal');
                if (event.target === modal) {
                    closeEventModal();
                }
            }

            // =================================================================
            // ✅ NOVO: SISTEMA DE EDIÇÃO DE DESCRIÇÃO
            // =================================================================
            
            /**
             * Inicia a edição da descrição de um evento
             */
            function startEditingDescription(eventId) {
                if (isEditingDescription) {
                    showMessage('Já existe uma edição em andamento', 'warning');
                    return;
                }
                
                console.log('✏️ Iniciando edição da descrição do evento:', eventId);
                
                // Encontrar o evento
                const event = filteredEvents.find(e => e.id === eventId);
                if (!event) {
                    showMessage('Evento não encontrado', 'error');
                    return;
                }
                
                isEditingDescription = true;
                currentEditingEventId = eventId;
                originalDescription = event.description || '';
                
                // Criar interface de edição
                const descriptionSection = document.getElementById('descriptionSection');
                if (!descriptionSection) return;
                
                descriptionSection.innerHTML = `
                    <div class="edit-description-section">
                        <p><strong><i class="fas fa-edit"></i> Editando Descrição:</strong></p>
                        <textarea 
                            id="descriptionTextarea" 
                            class="edit-description-textarea"
                            placeholder="Digite a descrição do evento..."
                        >${originalDescription}</textarea>
                        <div class="edit-buttons">
                            <button onclick="saveEventDescription()" class="btn-save">
                                <i class="fas fa-save"></i> Salvar
                            </button>
                            <button onclick="cancelEditingDescription()" class="btn-cancel">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                        </div>
                        <div id="editLoadingIndicator" class="edit-loading" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i> Salvando...
                        </div>
                        <div class="edit-shortcuts">
                            <small><i class="fas fa-keyboard"></i> Atalhos: Ctrl+Enter para salvar, Esc para cancelar</small>
                        </div>
                    </div>
                `;
                
                // Focar no textarea
                const textarea = document.getElementById('descriptionTextarea');
                if (textarea) {
                    textarea.focus();
                    textarea.setSelectionRange(textarea.value.length, textarea.value.length);
                }
                
                console.log('✅ Interface de edição criada');
            }
            
            /**
             * Cancela a edição da descrição
             */
            function cancelEditingDescription() {
                if (!isEditingDescription) return;
                
                console.log('❌ Cancelando edição da descrição');
                
                // Restaurar interface original
                const event = filteredEvents.find(e => e.id === currentEditingEventId);
                if (event) {
                    const descriptionSection = document.getElementById('descriptionSection');
                    if (descriptionSection) {
                        descriptionSection.innerHTML = `
                            <p><strong><i class="fas fa-info-circle"></i> Descrição:</strong></p>
                            ${originalDescription ? `
                                <div id="descriptionDisplay" class="description-display">${originalDescription}</div>
                            ` : `
                                <div id="descriptionDisplay" class="description-display description-empty">Nenhuma descrição</div>
                            `}
                            <button onclick="startEditingDescription('${event.id}')" class="btn-edit">
                                <i class="fas fa-edit"></i> ${originalDescription ? 'Editar Descrição' : 'Adicionar Descrição'}
                            </button>
                        `;
                    }
                }
                
                // Resetar variáveis
                isEditingDescription = false;
                currentEditingEventId = null;
                originalDescription = '';
                
                console.log('✅ Edição cancelada');
            }
            
            /**
             * Salva a descrição editada no Google Calendar
             */
            async function saveEventDescription() {
                if (!isEditingDescription || !currentEditingEventId) {
                    showMessage('Nenhuma edição ativa', 'error');
                    return;
                }
                
                const textarea = document.getElementById('descriptionTextarea');
                const saveBtn = document.querySelector('.btn-save');
                const cancelBtn = document.querySelector('.btn-cancel');
                const loadingIndicator = document.getElementById('editLoadingIndicator');
                
                if (!textarea) {
                    showMessage('Campo de texto não encontrado', 'error');
                    return;
                }
                
                const newDescription = textarea.value.trim();
                
                // Verificar se houve mudança
                if (newDescription === originalDescription) {
                    showMessage('Nenhuma alteração detectada', 'info');
                    cancelEditingDescription();
                    return;
                }
                
                console.log('💾 Salvando descrição do evento:', currentEditingEventId);
                
                // Mostrar loading
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'block';
                }
                
                // Desabilitar botões
                if (saveBtn) saveBtn.disabled = true;
                if (cancelBtn) cancelBtn.disabled = true;
                
                try {
                    // Buscar evento completo
                    const eventResponse = await gapi.client.calendar.events.get({
                        calendarId: 'primary',
                        eventId: currentEditingEventId
                    });
                    
                    const event = eventResponse.result;
                    
                    // Atualizar descrição
                    event.description = newDescription;
                    
                    // Salvar no Google Calendar
                    const updateResponse = await gapi.client.calendar.events.update({
                        calendarId: 'primary',
                        eventId: currentEditingEventId,
                        resource: event
                    });
                    
                    if (updateResponse.status === 200) {
                        console.log('✅ Descrição salva com sucesso');
                        showMessage('Descrição atualizada com sucesso!', 'success');
                        
                        // Atualizar evento local
                        const localEvent = filteredEvents.find(e => e.id === currentEditingEventId);
                        if (localEvent) {
                            localEvent.description = newDescription;
                        }
                        
                        // Atualizar resumo mensal (pode ter mudado os valores)
                        updateMonthlySummary();
                        
                        // Cancelar edição
                        cancelEditingDescription();
                        
                        // Recarregar eventos para garantir sincronização
                        await loadFilteredEvents();
                        
                    } else {
                        throw new Error(`Resposta inesperada da API: ${updateResponse.status}`);
                    }
                    
                } catch (error) {
                    console.error('❌ Erro ao salvar descrição:', error);
                    
                    let errorMessage = 'Erro ao salvar descrição. ';
                    
                    if (error.status === 401) {
                        errorMessage += 'Sessão expirada. Reconecte-se ao Google Calendar.';
                    } else if (error.status === 403) {
                        errorMessage += 'Sem permissão para editar este evento.';
                    } else if (error.status === 404) {
                        errorMessage += 'Evento não encontrado no Google Calendar.';
                    } else {
                        errorMessage += 'Tente novamente em alguns instantes.';
                    }
                    
                    showMessage(errorMessage, 'error');
                    
                    // Reabilitar botões em caso de erro
                    if (saveBtn) saveBtn.disabled = false;
                    if (cancelBtn) cancelBtn.disabled = false;
                    
                } finally {
                    // Esconder loading
                    if (loadingIndicator) {
                        loadingIndicator.style.display = 'none';
                    }
                    
                    console.log('🔄 Processo de salvamento finalizado');
                }
            }
    
            /**
             * Manipulador de eventos de teclado para atalhos
             */
            function handleEditingKeyboard(event) {
                if (!isEditingDescription) return;
                
                // Ctrl+Enter para salvar
                if (event.ctrlKey && event.key === 'Enter') {
                    event.preventDefault();
                    console.log('⌨️ Atalho Ctrl+Enter detectado');
                    saveEventDescription();
                    return;
                }
                
                // Escape para cancelar
                if (event.key === 'Escape') {
                    event.preventDefault();
                    console.log('⌨️ Atalho Escape detectado');
                    cancelEditingDescription();
                    return;
                }
            }
    
            // Adicionar listener para atalhos de teclado
            document.addEventListener('keydown', handleEditingKeyboard);

            // =================================================================
            // ✅ NOVO: SISTEMA DE MÚLTIPLAS CONTAS GOOGLE
            // =================================================================

            /**
             * Inicializa o sistema de múltiplas contas
             */
            function initializeMultiAccountSystem() {
                console.log('🔄 Inicializando sistema de múltiplas contas...');
                
                // Mostrar seção de múltiplas contas se já conectado
                if (isGoogleConnected) {
                    document.getElementById('multiAccountSection').style.display = 'block';
                    loadConnectedAccounts();
                }
            }

            /**
             * Carrega as contas já conectadas
             */
            async function loadConnectedAccounts() {
                console.log('🔄 Carregando contas conectadas...');
                
                try {
                    // Carregar contas do localStorage
                    const savedAccounts = localStorage.getItem('connectedGoogleAccounts');
                    if (savedAccounts) {
                        const accounts = JSON.parse(savedAccounts);
                        for (const [accountId, accountData] of Object.entries(accounts)) {
                            connectedAccounts.set(accountId, accountData);
                        }
                    }
                    
                    updateAccountsList();
                    
                } catch (error) {
                    console.error('❌ Erro ao carregar contas:', error);
                }
            }

            /**
             * Adiciona uma nova conta Google
             */
            async function addNewAccount() {
                console.log('🔄 Adicionando nova conta...');
                
                if (isLoadingAccounts) {
                    showMessage('Aguarde o carregamento da conta anterior', 'warning');
                    return;
                }
                
                isLoadingAccounts = true;
                
                try {
                    // Criar nova instância de autenticação
                    const authInstance = gapi.auth2.getAuthInstance();
                    
                    // Solicitar login com prompt para seleção de conta
                    const user = await authInstance.signIn({
                        prompt: 'select_account'
                    });
                    
                    const profile = user.getBasicProfile();
                    const accountId = profile.getId();
                    const email = profile.getEmail();
                    const name = profile.getName();
                    const imageUrl = profile.getImageUrl();
                    
                    // Verificar se a conta já está conectada
                    if (connectedAccounts.has(accountId)) {
                        showMessage('Esta conta já está conectada', 'warning');
                        return;
                    }
                    
                    // Adicionar nova conta
                    const accountData = {
                        id: accountId,
                        email: email,
                        name: name,
                        imageUrl: imageUrl,
                        accessToken: user.getAuthResponse().access_token,
                        connectedAt: new Date().toISOString(),
                        status: 'connected',
                        color: ACCOUNT_COLORS[connectedAccounts.size % ACCOUNT_COLORS.length]
                    };
                    
                    connectedAccounts.set(accountId, accountData);
                    
                    // Carregar calendários da nova conta
                    await loadAccountCalendars(accountId);
                    
                    // Salvar no localStorage
                    saveConnectedAccounts();
                    
                    // Atualizar interface
                    updateAccountsList();
                    
                    // Recarregar eventos
                    await loadEventsFromMultipleAccounts();
                    
                    showMessage(`Conta ${email} conectada com sucesso!`, 'success');
                    
                } catch (error) {
                    console.error('❌ Erro ao adicionar conta:', error);
                    showMessage('Erro ao conectar nova conta', 'error');
                } finally {
                    isLoadingAccounts = false;
                }
            }

            /**
             * Carrega os calendários de uma conta específica
             */
            async function loadAccountCalendars(accountId) {
                console.log('🔄 Carregando calendários da conta:', accountId);
                
                try {
                    const accountData = connectedAccounts.get(accountId);
                    if (!accountData) return;
                    
                    // Configurar token de acesso para esta conta
                    gapi.auth2.getAuthInstance().currentUser.get().reloadAuthResponse();
                    
                    // Buscar calendários
                    const response = await gapi.client.calendar.calendarList.list({
                        maxResults: 50
                    });
                    
                    const calendars = response.result.items.map(calendar => ({
                        id: calendar.id,
                        name: calendar.summary,
                        color: calendar.backgroundColor || accountData.color,
                        primary: calendar.primary || false,
                        selected: calendar.primary || false,
                        accessRole: calendar.accessRole
                    }));
                    
                    accountCalendars.set(accountId, calendars);
                    
                    // Adicionar calendários selecionados à lista ativa
                    calendars.forEach(calendar => {
                        if (calendar.selected) {
                            activeCalendars.add(`${accountId}:${calendar.id}`);
                        }
                    });
                    
                    console.log(`✅ ${calendars.length} calendários carregados para ${accountData.email}`);
                    
                } catch (error) {
                    console.error('❌ Erro ao carregar calendários:', error);
                }
            }

            /**
             * Atualiza a lista de contas na interface
             */
            function updateAccountsList() {
                const accountsList = document.getElementById('accountsList');
                const noAccountsMessage = document.getElementById('noAccountsMessage');
                
                if (!accountsList || !noAccountsMessage) return;
                
                if (connectedAccounts.size === 0) {
                    accountsList.innerHTML = '';
                    noAccountsMessage.style.display = 'block';
                    return;
                }
                
                noAccountsMessage.style.display = 'none';
                
                let html = '';
                
                for (const [accountId, accountData] of connectedAccounts) {
                    const calendars = accountCalendars.get(accountId) || [];
                    const activeCount = calendars.filter(cal => cal.selected).length;
                    const totalEvents = Array.from(allEvents.values())
                        .filter(event => event.accountId === accountId).length;
                    
                    html += `
                        <div class="account-item" data-account-id="${accountId}">
                            <div class="account-header">
                                <div class="account-info">
                                    <img src="${accountData.imageUrl}" alt="${accountData.name}" class="account-avatar">
                                    <div class="account-details">
                                        <div class="account-email">${accountData.email}</div>
                                        <div class="account-status">
                                            <span class="status-indicator status-${accountData.status}"></span>
                                            ${accountData.status === 'connected' ? 'Conectado' : 'Desconectado'}
                                        </div>
                                    </div>
                                </div>
                                <div class="account-actions">
                                    <button onclick="toggleAccountSettings('${accountId}')" class="account-btn btn-settings">
                                        <i class="fas fa-cog"></i> Configurar
                                    </button>
                                    <button onclick="disconnectAccount('${accountId}')" class="account-btn btn-disconnect">
                                        <i class="fas fa-unlink"></i> Desconectar
                                    </button>
                                </div>
                            </div>
                            
                            <div id="calendars-${accountId}" class="calendars-list" style="display: none;">
                                <div class="calendars-header">
                                    <i class="fas fa-calendar-alt"></i>
                                    Calendários (${activeCount}/${calendars.length} ativos)
                                </div>
                                ${calendars.map(calendar => `
                                    <div class="calendar-item">
                                        <div class="calendar-info">
                                            <div class="calendar-color" style="background-color: ${calendar.color}"></div>
                                            <div class="calendar-name">${calendar.name}</div>
                                        </div>
                                        <div class="calendar-toggle ${calendar.selected ? 'active' : ''}" 
                                             onclick="toggleCalendar('${accountId}', '${calendar.id}')">
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div class="account-summary">
                                <div class="sync-status">
                                    <div class="sync-info">
                                        <i class="fas fa-calendar"></i>
                                        <span>${calendars.length} calendários</span>
                                    </div>
                                    <div class="sync-info">
                                        <i class="fas fa-clock"></i>
                                        <span>${totalEvents} eventos</span>
                                    </div>
                                    <div class="sync-info">
                                        <i class="fas fa-sync"></i>
                                        <span>Última sync: ${new Date(accountData.connectedAt).toLocaleDateString()}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                accountsList.innerHTML = html;
            }

            /**
             * Alterna as configurações de uma conta
             */
            function toggleAccountSettings(accountId) {
                const calendarsSection = document.getElementById(`calendars-${accountId}`);
                if (calendarsSection) {
                    const isVisible = calendarsSection.style.display !== 'none';
                    calendarsSection.style.display = isVisible ? 'none' : 'block';
                }
            }

            /**
             * Alterna a seleção de um calendário
             */
            async function toggleCalendar(accountId, calendarId) {
                console.log('🔄 Alternando calendário:', accountId, calendarId);
                
                const calendars = accountCalendars.get(accountId);
                if (!calendars) return;
                
                const calendar = calendars.find(cal => cal.id === calendarId);
                if (!calendar) return;
                
                // Alternar seleção
                calendar.selected = !calendar.selected;
                
                const fullCalendarId = `${accountId}:${calendarId}`;
                
                if (calendar.selected) {
                    activeCalendars.add(fullCalendarId);
                } else {
                    activeCalendars.delete(fullCalendarId);
                }
                
                // Salvar configurações
                saveConnectedAccounts();
                
                // Atualizar interface
                updateAccountsList();
                
                // Recarregar eventos
                await loadEventsFromMultipleAccounts();
                
                console.log(`✅ Calendário ${calendar.name} ${calendar.selected ? 'ativado' : 'desativado'}`);
            }

            /**
             * Desconecta uma conta
             */
            async function disconnectAccount(accountId) {
                console.log('🔄 Desconectando conta:', accountId);
                
                const accountData = connectedAccounts.get(accountId);
                if (!accountData) return;
                
                if (!confirm(`Desconectar a conta ${accountData.email}?`)) {
                    return;
                }
                
                try {
                    // Remover calendários ativos desta conta
                    const calendars = accountCalendars.get(accountId) || [];
                    calendars.forEach(calendar => {
                        activeCalendars.delete(`${accountId}:${calendar.id}`);
                    });
                    
                    // Remover eventos desta conta
                    for (const [eventId, eventData] of allEvents) {
                        if (eventData.accountId === accountId) {
                            allEvents.delete(eventId);
                        }
                    }
                    
                    // Remover conta
                    connectedAccounts.delete(accountId);
                    accountCalendars.delete(accountId);
                    
                    // Salvar configurações
                    saveConnectedAccounts();
                    
                    // Atualizar interface
                    updateAccountsList();
                    
                    // Recarregar eventos
                    await loadEventsFromMultipleAccounts();
                    
                    showMessage(`Conta ${accountData.email} desconectada`, 'success');
                    
                } catch (error) {
                    console.error('❌ Erro ao desconectar conta:', error);
                    showMessage('Erro ao desconectar conta', 'error');
                }
            }

            /**
             * Salva as contas conectadas no localStorage
             */
            function saveConnectedAccounts() {
                try {
                    const accountsData = {};
                    for (const [accountId, accountData] of connectedAccounts) {
                        accountsData[accountId] = {
                            ...accountData,
                            calendars: accountCalendars.get(accountId) || []
                        };
                    }
                    
                    localStorage.setItem('connectedGoogleAccounts', JSON.stringify(accountsData));
                    console.log('✅ Contas salvas no localStorage');
                    
                } catch (error) {
                    console.error('❌ Erro ao salvar contas:', error);
                }
            }

            /**
             * Modifica a função loadEvents para carregar de múltiplas contas
             */
            async function loadEventsFromMultipleAccounts() {
                console.log('🔄 Carregando eventos de múltiplas contas...');
                
                if (!isGoogleConnected) return;
                
                try {
                    allEvents.clear();
                    
                    // Carregar eventos da conta principal
                    await loadEventsFromAccount('primary', 'primary');
                    
                    // Carregar eventos das contas adicionais
                    for (const [accountId, accountData] of connectedAccounts) {
                        if (accountData.status === 'connected') {
                            await loadEventsFromAccount(accountId, accountData.accessToken);
                        }
                    }
                    
                    // Converter para array e filtrar
                    filteredEvents = Array.from(allEvents.values());
                    
                    // Aplicar filtros atuais
                    applyCurrentFilters();
                    
                    // Atualizar interface
                    renderCalendar();
                    updateMonthlySummary();
                    
                    console.log(`✅ ${allEvents.size} eventos carregados de ${connectedAccounts.size + 1} contas`);
                    
                } catch (error) {
                    console.error('❌ Erro ao carregar eventos de múltiplas contas:', error);
                }
            }

            /**
             * Carrega eventos de uma conta específica
             */
            async function loadEventsFromAccount(accountId, accessToken) {
                try {
                    const calendars = accountId === 'primary' ? 
                        [{ id: 'primary' }] : 
                        (accountCalendars.get(accountId) || []).filter(cal => cal.selected);
                    
                    for (const calendar of calendars) {
                        const calendarId = calendar.id;
                        
                        // Configurar token se necessário
                        if (accessToken !== 'primary') {
                            gapi.auth.setToken({ access_token: accessToken });
                        }
                        
                        const response = await gapi.client.calendar.events.list({
                            calendarId: calendarId,
                            timeMin: new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).toISOString(),
                            timeMax: new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0, 23, 59, 59).toISOString(),
                            singleEvents: true,
                            orderBy: 'startTime',
                            maxResults: 2500
                        });
                        
                        const events = response.result.items || [];
                        
                        events.forEach(event => {
                            // Adicionar informações da conta
                            event.accountId = accountId;
                            event.calendarId = calendarId;
                            
                            if (accountId !== 'primary') {
                                const accountData = connectedAccounts.get(accountId);
                                event.accountEmail = accountData?.email;
                                event.accountColor = accountData?.color;
                            }
                            
                            allEvents.set(event.id, event);
                        });
                    }
                    
                } catch (error) {
                    console.error(`❌ Erro ao carregar eventos da conta ${accountId}:`, error);
                }
            }

            // =================================================================
            // FILTERS
            // =================================================================
            function applyFilters() {
                const keywordFilter = document.getElementById('keywordFilter')?.value || '';
                const typeFilter = document.getElementById('typeFilter')?.value || '';
                
                currentFilters.keywords = keywordFilter;
                currentFilters.type = typeFilter;
                
                console.log('🔍 Aplicando filtros:', currentFilters);
                
                loadFilteredEvents();
            }

            function clearFilters() {
                document.getElementById('keywordFilter').value = '';
                document.getElementById('typeFilter').value = '';
                
                currentFilters.keywords = '';
                currentFilters.type = '';
                
                console.log('🧹 Filtros limpos');
                
                loadFilteredEvents();
            }

            function applyCurrentFilters() {
                // Esta função é chamada quando os eventos são recarregados
                // Os filtros já são aplicados em loadFilteredEvents()
            }

            function updateFilterResults() {
                const filterResults = document.getElementById('filterResults');
                if (!filterResults) return;
                
                const hasFilters = currentFilters.keywords || currentFilters.type;
                
                if (hasFilters) {
                    const totalEvents = filteredEvents.length;
                    const keywords = currentFilters.keywords ? `palavras-chave relacionadas a pagamentos` : '';
                    const type = currentFilters.type ? `tipo "${currentFilters.type}"` : '';
                    
                    let filterText = 'Filtrado: ';
                    if (keywords && type) {
                        filterText += `${keywords} e ${type}`;
                    } else {
                        filterText += keywords || type;
                    }
                    
                    filterResults.innerHTML = `
                        <i class="fas fa-filter"></i> ${filterText} | 
                        <strong>${totalEvents}</strong> eventos encontrados
                    `;
                } else {
                    filterResults.innerHTML = `
                        <i class="fas fa-calendar-check"></i> Mostrando todos os eventos | 
                        <strong>${filteredEvents.length}</strong> eventos no total
                    `;
                }
            }

            // =================================================================
            // CALENDAR RENDERING
            // =================================================================
            function renderCalendar() {
                const calendarGrid = document.getElementById('calendarGrid');
                const currentMonthElement = document.getElementById('currentMonth');
                
                if (!calendarGrid || !currentMonthElement) return;
                
                // Atualizar título do mês
                const monthNames = [
                    'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                    'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
                ];
                currentMonthElement.textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
                
                // Limpar grid
                calendarGrid.innerHTML = '';
                
                // Headers dos dias da semana
                const dayHeaders = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
                dayHeaders.forEach(day => {
                    const headerDiv = document.createElement('div');
                    headerDiv.className = 'calendar-day-header';
                    headerDiv.textContent = day;
                    calendarGrid.appendChild(headerDiv);
                });
                
                // Calcular primeiro dia do mês e quantos dias tem
                const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startingDayOfWeek = firstDay.getDay();
                
                // Dias do mês anterior
                const prevMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 0);
                const daysInPrevMonth = prevMonth.getDate();
                
                for (let i = startingDayOfWeek - 1; i >= 0; i--) {
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'calendar-day other-month';
                    dayDiv.innerHTML = `<div class="day-number">${daysInPrevMonth - i}</div>`;
                    calendarGrid.appendChild(dayDiv);
                }
                
                // Dias do mês atual
                const today = new Date();
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'calendar-day';
                    
                    // Verificar se é hoje
                    if (dayDate.toDateString() === today.toDateString()) {
                        dayDiv.classList.add('today');
                    }
                    
                    // Calcular total do dia
                    const dayTotal = calculateDayTotal(dayDate);
                    
                    // Buscar eventos do dia
                    const dayEvents = getEventsForDay(dayDate);
                    
                    let dayHTML = `<div class="day-number">${day}</div>`;
                    
                    // Mostrar total se houver valores
                    if (dayTotal > 0) {
                        dayHTML += `<div class="day-total">${formatCurrency(dayTotal)}</div>`;
                    }
                    
                    // Mostrar eventos
                    if (dayEvents.length > 0) {
                        dayHTML += '<div class="day-events">';
                        const maxEvents = 3;
                        
                        for (let i = 0; i < Math.min(dayEvents.length, maxEvents); i++) {
                            const event = dayEvents[i];
                            const eventColor = getEventColor(event);
                            const eventTitle = event.summary || 'Sem título';
                            
                            dayHTML += `
                                <div class="event-item ${eventColor}" onclick="showEventDetails(${JSON.stringify(event).replace(/"/g, '&quot;')})">
                                    ${eventTitle.length > 20 ? eventTitle.substring(0, 20) + '...' : eventTitle}
                                </div>
                            `;
                        }
                        
                        if (dayEvents.length > maxEvents) {
                            dayHTML += `<div class="more-events">+${dayEvents.length - maxEvents} mais</div>`;
                        }
                        
                        dayHTML += '</div>';
                    }
                    
                    dayDiv.innerHTML = dayHTML;
                    calendarGrid.appendChild(dayDiv);
                }
                
                // Dias do próximo mês para completar a grade
                const totalCells = calendarGrid.children.length;
                const remainingCells = 42 - totalCells; // 6 semanas * 7 dias
                
                for (let day = 1; day <= remainingCells; day++) {
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'calendar-day other-month';
                    dayDiv.innerHTML = `<div class="day-number">${day}</div>`;
                    calendarGrid.appendChild(dayDiv);
                }
            }

            function previousMonth() {
                currentDate.setMonth(currentDate.getMonth() - 1);
                loadFilteredEvents();
            }

            function nextMonth() {
                currentDate.setMonth(currentDate.getMonth() + 1);
                loadFilteredEvents();
            }

            // =================================================================
            // INITIALIZATION
            // =================================================================
            document.addEventListener('DOMContentLoaded', function() {
                initializeGoogleAPI();
                renderCalendar();
                updateMonthlySummary();
                updatePaymentsList();
                initializePaymentFilters();
                initializeMultiAccountSystem();
            });
        </script>

        <!-- Scripts -->
        <script type="module" src="supabase.js"></script>
        <script type="module" src="dashboard-hvc.js"></script>
        <script type="module">
            import { injectSidebar } from './sidebar.js';
            injectSidebar("main-content-fluxo-caixa-hvc");
        </script>
        
        <!-- Google APIs - Carregar DEPOIS das funções estarem definidas -->
        <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
        <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    </body>
</html>
