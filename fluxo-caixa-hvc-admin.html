<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fluxo de Caixa - Administrador</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #000080, #800080);
            min-height: 100vh;
            color: white;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        .main-content {
            flex: 1;
            padding: 20px;
            margin-left: 250px;
        }

        .header {
            background: rgba(25, 25, 112, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 128, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #ffffff;
            font-size: 2rem;
            font-weight: 300;
        }

        .openfinance-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .openfinance-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .content-wrapper {
            display: flex;
            gap: 20px;
            height: calc(100vh - 200px);
        }

        .calendar-section {
            flex: 1;
            background: rgba(25, 25, 112, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 128, 0.3);
            resize: horizontal;
            overflow: auto;
            min-width: 300px;
            max-width: 80%;
        }

        .list-section {
            flex: 1;
            background: rgba(25, 25, 112, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 128, 0.3);
            resize: horizontal;
            overflow: auto;
            min-width: 300px;
            max-width: 80%;
        }

        .section-title {
            color: #ffffff;
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 300;
        }

        .calendar {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .calendar-nav {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
        }

        .calendar-nav:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .calendar-title {
            font-size: 1.2rem;
            font-weight: 500;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .calendar-day-header {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px;
            text-align: center;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .calendar-day {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px;
            text-align: center;
            cursor: pointer;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            position: relative;
        }

        .calendar-day:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .calendar-day.other-month {
            opacity: 0.5;
        }

        .calendar-day.today {
            background: rgba(255, 215, 0, 0.3);
            border: 2px solid #FFD700;
        }

        .calendar-day.selected {
            background: rgba(0, 255, 0, 0.3);
            border: 2px solid #00FF00;
        }

        .day-number {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .day-events {
            font-size: 0.7rem;
            width: 100%;
        }

        .event-item {
            background: rgba(255, 255, 255, 0.8);
            color: #333;
            padding: 1px 3px;
            margin: 1px 0;
            border-radius: 3px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .event-item.compromisso {
            background: rgba(0, 123, 255, 0.8);
            color: white;
        }

        .event-item.pagamento {
            background: rgba(255, 193, 7, 0.8);
            color: #333;
        }

        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.9rem;
            flex: 1;
            min-width: 120px;
        }

        .filter-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .filter-select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.9rem;
            min-width: 120px;
        }

        .filter-select option {
            background: #4a4a4a;
            color: white;
        }

        .add-btn {
            background: rgba(40, 167, 69, 0.8);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .add-btn:hover {
            background: rgba(40, 167, 69, 1);
            transform: translateY(-2px);
        }

        .items-list {
            max-height: calc(100vh - 400px);
            overflow-y: auto;
        }

        .item-card {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .item-card:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .item-title {
            font-size: 1.1rem;
            font-weight: 500;
            color: #ffffff;
        }

        .item-type {
            background: rgba(0, 123, 255, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .item-type.pagamento {
            background: rgba(255, 193, 7, 0.8);
            color: #333;
        }

        .item-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
        }

        .item-detail {
            font-size: 0.9rem;
            color: #e0e0e0;
        }

        .item-detail strong {
            color: #ffffff;
        }

        .item-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .btn-edit {
            background: rgba(0, 123, 255, 0.8);
            color: white;
        }

        .btn-edit:hover {
            background: rgba(0, 123, 255, 1);
        }

        .btn-delete {
            background: rgba(220, 53, 69, 0.8);
            color: white;
        }

        .btn-delete:hover {
            background: rgba(220, 53, 69, 1);
        }

        .status-select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 4px 8px;
            border-radius: 5px;
            font-size: 0.8rem;
        }

        .status-select option {
            background: #4a4a4a;
            color: white;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: linear-gradient(135deg, #000080, #800080);
            margin: 5% auto;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 128, 0.3);
            resize: both;
            min-width: 400px;
            min-height: 300px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            color: #ffffff;
            font-size: 1.5rem;
            font-weight: 300;
        }

        .close {
            color: #ffffff;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
        }

        .close:hover {
            opacity: 0.7;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            color: #ffffff;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            color: white;
            font-size: 1rem;
        }

        .form-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .form-select {
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            color: white;
            font-size: 1rem;
        }

        .form-select option {
            background: #4a4a4a;
            color: white;
        }

        .form-textarea {
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            color: white;
            font-size: 1rem;
            resize: vertical;
            min-height: 80px;
        }

        .form-textarea::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .form-checkbox {
            margin-right: 8px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .recurrence-fields {
            display: none;
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .recurrence-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .recurrence-number {
            width: 80px;
        }

        .recurrence-unit {
            flex: 1;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn-primary {
            background: rgba(0, 123, 255, 0.8);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
        }

        .btn-primary:hover {
            background: rgba(0, 123, 255, 1);
        }

        .btn-secondary {
            background: rgba(108, 117, 125, 0.8);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
        }

        .btn-secondary:hover {
            background: rgba(108, 117, 125, 1);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-content {
                margin-left: 0;
                padding: 10px;
            }

            .content-wrapper {
                flex-direction: column;
                height: auto;
            }

            .calendar-section,
            .list-section {
                resize: none;
                max-width: none;
            }

            .filters {
                flex-direction: column;
            }

            .modal-content {
                width: 95%;
                margin: 10% auto;
                resize: none;
            }
        }

        /* Scrollbar customization */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .divider {
            width: 4px;
            background: rgba(255, 255, 255, 0.2);
            cursor: col-resize;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
        }

        .divider:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        .divider::before {
            content: '‚ãÆ‚ãÆ';
            color: rgba(255, 255, 255, 0.6);
            font-size: 1.2rem;
            line-height: 1;
        }

        .currency-input {
            position: relative;
        }

        .currency-input::before {
            content: 'R$';
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.7);
            pointer-events: none;
        }

        .currency-input input {
            padding-left: 35px;
        }

        .recurrent-indicator {
            display: inline-block;
            margin-left: 5px;
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .hora-field {
            display: block;
        }

        .hora-field.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="main-content-fluxo-caixa-hvc" class="main-content">
            <div class="header">
                <h1>Fluxo de Caixa - Administrador</h1>
                <button class="openfinance-btn" onclick="openOpenFinanceModal()">
                    üè¶ OpenFinance
                </button>
            </div>

            <div class="content-wrapper">
                <div class="calendar-section">
                    <h2 class="section-title">üìÖ Agenda</h2>
                    <div class="calendar">
                        <div class="calendar-header">
                            <button class="calendar-nav" onclick="previousMonth()">‚Äπ</button>
                            <div class="calendar-title" id="calendar-title"></div>
                            <button class="calendar-nav" onclick="nextMonth()">‚Ä∫</button>
                        </div>
                        <div class="calendar-grid" id="calendar-grid"></div>
                    </div>
                </div>

                <div class="divider" id="divider"></div>

                <div class="list-section">
                    <h2 class="section-title">üíº Compromissos e Pagamentos</h2>
                    
                    <button class="add-btn" onclick="openModal()">+ Adicionar</button>
                    
                    <div class="filters">
                        <input type="text" class="filter-input" id="search-filter" placeholder="Buscar..." onkeyup="filterItems()">
                        <select class="filter-select" id="type-filter" onchange="filterItems()">
                            <option value="">Todos os tipos</option>
                            <option value="compromisso">Compromissos</option>
                            <option value="pagamento">Pagamentos</option>
                        </select>
                        <select class="filter-select" id="status-filter" onchange="filterItems()">
                            <option value="">Todos os status</option>
                            <option value="pendente">Pendente</option>
                            <option value="concluido">Conclu√≠do</option>
                            <option value="cancelado">Cancelado</option>
                        </select>
                        <input type="date" class="filter-input" id="date-filter" onchange="filterItems()">
                    </div>

                    <div class="items-list" id="items-list"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="item-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-title">Adicionar Item</h2>
                <button class="close" onclick="closeModal()">&times;</button>
            </div>
            
            <form id="item-form">
                <div class="form-group">
                    <label class="form-label" for="titulo">T√≠tulo *</label>
                    <input type="text" class="form-input" id="titulo" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="tipo">Tipo *</label>
                    <select class="form-select" id="tipo" required onchange="toggleHoraField()">
                        <option value="">Selecione...</option>
                        <option value="compromisso">Compromisso</option>
                        <option value="pagamento">Pagamento</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="categoria">Categoria</label>
                    <input type="text" class="form-input" id="categoria" placeholder="Ex: Reuni√£o, Fornecedor...">
                </div>

                <div class="form-group">
                    <label class="form-label" for="data_evento">Data *</label>
                    <input type="date" class="form-input" id="data_evento" required>
                </div>

                <div class="form-group hora-field" id="hora-field">
                    <label class="form-label" for="hora_evento">Hora</label>
                    <input type="time" class="form-input" id="hora_evento">
                </div>

                <div class="form-group">
                    <label class="form-label" for="valor">Valor (R$)</label>
                    <div class="currency-input">
                        <input type="text" class="form-input" id="valor" placeholder="0,00" oninput="formatCurrency(this)" onfocus="clearIfEmpty(this)" onblur="addZeroIfEmpty(this)">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="status">Status</label>
                    <select class="form-select" id="status">
                        <option value="pendente">Pendente</option>
                        <option value="concluido">Conclu√≠do</option>
                        <option value="cancelado">Cancelado</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="prioridade">Prioridade</label>
                    <select class="form-select" id="prioridade">
                        <option value="baixa">Baixa</option>
                        <option value="media">M√©dia</option>
                        <option value="alta">Alta</option>
                    </select>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" class="form-checkbox" id="tem_recorrencia" onchange="toggleRecurrenceFields()">
                    <label class="form-label" for="tem_recorrencia">Repetir este item</label>
                </div>

                <div class="recurrence-fields" id="recurrence-fields">
                    <div class="recurrence-row">
                        <label class="form-label">A cada:</label>
                        <input type="number" class="form-input recurrence-number" id="recorrencia_intervalo" min="1" value="1">
                        <select class="form-select recurrence-unit" id="recorrencia_unidade">
                            <option value="dias">dias</option>
                            <option value="dias_uteis">dias √∫teis</option>
                            <option value="semanas">semanas</option>
                            <option value="quinzenas">quinzenas</option>
                            <option value="meses">meses</option>
                            <option value="anos">anos</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="recorrencia_fim">Data fim (opcional)</label>
                        <input type="date" class="form-input" id="recorrencia_fim">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="descricao">Descri√ß√£o</label>
                    <textarea class="form-textarea" id="descricao" placeholder="Detalhes adicionais..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label" for="observacoes">Observa√ß√µes</label>
                    <textarea class="form-textarea" id="observacoes" placeholder="Observa√ß√µes internas..."></textarea>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-secondary" onclick="closeModal()">Cancelar</button>
                    <button type="submit" class="btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <script src="supabase.js"></script>
    <script>
        // Vari√°veis globais
        let currentDate = new Date();
        let selectedDate = null;
        let editingItemId = null;
        let agendaItems = [];

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            loadAgendaItems();
            renderCalendar();
            setupDividerResize();
            
            // Event listener para o formul√°rio
            document.getElementById('item-form').addEventListener('submit', saveItem);
        });

        // Fun√ß√£o para calcular datas de recorr√™ncia
        function calculateRecurrenceDates(startDate, endDate, interval, unit) {
            const dates = [];
            const start = new Date(startDate + 'T00:00:00');
            const end = endDate ? new Date(endDate + 'T00:00:00') : new Date(start.getFullYear(), 11, 31);
            
            let currentEventDate = new Date(start);
            
            // Adiciona a data inicial
            dates.push(new Date(currentEventDate));

            // Calcula pr√≥ximas datas baseado na unidade
            while (currentEventDate < end) {
                switch(unit) {
                    case 'dias':
                        currentEventDate.setDate(currentEventDate.getDate() + interval);
                        break;
                    case 'dias_uteis':
                        let addedDays = 0;
                        while (addedDays < interval) {
                            currentEventDate.setDate(currentEventDate.getDate() + 1);
                            const dayOfWeek = currentEventDate.getDay();
                            if (dayOfWeek !== 0 && dayOfWeek !== 6) { // N√£o √© domingo (0) nem s√°bado (6)
                                addedDays++;
                            }
                        }
                        break;
                    case 'semanas':
                        currentEventDate.setDate(currentEventDate.getDate() + (interval * 7));
                        break;
                    case 'quinzenas':
                        currentEventDate.setDate(currentEventDate.getDate() + (interval * 15));
                        break;
                    case 'meses':
                        currentEventDate.setMonth(currentEventDate.getMonth() + interval);
                        break;
                    case 'anos':
                        currentEventDate.setFullYear(currentEventDate.getFullYear() + interval);
                        break;
                }
                
                if (currentEventDate <= end) {
                    dates.push(new Date(currentEventDate));
                }
                
                // Limite de seguran√ßa
                if (dates.length > 100) break;
            }
            
            return dates.map(date => date.toISOString().split('T')[0]);
        }

        // Carregar itens da agenda
        async function loadAgendaItems() {
            try {
                const { data, error } = await supabase
                    .from('agenda_hvc')
                    .select('*')
                    .order('data_evento', { ascending: true });

                if (error) {
                    console.error('Erro ao carregar itens:', error);
                    return;
                }

                agendaItems = data || [];
                console.log('Items carregados:', agendaItems.length);
                renderCalendar();
                renderItemsList();
            } catch (error) {
                console.error('Erro ao carregar itens:', error);
            }
        }

        // Salvar item
        async function saveItem(event) {
            event.preventDefault();
            
            const formData = {
                titulo: document.getElementById('titulo').value,
                tipo: document.getElementById('tipo').value,
                categoria: document.getElementById('categoria').value,
                data_evento: document.getElementById('data_evento').value,
                hora_evento: document.getElementById('hora_evento').value || null,
                valor: parseCurrency(document.getElementById('valor').value),
                status: document.getElementById('status').value,
                prioridade: document.getElementById('prioridade').value,
                descricao: document.getElementById('descricao').value,
                observacoes: document.getElementById('observacoes').value,
                tem_recorrencia: document.getElementById('tem_recorrencia').checked,
                recorrencia_intervalo: document.getElementById('recorrencia_intervalo').value || null,
                recorrencia_unidade: document.getElementById('recorrencia_unidade').value || null,
                recorrencia_fim: document.getElementById('recorrencia_fim').value || null,
                ultima_alteracao_por: sessionStorage.getItem('usuario') || 'Sistema',
                ultima_alteracao_em: new Date().toISOString()
            };

            // Se for pagamento e n√£o tem hora, gerar hora autom√°tica
            if (formData.tipo === 'pagamento' && !formData.hora_evento) {
                formData.hora_evento = await generateNextPaymentTime(formData.data_evento);
            }

            try {
                let result;
                
                if (editingItemId) {
                    // Atualizar item existente
                    const { data, error } = await supabase
                        .from('agenda_hvc')
                        .update(formData)
                        .eq('id', editingItemId)
                        .select();
                    
                    result = { data, error };
                } else {
                    // Criar novo item
                    const { data, error } = await supabase
                        .from('agenda_hvc')
                        .insert([formData])
                        .select();
                    
                    result = { data, error };
                }

                if (result.error) {
                    console.error('Erro ao salvar item:', result.error);
                    alert('Erro ao salvar item: ' + result.error.message);
                    return;
                }

                console.log('Item salvo com sucesso:', result.data[0]);

                // Se tem recorr√™ncia e √© um novo item, criar eventos recorrentes
                if (formData.tem_recorrencia && !editingItemId) {
                    console.log('üîÑ Item com recorr√™ncia salvo');
                    
                    const recurrenceDates = calculateRecurrenceDates(
                        formData.data_evento,
                        formData.recorrencia_fim,
                        parseInt(formData.recorrencia_intervalo),
                        formData.recorrencia_unidade
                    );

                    console.log('üìä Calculando recorr√™ncia:', {
                        inicio: formData.data_evento,
                        fim: formData.recorrencia_fim || 'fim do ano',
                        intervalo: formData.recorrencia_intervalo,
                        unidade: formData.recorrencia_unidade
                    });
                    console.log('üìÖ Datas calculadas (' + recurrenceDates.length + '):', recurrenceDates);

                    // Remove a primeira data (j√° foi salva)
                    const futureDates = recurrenceDates.slice(1);
                    
                    if (futureDates.length > 0) {
                        console.log('üíæ Inserindo ' + futureDates.length + ' eventos recorrentes no Supabase...');
                        
                        const recurrentEvents = [];
                        
                        for (let i = 0; i < futureDates.length; i++) {
                            const eventDate = futureDates[i];
                            let eventTime = formData.hora_evento;
                            
                            // Para pagamentos, gerar hor√°rio sequencial
                            if (formData.tipo === 'pagamento') {
                                eventTime = await generateNextPaymentTime(eventDate);
                            }
                            
                            const recurrentEvent = {
                                ...formData,
                                data_evento: eventDate,
                                hora_evento: eventTime,
                                id: undefined // Remove o ID para criar novo registro
                            };
                            
                            recurrentEvents.push(recurrentEvent);
                        }
                        
                        // Inserir todos os eventos recorrentes
                        const { data: recurrentData, error: recurrentError } = await supabase
                            .from('agenda_hvc')
                            .insert(recurrentEvents)
                            .select();
                        
                        if (recurrentError) {
                            console.error('‚ùå Erro ao inserir eventos recorrentes:', recurrentError);
                        } else {
                            console.log('‚úÖ ' + recurrentData.length + ' eventos recorrentes inseridos com sucesso!');
                        }
                    }
                }

                closeModal();
                loadAgendaItems();
                
            } catch (error) {
                console.error('Erro ao salvar item:', error);
                alert('Erro ao salvar item: ' + error.message);
            }
        }

        // Gerar pr√≥ximo hor√°rio para pagamento
        async function generateNextPaymentTime(date) {
            try {
                const { data, error } = await supabase
                    .from('agenda_hvc')
                    .select('hora_evento')
                    .eq('data_evento', date)
                    .eq('tipo', 'pagamento')
                    .not('hora_evento', 'is', null)
                    .order('hora_evento', { ascending: false })
                    .limit(1);

                if (error) {
                    console.error('Erro ao buscar √∫ltimo hor√°rio:', error);
                    return '09:00';
                }

                if (data && data.length > 0) {
                    const lastTime = data[0].hora_evento;
                    const [hours, minutes] = lastTime.split(':').map(Number);
                    const nextMinutes = minutes + 1;
                    
                    if (nextMinutes >= 60) {
                        return `${String(hours + 1).padStart(2, '0')}:00`;
                    } else {
                        return `${String(hours).padStart(2, '0')}:${String(nextMinutes).padStart(2, '0')}`;
                    }
                } else {
                    return '09:00';
                }
            } catch (error) {
                console.error('Erro ao gerar hor√°rio:', error);
                return '09:00';
            }
        }

        // Renderizar calend√°rio
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // Atualizar t√≠tulo
            const monthNames = [
                'Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
            ];
            document.getElementById('calendar-title').textContent = `${monthNames[month]} ${year}`;
            
            // Limpar grid
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            
            // Cabe√ßalhos dos dias (come√ßando na segunda-feira)
            const dayHeaders = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b', 'Dom'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                grid.appendChild(header);
            });
            
            // Primeiro dia do m√™s
            const firstDay = new Date(year, month, 1);
            let dayOfWeek = firstDay.getDay();
            // Ajustar para come√ßar na segunda-feira (0 = domingo vira 6, outros -1)
            dayOfWeek = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            
            // √öltimo dia do m√™s
            const lastDay = new Date(year, month + 1, 0).getDate();
            
            // Dias do m√™s anterior
            const prevMonth = new Date(year, month, 0);
            const prevLastDay = prevMonth.getDate();
            
            for (let i = dayOfWeek - 1; i >= 0; i--) {
                const day = document.createElement('div');
                day.className = 'calendar-day other-month';
                day.innerHTML = `<div class="day-number">${prevLastDay - i}</div><div class="day-events"></div>`;
                grid.appendChild(day);
            }
            
            // Dias do m√™s atual
            const today = new Date();
            for (let day = 1; day <= lastDay; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                const currentDayDate = new Date(year, month, day);
                const dateStr = currentDayDate.toISOString().split('T')[0];
                
                // Verificar se √© hoje
                if (currentDayDate.toDateString() === today.toDateString()) {
                    dayElement.classList.add('today');
                }
                
                // Verificar se est√° selecionado
                if (selectedDate === dateStr) {
                    dayElement.classList.add('selected');
                }
                
                // Eventos do dia
                const dayEvents = agendaItems.filter(item => item.data_evento === dateStr);
                const eventsHtml = dayEvents.map(event => {
                    const recurrentIcon = event.tem_recorrencia ? ' üîÑ' : '';
                    return `<div class="event-item ${event.tipo}">${event.titulo}${recurrentIcon}</div>`;
                }).join('');
                
                dayElement.innerHTML = `<div class="day-number">${day}</div><div class="day-events">${eventsHtml}</div>`;
                dayElement.addEventListener('click', () => selectDate(dateStr));
                
                grid.appendChild(dayElement);
            }
            
            // Dias do pr√≥ximo m√™s
            const remainingCells = 42 - grid.children.length + 7; // +7 para os cabe√ßalhos
            for (let day = 1; day <= remainingCells - 7; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day other-month';
                dayElement.innerHTML = `<div class="day-number">${day}</div><div class="day-events"></div>`;
                grid.appendChild(dayElement);
            }
        }

        // Renderizar lista de itens
        function renderItemsList() {
            const container = document.getElementById('items-list');
            
            if (agendaItems.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #e0e0e0; margin-top: 50px;">Nenhum item encontrado</p>';
                return;
            }
            
            const itemsHtml = agendaItems.map(item => {
                const recurrentIcon = item.tem_recorrencia ? ' <span class="recurrent-indicator">üîÑ</span>' : '';
                const valorFormatted = item.valor ? formatCurrencyDisplay(item.valor) : '';
                
                return `
                    <div class="item-card">
                        <div class="item-header">
                            <div class="item-title">${item.titulo}${recurrentIcon}</div>
                            <div class="item-type ${item.tipo}">${item.tipo}</div>
                        </div>
                        <div class="item-details">
                            <div class="item-detail"><strong>Data:</strong> ${formatDate(item.data_evento)}</div>
                            ${item.hora_evento ? `<div class="item-detail"><strong>Hora:</strong> ${item.hora_evento}</div>` : ''}
                            ${item.categoria ? `<div class="item-detail"><strong>Categoria:</strong> ${item.categoria}</div>` : ''}
                            ${valorFormatted ? `<div class="item-detail"><strong>Valor:</strong> ${valorFormatted}</div>` : ''}
                            <div class="item-detail"><strong>Status:</strong> 
                                <select class="status-select" onchange="updateStatus(${item.id}, this.value)">
                                    <option value="pendente" ${item.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                    <option value="concluido" ${item.status === 'concluido' ? 'selected' : ''}>Conclu√≠do</option>
                                    <option value="cancelado" ${item.status === 'cancelado' ? 'selected' : ''}>Cancelado</option>
                                </select>
                            </div>
                            <div class="item-detail"><strong>Prioridade:</strong> ${item.prioridade}</div>
                            ${item.descricao ? `<div class="item-detail"><strong>Descri√ß√£o:</strong> ${item.descricao}</div>` : ''}
                            ${item.observacoes ? `<div class="item-detail"><strong>Observa√ß√µes:</strong> ${item.observacoes}</div>` : ''}
                            ${item.ultima_alteracao_por ? `<div class="item-detail"><strong>√öltima altera√ß√£o:</strong> ${item.ultima_alteracao_por} em ${formatDateTime(item.ultima_alteracao_em)}</div>` : ''}
                        </div>
                        <div class="item-actions">
                            <button class="btn btn-edit" onclick="editItem(${item.id})">Editar</button>
                            <button class="btn btn-delete" onclick="deleteItem(${item.id})">Excluir</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = itemsHtml;
        }

        // Navega√ß√£o do calend√°rio
        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }

        // Selecionar data
        function selectDate(dateStr) {
            selectedDate = dateStr;
            renderCalendar();
            filterItems();
        }

        // Modal
        function openModal(itemId = null) {
            editingItemId = itemId;
            const modal = document.getElementById('item-modal');
            const title = document.getElementById('modal-title');
            
            if (itemId) {
                title.textContent = 'Editar Item';
                loadItemData(itemId);
            } else {
                title.textContent = 'Adicionar Item';
                document.getElementById('item-form').reset();
                if (selectedDate) {
                    document.getElementById('data_evento').value = selectedDate;
                }
                toggleHoraField();
                toggleRecurrenceFields();
            }
            
            modal.style.display = 'block';
        }

        function closeModal() {
            document.getElementById('item-modal').style.display = 'none';
            editingItemId = null;
        }

        // Carregar dados do item para edi√ß√£o
        function loadItemData(itemId) {
            const item = agendaItems.find(i => i.id === itemId);
            if (!item) return;
            
            document.getElementById('titulo').value = item.titulo || '';
            document.getElementById('tipo').value = item.tipo || '';
            document.getElementById('categoria').value = item.categoria || '';
            document.getElementById('data_evento').value = item.data_evento || '';
            document.getElementById('hora_evento').value = item.hora_evento || '';
            document.getElementById('valor').value = item.valor ? formatCurrencyDisplay(item.valor) : '';
            document.getElementById('status').value = item.status || 'pendente';
            document.getElementById('prioridade').value = item.prioridade || 'media';
            document.getElementById('descricao').value = item.descricao || '';
            document.getElementById('observacoes').value = item.observacoes || '';
            document.getElementById('tem_recorrencia').checked = item.tem_recorrencia || false;
            document.getElementById('recorrencia_intervalo').value = item.recorrencia_intervalo || 1;
            document.getElementById('recorrencia_unidade').value = item.recorrencia_unidade || 'semanas';
            document.getElementById('recorrencia_fim').value = item.recorrencia_fim || '';
            
            toggleHoraField();
            toggleRecurrenceFields();
        }

        // Editar item
        function editItem(itemId) {
            openModal(itemId);
        }

        // Excluir item
        async function deleteItem(itemId) {
            const item = agendaItems.find(i => i.id === itemId);
            if (!item) return;
            
            let confirmMessage = `Tem certeza que deseja excluir "${item.titulo}"?`;
            
            // Se for recorrente, perguntar sobre eventos futuros
            if (item.tem_recorrencia) {
                confirmMessage += '\n\nEste item tem recorr√™ncia. Deseja excluir tamb√©m os eventos futuros da mesma s√©rie?';
                
                if (confirm(confirmMessage)) {
                    // Excluir eventos futuros da mesma s√©rie
                    try {
                        const { error } = await supabase
                            .from('agenda_hvc')
                            .delete()
                            .eq('titulo', item.titulo)
                            .eq('tipo', item.tipo)
                            .gte('data_evento', item.data_evento);
                        
                        if (error) {
                            console.error('Erro ao excluir s√©rie:', error);
                            alert('Erro ao excluir s√©rie: ' + error.message);
                            return;
                        }
                        
                        loadAgendaItems();
                    } catch (error) {
                        console.error('Erro ao excluir s√©rie:', error);
                        alert('Erro ao excluir s√©rie: ' + error.message);
                    }
                }
            } else {
                if (confirm(confirmMessage)) {
                    try {
                        const { error } = await supabase
                            .from('agenda_hvc')
                            .delete()
                            .eq('id', itemId);
                        
                        if (error) {
                            console.error('Erro ao excluir item:', error);
                            alert('Erro ao excluir item: ' + error.message);
                            return;
                        }
                        
                        loadAgendaItems();
                    } catch (error) {
                        console.error('Erro ao excluir item:', error);
                        alert('Erro ao excluir item: ' + error.message);
                    }
                }
            }
        }

        // Atualizar status
        async function updateStatus(itemId, newStatus) {
            try {
                const { error } = await supabase
                    .from('agenda_hvc')
                    .update({ 
                        status: newStatus,
                        ultima_alteracao_por: sessionStorage.getItem('usuario') || 'Sistema',
                        ultima_alteracao_em: new Date().toISOString()
                    })
                    .eq('id', itemId);
                
                if (error) {
                    console.error('Erro ao atualizar status:', error);
                    alert('Erro ao atualizar status: ' + error.message);
                    return;
                }
                
                loadAgendaItems();
            } catch (error) {
                console.error('Erro ao atualizar status:', error);
                alert('Erro ao atualizar status: ' + error.message);
            }
        }

        // Filtrar itens
        function filterItems() {
            const searchTerm = document.getElementById('search-filter').value.toLowerCase();
            const typeFilter = document.getElementById('type-filter').value;
            const statusFilter = document.getElementById('status-filter').value;
            const dateFilter = document.getElementById('date-filter').value;
            
            let filteredItems = agendaItems;
            
            // Filtro por data selecionada no calend√°rio
            if (selectedDate) {
                filteredItems = filteredItems.filter(item => item.data_evento === selectedDate);
            }
            
            // Filtro por busca
            if (searchTerm) {
                filteredItems = filteredItems.filter(item => 
                    item.titulo.toLowerCase().includes(searchTerm) ||
                    (item.categoria && item.categoria.toLowerCase().includes(searchTerm)) ||
                    (item.descricao && item.descricao.toLowerCase().includes(searchTerm))
                );
            }
            
            // Filtro por tipo
            if (typeFilter) {
                filteredItems = filteredItems.filter(item => item.tipo === typeFilter);
            }
            
            // Filtro por status
            if (statusFilter) {
                filteredItems = filteredItems.filter(item => item.status === statusFilter);
            }
            
            // Filtro por data espec√≠fica
            if (dateFilter) {
                filteredItems = filteredItems.filter(item => item.data_evento === dateFilter);
            }
            
            // Renderizar lista filtrada
            const container = document.getElementById('items-list');
            
            if (filteredItems.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #e0e0e0; margin-top: 50px;">Nenhum item encontrado</p>';
                return;
            }
            
            const itemsHtml = filteredItems.map(item => {
                const recurrentIcon = item.tem_recorrencia ? ' <span class="recurrent-indicator">üîÑ</span>' : '';
                const valorFormatted = item.valor ? formatCurrencyDisplay(item.valor) : '';
                
                return `
                    <div class="item-card">
                        <div class="item-header">
                            <div class="item-title">${item.titulo}${recurrentIcon}</div>
                            <div class="item-type ${item.tipo}">${item.tipo}</div>
                        </div>
                        <div class="item-details">
                            <div class="item-detail"><strong>Data:</strong> ${formatDate(item.data_evento)}</div>
                            ${item.hora_evento ? `<div class="item-detail"><strong>Hora:</strong> ${item.hora_evento}</div>` : ''}
                            ${item.categoria ? `<div class="item-detail"><strong>Categoria:</strong> ${item.categoria}</div>` : ''}
                            ${valorFormatted ? `<div class="item-detail"><strong>Valor:</strong> ${valorFormatted}</div>` : ''}
                            <div class="item-detail"><strong>Status:</strong> 
                                <select class="status-select" onchange="updateStatus(${item.id}, this.value)">
                                    <option value="pendente" ${item.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                    <option value="concluido" ${item.status === 'concluido' ? 'selected' : ''}>Conclu√≠do</option>
                                    <option value="cancelado" ${item.status === 'cancelado' ? 'selected' : ''}>Cancelado</option>
                                </select>
                            </div>
                            <div class="item-detail"><strong>Prioridade:</strong> ${item.prioridade}</div>
                            ${item.descricao ? `<div class="item-detail"><strong>Descri√ß√£o:</strong> ${item.descricao}</div>` : ''}
                            ${item.observacoes ? `<div class="item-detail"><strong>Observa√ß√µes:</strong> ${item.observacoes}</div>` : ''}
                            ${item.ultima_alteracao_por ? `<div class="item-detail"><strong>√öltima altera√ß√£o:</strong> ${item.ultima_alteracao_por} em ${formatDateTime(item.ultima_alteracao_em)}</div>` : ''}
                        </div>
                        <div class="item-actions">
                            <button class="btn btn-edit" onclick="editItem(${item.id})">Editar</button>
                            <button class="btn btn-delete" onclick="deleteItem(${item.id})">Excluir</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = itemsHtml;
        }

        // Toggle campo hora baseado no tipo
        function toggleHoraField() {
            const tipo = document.getElementById('tipo').value;
            const horaField = document.getElementById('hora-field');
            
            if (tipo === 'compromisso') {
                horaField.classList.remove('hidden');
                horaField.style.display = 'block';
            } else {
                horaField.classList.add('hidden');
                horaField.style.display = 'none';
                document.getElementById('hora_evento').value = '';
            }
        }

        // Toggle campos de recorr√™ncia
        function toggleRecurrenceFields() {
            const checkbox = document.getElementById('tem_recorrencia');
            const fields = document.getElementById('recurrence-fields');
            
            if (checkbox.checked) {
                fields.style.display = 'block';
            } else {
                fields.style.display = 'none';
            }
        }

        // Formata√ß√£o de moeda
        function formatCurrency(input) {
            let value = input.value.replace(/\D/g, '');
            value = (value / 100).toFixed(2);
            value = value.replace('.', ',');
            value = value.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            input.value = 'R$ ' + value;
        }

        function clearIfEmpty(input) {
            if (input.value === 'R$ 0,00' || input.value === '') {
                input.value = '';
            }
        }

        function addZeroIfEmpty(input) {
            if (input.value === '' || input.value === 'R$ ') {
                input.value = 'R$ 0,00';
            }
        }

        function parseCurrency(value) {
            if (!value) return 0;
            return parseFloat(value.replace(/[R$\s.]/g, '').replace(',', '.')) || 0;
        }

        function formatCurrencyDisplay(value) {
            if (!value) return '';
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }

        // Formata√ß√£o de data
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('pt-BR');
        }

        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return '';
            const date = new Date(dateTimeStr);
            return date.toLocaleString('pt-BR');
        }

        // Setup do redimensionamento
        function setupDividerResize() {
            const divider = document.getElementById('divider');
            const calendarSection = document.querySelector('.calendar-section');
            const listSection = document.querySelector('.list-section');
            const contentWrapper = document.querySelector('.content-wrapper');
            
            let isResizing = false;
            
            divider.addEventListener('mousedown', (e) => {
                isResizing = true;
                document.addEventListener('mousemove', handleResize);
                document.addEventListener('mouseup', stopResize);
                e.preventDefault();
            });
            
            function handleResize(e) {
                if (!isResizing) return;
                
                const wrapperRect = contentWrapper.getBoundingClientRect();
                const mouseX = e.clientX - wrapperRect.left;
                const wrapperWidth = wrapperRect.width;
                
                const leftPercent = (mouseX / wrapperWidth) * 100;
                const rightPercent = 100 - leftPercent;
                
                // Limites m√≠nimos e m√°ximos
                if (leftPercent >= 20 && leftPercent <= 80) {
                    calendarSection.style.flex = `0 0 ${leftPercent}%`;
                    listSection.style.flex = `0 0 ${rightPercent}%`;
                }
            }
            
            function stopResize() {
                isResizing = false;
                document.removeEventListener('mousemove', handleResize);
                document.removeEventListener('mouseup', stopResize);
            }
        }

        // OpenFinance Modal (placeholder)
        function openOpenFinanceModal() {
            alert('Funcionalidade OpenFinance ser√° implementada em breve!');
        }

        // Event listeners para fechar modal
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('item-modal');
            if (event.target === modal) {
                closeModal();
            }
        });

        // Atalhos de teclado
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        });
    </script>
    <script type="module" src="sidebar.js"></script>
    <script type="module">
        import { injectSidebar } from './sidebar.js';
        injectSidebar('main-content-fluxo-caixa-hvc');
    </script>
</body>
</html>

