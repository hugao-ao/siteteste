<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Autentica√ß√£o - Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .debug-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .debug-title {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .debug-result {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <h1>üîç Debug de Autentica√ß√£o</h1>
    
    <div class="debug-container">
        <h2 class="debug-title">Status Atual de Autentica√ß√£o</h2>
        <div id="auth-debug"></div>
        <button onclick="verificarTodosOsDados()">Verificar Todos os Dados</button>
        <button onclick="limparTodosOsDados()">Limpar Todos os Dados</button>
    </div>

    <div class="debug-container">
        <h2 class="debug-title">Teste de Link de Diagn√≥stico</h2>
        <input type="text" id="link-teste" placeholder="Cole o link do diagn√≥stico aqui" style="width: 100%; padding: 8px; margin: 10px 0;">
        <br>
        <button onclick="testarLinkDiagnostico()">Testar Link</button>
        <div id="link-debug"></div>
    </div>

    <div class="debug-container">
        <h2 class="debug-title">Simular Login</h2>
        <input type="text" id="sim-usuario" placeholder="Usu√°rio" value="admin" style="padding: 8px; margin: 5px;">
        <input type="text" id="sim-nivel" placeholder="N√≠vel" value="admin" style="padding: 8px; margin: 5px;">
        <input type="text" id="sim-projeto" placeholder="Projeto" value="Planejamento" style="padding: 8px; margin: 5px;">
        <input type="text" id="sim-user-id" placeholder="User ID" value="test-123" style="padding: 8px; margin: 5px;">
        <br>
        <button onclick="simularLogin()">Simular Login</button>
    </div>

    <!-- Importar o middleware -->
    <script src="auth-middleware-final.js"></script>
    
    <script>
        function verificarTodosOsDados() {
            const debugDiv = document.getElementById('auth-debug');
            
            let resultado = "=== DADOS NO SESSIONSTORAGE ===\n";
            resultado += `usuario: ${sessionStorage.getItem('usuario')}\n`;
            resultado += `nivel: ${sessionStorage.getItem('nivel')}\n`;
            resultado += `projeto: ${sessionStorage.getItem('projeto')}\n`;
            resultado += `user_id: ${sessionStorage.getItem('user_id')}\n`;
            resultado += `id: ${sessionStorage.getItem('id')}\n\n`;
            
            resultado += "=== DADOS NO LOCALSTORAGE ===\n";
            resultado += `usuario: ${localStorage.getItem('usuario')}\n`;
            resultado += `nivel: ${localStorage.getItem('nivel')}\n`;
            resultado += `projeto: ${localStorage.getItem('projeto')}\n`;
            resultado += `user_id: ${localStorage.getItem('user_id')}\n`;
            resultado += `id: ${localStorage.getItem('id')}\n\n`;
            
            resultado += "=== VERIFICA√á√ÉO DO MIDDLEWARE ===\n";
            if (window.AuthMiddleware) {
                resultado += `Middleware carregado: SIM\n`;
                resultado += `verificarAutenticacao(): ${window.AuthMiddleware.verificarAutenticacao()}\n`;
                resultado += `verificarPermissaoProjeto('Planejamento'): ${window.AuthMiddleware.verificarPermissaoProjeto('Planejamento')}\n`;
            } else {
                resultado += `Middleware carregado: N√ÉO\n`;
            }
            
            const classe = window.AuthMiddleware && window.AuthMiddleware.verificarAutenticacao() ? 'success' : 'error';
            debugDiv.innerHTML = `<div class="${classe}">${resultado}</div>`;
        }
        
        function limparTodosOsDados() {
            if (window.AuthMiddleware) {
                window.AuthMiddleware.limparDadosLogin();
            } else {
                // Limpar manualmente
                ['usuario', 'nivel', 'projeto', 'user_id', 'id'].forEach(key => {
                    sessionStorage.removeItem(key);
                    localStorage.removeItem(key);
                });
            }
            
            verificarTodosOsDados();
            alert('Todos os dados foram limpos!');
        }
        
        function simularLogin() {
            const usuario = document.getElementById('sim-usuario').value;
            const nivel = document.getElementById('sim-nivel').value;
            const projeto = document.getElementById('sim-projeto').value;
            const userId = document.getElementById('sim-user-id').value;
            
            const dadosLogin = {
                usuario: usuario,
                nivel: nivel,
                projeto: projeto,
                user_id: userId,
                id: userId
            };
            
            if (window.AuthMiddleware) {
                window.AuthMiddleware.salvarDadosLogin(dadosLogin);
            } else {
                // Salvar manualmente
                Object.keys(dadosLogin).forEach(key => {
                    sessionStorage.setItem(key, dadosLogin[key]);
                    localStorage.setItem(key, dadosLogin[key]);
                });
            }
            
            verificarTodosOsDados();
            alert('Login simulado com sucesso!');
        }
        
        function testarLinkDiagnostico() {
            const link = document.getElementById('link-teste').value;
            const debugDiv = document.getElementById('link-debug');
            
            if (!link) {
                debugDiv.innerHTML = '<div class="error">Digite um link para testar</div>';
                return;
            }
            
            // Extrair o par√¢metro link da URL
            let linkUnico = '';
            try {
                const url = new URL(link);
                linkUnico = url.searchParams.get('link');
            } catch (e) {
                debugDiv.innerHTML = '<div class="error">URL inv√°lida</div>';
                return;
            }
            
            if (!linkUnico) {
                debugDiv.innerHTML = '<div class="error">Par√¢metro "link" n√£o encontrado na URL</div>';
                return;
            }
            
            let resultado = `=== TESTE DO LINK ===\n`;
            resultado += `URL completa: ${link}\n`;
            resultado += `Link √∫nico extra√≠do: ${linkUnico}\n\n`;
            
            if (window.AuthMiddleware) {
                resultado += `Middleware dispon√≠vel: SIM\n`;
                resultado += `Usu√°rio autenticado: ${window.AuthMiddleware.verificarAutenticacao()}\n`;
                
                if (window.AuthMiddleware.verificarAutenticacao()) {
                    resultado += `\n‚úÖ USU√ÅRIO EST√Å LOGADO - Link deveria funcionar\n`;
                    resultado += `Clique no link abaixo para testar:\n`;
                    resultado += `${link}`;
                    
                    debugDiv.innerHTML = `
                        <div class="success">${resultado}</div>
                        <a href="${link}" target="_blank" style="display: inline-block; margin-top: 10px; padding: 10px; background: #007bff; color: white; text-decoration: none; border-radius: 4px;">
                            üîó Testar Link em Nova Aba
                        </a>
                    `;
                } else {
                    resultado += `\n‚ùå USU√ÅRIO N√ÉO EST√Å LOGADO - Link vai pedir login\n`;
                    debugDiv.innerHTML = `<div class="error">${resultado}</div>`;
                }
            } else {
                resultado += `Middleware dispon√≠vel: N√ÉO\n`;
                debugDiv.innerHTML = `<div class="error">${resultado}</div>`;
            }
        }
        
        // Verificar automaticamente ao carregar
        document.addEventListener('DOMContentLoaded', function() {
            verificarTodosOsDados();
        });
    </script>
</body>
</html>

