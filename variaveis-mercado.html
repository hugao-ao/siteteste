<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Variáveis de Mercado</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    /* --- Sidebar Integration Styles --- */
    body {
      display: flex;
      margin: 0;
      min-height: 100vh;
    }
    #main-content-mercado {
      flex-grow: 1;
      padding: 2rem;
      margin-left: 250px;
      transition: margin-left 0.3s ease;
      background-color: var(--bg-surface);
      color: var(--text-light);
    }
    #main-content-mercado.sidebar-collapsed {
      margin-left: 60px;
    }
    
    .mercado-container {
      background-color: var(--bg-card);
      border-radius: 8px;
      padding: 2rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-top: 1.5rem;
      max-width: 1400px;
    }
    
    .form-section {
      margin-bottom: 2rem;
      padding: 1.5rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background-color: var(--bg-surface);
    }
    
    .form-section h3 {
      margin-top: 0;
      color: var(--accent-color);
      border-bottom: 2px solid var(--accent-color);
      padding-bottom: 0.5rem;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .form-grid-9 {
      display: grid;
      grid-template-columns: repeat(9, 1fr);
      gap: 0.8rem;
      margin-top: 1rem;
    }
    
    @media (max-width: 1400px) {
      .form-grid-9 {
        grid-template-columns: repeat(5, 1fr);
      }
    }
    
    @media (max-width: 900px) {
      .form-grid-9 {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    @media (max-width: 600px) {
      .form-grid-9 {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
    }
    
    .form-group label {
      font-weight: bold;
      margin-bottom: 0.5rem;
      color: var(--text-light);
      font-size: 0.85rem;
    }
    
    .form-group input {
      padding: 0.75rem;
      border: 2px solid #ccc;
      border-radius: 4px;
      background-color: var(--bg-input);
      color: var(--text-light);
      font-size: 1rem;
    }
    
    .form-group input:focus {
      outline: none;
      border-color: #006400;
      border-width: 2px;
      box-shadow: 0 0 0 3px rgba(0, 100, 0, 0.2);
    }
    
    .form-group input:disabled {
      background-color: var(--bg-disabled);
      color: var(--text-muted);
      cursor: not-allowed;
    }
    
    .calculated-field {
      background-color: #f8f9fa;
      border-color: #6c757d;
    }
    
    .aposentadoria-field {
      background-color: #fff3cd;
      border-color: #ffc107;
    }
    
    .cdi-input-field {
      background-color: #e8f5e9 !important;
      border-color: #4caf50 !important;
    }
    
    .save-btn {
      background-color: var(--accent-color);
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 5px;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.3s ease;
      margin-top: 1rem;
    }
    
    .save-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    .save-btn:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .btn-secondary {
      background-color: #6c757d;
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 5px;
      font-size: 0.9rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-right: 0.5rem;
    }
    
    .btn-secondary:hover {
      background-color: #5a6268;
    }
    
    .btn-success {
      background-color: #28a745;
    }
    
    .btn-success:hover {
      background-color: #218838;
    }
    
    .btn-warning {
      background-color: #ffc107;
      color: #212529;
    }
    
    .btn-warning:hover {
      background-color: #e0a800;
    }
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .section-header h3 {
      margin: 0;
      border: none;
      padding: 0;
    }
    
    .section-buttons {
      display: flex;
      gap: 0.5rem;
    }
    
    .last-update {
      background-color: #e3f2fd;
      border: 1px solid #2196f3;
      border-radius: 4px;
      padding: 1rem;
      margin-bottom: 1rem;
      color: #1976d2;
      font-weight: bold;
    }
    
    .theme-planejamento .save-btn {
      background-color: #006400;
    }
    
    .theme-planejamento .form-section h3 {
      color: #006400;
      border-bottom-color: #006400;
    }
    
    .loading {
      text-align: center;
      padding: 2rem;
      color: var(--text-muted);
    }
    
    .error-message {
      background-color: #ffebee;
      border: 1px solid #f44336;
      color: #c62828;
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1rem;
    }
    
    .success-message {
      background-color: #e8f5e8;
      border: 1px solid #4caf50;
      color: #2e7d32;
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1rem;
    }
    
    .perfil-label {
      font-size: 0.75rem !important;
      line-height: 1.2;
    }
    
    .info-text {
      font-size: 0.8rem;
      color: #666;
      margin-top: 0.5rem;
      font-style: italic;
    }
  </style>
</head>
<body>
  <main id="main-content-mercado">
    <h1>Variáveis de Mercado</h1>
    
    <div class="mercado-container">
      <div id="loading" class="loading">
        <i class="fas fa-spinner fa-spin"></i> Carregando dados...
      </div>
      
      <div id="error-container"></div>
      <div id="success-container"></div>
      
      <div id="last-update-info" class="last-update" style="display: none;">
        <i class="fas fa-clock"></i> Última atualização: <span id="last-update-date">-</span>
      </div>
      
      <form id="mercado-form" style="display: none;">
        <!-- Seção de Variáveis de Entrada -->
        <div class="form-section">
          <h3><i class="fas fa-edit"></i> Variáveis de Entrada</h3>
          <div class="form-grid">
            <div class="form-group">
              <label for="selic">SELIC (%)</label>
              <input type="number" id="selic" name="selic" step="0.0001" min="0" required>
            </div>
            <div class="form-group">
              <label for="cdi_120_meses">CDI 120 meses (%)</label>
              <input type="number" id="cdi_120_meses" name="cdi_120_meses" step="0.0001" min="0" required>
            </div>
            <div class="form-group">
              <label for="ipca">IPCA (%)</label>
              <input type="number" id="ipca" name="ipca" step="0.0001" min="0" required>
            </div>
            <div class="form-group">
              <label for="ipca_120_meses">IPCA 120 meses (%)</label>
              <input type="number" id="ipca_120_meses" name="ipca_120_meses" step="0.0001" min="0" required>
            </div>
            <div class="form-group">
              <label for="rent_anual_aposentadoria"><i class="fas fa-umbrella-beach"></i> Rent Anual Aposentadoria (%)</label>
              <input type="number" id="rent_anual_aposentadoria" name="rent_anual_aposentadoria" step="0.0001" min="0" class="aposentadoria-field" required>
            </div>
          </div>
        </div>
        
        <!-- Seção de Variáveis Calculadas -->
        <div class="form-section">
          <h3><i class="fas fa-calculator"></i> Variáveis Calculadas Automaticamente</h3>
          <div class="form-grid">
            <div class="form-group">
              <label for="cdi">CDI (%)</label>
              <input type="number" id="cdi" name="cdi" class="calculated-field" disabled readonly>
            </div>
            <div class="form-group">
              <label for="cdi_aa_medio_10_anos">CDI a.a. Médio 10 anos (%)</label>
              <input type="number" id="cdi_aa_medio_10_anos" name="cdi_aa_medio_10_anos" class="calculated-field" disabled readonly>
            </div>
            <div class="form-group">
              <label for="ipca_aa_medio_10_anos">IPCA a.a. Médio 10 anos (%)</label>
              <input type="number" id="ipca_aa_medio_10_anos" name="ipca_aa_medio_10_anos" class="calculated-field" disabled readonly>
            </div>
            <div class="form-group">
              <label for="rent_mensal_aposentadoria"><i class="fas fa-umbrella-beach"></i> Rent Mensal Aposentadoria (%)</label>
              <input type="number" id="rent_mensal_aposentadoria" name="rent_mensal_aposentadoria" class="calculated-field aposentadoria-field" disabled readonly>
            </div>
          </div>
        </div>
        
        <!-- Seção de Multiplicadores % CDI por Perfil -->
        <div class="form-section">
          <div class="section-header">
            <h3><i class="fas fa-sliders-h"></i> Multiplicadores % do CDI por Perfil</h3>
            <div class="section-buttons">
              <button type="button" id="btn-usar-padrao" class="btn-secondary btn-warning">
                <i class="fas fa-undo"></i> Usar Padrão
              </button>
              <button type="button" id="btn-salvar-padrao" class="btn-secondary btn-success">
                <i class="fas fa-save"></i> Salvar como Padrão
              </button>
            </div>
          </div>
          <p class="info-text">Defina o percentual do CDI que cada perfil de investidor deve render. Os cálculos de rentabilidade serão baseados nesses valores.</p>
          <div class="form-grid-9">
            <div class="form-group">
              <label for="mult_sem_conhecimento" class="perfil-label">0. Sem Conhecimento (%)</label>
              <input type="number" id="mult_sem_conhecimento" name="mult_sem_conhecimento" step="1" min="0" max="200" class="cdi-input-field" value="80">
            </div>
            <div class="form-group">
              <label for="mult_iniciante" class="perfil-label">0.5. Iniciante (%)</label>
              <input type="number" id="mult_iniciante" name="mult_iniciante" step="1" min="0" max="200" class="cdi-input-field" value="95">
            </div>
            <div class="form-group">
              <label for="mult_ultra_cons" class="perfil-label">1. Ultra-Conservador (%)</label>
              <input type="number" id="mult_ultra_cons" name="mult_ultra_cons" step="1" min="0" max="200" class="cdi-input-field" value="100">
            </div>
            <div class="form-group">
              <label for="mult_cons" class="perfil-label">2. Conservador (%)</label>
              <input type="number" id="mult_cons" name="mult_cons" step="1" min="0" max="200" class="cdi-input-field" value="103">
            </div>
            <div class="form-group">
              <label for="mult_cons_mod" class="perfil-label">3. Conservador-Moderado (%)</label>
              <input type="number" id="mult_cons_mod" name="mult_cons_mod" step="1" min="0" max="200" class="cdi-input-field" value="106">
            </div>
            <div class="form-group">
              <label for="mult_mod" class="perfil-label">4. Moderado (%)</label>
              <input type="number" id="mult_mod" name="mult_mod" step="1" min="0" max="200" class="cdi-input-field" value="110">
            </div>
            <div class="form-group">
              <label for="mult_mod_arro" class="perfil-label">5. Moderado-Arrojado (%)</label>
              <input type="number" id="mult_mod_arro" name="mult_mod_arro" step="1" min="0" max="200" class="cdi-input-field" value="115">
            </div>
            <div class="form-group">
              <label for="mult_arro" class="perfil-label">6. Arrojado (%)</label>
              <input type="number" id="mult_arro" name="mult_arro" step="1" min="0" max="200" class="cdi-input-field" value="120">
            </div>
            <div class="form-group">
              <label for="mult_ultra_arro" class="perfil-label">7. Ultra-Arrojado (%)</label>
              <input type="number" id="mult_ultra_arro" name="mult_ultra_arro" step="1" min="0" max="200" class="cdi-input-field" value="130">
            </div>
          </div>
        </div>
        
        <!-- Seção de Rentabilidades 10 anos - 9 Perfis -->
        <div class="form-section">
          <h3><i class="fas fa-chart-line"></i> Rentabilidades 10 anos (%) - 9 Perfis</h3>
          <div class="form-grid-9">
            <div class="form-group">
              <label for="rent_sem_conhecimento_10_anos" class="perfil-label">0. Sem Conhecimento</label>
              <input type="number" id="rent_sem_conhecimento_10_anos" name="rent_sem_conhecimento_10_anos" class="calculated-field" disabled readonly>
            </div>
            <div class="form-group">
              <label for="rent_iniciante_10_anos" class="perfil-label">0.5. Iniciante</label>
              <input type="number" id="rent_iniciante_10_anos" name="rent_iniciante_10_anos" class="calculated-field" disabled readonly>
            </div>
            <div class="form-group">
              <label for="rent_ultra_cons_10_anos" class="perfil-label">1. Ultra-Conservador</label>
              <input type="number" id="rent_ultra_cons_10_anos" name="rent_ultra_cons_10_anos" class="calculated-field" disabled readonly>
            </div>
            <div class="form-group">
              <label for="rent_cons_10_anos" class="perfil-label">2. Conservador</label>
              <input type="number" id="rent_cons_10_anos" name="rent_cons_10_anos" class="calculated-field" disabled readonly>
            </div>
            <div class="form-group">
              <label for="rent_cons_mod_10_anos" class="perfil-label">3. Conservador-Moderado</label>
              <input type="number" id="rent_cons_mod_10_anos" name="rent_cons_mod_10_anos" class="calculated-field" disabled readonly>
            </div>
            <div class="form-group">
              <label for="rent_mod_10_anos" class="perfil-label">4. Moderado</label>
              <input type="number" id="rent_mod_10_anos" name="rent_mod_10_anos" class="calculated-field" disabled readonly>
            </div>
            <div class="form-group">
              <label for="rent_mod_arro_10_anos" class="perfil-label">5. Moderado-Arrojado</label>
              <input type="number" id="rent_mod_arro_10_anos" name="rent_mod_arro_10_anos" class="calculated-field" disabled readonly>
            </div>
            <div class="form-group">
              <label for="rent_arro_10_anos" class="perfil-label">6. Arrojado</label>
              <input type="number" id="rent_arro_10_anos" name="rent_arro_10_anos" class="calculated-field" disabled readonly>
            </div>
            <div class="form-group">
              <label for="rent_ultra_arro_10_anos" class="perfil-label">7. Ultra-Arrojado</label>
              <input type="number" id="rent_ultra_arro_10_anos" name="rent_ultra_arro_10_anos" class="calculated-field" disabled readonly>
            </div>
          </div>
        </div>
        
        <!-- Seção de Rentabilidades Atuais - 9 Perfis -->
        <div class="form-section">
          <h3><i class="fas fa-chart-bar"></i> Rentabilidades Atuais (%) - 9 Perfis</h3>
          <div class="form-grid-9">
            <div class="form-group">
              <label for="rent_sem_conhecimento" class="perfil-label">0. Sem Conhecimento</label>
              <input type="number" id="rent_sem_conhecimento" name="rent_sem_conhecimento" class="calculated-field" disabled readonly>
            </div>
            <div class="form-group">
              <label for="rent_iniciante" class="perfil-label">0.5. Iniciante</label>
              <input type="number" id="rent_iniciante" name="rent_iniciante" class="calculated-field" disabled readonly>
            </div>
            <div class="form-group">
              <label for="rent_ultra_cons" class="perfil-label">1. Ultra-Conservador</label>
              <input type="number" id="rent_ultra_cons" name="rent_ultra_cons" class="calculated-field" disabled readonly>
            </div>
            <div class="form-group">
              <label for="rent_cons" class="perfil-label">2. Conservador</label>
              <input type="number" id="rent_cons" name="rent_cons" class="calculated-field" disabled readonly>
            </div>
            <div class="form-group">
              <label for="rent_cons_mod" class="perfil-label">3. Conservador-Moderado</label>
              <input type="number" id="rent_cons_mod" name="rent_cons_mod" class="calculated-field" disabled readonly>
            </div>
            <div class="form-group">
              <label for="rent_mod" class="perfil-label">4. Moderado</label>
              <input type="number" id="rent_mod" name="rent_mod" class="calculated-field" disabled readonly>
            </div>
            <div class="form-group">
              <label for="rent_mod_arro" class="perfil-label">5. Moderado-Arrojado</label>
              <input type="number" id="rent_mod_arro" name="rent_mod_arro" class="calculated-field" disabled readonly>
            </div>
            <div class="form-group">
              <label for="rent_arro" class="perfil-label">6. Arrojado</label>
              <input type="number" id="rent_arro" name="rent_arro" class="calculated-field" disabled readonly>
            </div>
            <div class="form-group">
              <label for="rent_ultra_arro" class="perfil-label">7. Ultra-Arrojado</label>
              <input type="number" id="rent_ultra_arro" name="rent_ultra_arro" class="calculated-field" disabled readonly>
            </div>
          </div>
        </div>
        
        <button type="submit" class="save-btn" id="save-btn">
          <i class="fas fa-save"></i> Salvar Variáveis de Mercado
        </button>
      </form>
    </div>
  </main>

  <script type="module">
    import { injectSidebar } from './sidebar.js';
    import { supabase } from './supabase.js';
    
    injectSidebar("main-content-mercado", "Planejamento");
    
    // Elementos DOM
    const loadingEl = document.getElementById('loading');
    const errorContainer = document.getElementById('error-container');
    const successContainer = document.getElementById('success-container');
    const lastUpdateInfo = document.getElementById('last-update-info');
    const lastUpdateDate = document.getElementById('last-update-date');
    const mercadoForm = document.getElementById('mercado-form');
    const saveBtn = document.getElementById('save-btn');
    const btnUsarPadrao = document.getElementById('btn-usar-padrao');
    const btnSalvarPadrao = document.getElementById('btn-salvar-padrao');
    
    // Campos de entrada
    const selicInput = document.getElementById('selic');
    const cdi120Input = document.getElementById('cdi_120_meses');
    const ipcaInput = document.getElementById('ipca');
    const ipca120Input = document.getElementById('ipca_120_meses');
    const rentAnualAposentadoriaInput = document.getElementById('rent_anual_aposentadoria');
    
    // Campos calculados
    const cdiInput = document.getElementById('cdi');
    const cdiAaMedio10Input = document.getElementById('cdi_aa_medio_10_anos');
    const ipcaAaMedio10Input = document.getElementById('ipca_aa_medio_10_anos');
    const rentMensalAposentadoriaInput = document.getElementById('rent_mensal_aposentadoria');
    
    // Campos de multiplicadores % CDI
    const multSemConhecimentoInput = document.getElementById('mult_sem_conhecimento');
    const multInicianteInput = document.getElementById('mult_iniciante');
    const multUltraConsInput = document.getElementById('mult_ultra_cons');
    const multConsInput = document.getElementById('mult_cons');
    const multConsModInput = document.getElementById('mult_cons_mod');
    const multModInput = document.getElementById('mult_mod');
    const multModArroInput = document.getElementById('mult_mod_arro');
    const multArroInput = document.getElementById('mult_arro');
    const multUltraArroInput = document.getElementById('mult_ultra_arro');
    
    // Rentabilidades 10 anos - 9 Perfis
    const rentSemConhecimento10Input = document.getElementById('rent_sem_conhecimento_10_anos');
    const rentIniciante10Input = document.getElementById('rent_iniciante_10_anos');
    const rentUltraCons10Input = document.getElementById('rent_ultra_cons_10_anos');
    const rentCons10Input = document.getElementById('rent_cons_10_anos');
    const rentConsMod10Input = document.getElementById('rent_cons_mod_10_anos');
    const rentMod10Input = document.getElementById('rent_mod_10_anos');
    const rentModArro10Input = document.getElementById('rent_mod_arro_10_anos');
    const rentArro10Input = document.getElementById('rent_arro_10_anos');
    const rentUltraArro10Input = document.getElementById('rent_ultra_arro_10_anos');
    
    // Rentabilidades atuais - 9 Perfis
    const rentSemConhecimentoInput = document.getElementById('rent_sem_conhecimento');
    const rentInicianteInput = document.getElementById('rent_iniciante');
    const rentUltraConsInput = document.getElementById('rent_ultra_cons');
    const rentConsInput = document.getElementById('rent_cons');
    const rentConsModInput = document.getElementById('rent_cons_mod');
    const rentModInput = document.getElementById('rent_mod');
    const rentModArroInput = document.getElementById('rent_mod_arro');
    const rentArroInput = document.getElementById('rent_arro');
    const rentUltraArroInput = document.getElementById('rent_ultra_arro');
    
    // Valores padrão dos multiplicadores (realistas)
    // Ultra-Conservador = 100% CDI como base
    const MULTIPLICADORES_PADRAO = {
      sem_conhecimento: 80,   // 80% CDI - Poupança e afins
      iniciante: 95,          // 95% CDI - CDBs de bancos grandes
      ultra_cons: 100,        // 100% CDI - Tesouro Selic, CDBs 100%
      cons: 103,              // 103% CDI - CDBs acima de 100%, LCIs/LCAs
      cons_mod: 106,          // 106% CDI - Pequena exposição RV (até 10%)
      mod: 110,               // 110% CDI - Exposição moderada (até 30% RV)
      mod_arro: 115,          // 115% CDI - Exposição significativa (até 50% RV)
      arro: 120,              // 120% CDI - Alta exposição (até 70% RV)
      ultra_arro: 130         // 130% CDI - Exposição máxima (até 95% RV)
    };
    
    // Funções utilitárias
    function showError(message) {
      errorContainer.innerHTML = `<div class="error-message"><i class="fas fa-exclamation-triangle"></i> ${message}</div>`;
      successContainer.innerHTML = '';
    }
    
    function showSuccess(message) {
      successContainer.innerHTML = `<div class="success-message"><i class="fas fa-check-circle"></i> ${message}</div>`;
      errorContainer.innerHTML = '';
    }
    
    function clearMessages() {
      errorContainer.innerHTML = '';
      successContainer.innerHTML = '';
    }
    
    // Função para obter multiplicadores atuais dos inputs
    function getMultiplicadores() {
      return {
        sem_conhecimento: parseFloat(multSemConhecimentoInput.value) / 100 || 0.80,
        iniciante: parseFloat(multInicianteInput.value) / 100 || 0.95,
        ultra_cons: parseFloat(multUltraConsInput.value) / 100 || 1.00,
        cons: parseFloat(multConsInput.value) / 100 || 1.03,
        cons_mod: parseFloat(multConsModInput.value) / 100 || 1.06,
        mod: parseFloat(multModInput.value) / 100 || 1.10,
        mod_arro: parseFloat(multModArroInput.value) / 100 || 1.15,
        arro: parseFloat(multArroInput.value) / 100 || 1.20,
        ultra_arro: parseFloat(multUltraArroInput.value) / 100 || 1.30
      };
    }
    
    // Função para calcular todas as variáveis automaticamente
    function calculateVariables() {
      const selic = parseFloat(selicInput.value) || 0;
      const cdi120 = parseFloat(cdi120Input.value) || 0;
      const ipca = parseFloat(ipcaInput.value) || 0;
      const ipca120 = parseFloat(ipca120Input.value) || 0;
      const rentAnualAposentadoria = parseFloat(rentAnualAposentadoriaInput.value) || 0;
      
      // Obter multiplicadores dos inputs
      const mult = getMultiplicadores();
      
      // 1. CDI = SELIC - 0,1%
      const cdi = selic - 0.1;
      cdiInput.value = cdi.toFixed(4);
      
      // 2. CDI a.a. Médio 10 anos
      const cdiAaMedio10 = (Math.pow(1 + (cdi120 / 100), 1/10) - 1) * 100;
      cdiAaMedio10Input.value = cdiAaMedio10.toFixed(4);
      
      // 3. IPCA a.a. Médio 10 anos
      const ipcaAaMedio10 = (Math.pow(1 + (ipca120 / 100), 1/10) - 1) * 100;
      ipcaAaMedio10Input.value = ipcaAaMedio10.toFixed(4);
      
      // 4. Rent Mensal Aposentadoria
      const rentMensalAposentadoria = (Math.pow(1 + (rentAnualAposentadoria / 100), 1/12) - 1) * 100;
      rentMensalAposentadoriaInput.value = rentMensalAposentadoria.toFixed(4);
      
      // Rentabilidades 10 anos - 9 Perfis
      rentSemConhecimento10Input.value = (cdiAaMedio10 * mult.sem_conhecimento).toFixed(4);
      rentIniciante10Input.value = (cdiAaMedio10 * mult.iniciante).toFixed(4);
      rentUltraCons10Input.value = (cdiAaMedio10 * mult.ultra_cons).toFixed(4);
      rentCons10Input.value = (cdiAaMedio10 * mult.cons).toFixed(4);
      rentConsMod10Input.value = (cdiAaMedio10 * mult.cons_mod).toFixed(4);
      rentMod10Input.value = (cdiAaMedio10 * mult.mod).toFixed(4);
      rentModArro10Input.value = (cdiAaMedio10 * mult.mod_arro).toFixed(4);
      rentArro10Input.value = (cdiAaMedio10 * mult.arro).toFixed(4);
      rentUltraArro10Input.value = (cdiAaMedio10 * mult.ultra_arro).toFixed(4);
      
      // Rentabilidades atuais - 9 Perfis
      rentSemConhecimentoInput.value = (cdi * mult.sem_conhecimento).toFixed(4);
      rentInicianteInput.value = (cdi * mult.iniciante).toFixed(4);
      rentUltraConsInput.value = (cdi * mult.ultra_cons).toFixed(4);
      rentConsInput.value = (cdi * mult.cons).toFixed(4);
      rentConsModInput.value = (cdi * mult.cons_mod).toFixed(4);
      rentModInput.value = (cdi * mult.mod).toFixed(4);
      rentModArroInput.value = (cdi * mult.mod_arro).toFixed(4);
      rentArroInput.value = (cdi * mult.arro).toFixed(4);
      rentUltraArroInput.value = (cdi * mult.ultra_arro).toFixed(4);
    }
    
    // Função para usar valores padrão
    function usarPadrao() {
      multSemConhecimentoInput.value = MULTIPLICADORES_PADRAO.sem_conhecimento;
      multInicianteInput.value = MULTIPLICADORES_PADRAO.iniciante;
      multUltraConsInput.value = MULTIPLICADORES_PADRAO.ultra_cons;
      multConsInput.value = MULTIPLICADORES_PADRAO.cons;
      multConsModInput.value = MULTIPLICADORES_PADRAO.cons_mod;
      multModInput.value = MULTIPLICADORES_PADRAO.mod;
      multModArroInput.value = MULTIPLICADORES_PADRAO.mod_arro;
      multArroInput.value = MULTIPLICADORES_PADRAO.arro;
      multUltraArroInput.value = MULTIPLICADORES_PADRAO.ultra_arro;
      calculateVariables();
      showSuccess('Valores padrão aplicados!');
    }
    
    // Função para salvar como padrão (localStorage)
    function salvarComoPadrao() {
      const customPadrao = {
        sem_conhecimento: parseInt(multSemConhecimentoInput.value),
        iniciante: parseInt(multInicianteInput.value),
        ultra_cons: parseInt(multUltraConsInput.value),
        cons: parseInt(multConsInput.value),
        cons_mod: parseInt(multConsModInput.value),
        mod: parseInt(multModInput.value),
        mod_arro: parseInt(multModArroInput.value),
        arro: parseInt(multArroInput.value),
        ultra_arro: parseInt(multUltraArroInput.value)
      };
      localStorage.setItem('multiplicadores_padrao_custom', JSON.stringify(customPadrao));
      showSuccess('Valores salvos como padrão personalizado!');
    }
    
    // Função para carregar padrão personalizado
    function carregarPadraoPersonalizado() {
      const saved = localStorage.getItem('multiplicadores_padrao_custom');
      if (saved) {
        try {
          const custom = JSON.parse(saved);
          multSemConhecimentoInput.value = custom.sem_conhecimento || MULTIPLICADORES_PADRAO.sem_conhecimento;
          multInicianteInput.value = custom.iniciante || MULTIPLICADORES_PADRAO.iniciante;
          multUltraConsInput.value = custom.ultra_cons || MULTIPLICADORES_PADRAO.ultra_cons;
          multConsInput.value = custom.cons || MULTIPLICADORES_PADRAO.cons;
          multConsModInput.value = custom.cons_mod || MULTIPLICADORES_PADRAO.cons_mod;
          multModInput.value = custom.mod || MULTIPLICADORES_PADRAO.mod;
          multModArroInput.value = custom.mod_arro || MULTIPLICADORES_PADRAO.mod_arro;
          multArroInput.value = custom.arro || MULTIPLICADORES_PADRAO.arro;
          multUltraArroInput.value = custom.ultra_arro || MULTIPLICADORES_PADRAO.ultra_arro;
          return true;
        } catch (e) {
          console.error('Erro ao carregar padrão personalizado:', e);
        }
      }
      return false;
    }
    
    // Adicionar listeners para recalcular quando os valores mudarem
    [selicInput, cdi120Input, ipcaInput, ipca120Input, rentAnualAposentadoriaInput,
     multSemConhecimentoInput, multInicianteInput, multUltraConsInput, multConsInput,
     multConsModInput, multModInput, multModArroInput, multArroInput, multUltraArroInput
    ].forEach(input => {
      input.addEventListener('input', calculateVariables);
    });
    
    // Listeners para botões
    btnUsarPadrao.addEventListener('click', usarPadrao);
    btnSalvarPadrao.addEventListener('click', salvarComoPadrao);
    
    // Função para carregar dados existentes
    async function loadExistingData() {
      try {
        const { data, error } = await supabase
          .from('variaveis_mercado')
          .select('*')
          .order('data_ultima_atualizacao', { ascending: false })
          .limit(1);
        
        if (error) throw error;
        
        if (data && data.length > 0) {
          const latest = data[0];
          
          // Preencher campos de entrada
          selicInput.value = parseFloat(latest.selic || 0).toFixed(4);
          cdi120Input.value = parseFloat(latest.cdi_120_meses || 0).toFixed(4);
          ipcaInput.value = parseFloat(latest.ipca || 0).toFixed(4);
          ipca120Input.value = parseFloat(latest.ipca_120_meses || 0).toFixed(4);
          rentAnualAposentadoriaInput.value = parseFloat(latest.rent_anual_aposentadoria || 0).toFixed(4);
          
          // Carregar multiplicadores salvos ou usar padrão personalizado
          if (latest.mult_sem_conhecimento !== null && latest.mult_sem_conhecimento !== undefined) {
            multSemConhecimentoInput.value = latest.mult_sem_conhecimento;
            multInicianteInput.value = latest.mult_iniciante;
            multUltraConsInput.value = latest.mult_ultra_cons;
            multConsInput.value = latest.mult_cons;
            multConsModInput.value = latest.mult_cons_mod;
            multModInput.value = latest.mult_mod;
            multModArroInput.value = latest.mult_mod_arro;
            multArroInput.value = latest.mult_arro;
            multUltraArroInput.value = latest.mult_ultra_arro;
          } else if (!carregarPadraoPersonalizado()) {
            // Se não tem dados salvos nem padrão personalizado, usar padrão
            usarPadrao();
          }
          
          // Recalcular variáveis
          calculateVariables();
          
          // Mostrar data da última atualização
          const updateDate = new Date(latest.data_ultima_atualizacao);
          lastUpdateDate.textContent = updateDate.toLocaleString('pt-BR');
          lastUpdateInfo.style.display = 'block';
        } else {
          // Sem dados, carregar padrão personalizado ou usar padrão
          if (!carregarPadraoPersonalizado()) {
            usarPadrao();
          }
        }
      } catch (error) {
        console.error('Erro ao carregar dados:', error);
        showError('Erro ao carregar dados existentes: ' + error.message);
        // Em caso de erro, usar padrão
        if (!carregarPadraoPersonalizado()) {
          usarPadrao();
        }
      }
    }
    
    // Função para salvar dados
    async function saveData(event) {
      event.preventDefault();
      
      const userId = sessionStorage.getItem('user_id');
      if (!userId) {
        showError('Usuário não identificado. Faça login novamente.');
        return;
      }
      
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
      
      try {
        const dataToSave = {
          selic: parseFloat(selicInput.value),
          cdi_120_meses: parseFloat(cdi120Input.value),
          ipca: parseFloat(ipcaInput.value),
          ipca_120_meses: parseFloat(ipca120Input.value),
          cdi: parseFloat(cdiInput.value),
          cdi_aa_medio_10_anos: parseFloat(cdiAaMedio10Input.value),
          ipca_aa_medio_10_anos: parseFloat(ipcaAaMedio10Input.value),
          rent_anual_aposentadoria: parseFloat(rentAnualAposentadoriaInput.value),
          rent_mensal_aposentadoria: parseFloat(rentMensalAposentadoriaInput.value),
          // Multiplicadores % CDI
          mult_sem_conhecimento: parseInt(multSemConhecimentoInput.value),
          mult_iniciante: parseInt(multInicianteInput.value),
          mult_ultra_cons: parseInt(multUltraConsInput.value),
          mult_cons: parseInt(multConsInput.value),
          mult_cons_mod: parseInt(multConsModInput.value),
          mult_mod: parseInt(multModInput.value),
          mult_mod_arro: parseInt(multModArroInput.value),
          mult_arro: parseInt(multArroInput.value),
          mult_ultra_arro: parseInt(multUltraArroInput.value),
          // Rentabilidades 10 anos - 9 Perfis
          rent_sem_conhecimento_10_anos: parseFloat(rentSemConhecimento10Input.value),
          rent_iniciante_10_anos: parseFloat(rentIniciante10Input.value),
          rent_ultra_cons_10_anos: parseFloat(rentUltraCons10Input.value),
          rent_cons_10_anos: parseFloat(rentCons10Input.value),
          rent_cons_mod_10_anos: parseFloat(rentConsMod10Input.value),
          rent_mod_10_anos: parseFloat(rentMod10Input.value),
          rent_mod_arro_10_anos: parseFloat(rentModArro10Input.value),
          rent_arro_10_anos: parseFloat(rentArro10Input.value),
          rent_ultra_arro_10_anos: parseFloat(rentUltraArro10Input.value),
          // Rentabilidades atuais - 9 Perfis
          rent_sem_conhecimento: parseFloat(rentSemConhecimentoInput.value),
          rent_iniciante: parseFloat(rentInicianteInput.value),
          rent_ultra_cons: parseFloat(rentUltraConsInput.value),
          rent_cons: parseFloat(rentConsInput.value),
          rent_cons_mod: parseFloat(rentConsModInput.value),
          rent_mod: parseFloat(rentModInput.value),
          rent_mod_arro: parseFloat(rentModArroInput.value),
          rent_arro: parseFloat(rentArroInput.value),
          rent_ultra_arro: parseFloat(rentUltraArroInput.value),
          atualizado_por_id: userId
        };
        
        const { data, error } = await supabase
          .from('variaveis_mercado')
          .insert([dataToSave])
          .select();
        
        if (error) throw error;
        
        showSuccess('Variáveis de mercado salvas com sucesso!');
        
        const updateDate = new Date();
        lastUpdateDate.textContent = updateDate.toLocaleString('pt-BR');
        lastUpdateInfo.style.display = 'block';
        
      } catch (error) {
        console.error('Erro ao salvar:', error);
        showError('Erro ao salvar variáveis: ' + error.message);
      } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-save"></i> Salvar Variáveis de Mercado';
      }
    }
    
    // Inicialização
    document.addEventListener("DOMContentLoaded", async () => {
      const userLevel = sessionStorage.getItem("nivel");
      if (userLevel !== 'admin') {
        showError("Acesso não autorizado.");
        setTimeout(() => {
          window.location.href = "index.html";
        }, 2000);
        return;
      }
      
      const mainContent = document.getElementById('main-content-mercado');
      if (mainContent) {
        mainContent.classList.add('theme-planejamento');
        const sidebar = document.getElementById('sidebar');
        if(sidebar) {
          sidebar.classList.remove('theme-admin', 'theme-argos', 'theme-hvc', 'theme-planejamento', 'theme-default');
          sidebar.classList.add('theme-planejamento');
        }
      }
      
      await loadExistingData();
      
      loadingEl.style.display = 'none';
      mercadoForm.style.display = 'block';
      
      mercadoForm.addEventListener('submit', saveData);
    });
  </script>
</body>
</html>
