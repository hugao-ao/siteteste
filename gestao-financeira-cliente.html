<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gestão Financeira - Cliente</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    /* --- Sidebar Integration Styles --- */
    body {
      display: flex;
      margin: 0;
      min-height: 100vh;
    }
    #main-content-gestao-financeira {
      flex-grow: 1;
      padding: 2rem;
      margin-left: 250px; /* Default margin for expanded sidebar */
      transition: margin-left 0.3s ease;
      background-color: var(--bg-surface);
      color: var(--text-light);
    }
    #main-content-gestao-financeira.sidebar-collapsed {
      margin-left: 60px; /* Margin for collapsed sidebar */
    }
    /* --- End Sidebar Integration Styles --- */
    
    .gestao-container {
      background-color: var(--bg-card);
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-top: 1.5rem;
    }
    
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1.5rem;
      align-items: flex-end;
    }
    
    .form-group {
      flex: 1;
      min-width: 150px; /* Ajustado para caber mais campos */
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    
    .subcategoria-label,
    .forma-label {
      color: #DAA520; /* Dourado */
      text-decoration: underline;
      cursor: pointer;
    }
    
    .form-group select,
    .form-group input {
      width: 100%;
      padding: 0.75rem;
      border-radius: 4px;
      border: 1px solid var(--border-color);
      background-color: var(--bg-input);
      color: var(--text-light);
    }
    
    .form-group input[type="date"] {
      /* Estilo específico para campos de data, se necessário */
      padding: calc(0.75rem - 1px); /* Ajuste para consistência */
    }
    
    .form-group.repete-group {
      display: flex;
      gap: 0.5rem;
      align-items: flex-end;
      flex-basis: 300px; /* Ajustar largura */
    }
    
    .form-group.repete-group .repete-numero {
      flex-basis: 80px;
      min-width: 60px;
    }
    
    .form-group.repete-group .repete-periodo {
      flex: 1;
    }
    
    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 4px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    
    .btn-primary {
      background-color: var(--accent-color);
      color: white;
    }
    
    .btn-primary:hover {
      background-color: var(--accent-color-darker);
    }
    
    .btn-secondary {
      background-color: var(--bg-button-secondary);
      color: var(--text-light);
      border: 1px solid var(--border-color);
    }
    
    .btn-secondary:hover {
      background-color: var(--bg-hover);
    }
    
    .table-container {
      margin-top: 2rem;
      overflow-x: auto;
    }
    
    .financeiro-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .financeiro-table th {
      text-align: left;
      padding: 0.75rem;
      border-bottom: 2px solid var(--border-color);
      color: var(--text-accent);
    }
    
    .financeiro-table td {
      padding: 0.75rem;
      border-bottom: 1px solid var(--border-color);
    }
    
    .financeiro-table tr:hover {
      background-color: var(--bg-hover);
    }
    
    .action-btn {
      background: none;
      border: none;
      cursor: pointer;
      margin-right: 0.5rem;
      color: var(--text-accent);
      font-size: 1.1rem;
    }
    
    .action-btn:hover {
      color: var(--accent-color);
    }
    
    .entrada {
      color: #27ae60;
    }
    
    .saida {
      color: #e74c3c;
    }
    
    .alert {
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1.5rem;
      display: none;
    }
    
    .alert-success {
      background-color: rgba(39, 174, 96, 0.2);
      border: 1px solid #27ae60;
      color: #27ae60;
    }
    
    .alert-error {
      background-color: rgba(231, 76, 60, 0.2);
      border: 1px solid #e74c3c;
      color: #e74c3c;
    }
    
    /* Modais */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.7);
    }
    
    .modal-content {
      background-color: #1e3a2b; /* Verde escuro da paleta */
      margin: 10% auto;
      padding: 1.5rem;
      border-radius: 8px;
      width: 80%;
      max-width: 600px; /* Aumentado para caber mais campos */
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      position: relative;
      z-index: 1001;
      border: 3px solid #DAA520; /* Borda dourada */
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      border-bottom: 1px solid #DAA520; /* Borda dourada */
      padding-bottom: 0.75rem;
    }
    
    .close-modal {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-light);
    }
    
    .modal-body {
      margin-bottom: 1.5rem;
    }
    
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
    }
    
    /* Estilos para a lista de itens no modal */
    .modal-list {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 1rem;
      border: 1px solid #DAA520; /* Borda dourada */
      border-radius: 4px;
      padding: 0.5rem;
      background-color: #2a4d3a; /* Verde médio da paleta */
    }
    
    .modal-list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem;
      border-bottom: 1px solid #DAA520; /* Borda dourada */
      background-color: #1e3a2b; /* Verde escuro da paleta */
    }
    
    .modal-list-item:last-child {
      border-bottom: none;
    }
    
    .modal-list-item-actions {
      display: flex;
      gap: 0.5rem;
    }
    
    .modal-list-item-actions button {
      background: none;
      border: none;
      cursor: pointer;
      color: #DAA520; /* Dourado */
      font-size: 1rem;
    }
    
    .modal-list-item-actions button:hover {
      color: #FFD700; /* Dourado mais claro no hover */
    }
    
    .add-item-form {
      display: flex;
      flex-wrap: wrap; /* Permitir quebra de linha */
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    
    .add-item-form input,
    .add-item-form select {
      flex: 1;
      padding: 0.5rem;
      border-radius: 4px;
      border: 1px solid #DAA520; /* Borda dourada */
      background-color: #2a4d3a; /* Verde médio da paleta */
      color: var(--text-light);
      min-width: 120px; /* Largura mínima */
    }
    
    .add-item-form button {
      padding: 0.5rem 1rem;
      border-radius: 4px;
      background-color: #DAA520; /* Dourado */
      color: #1e3a2b; /* Verde escuro */
      border: none;
      cursor: pointer;
      align-self: flex-end; /* Alinhar botão */
    }
    
    .add-item-form button:hover {
      background-color: #FFD700; /* Dourado mais claro no hover */
    }
    
    .edit-mode {
      background-color: #2a4d3a; /* Verde médio da paleta */
    }
    
    .edit-input {
      flex: 1;
      padding: 0.5rem;
      border-radius: 4px;
      border: 1px solid #DAA520; /* Borda dourada */
      background-color: #2a4d3a; /* Verde médio da paleta */
      color: var(--text-light);
      margin-right: 0.5rem;
    }
    
    /* Esconder campos de cartão de crédito por padrão */
    .cartao-fields {
      display: none;
      width: 100%; /* Ocupar linha inteira */
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    
    .cartao-fields.visible {
      display: flex;
    }
    
  </style>
</head>
<body>
  <!-- Sidebar será injetada aqui pelo sidebar.js -->
  <main id="main-content-gestao-financeira">
    <h1 id="cliente-nome">Gestão Financeira - Cliente</h1>
    
    <div class="gestao-container">
      <div id="alert-success" class="alert alert-success">
        Item adicionado com sucesso!
      </div>
      
      <div id="alert-error" class="alert alert-error">
        Erro ao adicionar item. Tente novamente.
      </div>
      
      <form id="item-form">
        <!-- Primeira Linha -->
        <div class="form-row">
          <div class="form-group">
            <label for="tipo-item">Tipo:</label>
            <select id="tipo-item" required>
              <option value="" disabled selected>Selecione o tipo</option>
              <option value="ENTRADA">ENTRADA</option>
              <option value="SAIDA">SAÍDA</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="categoria-item">Categoria:</label>
            <select id="categoria-item" required>
              <option value="" disabled selected>Selecione a categoria</option>
              <option value="RECEITA">Receita</option>
              <option value="DESPESA_FIXA">Despesa Fixa</option>
              <option value="DESPESA_VARIAVEL">Despesa Variável</option>
              <option value="INVESTIMENTO">Investimento</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="descricao-item">Descrição:</label>
            <input type="text" id="descricao-item" placeholder="Descrição do item" required>
          </div>
          
          <div class="form-group">
            <label for="subcategoria-item" class="subcategoria-label">Subcategoria (opcional):</label>
            <select id="subcategoria-item">
              <option value="" selected>Sem subcategoria</option>
              <!-- Opções serão carregadas dinamicamente -->
            </select>
          </div>
        </div>
        
        <!-- Segunda Linha -->
        <div class="form-row">
          <div class="form-group">
            <label for="via-item">Via:</label>
            <select id="via-item">
              <option value="SEM_PREENCHIMENTO" selected>[sem preenchimento]</option>
              <option value="DEBITO">DÉBITO</option>
              <option value="CREDITO">CRÉDITO</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="forma-item" class="forma-label">Forma:</label>
            <select id="forma-item">
              <option value="SEM_PREENCHIMENTO" selected>[sem preenchimento]</option>
              <!-- Opções serão carregadas dinamicamente -->
            </select>
          </div>
          
          <div class="form-group repete-group">
            <div class="repete-numero">
              <label for="repete-numero">Se repete a cada:</label>
              <select id="repete-numero" required>
                <!-- Números de 1 a 31 -->
              </select>
            </div>
            <div class="repete-periodo">
              <label for="repete-periodo">&nbsp;</label> <!-- Label vazio para alinhamento -->
              <select id="repete-periodo" required>
                <option value="NAO_REPETE">Não Repete</option>
                <option value="DIAS">Dia(s)</option>
                <option value="DIAS_UTEIS">Dia(s) Útil(eis)</option>
                <option value="SEMANAS">Semana(s)</option>
                <option value="QUINZENAS">Quinzena(s)</option>
                <option value="MESES">Mês(es)</option>
                <option value="TRIMESTRES">Trimestre(s)</option>
                <option value="QUADRIMESTRES">Quadrimestre(s)</option>
                <option value="SEMESTRES">Semestre(s)</option>
                <option value="ANOS">Anual(is)</option>
              </select>
            </div>
          </div>
          
          <div class="form-group">
            <label for="data-inicial">Data Inicial:</label>
            <input type="date" id="data-inicial">
          </div>
          
          <div class="form-group">
            <label for="data-final">Data Final:</label>
            <input type="date" id="data-final">
          </div>
          
          <div class="form-group">
            <button type="submit" class="btn btn-primary">Adicionar Item</button>
          </div>
        </div>
      </form>
      
      <div class="table-container">
        <table class="financeiro-table">
          <thead>
            <tr>
              <th>Tipo</th>
              <th>Categoria</th>
              <th>Descrição</th>
              <th>Subcategoria</th>
              <th>Via</th>
              <th>Forma</th>
              <th>Repetição</th>
              <th>Data Inicial</th>
              <th>Data Final</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="itens-table-body">
            <!-- Itens serão carregados dinamicamente -->
            <tr>
              <td colspan="10" class="text-center">Nenhum item financeiro cadastrado.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Modal para gerenciar subcategorias -->
    <div id="subcategoria-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Gerenciar Subcategorias</h3>
          <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="add-item-form">
            <input type="text" id="nova-subcategoria" placeholder="Nome da nova subcategoria">
            <button type="button" id="btn-add-subcategoria-modal">Adicionar</button>
          </div>
          
          <div class="modal-list" id="subcategorias-list">
            <!-- Lista de subcategorias será carregada dinamicamente -->
            <div class="modal-list-item">
              <span>Carregando subcategorias...</span>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="btn-cancel-subcategoria">Cancelar</button>
          <button class="btn btn-primary" id="btn-save-subcategoria">Salvar Alterações</button>
        </div>
      </div>
    </div>
    
    <!-- Modal para gerenciar formas de pagamento -->
    <div id="forma-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Gerenciar Formas de Pagamento</h3>
          <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="add-item-form">
            <input type="text" id="nova-forma-nome" placeholder="Nome (Ex: Conta BB, Cartão Nubank)">
            <select id="nova-forma-tipo">
              <option value="CONTA">Conta</option>
              <option value="CARTAO_CREDITO">Cartão de Crédito</option>
            </select>
            <div class="cartao-fields" id="nova-forma-cartao-fields">
              <input type="number" id="nova-forma-vencimento" placeholder="Dia Venc." min="1" max="31">
              <input type="number" id="nova-forma-fechamento" placeholder="Dia Fech." min="1" max="31">
            </div>
            <button type="button" id="btn-add-forma-modal">Adicionar</button>
          </div>
          
          <div class="modal-list" id="formas-list">
            <!-- Lista de formas será carregada dinamicamente -->
            <div class="modal-list-item">
              <span>Carregando formas de pagamento...</span>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="btn-cancel-forma">Cancelar</button>
          <button class="btn btn-primary" id="btn-save-forma">Salvar Alterações</button>
        </div>
      </div>
    </div>
  </main>

  <script type="module">
    import { injectSidebar } from './sidebar.js';
    import { supabase } from './supabase.js';
    
    // Injetar a sidebar
    injectSidebar("main-content-gestao-financeira");
    
    // --- Elementos DOM --- 
    const clienteNome = document.getElementById('cliente-nome');
    const itemForm = document.getElementById('item-form');
    const tipoItemSelect = document.getElementById('tipo-item');
    const descricaoItemInput = document.getElementById('descricao-item');
    const categoriaItemSelect = document.getElementById('categoria-item');
    const subcategoriaItemSelect = document.getElementById('subcategoria-item');
    const subcategoriaLabel = document.querySelector('.subcategoria-label');
    const itensTableBody = document.getElementById('itens-table-body');
    const alertSuccess = document.getElementById('alert-success');
    const alertError = document.getElementById('alert-error');
    
    // Novos campos
    const viaItemSelect = document.getElementById('via-item');
    const formaItemSelect = document.getElementById('forma-item');
    const formaLabel = document.querySelector('.forma-label');
    const repeteNumeroSelect = document.getElementById('repete-numero');
    const repetePeriodoSelect = document.getElementById('repete-periodo');
    const dataInicialInput = document.getElementById('data-inicial');
    const dataFinalInput = document.getElementById('data-final');
    
    // Modal de subcategoria
    const subcategoriaModal = document.getElementById('subcategoria-modal');
    const subcategoriasListEl = document.getElementById('subcategorias-list');
    const novaSubcategoriaInput = document.getElementById('nova-subcategoria');
    const btnAddSubcategoriaModal = document.getElementById('btn-add-subcategoria-modal');
    const btnCancelSubcategoria = document.getElementById('btn-cancel-subcategoria');
    const btnSaveSubcategoria = document.getElementById('btn-save-subcategoria');
    const closeModalSubcategoriaBtn = subcategoriaModal.querySelector('.close-modal');
    
    // Modal de forma de pagamento
    const formaModal = document.getElementById('forma-modal');
    const formasListEl = document.getElementById('formas-list');
    const novaFormaNomeInput = document.getElementById('nova-forma-nome');
    const novaFormaTipoSelect = document.getElementById('nova-forma-tipo');
    const novaFormaCartaoFields = document.getElementById('nova-forma-cartao-fields');
    const novaFormaVencimentoInput = document.getElementById('nova-forma-vencimento');
    const novaFormaFechamentoInput = document.getElementById('nova-forma-fechamento');
    const btnAddFormaModal = document.getElementById('btn-add-forma-modal');
    const btnCancelForma = document.getElementById('btn-cancel-forma');
    const btnSaveForma = document.getElementById('btn-save-forma');
    const closeModalFormaBtn = formaModal.querySelector('.close-modal');
    
    // --- Variáveis Globais --- 
    let clienteId = null;
    let subcategorias = [];
    let formasPagamento = [];
    let categoriaAtual = null;
    let subcategoriasModificadas = [];
    let subcategoriasRemovidas = [];
    let subcategoriasAdicionadas = [];
    let formasModificadas = [];
    let formasRemovidas = [];
    let formasAdicionadas = [];
    
    // Mapeamento de categorias para IDs
    let categoriasMap = {
      "RECEITA": null,
      "DESPESA_FIXA": null,
      "DESPESA_VARIAVEL": null,
      "INVESTIMENTO": null
    };
    
    // --- Funções --- 
    
    // Obter parâmetros da URL
    function getUrlParams() {
      const urlParams = new URLSearchParams(window.location.search);
      return {
        id: urlParams.get('id')
      };
    }
    
    // Carregar dados do cliente
    async function loadClienteData() {
      try {
        const { id } = getUrlParams();
        if (!id) {
          alert('ID do cliente não especificado.');
          window.location.href = 'clientes-dashboard.html';
          return;
        }
        
        clienteId = id;
        
        const { data, error } = await supabase
          .from('clientes')
          .select(`
            *,
            dados_cadastrais(*)
          `)
          .eq('id', id)
          .single();
        
        if (error) throw error;
        
        if (data) {
          const dadosCadastraisArray = data.dados_cadastrais || [];
          const dadosCadastrais = dadosCadastraisArray.find(dc => dc && dc.cliente_id === data.id) || {};
          const nome = dadosCadastrais.nome_completo || data.nome || 'Cliente';
          clienteNome.textContent = `Gestão Financeira - ${nome}`;
          document.title = `Gestão Financeira - ${nome}`;
        }
      } catch (error) {
        console.error('Erro ao carregar dados do cliente:', error);
      }
    }
    
    // Carregar categorias financeiras
    async function loadCategorias() {
      try {
        const { data, error } = await supabase
          .from('categorias_financeiras')
          .select('*');
        
        if (error) throw error;
        
        if (data && data.length > 0) {
          data.forEach(cat => {
            if (cat.tipo === 'RECEITA') categoriasMap.RECEITA = cat.id;
            else if (cat.tipo === 'DESPESA_FIXA') categoriasMap.DESPESA_FIXA = cat.id;
            else if (cat.tipo === 'DESPESA_VARIAVEL') categoriasMap.DESPESA_VARIAVEL = cat.id;
            else if (cat.tipo === 'INVESTIMENTO') categoriasMap.INVESTIMENTO = cat.id;
          });
          console.log("Categorias carregadas:", categoriasMap);
        } else {
          await createDefaultCategorias();
        }
      } catch (error) {
        console.error('Erro ao carregar categorias:', error);
      }
    }
    
    // Criar categorias padrão
    async function createDefaultCategorias() {
      try {
        const categoriasDefault = [
          { tipo: 'RECEITA', nome: 'Receita', descricao: 'Entradas de dinheiro e receitas' },
          { tipo: 'DESPESA_FIXA', nome: 'Despesa Fixa', descricao: 'Despesas que ocorrem regularmente com valor fixo' },
          { tipo: 'DESPESA_VARIAVEL', nome: 'Despesa Variável', descricao: 'Despesas que variam em valor ou frequência' },
          { tipo: 'INVESTIMENTO', nome: 'Investimento', descricao: 'Aplicações financeiras e investimentos' }
        ];
        
        const { data, error } = await supabase
          .from('categorias_financeiras')
          .insert(categoriasDefault)
          .select();
        
        if (error) throw error;
        
        if (data && data.length > 0) {
          data.forEach(cat => {
            if (cat.tipo === 'RECEITA') categoriasMap.RECEITA = cat.id;
            else if (cat.tipo === 'DESPESA_FIXA') categoriasMap.DESPESA_FIXA = cat.id;
            else if (cat.tipo === 'DESPESA_VARIAVEL') categoriasMap.DESPESA_VARIAVEL = cat.id;
            else if (cat.tipo === 'INVESTIMENTO') categoriasMap.INVESTIMENTO = cat.id;
          });
          console.log("Categorias padrão criadas:", categoriasMap);
        }
      } catch (error) {
        console.error('Erro ao criar categorias padrão:', error);
      }
    }
    
    // Carregar subcategorias
    async function loadSubcategorias() {
      try {
        const { data, error } = await supabase
          .from('subcategorias_financeiras')
          .select('*')
          .or(`cliente_id.is.null,cliente_id.eq.${clienteId}`);
        
        if (error) throw error;
        
        subcategorias = data || [];
        updateSubcategoriasSelect();
      } catch (error) {
        console.error('Erro ao carregar subcategorias:', error);
      }
    }
    
    // Carregar formas de pagamento
    async function loadFormasPagamento() {
      try {
        const { data, error } = await supabase
          .from('formas_pagamento')
          .select('*')
          .or(`cliente_id.is.null,cliente_id.eq.${clienteId}`);
        
        if (error) throw error;
        
        formasPagamento = data || [];
        updateFormasSelect();
      } catch (error) {
        console.error('Erro ao carregar formas de pagamento:', error);
      }
    }
    
    // Atualizar select de subcategorias
    function updateSubcategoriasSelect() {
      subcategoriaItemSelect.innerHTML = '<option value="" selected>Sem subcategoria</option>';
      const categoriaSelecionada = categoriaItemSelect.value;
      const categoriaId = categoriasMap[categoriaSelecionada];
      
      if (!categoriaId) return;
      
      const subcategoriasFiltradas = subcategorias.filter(sub => sub.categoria_id === categoriaId);
      subcategoriasFiltradas.forEach(sub => {
        const option = document.createElement('option');
        option.value = sub.id;
        option.textContent = sub.nome;
        subcategoriaItemSelect.appendChild(option);
      });
    }
    
    // Atualizar select de formas de pagamento
    function updateFormasSelect() {
      formaItemSelect.innerHTML = '<option value="SEM_PREENCHIMENTO" selected>[sem preenchimento]</option>';
      formasPagamento.forEach(forma => {
        const option = document.createElement('option');
        option.value = forma.id;
        option.textContent = forma.nome;
        formaItemSelect.appendChild(option);
      });
      // Aplicar regras de TIPO
      handleTipoChange();
    }
    
    // Renderizar lista de subcategorias no modal
    function renderSubcategoriasList() {
      subcategoriasListEl.innerHTML = '';
      const categoriaId = categoriasMap[categoriaAtual];
      
      if (!categoriaId) {
        subcategoriasListEl.innerHTML = '<div class="modal-list-item"><span>Erro: Categoria não encontrada.</span></div>';
        return;
      }
      
      const subcategoriasFiltradas = subcategorias.filter(sub => sub.categoria_id === categoriaId);
      
      if (subcategoriasFiltradas.length === 0) {
        subcategoriasListEl.innerHTML = '<div class="modal-list-item"><span>Nenhuma subcategoria encontrada.</span></div>';
        return;
      }
      
      subcategoriasFiltradas.forEach(sub => {
        const item = document.createElement('div');
        item.className = 'modal-list-item';
        item.dataset.id = sub.id;
        
        const span = document.createElement('span');
        span.textContent = sub.nome;
        
        const actions = document.createElement('div');
        actions.className = 'modal-list-item-actions';
        
        const editBtn = document.createElement('button');
        editBtn.innerHTML = '<i class="fas fa-edit"></i>';
        editBtn.title = 'Editar';
        editBtn.addEventListener('click', () => editSubcategoriaItem(item, sub, span, actions, editBtn, deleteBtn));
        
        const deleteBtn = document.createElement('button');
        deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
        deleteBtn.title = 'Excluir';
        deleteBtn.addEventListener('click', () => deleteSubcategoriaItem(item, sub));
        
        actions.appendChild(editBtn);
        actions.appendChild(deleteBtn);
        
        item.appendChild(span);
        item.appendChild(actions);
        
        subcategoriasListEl.appendChild(item);
      });
    }
    
    // Renderizar lista de formas de pagamento no modal
    function renderFormasList() {
      formasListEl.innerHTML = '';
      
      if (formasPagamento.length === 0) {
        formasListEl.innerHTML = '<div class="modal-list-item"><span>Nenhuma forma de pagamento encontrada.</span></div>';
        return;
      }
      
      formasPagamento.forEach(forma => {
        const item = document.createElement('div');
        item.className = 'modal-list-item';
        item.dataset.id = forma.id;
        
        const span = document.createElement('span');
        span.textContent = `${forma.nome} (${forma.tipo === 'CARTAO_CREDITO' ? 'Cartão' : 'Conta'})${forma.tipo === 'CARTAO_CREDITO' ? ` - Venc: ${forma.data_vencimento || 'N/A'}` : ''}`;
        
        const actions = document.createElement('div');
        actions.className = 'modal-list-item-actions';
        
        const editBtn = document.createElement('button');
        editBtn.innerHTML = '<i class="fas fa-edit"></i>';
        editBtn.title = 'Editar';
        editBtn.addEventListener('click', () => editFormaItem(item, forma, span, actions, editBtn, deleteBtn));
        
        const deleteBtn = document.createElement('button');
        deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
        deleteBtn.title = 'Excluir';
        deleteBtn.addEventListener('click', () => deleteFormaItem(item, forma));
        
        actions.appendChild(editBtn);
        actions.appendChild(deleteBtn);
        
        item.appendChild(span);
        item.appendChild(actions);
        
        formasListEl.appendChild(item);
      });
    }
    
    // --- Funções de Edição/Exclusão (Modal Subcategorias) ---
    function editSubcategoriaItem(item, sub, span, actions, editBtn, deleteBtn) {
      item.classList.add('edit-mode');
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'edit-input';
      input.value = sub.nome;
      
      const confirmBtn = document.createElement('button');
      confirmBtn.innerHTML = '<i class="fas fa-check"></i>';
      confirmBtn.title = 'Confirmar';
      confirmBtn.addEventListener('click', () => {
        const novoNome = input.value.trim();
        if (novoNome) {
          const subIndex = subcategorias.findIndex(s => s.id === sub.id);
          if (subIndex !== -1) subcategorias[subIndex].nome = novoNome;
          
          if (!subcategoriasAdicionadas.some(s => s.id === sub.id)) {
            const modIndex = subcategoriasModificadas.findIndex(s => s.id === sub.id);
            if (modIndex !== -1) subcategoriasModificadas[modIndex].nome = novoNome;
            else subcategoriasModificadas.push({...subcategorias[subIndex]});
          } else {
            const addIndex = subcategoriasAdicionadas.findIndex(s => s.id === sub.id);
            if (addIndex !== -1) subcategoriasAdicionadas[addIndex].nome = novoNome;
          }
          span.textContent = novoNome;
        }
        item.classList.remove('edit-mode');
        item.replaceChild(span, input);
        actions.innerHTML = '';
        actions.appendChild(editBtn);
        actions.appendChild(deleteBtn);
      });
      
      const cancelBtn = document.createElement('button');
      cancelBtn.innerHTML = '<i class="fas fa-times"></i>';
      cancelBtn.title = 'Cancelar';
      cancelBtn.addEventListener('click', () => {
        item.classList.remove('edit-mode');
        item.replaceChild(span, input);
        actions.innerHTML = '';
        actions.appendChild(editBtn);
        actions.appendChild(deleteBtn);
      });
      
      item.replaceChild(input, span);
      actions.innerHTML = '';
      actions.appendChild(confirmBtn);
      actions.appendChild(cancelBtn);
      input.focus();
    }
    
    function deleteSubcategoriaItem(item, sub) {
      subcategorias = subcategorias.filter(s => s.id !== sub.id);
      const addedIndex = subcategoriasAdicionadas.findIndex(s => s.id === sub.id);
      if (addedIndex !== -1) {
        subcategoriasAdicionadas.splice(addedIndex, 1);
      } else {
        subcategoriasRemovidas.push(sub.id);
        const modifiedIndex = subcategoriasModificadas.findIndex(s => s.id === sub.id);
        if (modifiedIndex !== -1) subcategoriasModificadas.splice(modifiedIndex, 1);
      }
      item.remove();
      if (subcategoriasListEl.children.length === 0) {
        subcategoriasListEl.innerHTML = '<div class="modal-list-item"><span>Nenhuma subcategoria encontrada.</span></div>';
      }
    }
    
    // --- Funções de Edição/Exclusão (Modal Formas) ---
    function editFormaItem(item, forma, span, actions, editBtn, deleteBtn) {
      item.classList.add('edit-mode');
      const nomeInput = document.createElement('input');
      nomeInput.type = 'text';
      nomeInput.className = 'edit-input';
      nomeInput.value = forma.nome;
      
      const tipoSelect = document.createElement('select');
      tipoSelect.className = 'edit-input';
      tipoSelect.innerHTML = `
        <option value="CONTA" ${forma.tipo === 'CONTA' ? 'selected' : ''}>Conta</option>
        <option value="CARTAO_CREDITO" ${forma.tipo === 'CARTAO_CREDITO' ? 'selected' : ''}>Cartão de Crédito</option>
      `;
      
      const vencimentoInput = document.createElement('input');
      vencimentoInput.type = 'number';
      vencimentoInput.className = 'edit-input';
      vencimentoInput.placeholder = 'Dia Venc.';
      vencimentoInput.min = 1; vencimentoInput.max = 31;
      vencimentoInput.value = forma.data_vencimento || '';
      
      const fechamentoInput = document.createElement('input');
      fechamentoInput.type = 'number';
      fechamentoInput.className = 'edit-input';
      fechamentoInput.placeholder = 'Dia Fech.';
      fechamentoInput.min = 1; fechamentoInput.max = 31;
      fechamentoInput.value = forma.data_fechamento || '';
      
      const cartaoFieldsDiv = document.createElement('div');
      cartaoFieldsDiv.className = 'cartao-fields';
      cartaoFieldsDiv.appendChild(vencimentoInput);
      cartaoFieldsDiv.appendChild(fechamentoInput);
      
      tipoSelect.addEventListener('change', () => {
        cartaoFieldsDiv.classList.toggle('visible', tipoSelect.value === 'CARTAO_CREDITO');
      });
      cartaoFieldsDiv.classList.toggle('visible', forma.tipo === 'CARTAO_CREDITO');
      
      const confirmBtn = document.createElement('button');
      confirmBtn.innerHTML = '<i class="fas fa-check"></i>';
      confirmBtn.title = 'Confirmar';
      confirmBtn.addEventListener('click', () => {
        const novoNome = nomeInput.value.trim();
        const novoTipo = tipoSelect.value;
        const novoVencimento = parseInt(vencimentoInput.value) || null;
        let novoFechamento = parseInt(fechamentoInput.value) || null;
        
        if (novoTipo === 'CARTAO_CREDITO' && novoVencimento && !novoFechamento) {
          novoFechamento = (novoVencimento - 7 + 31) % 31 + 1; // Estima fechamento 7 dias antes
        }
        
        if (novoNome) {
          const formaIndex = formasPagamento.findIndex(f => f.id === forma.id);
          if (formaIndex !== -1) {
            formasPagamento[formaIndex].nome = novoNome;
            formasPagamento[formaIndex].tipo = novoTipo;
            formasPagamento[formaIndex].data_vencimento = novoTipo === 'CARTAO_CREDITO' ? novoVencimento : null;
            formasPagamento[formaIndex].data_fechamento = novoTipo === 'CARTAO_CREDITO' ? novoFechamento : null;
          }
          
          if (!formasAdicionadas.some(f => f.id === forma.id)) {
            const modIndex = formasModificadas.findIndex(f => f.id === forma.id);
            if (modIndex !== -1) Object.assign(formasModificadas[modIndex], formasPagamento[formaIndex]);
            else formasModificadas.push({...formasPagamento[formaIndex]});
          } else {
            const addIndex = formasAdicionadas.findIndex(f => f.id === forma.id);
            if (addIndex !== -1) Object.assign(formasAdicionadas[addIndex], formasPagamento[formaIndex]);
          }
          span.textContent = `${novoNome} (${novoTipo === 'CARTAO_CREDITO' ? 'Cartão' : 'Conta'})${novoTipo === 'CARTAO_CREDITO' ? ` - Venc: ${novoVencimento || 'N/A'}` : ''}`;
        }
        item.classList.remove('edit-mode');
        item.replaceChild(span, nomeInput);
        item.removeChild(tipoSelect);
        item.removeChild(cartaoFieldsDiv);
        actions.innerHTML = '';
        actions.appendChild(editBtn);
        actions.appendChild(deleteBtn);
      });
      
      const cancelBtn = document.createElement('button');
      cancelBtn.innerHTML = '<i class="fas fa-times"></i>';
      cancelBtn.title = 'Cancelar';
      cancelBtn.addEventListener('click', () => {
        item.classList.remove('edit-mode');
        item.replaceChild(span, nomeInput);
        item.removeChild(tipoSelect);
        item.removeChild(cartaoFieldsDiv);
        actions.innerHTML = '';
        actions.appendChild(editBtn);
        actions.appendChild(deleteBtn);
      });
      
      item.replaceChild(nomeInput, span);
      item.appendChild(tipoSelect);
      item.appendChild(cartaoFieldsDiv);
      actions.innerHTML = '';
      actions.appendChild(confirmBtn);
      actions.appendChild(cancelBtn);
      nomeInput.focus();
    }
    
    function deleteFormaItem(item, forma) {
      formasPagamento = formasPagamento.filter(f => f.id !== forma.id);
      const addedIndex = formasAdicionadas.findIndex(f => f.id === forma.id);
      if (addedIndex !== -1) {
        formasAdicionadas.splice(addedIndex, 1);
      } else {
        formasRemovidas.push(forma.id);
        const modifiedIndex = formasModificadas.findIndex(f => f.id === forma.id);
        if (modifiedIndex !== -1) formasModificadas.splice(modifiedIndex, 1);
      }
      item.remove();
      if (formasListEl.children.length === 0) {
        formasListEl.innerHTML = '<div class="modal-list-item"><span>Nenhuma forma de pagamento encontrada.</span></div>';
      }
    }
    
    // Adicionar subcategoria temporariamente no modal
    function addSubcategoriaTemp() {
      const nome = novaSubcategoriaInput.value.trim();
      if (!nome) { alert('Informe o nome da subcategoria.'); return; }
      const categoriaId = categoriasMap[categoriaAtual];
      if (!categoriaId) { alert('Erro: Categoria não encontrada.'); return; }
      const existingSub = subcategorias.find(sub => sub.categoria_id === categoriaId && sub.nome.toLowerCase() === nome.toLowerCase());
      if (existingSub) { alert('Já existe uma subcategoria com este nome.'); return; }
      
      const tempId = 'temp_sub_' + Date.now();
      const novaSub = { id: tempId, categoria_id: categoriaId, nome: nome, cliente_id: clienteId };
      subcategorias.push(novaSub);
      subcategoriasAdicionadas.push(novaSub);
      novaSubcategoriaInput.value = '';
      renderSubcategoriasList();
      novaSubcategoriaInput.focus();
    }
    
    // Adicionar forma de pagamento temporariamente no modal
    function addFormaTemp() {
      const nome = novaFormaNomeInput.value.trim();
      const tipo = novaFormaTipoSelect.value;
      const vencimento = parseInt(novaFormaVencimentoInput.value) || null;
      let fechamento = parseInt(novaFormaFechamentoInput.value) || null;
      
      if (!nome) { alert('Informe o nome da forma de pagamento.'); return; }
      if (tipo === 'CARTAO_CREDITO' && !vencimento) { alert('Informe o dia de vencimento para cartão de crédito.'); return; }
      
      if (tipo === 'CARTAO_CREDITO' && vencimento && !fechamento) {
        fechamento = (vencimento - 7 + 31) % 31 + 1; // Estima fechamento 7 dias antes
      }
      
      const existingForma = formasPagamento.find(f => f.nome.toLowerCase() === nome.toLowerCase());
      if (existingForma) { alert('Já existe uma forma de pagamento com este nome.'); return; }
      
      const tempId = 'temp_forma_' + Date.now();
      const novaForma = {
        id: tempId,
        nome: nome,
        tipo: tipo,
        data_vencimento: tipo === 'CARTAO_CREDITO' ? vencimento : null,
        data_fechamento: tipo === 'CARTAO_CREDITO' ? fechamento : null,
        cliente_id: clienteId
      };
      
      formasPagamento.push(novaForma);
      formasAdicionadas.push(novaForma);
      
      // Limpar campos
      novaFormaNomeInput.value = '';
      novaFormaTipoSelect.value = 'CONTA';
      novaFormaVencimentoInput.value = '';
      novaFormaFechamentoInput.value = '';
      novaFormaCartaoFields.classList.remove('visible');
      
      renderFormasList();
      novaFormaNomeInput.focus();
    }
    
    // Salvar alterações de subcategorias
    async function saveSubcategoriasChanges() {
      try {
        if (subcategoriasAdicionadas.length > 0) {
          const subsToAdd = subcategoriasAdicionadas.map(sub => ({ categoria_id: sub.categoria_id, nome: sub.nome, cliente_id: clienteId }));
          const { error: addError } = await supabase.from('subcategorias_financeiras').insert(subsToAdd);
          if (addError) throw addError;
        }
        for (const sub of subcategoriasModificadas) {
          const { error: updateError } = await supabase.from('subcategorias_financeiras').update({ nome: sub.nome }).eq('id', sub.id);
          if (updateError) throw updateError;
        }
        if (subcategoriasRemovidas.length > 0) {
          const { error: deleteError } = await supabase.from('subcategorias_financeiras').delete().in('id', subcategoriasRemovidas);
          if (deleteError) throw deleteError;
        }
        await loadSubcategorias();
        subcategoriasAdicionadas = []; subcategoriasModificadas = []; subcategoriasRemovidas = [];
        subcategoriaModal.style.display = 'none';
        showSuccessAlert('Subcategorias atualizadas com sucesso!');
      } catch (error) {
        showErrorAlert(`Erro ao salvar subcategorias: ${error.message}`);
      }
    }
    
    // Salvar alterações de formas de pagamento
    async function saveFormasChanges() {
      try {
        if (formasAdicionadas.length > 0) {
          const formasToAdd = formasAdicionadas.map(f => ({ nome: f.nome, tipo: f.tipo, data_vencimento: f.data_vencimento, data_fechamento: f.data_fechamento, cliente_id: clienteId }));
          const { error: addError } = await supabase.from('formas_pagamento').insert(formasToAdd);
          if (addError) throw addError;
        }
        for (const forma of formasModificadas) {
          const { error: updateError } = await supabase.from('formas_pagamento').update({ nome: forma.nome, tipo: forma.tipo, data_vencimento: forma.data_vencimento, data_fechamento: forma.data_fechamento }).eq('id', forma.id);
          if (updateError) throw updateError;
        }
        if (formasRemovidas.length > 0) {
          const { error: deleteError } = await supabase.from('formas_pagamento').delete().in('id', formasRemovidas);
          if (deleteError) throw deleteError;
        }
        await loadFormasPagamento();
        formasAdicionadas = []; formasModificadas = []; formasRemovidas = [];
        formaModal.style.display = 'none';
        showSuccessAlert('Formas de pagamento atualizadas com sucesso!');
      } catch (error) {
        showErrorAlert(`Erro ao salvar formas de pagamento: ${error.message}`);
      }
    }
    
    // Mostrar alertas
    function showSuccessAlert(message) {
      alertSuccess.textContent = message;
      alertSuccess.style.display = 'block';
      setTimeout(() => { alertSuccess.style.display = 'none'; }, 3000);
    }
    function showErrorAlert(message) {
      alertError.textContent = message;
      alertError.style.display = 'block';
      setTimeout(() => { alertError.style.display = 'none'; }, 5000);
    }
    
    // Lidar com mudança de TIPO
    function handleTipoChange() {
      const tipo = tipoItemSelect.value;
      const isEntrada = tipo === 'ENTRADA';
      
      // Categoria
      categoriaItemSelect.disabled = isEntrada;
      if (isEntrada) {
        categoriaItemSelect.value = 'RECEITA';
      } else {
        if (categoriaItemSelect.value === 'RECEITA') categoriaItemSelect.value = '';
      }
      Array.from(categoriaItemSelect.options).forEach(opt => {
        opt.style.display = (opt.value === 'RECEITA' && !isEntrada) ? 'none' : '';
      });
      
      // Via
      viaItemSelect.disabled = isEntrada;
      if (isEntrada) {
        viaItemSelect.value = 'SEM_PREENCHIMENTO';
      } else {
        if (viaItemSelect.value === 'SEM_PREENCHIMENTO') viaItemSelect.value = ''; // Forçar seleção
      }
      Array.from(viaItemSelect.options).forEach(opt => {
        opt.style.display = (opt.value === 'SEM_PREENCHIMENTO' && !isEntrada) ? 'none' : '';
      });
      
      // Forma
      formaItemSelect.disabled = isEntrada;
      if (isEntrada) {
        formaItemSelect.value = 'SEM_PREENCHIMENTO';
      } else {
        if (formaItemSelect.value === 'SEM_PREENCHIMENTO') formaItemSelect.value = ''; // Forçar seleção
      }
      Array.from(formaItemSelect.options).forEach(opt => {
        opt.style.display = (opt.value === 'SEM_PREENCHIMENTO' && !isEntrada) ? 'none' : '';
      });
      
      updateSubcategoriasSelect();
    }
    
    // --- Inicialização --- 
    document.addEventListener('DOMContentLoaded', async () => {
      await loadClienteData();
      await loadCategorias();
      await loadSubcategorias();
      await loadFormasPagamento();
      
      // Preencher select de repetição numérica
      for (let i = 1; i <= 31; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = i;
        repeteNumeroSelect.appendChild(option);
      }
      
      // Event listeners
      categoriaItemSelect.addEventListener('change', updateSubcategoriasSelect);
      tipoItemSelect.addEventListener('change', handleTipoChange);
      
      // Abrir modal de subcategorias
      subcategoriaLabel.addEventListener('click', () => {
        let catSel;
        if (tipoItemSelect.value === 'ENTRADA') catSel = 'RECEITA';
        else catSel = categoriaItemSelect.value;
        if (!catSel) { alert('Selecione uma categoria.'); return; }
        if (!categoriasMap[catSel]) { alert('Erro: ID da categoria não encontrado.'); return; }
        categoriaAtual = catSel;
        subcategoriasAdicionadas = []; subcategoriasModificadas = []; subcategoriasRemovidas = [];
        renderSubcategoriasList();
        subcategoriaModal.style.display = 'block';
      });
      
      // Abrir modal de formas de pagamento
      formaLabel.addEventListener('click', () => {
        formasAdicionadas = []; formasModificadas = []; formasRemovidas = [];
        renderFormasList();
        formaModal.style.display = 'block';
      });
      
      // Event listeners para modal de subcategoria
      btnAddSubcategoriaModal.addEventListener('click', addSubcategoriaTemp);
      novaSubcategoriaInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); addSubcategoriaTemp(); } });
      btnSaveSubcategoria.addEventListener('click', saveSubcategoriasChanges);
      btnCancelSubcategoria.addEventListener('click', () => {
        subcategoriasAdicionadas = []; subcategoriasModificadas = []; subcategoriasRemovidas = [];
        loadSubcategorias(); // Recarrega original
        subcategoriaModal.style.display = 'none';
      });
      closeModalSubcategoriaBtn.addEventListener('click', () => btnCancelSubcategoria.click()); // Reutiliza lógica de cancelamento
      
      // Event listeners para modal de forma de pagamento
      novaFormaTipoSelect.addEventListener('change', () => {
        novaFormaCartaoFields.classList.toggle('visible', novaFormaTipoSelect.value === 'CARTAO_CREDITO');
      });
      btnAddFormaModal.addEventListener('click', addFormaTemp);
      btnSaveForma.addEventListener('click', saveFormasChanges);
      btnCancelForma.addEventListener('click', () => {
        formasAdicionadas = []; formasModificadas = []; formasRemovidas = [];
        loadFormasPagamento(); // Recarrega original
        formaModal.style.display = 'none';
      });
      closeModalFormaBtn.addEventListener('click', () => btnCancelForma.click()); // Reutiliza lógica de cancelamento
      
      // Fechar modais ao clicar fora
      window.addEventListener('click', (e) => {
        if (e.target === subcategoriaModal) closeModalSubcategoriaBtn.click();
        if (e.target === formaModal) closeModalFormaBtn.click();
      });
      
      // Event listener para o formulário de item
      itemForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Validações
        const tipo = tipoItemSelect.value;
        const categoria = categoriaItemSelect.value;
        const via = viaItemSelect.value;
        const forma = formaItemSelect.value;
        const repeteNum = repeteNumeroSelect.value;
        const repetePer = repetePeriodoSelect.value;
        
        if (tipo === 'SAIDA') {
          if (via === 'SEM_PREENCHIMENTO') { showErrorAlert('Selecione a VIA para SAÍDA.'); return; }
          if (forma === 'SEM_PREENCHIMENTO') { showErrorAlert('Selecione a FORMA para SAÍDA.'); return; }
        }
        if (repetePer !== 'NAO_REPETE' && !repeteNum) { showErrorAlert('Selecione o número para a repetição.'); return; }
        
        // Obter dados do formulário
        const itemData = {
          cliente_id: clienteId,
          tipo: tipo,
          categoria_id: categoriasMap[categoria],
          descricao: descricaoItemInput.value,
          subcategoria_id: subcategoriaItemSelect.value || null,
          via: tipo === 'SAIDA' ? via : null,
          forma_pagamento_id: tipo === 'SAIDA' ? (forma || null) : null,
          repete_numero: repetePer !== 'NAO_REPETE' ? parseInt(repeteNum) : null,
          repete_periodo: repetePer,
          data_inicial: dataInicialInput.value || `${new Date().getFullYear()}-01-01`, // Default para 01/01 do ano vigente
          data_final: dataFinalInput.value || null
        };
        
        try {
          const { error } = await supabase.from('itens_financeiros').insert([itemData]);
          if (error) throw error;
          
          showSuccessAlert('Item adicionado com sucesso!');
          itemForm.reset(); // Limpar formulário
          handleTipoChange(); // Resetar regras dinâmicas
          // TODO: Recarregar e exibir a tabela de itens
          
        } catch (error) {
          showErrorAlert(`Erro ao adicionar item: ${error.message}`);
        }
      });
      
      // Inicializar estado dos campos dinâmicos
      handleTipoChange();
    });
  </script>
  
    <script type="module" src="js/gestao-financeira-filtro.js"></script>
  
</body>
</html>
