<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gestão Financeira - Cliente</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="gestao-financeira-moderno.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
  <!-- Sidebar será injetada aqui pelo sidebar.js -->
  <main id="main-content-gestao-financeira">
    <h1 id="cliente-nome">Gestão Financeira - Cliente</h1>
    
    <div class="gestao-container">
      <div id="alert-success" class="alert alert-success">
        Item adicionado com sucesso!
      </div>
      
      <div id="alert-error" class="alert alert-error">
        Erro ao adicionar item. Tente novamente.
      </div>
      
      <form id="item-form">
        <!-- Primeira Linha do Grid -->
        <div class="form-grid">
          <div class="form-group col-2">
            <label for="tipo-item">Tipo:</label>
            <select id="tipo-item" required>
              <option value="" disabled selected>Selecione o tipo</option>
              <option value="ENTRADA">ENTRADA</option>
              <option value="SAIDA">SAÍDA</option>
            </select>
          </div>
          
          <div class="form-group col-3">
            <label for="categoria-item">Categoria:</label>
            <select id="categoria-item" required>
              <option value="" disabled selected>Selecione a categoria</option>
              <option value="RECEITA">Receita</option>
              <option value="DESPESA_FIXA">Despesa Fixa</option>
              <option value="DESPESA_VARIAVEL">Despesa Variável</option>
              <option value="INVESTIMENTO">Investimento</option>
            </select>
          </div>
          
          <div class="form-group col-4">
            <label for="descricao-item">Descrição:</label>
            <input type="text" id="descricao-item" placeholder="Descrição do item" required>
          </div>
          
          <div class="form-group col-3">
            <label for="subcategoria-item" class="subcategoria-label">Subcategoria (opcional):</label>
            <select id="subcategoria-item">
              <option value="" selected>Sem subcategoria</option>
              <!-- Opções serão carregadas dinamicamente -->
            </select>
          </div>
        </div>
        
        <!-- Segunda Linha do Grid -->
        <div class="form-grid">
          <div class="form-group col-2">
            <label for="via-item">Via:</label>
            <select id="via-item">
              <option value="SEM_PREENCHIMENTO" selected>[sem preenchimento]</option>
              <option value="DEBITO">DÉBITO</option>
              <option value="CREDITO">CRÉDITO</option>
            </select>
          </div>
          
          <div class="form-group col-3">
            <label for="forma-item" class="forma-label">Forma:</label>
            <select id="forma-item">
              <option value="SEM_PREENCHIMENTO" selected>[sem preenchimento]</option>
              <!-- Opções serão carregadas dinamicamente -->
            </select>
          </div>
          
          <div class="form-group col-3">
            <div class="repete-group">
              <div>
                <label for="repete-numero">Se repete a cada:</label>
                <select id="repete-numero" required>
                  <!-- Números de 1 a 31 -->
                </select>
              </div>
              <div>
                <label for="repete-periodo">&nbsp;</label> <!-- Label vazio para alinhamento -->
                <select id="repete-periodo" required>
                  <option value="NAO_REPETE">Não Repete</option>
                  <option value="DIAS">Dia(s)</option>
                  <option value="DIAS_UTEIS">Dia(s) Útil(eis)</option>
                  <option value="SEMANAS">Semana(s)</option>
                  <option value="QUINZENAS">Quinzena(s)</option>
                  <option value="MESES">Mês(es)</option>
                  <option value="TRIMESTRES">Trimestre(s)</option>
                  <option value="QUADRIMESTRES">Quadrimestre(s)</option>
                  <option value="SEMESTRES">Semestre(s)</option>
                  <option value="ANOS">Anual(is)</option>
                </select>
              </div>
            </div>
          </div>
          
          <div class="form-group col-2">
            <label for="data-inicial">Data Inicial:</label>
            <input type="date" id="data-inicial">
          </div>
          
          <div class="form-group col-2">
            <label for="data-final">Data Final:</label>
            <input type="date" id="data-final">
          </div>
        </div>
        
        <div class="btn-container">
          <button type="submit" class="btn btn-primary">Adicionar Item</button>
        </div>
      </form>
      
      <div class="table-container">
        <table class="financeiro-table">
          <thead>
            <tr>
              <th>Tipo</th>
              <th>Categoria</th>
              <th>Descrição</th>
              <th>Subcategoria</th>
              <th>Via</th>
              <th>Forma</th>
              <th>Repetição</th>
              <th>Data Inicial</th>
              <th>Data Final</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="itens-table-body">
            <!-- Itens serão carregados dinamicamente -->
            <tr>
              <td colspan="10" class="text-center">Nenhum item financeiro cadastrado.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Modal para gerenciar subcategorias -->
    <div id="subcategoria-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Gerenciar Subcategorias</h3>
          <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="add-item-form">
            <input type="text" id="nova-subcategoria" placeholder="Nome da nova subcategoria">
            <button type="button" id="btn-add-subcategoria-modal">Adicionar</button>
          </div>
          
          <div class="modal-list" id="subcategorias-list">
            <!-- Lista de subcategorias será carregada dinamicamente -->
            <div class="modal-list-item">
              <span>Carregando subcategorias...</span>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="btn-cancel-subcategoria">Cancelar</button>
          <button class="btn btn-primary" id="btn-save-subcategoria">Salvar Alterações</button>
        </div>
      </div>
    </div>
    
    <!-- Modal para gerenciar formas de pagamento -->
    <div id="forma-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Gerenciar Formas de Pagamento</h3>
          <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="add-item-form">
            <input type="text" id="nova-forma-nome" placeholder="Nome (Ex: Conta BB, Cartão Nubank)">
            <select id="nova-forma-tipo">
              <option value="CONTA">Conta</option>
              <option value="CARTAO_CREDITO">Cartão de Crédito</option>
            </select>
            <div class="cartao-fields" id="nova-forma-cartao-fields">
              <input type="number" id="nova-forma-vencimento" placeholder="Dia Venc." min="1" max="31">
              <input type="number" id="nova-forma-fechamento" placeholder="Dia Fech." min="1" max="31">
            </div>
            <button type="button" id="btn-add-forma-modal">Adicionar</button>
          </div>
          
          <div class="modal-list" id="formas-list">
            <!-- Lista de formas será carregada dinamicamente -->
            <div class="modal-list-item">
              <span>Carregando formas de pagamento...</span>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="btn-cancel-forma">Cancelar</button>
          <button class="btn btn-primary" id="btn-save-forma">Salvar Alterações</button>
        </div>
      </div>
    </div>
  </main>

  <script type="module">
    import { supabase } from './supabase.js';
    
    // Variáveis globais
    let clienteId;
    let clienteData;
    let categorias = [];
    let categoriasMap = {};
    let subcategorias = [];
    let formasPagamento = [];
    let categoriaAtual = '';
    
    // Arrays para controle de alterações
    let subcategoriasAdicionadas = [];
    let subcategoriasModificadas = [];
    let subcategoriasRemovidas = [];
    let formasAdicionadas = [];
    let formasModificadas = [];
    let formasRemovidas = [];
    
    // Elementos DOM
    const clienteNomeEl = document.getElementById('cliente-nome');
    const tipoItemSelect = document.getElementById('tipo-item');
    const categoriaItemSelect = document.getElementById('categoria-item');
    const descricaoItemInput = document.getElementById('descricao-item');
    const subcategoriaItemSelect = document.getElementById('subcategoria-item');
    const viaItemSelect = document.getElementById('via-item');
    const formaItemSelect = document.getElementById('forma-item');
    const repeteNumeroSelect = document.getElementById('repete-numero');
    const repetePeriodoSelect = document.getElementById('repete-periodo');
    const dataInicialInput = document.getElementById('data-inicial');
    const dataFinalInput = document.getElementById('data-final');
    const itemForm = document.getElementById('item-form');
    const itensTableBody = document.getElementById('itens-table-body');
    const alertSuccess = document.getElementById('alert-success');
    const alertError = document.getElementById('alert-error');
    
    // Elementos para subcategorias
    const subcategoriaLabel = document.querySelector('.subcategoria-label');
    const subcategoriaModal = document.getElementById('subcategoria-modal');
    const subcategoriasListEl = document.getElementById('subcategorias-list');
    const novaSubcategoriaInput = document.getElementById('nova-subcategoria');
    const btnAddSubcategoriaModal = document.getElementById('btn-add-subcategoria-modal');
    const btnSaveSubcategoria = document.getElementById('btn-save-subcategoria');
    const btnCancelSubcategoria = document.getElementById('btn-cancel-subcategoria');
    const closeModalSubcategoriaBtn = subcategoriaModal.querySelector('.close-modal');
    
    // Elementos para formas de pagamento
    const formaLabel = document.querySelector('.forma-label');
    const formaModal = document.getElementById('forma-modal');
    const formasListEl = document.getElementById('formas-list');
    const novaFormaNomeInput = document.getElementById('nova-forma-nome');
    const novaFormaTipoSelect = document.getElementById('nova-forma-tipo');
    const novaFormaVencimentoInput = document.getElementById('nova-forma-vencimento');
    const novaFormaFechamentoInput = document.getElementById('nova-forma-fechamento');
    const novaFormaCartaoFields = document.getElementById('nova-forma-cartao-fields');
    const btnAddFormaModal = document.getElementById('btn-add-forma-modal');
    const btnSaveForma = document.getElementById('btn-save-forma');
    const btnCancelForma = document.getElementById('btn-cancel-forma');
    const closeModalFormaBtn = formaModal.querySelector('.close-modal');
    
    // Carregar dados do cliente
    async function loadClienteData() {
      try {
        // Obter ID do cliente da URL
        const urlParams = new URLSearchParams(window.location.search);
        clienteId = urlParams.get('id');
        
        if (!clienteId) {
          alert('ID do cliente não especificado na URL');
          window.location.href = 'clientes-dashboard.html';
          return;
        }
        
        const { data, error } = await supabase
          .from('clientes')
          .select(`
            *,
            dados_cadastrais(*)
          `)
          .eq('id', clienteId)
          .single();
        
        if (error) throw error;
        
        clienteData = data;
        clienteNomeEl.textContent = `Gestão Financeira - ${clienteData.nome}`;
        
      } catch (error) {
        console.error('Erro ao carregar dados do cliente:', error);
        alert('Erro ao carregar dados do cliente. Tente novamente mais tarde.');
      }
    }
    
    // Carregar categorias
    async function loadCategorias() {
      try {
        const { data, error } = await supabase
          .from('categorias_financeiras')
          .select('*');
        
        if (error) throw error;
        
        categorias = data || [];
        
        // Criar mapeamento de nome para ID
        categorias.forEach(cat => {
          categoriasMap[cat.nome] = cat.id;
        });
        
      } catch (error) {
        console.error('Erro ao carregar categorias:', error);
      }
    }
    
    // Carregar subcategorias
    async function loadSubcategorias() {
      try {
        const { data, error } = await supabase
          .from('subcategorias_financeiras')
          .select('*')
          .or(`cliente_id.is.null,cliente_id.eq.${clienteId}`);
        
        if (error) throw error;
        
        subcategorias = data || [];
        updateSubcategoriasSelect();
        
      } catch (error) {
        console.error('Erro ao carregar subcategorias:', error);
      }
    }
    
    // Atualizar select de subcategorias com base na categoria selecionada
    function updateSubcategoriasSelect() {
      // Limpar opções atuais, exceto a primeira
      while (subcategoriaItemSelect.options.length > 1) {
        subcategoriaItemSelect.remove(1);
      }
      
      // Obter categoria selecionada
      let categoriaSelecionada;
      if (tipoItemSelect.value === 'ENTRADA') {
        categoriaSelecionada = 'RECEITA';
      } else {
        categoriaSelecionada = categoriaItemSelect.value;
      }
      
      if (!categoriaSelecionada) return;
      
      // Filtrar subcategorias pela categoria
      const categoriaId = categoriasMap[categoriaSelecionada];
      if (!categoriaId) return;
      
      const subcategoriasFiltradas = subcategorias.filter(sub => sub.categoria_id === categoriaId);
      
      // Adicionar opções filtradas
      subcategoriasFiltradas.forEach(sub => {
        const option = document.createElement('option');
        option.value = sub.id;
        option.textContent = sub.nome;
        subcategoriaItemSelect.appendChild(option);
      });
    }
    
    // Carregar formas de pagamento
    async function loadFormasPagamento() {
      try {
        const { data, error } = await supabase
          .from('formas_pagamento')
          .select('*')
          .eq('cliente_id', clienteId);
        
        if (error) throw error;
        
        formasPagamento = data || [];
        
        // Limpar opções atuais, exceto a primeira
        while (formaItemSelect.options.length > 1) {
          formaItemSelect.remove(1);
        }
        
        // Adicionar opções
        formasPagamento.forEach(forma => {
          const option = document.createElement('option');
          option.value = forma.id;
          
          if (forma.tipo === 'CARTAO_CREDITO') {
            option.textContent = `${forma.nome} (Cartão - Venc: ${forma.data_vencimento || 'N/A'})`;
          } else {
            option.textContent = `${forma.nome} (Conta)`;
          }
          
          formaItemSelect.appendChild(option);
        });
        
      } catch (error) {
        console.error('Erro ao carregar formas de pagamento:', error);
      }
    }
    
    // Renderizar lista de subcategorias no modal
    function renderSubcategoriasList() {
      // Filtrar subcategorias pela categoria atual
      const categoriaId = categoriasMap[categoriaAtual];
      if (!categoriaId) {
        subcategoriasListEl.innerHTML = '<div class="modal-list-item"><span>Erro: Categoria não encontrada.</span></div>';
        return;
      }
      
      const subcategoriasFiltradas = subcategorias.filter(sub => sub.categoria_id === categoriaId);
      
      if (subcategoriasFiltradas.length === 0) {
        subcategoriasListEl.innerHTML = '<div class="modal-list-item"><span>Nenhuma subcategoria encontrada.</span></div>';
        return;
      }
      
      subcategoriasListEl.innerHTML = '';
      
      subcategoriasFiltradas.forEach(sub => {
        const item = document.createElement('div');
        item.className = 'modal-list-item';
        
        const span = document.createElement('span');
        span.textContent = sub.nome;
        
        const actions = document.createElement('div');
        actions.className = 'modal-list-item-actions';
        
        const editBtn = document.createElement('button');
        editBtn.innerHTML = '<i class="fas fa-edit"></i>';
        editBtn.title = 'Editar';
        editBtn.addEventListener('click', () => editSubcategoriaItem(item, span, sub));
        
        const deleteBtn = document.createElement('button');
        deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
        deleteBtn.title = 'Excluir';
        deleteBtn.addEventListener('click', () => {
          if (confirm(`Deseja realmente excluir a subcategoria "${sub.nome}"?`)) {
            deleteSubcategoriaItem(item, sub);
          }
        });
        
        // Adicionar botões apenas se for uma subcategoria do cliente
        if (sub.cliente_id === clienteId) {
          actions.appendChild(editBtn);
          actions.appendChild(deleteBtn);
        } else {
          const infoSpan = document.createElement('span');
          infoSpan.textContent = ' (global)';
          infoSpan.style.fontSize = '0.8em';
          infoSpan.style.opacity = '0.7';
          span.appendChild(infoSpan);
        }
        
        item.appendChild(span);
        item.appendChild(actions);
        subcategoriasListEl.appendChild(item);
      });
    }
    
    // Renderizar lista de formas de pagamento no modal
    function renderFormasList() {
      if (formasPagamento.length === 0) {
        formasListEl.innerHTML = '<div class="modal-list-item"><span>Nenhuma forma de pagamento encontrada.</span></div>';
        return;
      }
      
      formasListEl.innerHTML = '';
      
      formasPagamento.forEach(forma => {
        const item = document.createElement('div');
        item.className = 'modal-list-item';
        
        const span = document.createElement('span');
        if (forma.tipo === 'CARTAO_CREDITO') {
          span.textContent = `${forma.nome} (Cartão - Venc: ${forma.data_vencimento || 'N/A'})`;
        } else {
          span.textContent = `${forma.nome} (Conta)`;
        }
        
        const actions = document.createElement('div');
        actions.className = 'modal-list-item-actions';
        
        const editBtn = document.createElement('button');
        editBtn.innerHTML = '<i class="fas fa-edit"></i>';
        editBtn.title = 'Editar';
        editBtn.addEventListener('click', () => editFormaItem(item, span, forma));
        
        const deleteBtn = document.createElement('button');
        deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
        deleteBtn.title = 'Excluir';
        deleteBtn.addEventListener('click', () => {
          if (confirm(`Deseja realmente excluir a forma de pagamento "${forma.nome}"?`)) {
            deleteFormaItem(item, forma);
          }
        });
        
        actions.appendChild(editBtn);
        actions.appendChild(deleteBtn);
        
        item.appendChild(span);
        item.appendChild(actions);
        formasListEl.appendChild(item);
      });
    }
    
    // Editar subcategoria no modal
    function editSubcategoriaItem(item, span, subcategoria) {
      item.classList.add('edit-mode');
      
      const nomeInput = document.createElement('input');
      nomeInput.type = 'text';
      nomeInput.className = 'edit-input';
      nomeInput.value = subcategoria.nome;
      
      const actions = item.querySelector('.modal-list-item-actions');
      actions.innerHTML = '';
      
      const confirmBtn = document.createElement('button');
      confirmBtn.innerHTML = '<i class="fas fa-check"></i>';
      confirmBtn.title = 'Confirmar';
      confirmBtn.addEventListener('click', () => {
        const novoNome = nomeInput.value.trim();
        if (!novoNome) return;
        
        // Verificar se já existe outra subcategoria com este nome
        const existingSub = subcategorias.find(sub => 
          sub.id !== subcategoria.id && 
          sub.categoria_id === subcategoria.categoria_id && 
          sub.nome.toLowerCase() === novoNome.toLowerCase()
        );
        
        if (existingSub) {
          alert('Já existe uma subcategoria com este nome.');
          return;
        }
        
        subcategoria.nome = novoNome;
        
        // Adicionar à lista de modificadas se não for nova
        if (!subcategoriasAdicionadas.some(s => s.id === subcategoria.id)) {
          const existingModIndex = subcategoriasModificadas.findIndex(s => s.id === subcategoria.id);
          if (existingModIndex === -1) {
            subcategoriasModificadas.push(subcategoria);
          } else {
            subcategoriasModificadas[existingModIndex] = subcategoria;
          }
        }
        
        span.textContent = novoNome;
        item.classList.remove('edit-mode');
        item.replaceChild(span, nomeInput);
        actions.innerHTML = '';
        actions.appendChild(editBtn);
        actions.appendChild(deleteBtn);
      });
      
      const cancelBtn = document.createElement('button');
      cancelBtn.innerHTML = '<i class="fas fa-times"></i>';
      cancelBtn.title = 'Cancelar';
      cancelBtn.addEventListener('click', () => {
        item.classList.remove('edit-mode');
        item.replaceChild(span, nomeInput);
        actions.innerHTML = '';
        actions.appendChild(editBtn);
        actions.appendChild(deleteBtn);
      });
      
      const editBtn = document.createElement('button');
      editBtn.innerHTML = '<i class="fas fa-edit"></i>';
      editBtn.title = 'Editar';
      
      const deleteBtn = document.createElement('button');
      deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
      deleteBtn.title = 'Excluir';
      
      actions.appendChild(confirmBtn);
      actions.appendChild(cancelBtn);
      item.replaceChild(nomeInput, span);
      nomeInput.focus();
    }
    
    // Excluir subcategoria
    function deleteSubcategoriaItem(item, subcategoria) {
      subcategorias = subcategorias.filter(s => s.id !== subcategoria.id);
      
      const addedIndex = subcategoriasAdicionadas.findIndex(s => s.id === subcategoria.id);
      if (addedIndex !== -1) {
        subcategoriasAdicionadas.splice(addedIndex, 1);
      } else {
        subcategoriasRemovidas.push(subcategoria.id);
        const modifiedIndex = subcategoriasModificadas.findIndex(s => s.id === subcategoria.id);
        if (modifiedIndex !== -1) subcategoriasModificadas.splice(modifiedIndex, 1);
      }
      
      item.remove();
      
      if (subcategoriasListEl.children.length === 0) {
        subcategoriasListEl.innerHTML = '<div class="modal-list-item"><span>Nenhuma subcategoria encontrada.</span></div>';
      }
    }
    
    // Editar forma de pagamento no modal
    function editFormaItem(item, span, forma) {
      item.classList.add('edit-mode');
      
      const nomeInput = document.createElement('input');
      nomeInput.type = 'text';
      nomeInput.className = 'edit-input';
      nomeInput.value = forma.nome;
      
      const tipoSelect = document.createElement('select');
      tipoSelect.className = 'edit-input';
      
      const optConta = document.createElement('option');
      optConta.value = 'CONTA';
      optConta.textContent = 'Conta';
      
      const optCartao = document.createElement('option');
      optCartao.value = 'CARTAO_CREDITO';
      optCartao.textContent = 'Cartão de Crédito';
      
      tipoSelect.appendChild(optConta);
      tipoSelect.appendChild(optCartao);
      tipoSelect.value = forma.tipo;
      
      const cartaoFieldsDiv = document.createElement('div');
      cartaoFieldsDiv.className = 'cartao-fields';
      cartaoFieldsDiv.style.display = forma.tipo === 'CARTAO_CREDITO' ? 'flex' : 'none';
      
      const vencimentoInput = document.createElement('input');
      vencimentoInput.type = 'number';
      vencimentoInput.min = '1';
      vencimentoInput.max = '31';
      vencimentoInput.placeholder = 'Dia Venc.';
      vencimentoInput.value = forma.data_vencimento || '';
      
      const fechamentoInput = document.createElement('input');
      fechamentoInput.type = 'number';
      fechamentoInput.min = '1';
      fechamentoInput.max = '31';
      fechamentoInput.placeholder = 'Dia Fech.';
      fechamentoInput.value = forma.data_fechamento || '';
      
      cartaoFieldsDiv.appendChild(vencimentoInput);
      cartaoFieldsDiv.appendChild(fechamentoInput);
      
      tipoSelect.addEventListener('change', () => {
        cartaoFieldsDiv.style.display = tipoSelect.value === 'CARTAO_CREDITO' ? 'flex' : 'none';
      });
      
      const actions = item.querySelector('.modal-list-item-actions');
      actions.innerHTML = '';
      
      const confirmBtn = document.createElement('button');
      confirmBtn.innerHTML = '<i class="fas fa-check"></i>';
      confirmBtn.title = 'Confirmar';
      confirmBtn.addEventListener('click', () => {
        const novoNome = nomeInput.value.trim();
        const novoTipo = tipoSelect.value;
        const novoVencimento = novoTipo === 'CARTAO_CREDITO' ? parseInt(vencimentoInput.value) || null : null;
        const novoFechamento = novoTipo === 'CARTAO_CREDITO' ? parseInt(fechamentoInput.value) || null : null;
        
        if (!novoNome) return;
        
        // Verificar se já existe outra forma com este nome
        const existingForma = formasPagamento.find(f => 
          f.id !== forma.id && 
          f.nome.toLowerCase() === novoNome.toLowerCase()
        );
        
        if (existingForma) {
          alert('Já existe uma forma de pagamento com este nome.');
          return;
        }
        
        if (novoTipo === 'CARTAO_CREDITO' && !novoVencimento) {
          alert('Informe o dia de vencimento para cartão de crédito.');
          return;
        }
        
        forma.nome = novoNome;
        forma.tipo = novoTipo;
        forma.data_vencimento = novoVencimento;
        forma.data_fechamento = novoFechamento;
        
        // Adicionar à lista de modificadas se não for nova
        if (!formasAdicionadas.some(f => f.id === forma.id)) {
          const existingModIndex = formasModificadas.findIndex(f => f.id === forma.id);
          if (existingModIndex === -1) {
            formasModificadas.push(forma);
          } else {
            formasModificadas[existingModIndex] = forma;
          }
        }
        
        span.textContent = `${novoNome} (${novoTipo === 'CARTAO_CREDITO' ? 'Cartão' : 'Conta'})${novoTipo === 'CARTAO_CREDITO' ? ` - Venc: ${novoVencimento || 'N/A'}` : ''}`;
        item.classList.remove('edit-mode');
        item.replaceChild(span, nomeInput);
        item.removeChild(tipoSelect);
        item.removeChild(cartaoFieldsDiv);
        actions.innerHTML = '';
        actions.appendChild(editBtn);
        actions.appendChild(deleteBtn);
      });
      
      const cancelBtn = document.createElement('button');
      cancelBtn.innerHTML = '<i class="fas fa-times"></i>';
      cancelBtn.title = 'Cancelar';
      cancelBtn.addEventListener('click', () => {
        item.classList.remove('edit-mode');
        item.replaceChild(span, nomeInput);
        item.removeChild(tipoSelect);
        item.removeChild(cartaoFieldsDiv);
        actions.innerHTML = '';
        actions.appendChild(editBtn);
        actions.appendChild(deleteBtn);
      });
      
      const editBtn = document.createElement('button');
      editBtn.innerHTML = '<i class="fas fa-edit"></i>';
      editBtn.title = 'Editar';
      
      const deleteBtn = document.createElement('button');
      deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
      deleteBtn.title = 'Excluir';
      
      actions.appendChild(confirmBtn);
      actions.appendChild(cancelBtn);
      item.replaceChild(nomeInput, span);
      item.appendChild(tipoSelect);
      item.appendChild(cartaoFieldsDiv);
      nomeInput.focus();
    }
    
    // Excluir forma de pagamento
    function deleteFormaItem(item, forma) {
      formasPagamento = formasPagamento.filter(f => f.id !== forma.id);
      
      const addedIndex = formasAdicionadas.findIndex(f => f.id === forma.id);
      if (addedIndex !== -1) {
        formasAdicionadas.splice(addedIndex, 1);
      } else {
        formasRemovidas.push(forma.id);
        const modifiedIndex = formasModificadas.findIndex(f => f.id === forma.id);
        if (modifiedIndex !== -1) formasModificadas.splice(modifiedIndex, 1);
      }
      
      item.remove();
      
      if (formasListEl.children.length === 0) {
        formasListEl.innerHTML = '<div class="modal-list-item"><span>Nenhuma forma de pagamento encontrada.</span></div>';
      }
    }
    
    // Adicionar subcategoria temporariamente no modal
    function addSubcategoriaTemp() {
      const nome = novaSubcategoriaInput.value.trim();
      if (!nome) { alert('Informe o nome da subcategoria.'); return; }
      
      const categoriaId = categoriasMap[categoriaAtual];
      if (!categoriaId) { alert('Erro: Categoria não encontrada.'); return; }
      
      const existingSub = subcategorias.find(sub => 
        sub.categoria_id === categoriaId && 
        sub.nome.toLowerCase() === nome.toLowerCase()
      );
      
      if (existingSub) { alert('Já existe uma subcategoria com este nome.'); return; }
      
      const tempId = 'temp_sub_' + Date.now();
      const novaSub = { id: tempId, categoria_id: categoriaId, nome: nome, cliente_id: clienteId };
      
      subcategorias.push(novaSub);
      subcategoriasAdicionadas.push(novaSub);
      
      novaSubcategoriaInput.value = '';
      renderSubcategoriasList();
      novaSubcategoriaInput.focus();
    }
    
    // Adicionar forma de pagamento temporariamente no modal
    function addFormaTemp() {
      const nome = novaFormaNomeInput.value.trim();
      const tipo = novaFormaTipoSelect.value;
      const vencimento = parseInt(novaFormaVencimentoInput.value) || null;
      let fechamento = parseInt(novaFormaFechamentoInput.value) || null;
      
      if (!nome) { alert('Informe o nome da forma de pagamento.'); return; }
      
      if (tipo === 'CARTAO_CREDITO' && !vencimento) { 
        alert('Informe o dia de vencimento para cartão de crédito.'); 
        return; 
      }
      
      if (tipo === 'CARTAO_CREDITO' && vencimento && !fechamento) {
        fechamento = (vencimento - 7 + 31) % 31 + 1; // Estima fechamento 7 dias antes
      }
      
      const existingForma = formasPagamento.find(f => f.nome.toLowerCase() === nome.toLowerCase());
      if (existingForma) { alert('Já existe uma forma de pagamento com este nome.'); return; }
      
      const tempId = 'temp_forma_' + Date.now();
      const novaForma = {
        id: tempId,
        nome: nome,
        tipo: tipo,
        data_vencimento: tipo === 'CARTAO_CREDITO' ? vencimento : null,
        data_fechamento: tipo === 'CARTAO_CREDITO' ? fechamento : null,
        cliente_id: clienteId
      };
      
      formasPagamento.push(novaForma);
      formasAdicionadas.push(novaForma);
      
      // Limpar campos
      novaFormaNomeInput.value = '';
      novaFormaTipoSelect.value = 'CONTA';
      novaFormaVencimentoInput.value = '';
      novaFormaFechamentoInput.value = '';
      novaFormaCartaoFields.classList.remove('visible');
      
      renderFormasList();
      novaFormaNomeInput.focus();
    }
    
    // Salvar alterações de subcategorias
    async function saveSubcategoriasChanges() {
      try {
        if (subcategoriasAdicionadas.length > 0) {
          const subsToAdd = subcategoriasAdicionadas.map(sub => ({ 
            categoria_id: sub.categoria_id, 
            nome: sub.nome, 
            cliente_id: clienteId 
          }));
          
          const { error: addError } = await supabase
            .from('subcategorias_financeiras')
            .insert(subsToAdd);
          
          if (addError) throw addError;
        }
        
        for (const sub of subcategoriasModificadas) {
          const { error: updateError } = await supabase
            .from('subcategorias_financeiras')
            .update({ nome: sub.nome })
            .eq('id', sub.id);
          
          if (updateError) throw updateError;
        }
        
        if (subcategoriasRemovidas.length > 0) {
          const { error: deleteError } = await supabase
            .from('subcategorias_financeiras')
            .delete()
            .in('id', subcategoriasRemovidas);
          
          if (deleteError) throw deleteError;
        }
        
        await loadSubcategorias();
        subcategoriasAdicionadas = [];
        subcategoriasModificadas = [];
        subcategoriasRemovidas = [];
        
        subcategoriaModal.style.display = 'none';
        showSuccessAlert('Subcategorias atualizadas com sucesso!');
        
      } catch (error) {
        showErrorAlert(`Erro ao salvar subcategorias: ${error.message}`);
      }
    }
    
    // Salvar alterações de formas de pagamento
    async function saveFormasChanges() {
      try {
        if (formasAdicionadas.length > 0) {
          const formasToAdd = formasAdicionadas.map(f => ({ 
            nome: f.nome, 
            tipo: f.tipo, 
            data_vencimento: f.data_vencimento, 
            data_fechamento: f.data_fechamento, 
            cliente_id: clienteId 
          }));
          
          const { error: addError } = await supabase
            .from('formas_pagamento')
            .insert(formasToAdd);
          
          if (addError) throw addError;
        }
        
        for (const forma of formasModificadas) {
          const { error: updateError } = await supabase
            .from('formas_pagamento')
            .update({ 
              nome: forma.nome, 
              tipo: forma.tipo, 
              data_vencimento: forma.data_vencimento, 
              data_fechamento: forma.data_fechamento 
            })
            .eq('id', forma.id);
          
          if (updateError) throw updateError;
        }
        
        if (formasRemovidas.length > 0) {
          const { error: deleteError } = await supabase
            .from('formas_pagamento')
            .delete()
            .in('id', formasRemovidas);
          
          if (deleteError) throw deleteError;
        }
        
        await loadFormasPagamento();
        formasAdicionadas = [];
        formasModificadas = [];
        formasRemovidas = [];
        
        formaModal.style.display = 'none';
        showSuccessAlert('Formas de pagamento atualizadas com sucesso!');
        
      } catch (error) {
        showErrorAlert(`Erro ao salvar formas de pagamento: ${error.message}`);
      }
    }
    
    // Mostrar alertas
    function showSuccessAlert(message) {
      alertSuccess.textContent = message;
      alertSuccess.style.display = 'block';
      setTimeout(() => { alertSuccess.style.display = 'none'; }, 3000);
    }
    
    function showErrorAlert(message) {
      alertError.textContent = message;
      alertError.style.display = 'block';
      setTimeout(() => { alertError.style.display = 'none'; }, 5000);
    }
    
    // Lidar com mudança de TIPO
    function handleTipoChange() {
      const tipo = tipoItemSelect.value;
      const isEntrada = tipo === 'ENTRADA';
      
      // Categoria
      categoriaItemSelect.disabled = isEntrada;
      if (isEntrada) {
        categoriaItemSelect.value = 'RECEITA';
      } else {
        if (categoriaItemSelect.value === 'RECEITA') categoriaItemSelect.value = '';
      }
      
      Array.from(categoriaItemSelect.options).forEach(opt => {
        opt.style.display = (opt.value === 'RECEITA' && !isEntrada) ? 'none' : '';
      });
      
      // Via
      viaItemSelect.disabled = isEntrada;
      if (isEntrada) {
        viaItemSelect.value = 'SEM_PREENCHIMENTO';
      } else {
        if (viaItemSelect.value === 'SEM_PREENCHIMENTO') viaItemSelect.value = ''; // Forçar seleção
      }
      
      Array.from(viaItemSelect.options).forEach(opt => {
        opt.style.display = (opt.value === 'SEM_PREENCHIMENTO' && !isEntrada) ? 'none' : '';
      });
      
      // Forma
      formaItemSelect.disabled = isEntrada;
      if (isEntrada) {
        formaItemSelect.value = 'SEM_PREENCHIMENTO';
      } else {
        if (formaItemSelect.value === 'SEM_PREENCHIMENTO') formaItemSelect.value = ''; // Forçar seleção
      }
      
      Array.from(formaItemSelect.options).forEach(opt => {
        opt.style.display = (opt.value === 'SEM_PREENCHIMENTO' && !isEntrada) ? 'none' : '';
      });
      
      updateSubcategoriasSelect();
    }
    
    // --- Inicialização --- 
    document.addEventListener('DOMContentLoaded', async () => {
      await loadClienteData();
      await loadCategorias();
      await loadSubcategorias();
      await loadFormasPagamento();
      
      // Preencher select de repetição numérica
      for (let i = 1; i <= 31; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = i;
        repeteNumeroSelect.appendChild(option);
      }
      
      // Event listeners
      categoriaItemSelect.addEventListener('change', updateSubcategoriasSelect);
      tipoItemSelect.addEventListener('change', handleTipoChange);
      
      // Abrir modal de subcategorias
      subcategoriaLabel.addEventListener('click', () => {
        let catSel;
        if (tipoItemSelect.value === 'ENTRADA') catSel = 'RECEITA';
        else catSel = categoriaItemSelect.value;
        
        if (!catSel) { alert('Selecione uma categoria.'); return; }
        if (!categoriasMap[catSel]) { alert('Erro: ID da categoria não encontrado.'); return; }
        
        categoriaAtual = catSel;
        subcategoriasAdicionadas = [];
        subcategoriasModificadas = [];
        subcategoriasRemovidas = [];
        
        renderSubcategoriasList();
        subcategoriaModal.style.display = 'block';
      });
      
      // Abrir modal de formas de pagamento
      formaLabel.addEventListener('click', () => {
        formasAdicionadas = [];
        formasModificadas = [];
        formasRemovidas = [];
        
        renderFormasList();
        formaModal.style.display = 'block';
      });
      
      // Event listeners para modal de subcategoria
      btnAddSubcategoriaModal.addEventListener('click', addSubcategoriaTemp);
      novaSubcategoriaInput.addEventListener('keypress', (e) => { 
        if (e.key === 'Enter') { 
          e.preventDefault(); 
          addSubcategoriaTemp(); 
        } 
      });
      
      btnSaveSubcategoria.addEventListener('click', saveSubcategoriasChanges);
      btnCancelSubcategoria.addEventListener('click', () => {
        subcategoriasAdicionadas = [];
        subcategoriasModificadas = [];
        subcategoriasRemovidas = [];
        loadSubcategorias(); // Recarrega original
        subcategoriaModal.style.display = 'none';
      });
      
      closeModalSubcategoriaBtn.addEventListener('click', () => btnCancelSubcategoria.click()); // Reutiliza lógica de cancelamento
      
      // Event listeners para modal de forma de pagamento
      novaFormaTipoSelect.addEventListener('change', () => {
        novaFormaCartaoFields.classList.toggle('visible', novaFormaTipoSelect.value === 'CARTAO_CREDITO');
      });
      
      btnAddFormaModal.addEventListener('click', addFormaTemp);
      btnSaveForma.addEventListener('click', saveFormasChanges);
      btnCancelForma.addEventListener('click', () => {
        formasAdicionadas = [];
        formasModificadas = [];
        formasRemovidas = [];
        loadFormasPagamento(); // Recarrega original
        formaModal.style.display = 'none';
      });
      
      closeModalFormaBtn.addEventListener('click', () => btnCancelForma.click()); // Reutiliza lógica de cancelamento
      
      // Fechar modais ao clicar fora
      window.addEventListener('click', (e) => {
        if (e.target === subcategoriaModal) closeModalSubcategoriaBtn.click();
        if (e.target === formaModal) closeModalFormaBtn.click();
      });
      
      // Event listener para o formulário de item
      itemForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Validações
        const tipo = tipoItemSelect.value;
        const categoria = categoriaItemSelect.value;
        const via = viaItemSelect.value;
        const forma = formaItemSelect.value;
        const repeteNum = repeteNumeroSelect.value;
        const repetePer = repetePeriodoSelect.value;
        
        if (tipo === 'SAIDA') {
          if (via === 'SEM_PREENCHIMENTO') { showErrorAlert('Selecione a VIA para SAÍDA.'); return; }
          if (forma === 'SEM_PREENCHIMENTO') { showErrorAlert('Selecione a FORMA para SAÍDA.'); return; }
        }
        
        if (repetePer !== 'NAO_REPETE' && !repeteNum) { showErrorAlert('Selecione o número para a repetição.'); return; }
        
        // Obter dados do formulário
        const itemData = {
          cliente_id: clienteId,
          tipo: tipo,
          categoria_id: categoriasMap[categoria],
          descricao: descricaoItemInput.value,
          subcategoria_id: subcategoriaItemSelect.value || null,
          via: tipo === 'SAIDA' ? via : null,
          forma_pagamento_id: tipo === 'SAIDA' ? (forma || null) : null,
          repete_numero: repetePer !== 'NAO_REPETE' ? parseInt(repeteNum) : null,
          repete_periodo: repetePer,
          data_inicial: dataInicialInput.value || `${new Date().getFullYear()}-01-01`, // Default para 01/01 do ano vigente
          data_final: dataFinalInput.value || null
        };
        
        try {
          const { error } = await supabase.from('itens_financeiros').insert([itemData]);
          if (error) throw error;
          
          showSuccessAlert('Item adicionado com sucesso!');
          itemForm.reset(); // Limpar formulário
          handleTipoChange(); // Resetar regras dinâmicas
          // TODO: Recarregar e exibir a tabela de itens
          
        } catch (error) {
          showErrorAlert(`Erro ao adicionar item: ${error.message}`);
        }
      });
      
      // Inicializar estado dos campos dinâmicos
      handleTipoChange();
    });
  </script>
</body>
</html>
